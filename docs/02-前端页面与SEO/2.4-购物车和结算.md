# 2.4 购物车和结算

## 功能概述

实现完整的购物车管理和Stripe支付集成。

## 购物车系统

### 迷你购物车 ([`MiniCart.astro`](../../frontend/src/components/cart/MiniCart.astro))

**触发方式**:
- 点击Header购物车图标
- 添加商品后自动弹出（可选）

**布局**:
```
┌─────────────────────────┐
│ 购物车 (3)         [X] │
├─────────────────────────┤
│ [图] 产品名称           │
│      $99.99 x 2         │
│      [+] 2 [-] [删除]   │
├─────────────────────────┤
│ [图] 产品名称           │
│      $49.99 x 1         │
│      [+] 1 [-] [删除]   │
├─────────────────────────┤
│ 小计: $249.97          │
│ [查看购物车] [去结算]  │
└─────────────────────────┘
```

**功能**:
- 商品列表展示
- 数量调整（+/-）
- 删除商品
- 小计金额
- 快速结算

**交互**:
- 滑出式侧边栏
- 点击遮罩层关闭
- 实时更新数量

### 购物车页面 ([`/cart.astro`](../../frontend/src/pages/cart.astro))

**完整布局**:
```
┌─────────────────────────────────────┐
│ 购物车 (3件商品)                    │
├──────────────────┬──────────────────┤
│ [图] 产品名称    │  优惠码          │
│ 规格: 红色/L     │  [输入框] [应用] │
│ $99.99          │                  │
│ [+] 2 [-] [删除]│  订单摘要        │
│                  │  小计: $249.97   │
│ [图] 产品名称    │  运费: $10.00    │
│ $49.99          │  折扣: -$25.00   │
│ [+] 1 [-] [删除]│  总计: $234.97   │
│                  │                  │
│ [继续购物]       │  [去结算]        │
└──────────────────┴──────────────────┘
```

**功能**:
1. **商品列表**
   - 产品图片、名称、规格
   - 单价和小计
   - 数量调整
   - 删除按钮
   - 库存提示

2. **优惠码**
   - 输入框
   - 应用按钮
   - 验证反馈
   - 显示折扣金额

3. **订单摘要**
   - 商品小计
   - 运费计算
   - 优惠折扣
   - 总计金额

4. **操作按钮**
   - 继续购物
   - 去结算
   - 清空购物车

### 购物车状态管理 ([`cart.ts`](../../frontend/src/lib/cart.ts))

**数据结构**:
```typescript
interface CartItem {
  productId: string;
  name: string;
  price: number;
  quantity: number;
  image: string;
  variant?: {
    size?: string;
    color?: string;
  };
}

interface Cart {
  items: CartItem[];
  subtotal: number;
  discount: number;
  shipping: number;
  total: number;
  couponCode?: string;
}
```

**核心方法**:
```typescript
// 添加商品
addToCart(item: CartItem): void

// 更新数量
updateQuantity(productId: string, quantity: number): void

// 删除商品
removeItem(productId: string): void

// 清空购物车
clearCart(): void

// 应用优惠码
applyCoupon(code: string): Promise<void>

// 计算总计
calculateTotal(): number
```

**持久化**:
- 使用localStorage存储
- 页面加载时恢复
- 实时同步更新

## 结算流程

### 结算页面 ([`/checkout.astro`](../../frontend/src/pages/checkout.astro))

**步骤指示器**:
```
1. 收货信息 → 2. 支付方式 → 3. 确认订单
```

**表单布局**:
```
┌─────────────────────────────────────┐
│ 1. 收货信息                         │
├─────────────────────────────────────┤
│ 邮箱: [___________________]         │
│ 姓名: [___________________]         │
│ 电话: [___________________]         │
│ 地址: [___________________]         │
│ 城市: [_______] 邮编: [_______]    │
│ 国家: [下拉选择]                    │
├─────────────────────────────────────┤
│ 2. 支付方式                         │
├─────────────────────────────────────┤
│ [Stripe支付表单]                    │
│ 卡号: [____-____-____-____]         │
│ 有效期: [__/__] CVV: [___]         │
├─────────────────────────────────────┤
│ 订单摘要                            │
│ 商品 (3): $249.97                   │
│ 运费: $10.00                        │
│ 总计: $259.97                       │
│                                     │
│ [提交订单]                          │
└─────────────────────────────────────┘
```

**表单验证**:
- 必填字段检查
- 邮箱格式验证
- 电话号码验证
- 地址完整性检查

**Stripe集成**:
```typescript
// 初始化Stripe
const stripe = await loadStripe(PUBLIC_STRIPE_KEY);

// 创建PaymentIntent
const { clientSecret } = await createOrder({
  items: cart.items,
  shipping: shippingAddress,
  email: customerEmail
});

// 确认支付
const { error } = await stripe.confirmCardPayment(clientSecret, {
  payment_method: {
    card: cardElement,
    billing_details: {
      name: customerName,
      email: customerEmail
    }
  }
});
```

### 订单确认页 ([`/order-confirm.astro`](../../frontend/src/pages/order-confirm.astro))

**显示内容**:
```
┌─────────────────────────────────────┐
│ ✓ 订单提交成功！                    │
│                                     │
│ 订单号: #ORD-20240101-001          │
│ 支付状态: 已支付                    │
│                                     │
│ 我们已发送确认邮件到:               │
│ customer@example.com                │
├─────────────────────────────────────┤
│ 订单详情                            │
│ [产品列表]                          │
│                                     │
│ 收货地址                            │
│ [地址信息]                          │
│                                     │
│ 支付信息                            │
│ 总计: $259.97                       │
│ 支付方式: Visa ****1234             │
├─────────────────────────────────────┤
│ [查看订单详情] [继续购物]          │
└─────────────────────────────────────┘
```

**功能**:
- 订单号显示
- 订单详情展示
- 邮件确认提示
- 后续操作引导

### 订单追踪页 ([`/order.astro`](../../frontend/src/pages/order.astro))

**查询方式**:
- 订单号 + 邮箱
- 或通过邮件链接直接访问

**物流状态**:
```
┌─────────────────────────────────────┐
│ 订单 #ORD-20240101-001              │
│ 状态: 运输中                        │
├─────────────────────────────────────┤
│ 物流时间线                          │
│ ● 2024-01-01 订单已创建             │
│ ● 2024-01-02 订单已支付             │
│ ● 2024-01-03 商品已发货             │
│ ○ 预计送达: 2024-01-05              │
├─────────────────────────────────────┤
│ 物流信息                            │
│ 快递公司: 顺丰速运                  │
│ 快递单号: SF1234567890              │
│ [查看物流详情]                      │
└─────────────────────────────────────┘
```

## 支付集成

### Stripe配置

**环境变量**:
```env
PUBLIC_STRIPE_PUBLIC_KEY=pk_test_xxx
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

**支付流程**:
1. 前端：创建订单，获取clientSecret
2. 前端：使用Stripe Elements收集支付信息
3. 前端：确认支付
4. 后端：接收Webhook，更新订单状态
5. 后端：发送确认邮件

### Webhook处理

**监听事件**:
- `payment_intent.succeeded` - 支付成功
- `payment_intent.payment_failed` - 支付失败

**处理逻辑**:
```typescript
// 验证签名
const sig = request.headers.get('stripe-signature');
const event = stripe.webhooks.constructEvent(body, sig, webhookSecret);

// 处理事件
switch (event.type) {
  case 'payment_intent.succeeded':
    // 更新订单状态为paid
    // 扣减库存
    // 发送确认邮件
    break;
  case 'payment_intent.payment_failed':
    // 更新订单状态为failed
    break;
}
```

## 优惠码系统

### 验证逻辑

**检查项**:
1. 优惠码是否存在
2. 是否在有效期内
3. 是否达到最低消费
4. 是否超过使用次数
5. 是否已被当前用户使用

**折扣计算**:
```typescript
// 百分比折扣
if (coupon.type === 'percentage') {
  discount = subtotal * (coupon.value / 100);
}

// 固定金额折扣
if (coupon.type === 'fixed') {
  discount = coupon.value;
}

// 应用折扣
total = subtotal + shipping - discount;
```

## 性能优化

### 购物车操作
- 数量更新使用防抖（500ms）
- 优惠码验证使用节流（1秒）
- localStorage批量更新

### 结算页面
- 预加载Stripe SDK
- 表单验证客户端优先
- 支付按钮防重复点击

### 订单查询
- 使用服务端渲染
- 缓存订单详情
- 减少数据库查询

## 安全措施

### 数据验证
- 前端：基础验证
- 后端：完整验证
- 价格服务端计算

### 支付安全
- 使用Stripe Elements（PCI合规）
- Webhook签名验证
- HTTPS强制

### 防刷单
- 订单频率限制
- IP地址检查
- 异常订单标记

## 相关文档

- [订单API](../03-后端API/3.3-订单和支付.md)
- [优惠券系统](../04-管理后台/4.6-优惠券管理.md)
- [邮件通知](../03-后端API/3.3-订单和支付.md#邮件通知)

## 状态

✅ **已完成** - 购物车和支付功能已实现