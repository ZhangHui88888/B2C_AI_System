# 博客系统实现指南

## 概述

博客系统已完全集成到数据库中，替代了之前的静态内容方式。博客文章存储在 `content_library` 表中（type='blog'），作者信息管理在 `authors` 表中。

---

## 数据库架构

### 迁移文件
- **文件位置**: [`docs/database/009_blog_support.sql`](../database/009_blog_support.sql)
- **执行顺序**: 在 `008_admin_users.sql` 之后运行

### 主要变更

1. **添加 'blog' 到 content_type_enum**
   - 扩展现有内容类型（script、caption、description）

2. **content_library 表新增字段**
   - `slug` (VARCHAR(255)): URL 友好的标识符
   - `published_at` (TIMESTAMPTZ): 发布时间戳

3. **自动生成 Slug**
   - 触发器自动从标题生成 slug
   - 处理重复 slug（自动添加数字后缀）
   - 仅适用于博客文章

4. **索引**
   - `idx_content_slug`: 快速 slug 查询
   - `idx_content_published`: 按发布日期排序
   - `unique_content_slug_per_brand`: 确保每个品牌的 slug 唯一

---

## API 接口

### 内容 API（博客文章）

#### 列出博客文章
```
GET /api/content?type=blog&status=published&page=1&limit=20
```

**查询参数：**
- `type`: 'blog'（博客文章必填）
- `status`: 'draft'（草稿）| 'approved'（已审核）| 'published'（已发布）
- `author_id`: 按作者 UUID 筛选
- `page`: 页码（默认：1）
- `limit`: 每页条数（默认：20，最大：100）

**响应示例：**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "type": "blog",
      "title": "文章标题",
      "slug": "article-title",
      "meta_description": "简短描述",
      "content": "完整的 Markdown 内容",
      "status": "published",
      "published_at": "2025-01-15T10:00:00Z",
      "created_at": "2025-01-15T09:00:00Z",
      "updated_at": "2025-01-15T09:30:00Z",
      "author": {
        "id": "uuid",
        "name": "作者姓名",
        "slug": "author-slug",
        "avatar_url": "https://..."
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "totalPages": 3
  }
}
```

#### 通过 Slug 获取单篇博客
```
GET /api/content?type=blog&slug=article-title&status=published
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "title": "文章标题",
    "slug": "article-title",
    "meta_description": "简短描述",
    "content": "完整的 Markdown 内容",
    "status": "published",
    "published_at": "2025-01-15T10:00:00Z",
    "author": {
      "id": "uuid",
      "name": "作者姓名",
      "slug": "author-slug",
      "avatar_url": "https://...",
      "bio": "作者简介",
      "credentials": ["专家", "作家"],
      "social_links": {
        "twitter": "https://twitter.com/...",
        "linkedin": "https://linkedin.com/in/..."
      }
    }
  }
}
```

### 作者 API

#### 列出作者
```
GET /api/authors?active=true&page=1&limit=20
```

#### 通过 Slug 获取作者
```
GET /api/authors?slug=author-slug
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "作者姓名",
    "slug": "author-slug",
    "avatar_url": "https://...",
    "bio": "作者简介",
    "credentials": ["专家", "作家"],
    "social_links": {
      "twitter": "https://twitter.com/...",
      "linkedin": "https://linkedin.com/in/..."
    },
    "is_active": true,
    "article_count": 15,
    "contentStats": {
      "total": 15,
      "byType": { "blog": 15 },
      "byStatus": { "published": 12, "draft": 3 }
    }
  }
}
```

---

## 前端页面

### 博客列表页
- **路径**: `/blog`
- **文件**: [`frontend/src/pages/blog/index.astro`](../../frontend/src/pages/blog/index.astro)
- **功能特性**:
  - 从 API 获取已发布的博客文章
  - 响应式网格显示（1/2/3 列）
  - 显示作者姓名并链接到作者页面
  - 显示发布/更新日期
  - API 失败时的错误处理

### 博客详情页
- **路径**: `/blog/[slug]`
- **文件**: [`frontend/src/pages/blog/[slug].astro`](../../frontend/src/pages/blog/[slug].astro)
- **功能特性**:
  - 通过 slug 获取单篇文章
  - 将 Markdown 内容渲染为 HTML
  - 显示作者信息卡片
  - 显示发布/更新日期
  - 包含 SEO 组件（ArticleSchema、BreadcrumbSchema）
  - GEO 优化（Summary、DefinitionParagraph）

### 作者页面
- **路径**: `/author/[slug]`
- **文件**: [`frontend/src/pages/author/[slug].astro`](../../frontend/src/pages/author/[slug].astro)
- **功能特性**:
  - 通过 slug 获取作者详情
  - 列出该作者的所有已发布文章
  - 显示作者头像、简介、资质
  - 显示社交媒体链接
  - 包含 SEO 组件（PersonSchema、BreadcrumbSchema）

---

## API 客户端方法

[`frontend/src/lib/api.ts`](../../frontend/src/lib/api.ts) 中新增的方法：

```typescript
// 获取博客文章（带筛选）
api.getBlogPosts({ 
  page: 1, 
  limit: 20, 
  status: 'published',
  author_id: 'uuid' 
})

// 通过 ID 获取单篇博客
api.getBlogPost(id)

// 通过 slug 获取博客文章
api.getBlogPostBySlug(slug)

// 通过 slug 获取作者
api.getAuthorBySlug(slug)
```

---

## 创建博客文章

### 方式一：通过管理后台（推荐）

1. 访问 `/admin/content`
2. 点击"创建新内容"
3. 选择类型："blog"
4. 填写信息：
   - 标题（slug 自动生成）
   - Meta 描述
   - 内容（Markdown 格式）
   - 作者
   - 状态（草稿/已审核/已发布）
5. 保存

### 方式二：通过 API

```bash
POST /api/content
Content-Type: application/json

{
  "type": "blog",
  "title": "如何选择合适的产品",
  "meta_description": "一份实用的购买指南",
  "content": "## 简介\n\n完整的 Markdown 内容...",
  "author_id": "author-uuid",
  "status": "published",
  "published_at": "2025-01-15T10:00:00Z"
}
```

### 方式三：直接操作数据库

```sql
INSERT INTO content_library (
  brand_id,
  type,
  title,
  meta_description,
  content,
  author_id,
  status,
  published_at
) VALUES (
  'brand-uuid',
  'blog',
  '文章标题',
  '简短描述',
  '完整的 Markdown 内容',
  'author-uuid',
  'published',
  NOW()
);
-- Slug 将由触发器自动生成
```

---

## 内容格式

### Markdown 支持

博客系统使用简单的 Markdown 渲染器，支持：

- **标题**: `# H1`、`## H2`、`### H3`
- **段落**: 纯文本
- **换行**: 段落之间空行

示例：
```markdown
## 简介

这是第一段。

这是第二段。

### 小节

更多内容。
```

### 扩展 Markdown 支持

要添加更多 Markdown 功能，更新 [`frontend/src/pages/blog/[slug].astro`](../../frontend/src/pages/blog/[slug].astro) 中的 `renderMarkdown()` 函数：

```typescript
function renderMarkdown(md: string): string {
  // 添加对粗体、斜体、链接、列表等的支持
  // 或集成完整的 Markdown 库，如 marked 或 remark
}
```

---

## SEO 和 GEO 优化

### 使用的 SEO 组件

1. **ArticleSchema**: 博客文章的结构化数据
   - 标题、描述、作者
   - 发布和修改日期
   - 图片 URL

2. **BreadcrumbSchema**: 导航面包屑
   - 首页 → 博客 → 文章标题

3. **PersonSchema**: 作者结构化数据
   - 姓名、简介、头像
   - 社交媒体资料（sameAs）

### 使用的 GEO 组件

1. **PublishDate**: 显示发布和更新日期
2. **AuthorInfo**: 作者卡片（头像和简介）
3. **Summary**: TL;DR 部分（供 AI 爬虫使用）
4. **DefinitionParagraph**: 定义主题

---

## 性能考虑

### 缓存策略

1. **API 层**: 内容 API 响应可缓存在 Cloudflare KV 中
2. **页面层**: 使用 SSR 按需生成静态页面
3. **数据库**: 在 slug 和 published_at 上建立索引以加快查询

### 优化建议

1. **限制 API 调用**: 前端仅获取已发布的文章
2. **分页**: 使用合理的页面大小（20-50 条）
3. **图片优化**: 使用 CDN 处理作者头像和文章图片
4. **懒加载**: 首屏以下的图片使用懒加载

---

## 迁移检查清单

- [ ] 在 Supabase SQL 编辑器中运行 `docs/database/009_blog_support.sql`
- [ ] 验证 `content_type_enum` 包含 'blog'
- [ ] 检查 `content_library` 表有 `slug` 和 `published_at` 字段
- [ ] 测试 slug 自动生成触发器
- [ ] 在 `authors` 表中创建至少一个作者
- [ ] 创建示例博客文章
- [ ] 测试博客列表页：`/blog`
- [ ] 测试博客详情页：`/blog/[slug]`
- [ ] 测试作者页面：`/author/[slug]`
- [ ] 验证页面源代码中的 SEO schemas
- [ ] 检查移动端响应式

---

## 故障排除

### 博客文章不显示

1. 检查文章状态是否为 'published'
2. 验证 `published_at` 已设置
3. 检查 brand_id 是否匹配当前品牌
4. 验证 API 端点是否可访问

### Slug 冲突

- 自动 slug 触发器通过添加数字处理重复
- 如需要可手动设置唯一 slug

### 找不到作者

1. 验证作者存在于 `authors` 表中
2. 检查作者 `is_active` 为 true
3. 确保作者属于正确的品牌

### API 错误

1. 检查 Cloudflare Worker 日志
2. 验证 Supabase 连接
3. 检查品牌中间件是否正常工作
4. 验证请求参数

---

## 未来增强功能

### 计划功能

1. **富文本编辑器**: 所见即所得的内容创建编辑器
2. **图片上传**: 博客文章的直接图片上传
3. **分类/标签**: 按主题组织文章
4. **评论系统**: 读者互动系统
5. **相关文章**: AI 驱动的文章推荐
6. **搜索功能**: 博客文章的全文搜索
7. **RSS 订阅**: 自动生成 RSS/Atom feed
8. **草稿预览**: 预览未发布的文章
9. **定时发布**: 在指定时间自动发布
10. **分析统计**: 追踪浏览量、互动、热门文章

### 集成想法

1. **邮件通讯**: 自动向订阅者发送新文章
2. **社交分享**: 自动发布到社交媒体
3. **SEO 工具**: 关键词分析、可读性评分
4. **AI 助手**: 内容建议、语法检查
5. **多语言**: 自动翻译文章

---

## 技术支持

遇到问题时：
1. 查看本文档
2. 检查 API 端点响应
3. 查看 Cloudflare Worker 日志
4. 验证数据库架构与迁移匹配
5. 先使用示例数据测试