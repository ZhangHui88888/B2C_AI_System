# DTC 内容电商系统 - 功能说明

> 本文档提供系统所有功能的详细说明
> 不包含开发进度，进度追踪请查看《开发计划.md》

---

## 自动化图例

| 图标 | 含义 | 说明 |
|------|------|------|
| 🤖 自动 | 代码自动执行 | 无需人工干预，系统自动完成 |
| 🧠 AI | AI 辅助生成 | AI 生成内容，人工审核/确认 |
| ⚙️ 配置 | 需要配置 | 人工配置规则，系统按规则执行 |
| - | 手动操作 | 需要人工完成 |

---

## 项目概述

这是一个 **DTC（Direct-to-Consumer）内容电商独立站**系统，采用现代技术栈构建，支持：

- 🛒 **电商功能**：产品展示、购物车、在线支付
- 🤖 **AI 客服**：基于 RAG 的智能问答
- 📝 **内容生成**：AI 生成视频脚本、产品文案
- 📊 **数据分析**：销售统计、利润分析

### 多品牌架构（独立域名模式）

**工作原理：**
1. 每个品牌绑定独立域名（如 `techgear.com`、`beautyglow.com`）
2. 所有域名指向同一套 Cloudflare Workers/Pages
3. 系统根据访问域名自动识别品牌，查询对应数据
4. 客户看到的是完全独立的网站，互不知道其他品牌存在

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 前端 | Astro 5.x | 静态生成，SEO 友好 |
| 样式 | TailwindCSS 4.x | 原子化 CSS |
| 后端 | Cloudflare Workers | 边缘计算，全球部署 |
| 数据库 | Supabase (PostgreSQL) | 托管数据库 + 实时功能 |
| 支付 | Stripe | 信用卡、Apple Pay、Google Pay |
| AI | DeepSeek | 对话 + 向量检索 |
| 邮件 | Resend | 订单通知邮件 |

---

## 功能模块清单

### 1. 项目初始化

#### 1.1 基础架构

**功能说明：**
- Astro 前端项目结构
- Cloudflare Worker 后端结构
- TailwindCSS 配置
- TypeScript 配置
- Wrangler 配置
- 环境变量模板
- 基础布局组件
- API 客户端封装
- 购物车状态管理
- Supabase 客户端
- 数据库类型定义

#### 1.2 数据库模型

**数据表：**
- `brands` - 品牌/站点信息（多租户核心表，含 domain 字段）
- `products` - 产品信息（名称、价格、图片、SEO 等）
- `categories` - 产品分类（支持层级）
- `orders` - 订单记录（状态、支付、物流）
- `customers` - 客户信息（统计购买历史）
- `conversations` - AI 对话历史
- `knowledge_base` - RAG 知识库
- `settings` - 系统设置（AI 开关、店铺信息等）
- `content_library` - AI 生成的内容（脚本、文案）
- `reviews` - 产品评价
- `authors` - 内容作者
- `coupons` - 优惠券
- `admin_users` - 管理员用户

**多品牌数据隔离：**
- 所有表都通过 `brand_id` 关联到品牌
- `brands` 表的 `domain` 字段存储独立域名
- 系统根据请求域名查询 `brands.domain` 获取 `brand_id`
- 每个品牌有独立的：产品、分类、订单、客户、设置、知识库

---

### 2. 前端页面 + 基础 SEO/GEO

#### 2.1 基础 SEO + GEO

**基础 SEO：**
- `<title>` 动态标题 (🤖 自动)
- `<meta description>` (🤖 自动)
- Open Graph 标签 (🤖 自动)
- Twitter Card (🤖 自动)
- `<link rel="canonical">` (🤖 自动)
- 列表筛选/排序/分页 URL 规范 (🤖 自动)
- URL 参数索引策略 (⚙️ 配置)
- Product Schema (🤖 自动)
- BreadcrumbList Schema (🤖 自动)
- Organization Schema (🤖 自动)
- FAQ Schema (🤖 自动)
- sitemap.xml 动态生成 (🤖 自动)
- robots.txt (⚙️ 配置)

**基础 GEO（AI 搜索友好）：**
- AI 爬虫 robots.txt (⚙️ 配置)
- 发布日期组件 (🤖 自动)
- 作者信息组件 (🤖 自动)
- 摘要/TL;DR 区域 (🧠 AI)
- 问答格式组件 (🤖 自动)
- 定义式段落 (🧠 AI)
- 结构化列表 (🤖 自动)

#### 2.2 首页和布局组件

**功能说明：**
- 响应式 Header
- 移动端汉堡菜单
- Footer
- Hero 区域（大图/视频背景 + CTA）
- 热销产品轮播
- 分类展示网格
- 社会证明区域（评价/媒体报道）
- Email 订阅表单
- ProductCard 组件
- CategoryCard 组件

#### 2.3 产品页面

**功能说明：**
- 产品列表页 `/products`（筛选、排序、分页）
- 产品详情页 `/products/[slug]`（图片画廊、规格、相关产品）
- 分类页面 `/category/[slug]`

**自动化功能：**
- 筛选栏 (🤖 自动根据数据生成筛选项)
- 分页 (🤖 自动计算)
- 规格表格 (🤖 自动渲染为结构化表格)
- 相关产品 (🤖 自动匹配同分类/标签产品)

#### 2.4 购物车和结算

**功能说明：**
- 迷你购物车（侧边栏）
- 购物车页面 `/cart`
- 数量调整/删除
- 优惠码输入（验证、折扣显示）
- 结算页面 `/checkout`
- 步骤指示器（信息 → 支付 → 确认）
- 收货地址表单
- Stripe 支付集成
- 订单确认页
- 订单追踪页

#### 2.5 静态页面

**功能说明：**
- 关于我们 `/about`
- 联系我们 `/contact`
- 隐私政策 `/privacy`
- 服务条款 `/terms`
- 退换货政策 `/returns`
- 发货说明 `/shipping`
- FAQ `/faq`（含 FAQ Schema）
- 博客列表 `/blog`
- 博客详情 `/blog/[slug]`（含 Article Schema + 作者信息）
- 作者页面 `/author/[slug]`（作者简介、资质、文章列表）

#### 2.6 E-E-A-T 信任元素

**功能说明：**
- 安全支付徽章（Stripe/PayPal/Visa/Mastercard）
- SSL 安全标识
- 社交媒体链接（Instagram/TikTok/Facebook）
- 媒体报道展示
- 产品认证标识（CE/FCC/FDA）
- 第三方评价入口（Trustpilot/Google Reviews）

---

### 3. 后端 API

#### 3.1 域名品牌识别（核心）

**功能说明：**
- 域名识别中间件（根据 Host 头查询 brands.domain 获取 brand_id）
- 品牌信息缓存（可选 KV 缓存）
- KV 缓存键包含 Host（避免跨品牌缓存污染）
- 默认品牌回退（开发环境 localhost）
- 生产环境未匹配域名处理（返回 404）
- 品牌上下文注入（所有 API 自动携带 brand_id）

#### 3.2 基础 API

**功能说明：**
- 产品列表 API（`POST /api/products/list`）
  - 按 brand_id 过滤
  - 支持分页/筛选/排序
- 产品详情 API（`GET /api/products/:slug`）
  - 按 brand_id 过滤
  - 返回相关产品
- 分类列表 API（`GET /api/categories`）
  - 按 brand_id 过滤
  - 返回层级结构 + 产品数量
- CORS 中间件
- 错误处理
- Supabase 连接

#### 3.3 订单和支付

**功能说明：**
- 购物车验证（`POST /api/cart/validate`）
  - 库存校验
  - 价格验证
- 创建订单（`POST /api/orders/create`）
  - 服务端金额/币种校验
  - 创建 Stripe PaymentIntent
- 订单详情（`GET /api/orders/:id`）
- Stripe Webhook（`POST /api/stripe/webhook`）
  - 签名验证
  - 幂等处理（stripe_event_id 去重）
  - 订单状态机校验
  - 库存扣减
  - 邮件通知

#### 3.4 AI 客服

**功能说明：**
- 普通对话（`POST /api/chat`）
  - 按 brand_id 读取 settings
  - RAG 向量检索
  - 对话历史管理
- 流式响应（`POST /api/chat/stream`）
  - SSE 实时流式输出
- 知识库 CRUD（`GET/POST/PUT/DELETE /api/knowledge`）
- 知识库同步（`POST /api/knowledge/sync`）
- 多语言支持（AI 自动检测）
- 人工转接关键词匹配
- 前端聊天组件（ChatWidget.astro）

**多品牌架构：**
- 每个品牌独立知识库（brand_id 隔离）
- 品牌级配置（AI 人设、系统提示词、欢迎语）
- 向量存储方案（单表 + brand_id 字段）
- RAG 检索流程（按 brand_id 过滤）

---

### 4. 管理后台

#### 4.1 后台框架

**功能说明：**
- 后台布局 AdminLayout（响应式侧边栏）
- 登录认证（Supabase Auth 邮箱密码登录）
- 仪表盘（统计卡片、快捷操作）
- 品牌切换器（顶栏品牌选择器）
- 角色权限模型（RBAC）

#### 4.2 产品管理

**功能说明：**
- 产品列表（`/admin/products`）
  - 分页、状态标签
  - 筛选、搜索
- 产品编辑（`/admin/products/[id]`）
  - 完整编辑表单
  - 图片上传
  - SEO 字段
- 产品创建（`/admin/products/new`）
- 批量操作（批量激活/停用/删除）
- 分类管理（`/admin/categories`）
  - 树形分类管理

#### 4.3 订单管理

**功能说明：**
- 订单列表（`/admin/orders`）
  - 状态筛选
  - 时间范围筛选
- 订单详情（`/admin/orders/[id]`）
  - 完整订单信息
  - 客户信息
  - 时间线
- 状态更新（状态流转含校验）
- 物流信息填写（自动发送发货通知邮件）
- 退款操作（Stripe Refund API + 退款通知邮件）

#### 4.4 系统设置

**功能说明：**
- 店铺设置（名称、通知邮箱）
- 支付设置（货币、Stripe 公钥、支付方式）
- 发货设置（运费、免运费门槛、预计送达时间）
- 邮件模板管理（订单确认/发货/评价邀请模板）

#### 4.5 内容管理

**作者管理：**
- 作者列表（`/admin/authors`）
- 作者创建/编辑（姓名、头像、简介、资质证书、社交链接）
- 作者关联文章

**评价管理：**
- 评价列表（`/admin/reviews`）
- 评价审核（通过/拒绝/标记垃圾）
- 购买者标识（自动标记已购买用户）
- 评价回复（商家回复功能）
- 邀请评价（订单完成后自动邮件邀请）

**信任元素管理：**
- 媒体报道管理（`/admin/trust`）
- 产品认证管理
- 第三方评价配置
- 社交媒体配置

#### 4.6 优惠券管理

**功能说明：**
- 优惠券列表（`/admin/coupons`）
- 创建/编辑优惠券
  - 类型（固定金额/百分比）
  - 使用条件（最低消费、指定产品/分类）
  - 有效期
  - 使用次数限制
- 优惠券验证
- 结算页集成

#### 4.7 品牌管理

**功能说明：**
- 品牌列表（`/admin/brands`）
- 多品牌 CRUD
- 域名配置
- 品牌设置

---

### 5. AI 内容工具

#### 5.1 AI 内容质量防护

**功能说明：**
- 人工审核流程（AI 生成 → 草稿 → 审核 → 发布）
- 原创度检测（🧠 AI）
- AI 内容标识（🤖 自动）
- 内容差异化引擎（🧠 AI 自动融入真实产品数据）
- 作者署名系统
- 发布频率限制（🤖 自动）
- 内容更新提醒（🤖 自动）

#### 5.2 视频脚本生成

**功能说明：**
- 产品选择（`/admin/content`）
- 视频类型选择（开箱/测评/教程/促销）
- 脚本生成（🧠 AI：Hook + 主体 + CTA）
- 配乐推荐（🧠 AI）
- Hashtag 推荐（🧠 AI）
- 脚本库（content_library 表存储）

#### 5.3 文案生成

**功能说明：**
- 产品描述（长/短）（🧠 AI）
- 社交媒体文案（🧠 AI，支持多平台）
- 邮件营销文案（🧠 AI）
- 文案库（content_library 表存储）
- 语气风格调整（🧠 AI：casual/professional/playful/luxury/informative）

---

### 6. 数据分析

#### 6.1 数据看板

**功能说明：**
- 销售概览（`/admin/analytics`）
  - 今日/30天销售额、订单数、AOV
- 销售趋势图（Chart.js 按天的销售曲线）
- 产品排行榜（收入 Top 10）
- 客户分析（`/api/analytics/customers`）
  - 新客/老客、复购率、LTV
- 转化漏斗（`/api/analytics/funnel`）
  - 订单→支付→发货→送达

---

### 7. 高级 SEO/GEO 工具（待开发）

#### 7.1 页面级 SEO 优化

**Meta 标签管理：**
- Title 标签编辑器（支持变量模板）
- Description 编辑器（实时预览）
- 关键词密度分析（🤖 自动）
- 重复 Meta 检测（🤖 自动）
- 批量 Meta 生成（🧠 AI）

**图片 SEO：**
- Alt 文本检查（🤖 自动）
- Alt 文本 AI 建议（🧠 AI）
- 文件名优化（🧠 AI）
- 图片压缩（🤖 自动）
- WebP 转换（🤖 自动）

**内链优化：**
- 孤立页面检测（🤖 自动）
- 内链密度分析（🤖 自动）
- 相关内容 AI 推荐（🧠 AI）
- 内链结构可视化（🤖 自动）

#### 7.2 技术 SEO

**爬虫控制：**
- Sitemap 管理界面
- Sitemap 分片（> 50,000 URL 自动分片）
- Robots.txt 编辑器
- Crawl Budget 分析

**URL 与重定向：**
- 301 重定向管理
- 重定向链检测（🤖 自动）
- 404 页面监控（🤖 自动）

**页面性能：**
- Core Web Vitals 监控（LCP、FID、CLS、INP）
- 性能趋势图
- 优化建议生成

#### 7.3 内容 SEO

**关键词研究：**
- 种子词扩展（🧠 AI）
- 搜索意图分类（🧠 AI）
- 关键词难度评估（🧠 AI）
- 关键词分组（🧠 AI）

**内容优化：**
- 内容评分系统（🧠 AI）
- 可读性分析（🤖 自动）
- 标题层级检查（🤖 自动）
- E-E-A-T 评分（🧠 AI）

#### 7.4 监控与报告

**排名追踪：**
- 关键词排名监控（🤖 定时追踪）
- 排名变化提醒（🤖 自动）
- 竞品排名对比

**索引监控：**
- 索引状态检查（🤖 定时检测）
- 索引覆盖率报告
- Search Console 集成

**自动化报告：**
- 周报自动生成（🤖 每周一自动）
- 月报自动生成（🤖 每月 1 日自动）

#### 7.5 GEO 生成式引擎优化

**AI 爬虫管理：**
- AI 爬虫识别（🤖 自动）
- robots.txt AI 规则（⚙️ 配置）
- AI 爬虫日志（🤖 自动记录）

**内容结构优化：**
- 问答格式检测（🤖 自动）
- 摘要/TL;DR 生成（🧠 AI）
- 定义式开头检测（🧠 AI）

**品牌可见性：**
- 品牌名提及优化（🧠 AI）
- 品牌+产品关联（🧠 AI）
- 对比内容创建（🧠 AI）

**AI 搜索监控：**
- AI 引用追踪（🤖 定时监控）
- AI 回答截图（🤖 定期自动）
- 竞品 AI 可见性对比（🤖 自动）

---

### 8. 多品牌管理（待开发）

#### 8.1 品牌管理

**功能说明：**
- 品牌创建（名称、Slug、域名）
- 品牌编辑（Logo、设置、主题色）
- 域名绑定配置（DNS 指引）
- 品牌主题定制（颜色、字体、布局风格）
- 用户权限分配（品牌管理员、编辑、只读）
- 品牌启用/禁用

#### 8.2 协作管理

**功能说明：**
- 总后台（超级管理员视图，切换品牌）
- 品牌独立后台（品牌管理员只能看到自己的品牌）
- 跨品牌数据看板（汇总所有品牌的销售数据）
- 知识库共享（AI 知识库跨品牌复用）
- 模板共享（邮件模板、脚本模板跨品牌复用）

---

### 9. 流量与转化（待开发）

#### 9.1 广告追踪像素

**功能说明：**
- Facebook Pixel 集成
- Google Ads 转化追踪
- TikTok Pixel
- Pinterest Tag
- 像素配置界面
- 服务端事件（Conversions API）
- 统一事件追踪层
- 事件去重与一致性校验

**标准电商事件：**
- PageView（页面加载）
- ViewContent（产品详情页）
- AddToCart（加入购物车）
- InitiateCheckout（进入结算页）
- Purchase（支付成功）

#### 9.2 UTM 参数追踪

**功能说明：**
- UTM 参数解析（🤖 自动）
- 来源归因存储（🤖 自动）
- 来源报表（🤖 自动）
- 首次/末次归因
- 归因窗口与 TTL 策略

#### 9.3 邮件营销自动化

**交易邮件：**
- 订单确认邮件（🤖 自动）
- 发货通知邮件（🤖 自动）
- 送达确认邮件（🤖 自动）

**弃购挽回：**
- 弃购检测（🤖 自动）
- 弃购邮件序列（🤖 自动：1小时/24小时/72小时）
- 弃购邮件内容（🧠 AI）
- 弃购转化统计（🤖 自动）

**营销邮件：**
- 欢迎邮件序列（🤖 自动）
- 欢迎邮件内容（🧠 AI）
- 复购提醒（🤖 自动）
- 节日营销（🧠 AI）
- 新品通知（🤖 自动）
- 发送时间优化（🧠 AI）

**邮件合规：**
- 退订链接（🤖 自动）
- 退订管理（🤖 自动）
- 发送频率限制（🤖 自动）
- 订阅偏好与营销授权
- 弃购判定防误伤

#### 9.4 优惠券系统

**功能说明：**
- 优惠券创建（固定金额/百分比折扣）
- 使用条件（最低消费、指定产品/分类、首单专享）
- 有效期设置
- 使用次数限制
- 优惠码生成（🤖 自动）
- 优惠码验证（🤖 自动）
- 使用统计（🤖 自动）

#### 9.5 用户留存

**会员系统：**
- 积分获取（🤖 自动）
- 积分兑换（🤖 自动）
- 会员等级（🤖 自动升降级）

**推荐有礼：**
- 推荐码生成（🤖 自动）
- 推荐追踪（🤖 自动）
- 推荐奖励（🤖 自动）
- 被推荐人优惠（🤖 自动）
- 推荐统计（🤖 自动）

---

### 10. 部署运维（待开发）

#### 10.1 部署配置

**功能说明：**
- Cloudflare Pages 部署（前端静态站点）
- Cloudflare Workers 部署（API 边缘部署）
- 多域名绑定（独立域名模式配置）
- GitHub Actions CI/CD（自动构建、测试、部署）
- 环境变量管理（开发/预发/生产环境配置）

#### 10.2 监控维护

**功能说明：**
- 日志查看（Cloudflare Workers 日志）
- 关键路径结构化日志（订单创建、Stripe Webhook、AI 对话等）
- 性能监控（请求延迟、错误率）
- 备份策略（Supabase 数据库定期备份）
- 安全检查（依赖漏洞扫描、密钥轮换）
- 告警配置（错误率/延迟超阈值时通知）

---

## 项目结构

```
B2C_AI_System/
├── frontend/                 # Astro 前端
│   ├── src/
│   │   ├── pages/           # 页面
│   │   ├── components/      # 组件
│   │   ├── layouts/         # 布局
│   │   ├── lib/             # 工具库
│   │   └── styles/          # 样式
│   └── public/              # 静态资源
│
├── worker/                   # Cloudflare Worker 后端
│   └── src/
│       ├── routes/          # API 路由
│       ├── middleware/      # 中间件
│       └── utils/           # 工具函数
│
├── docs/                     # 文档
│   ├── database/            # 数据库脚本
│   ├── 功能说明.md          # 本文档
│   ├── 开发计划.md          # 开发计划和进度追踪
│   ├── 功能依赖关系图.md    # 功能依赖关系
│   ├── 安全性说明.md        # 安全设计
│   └── 环境变量配置.md      # 环境变量说明
│
└── README.md                 # 项目说明
```

---

## 更新日志

- 2025-12-25：创建功能说明文档（从功能文档中分离，移除进度标记）