# 10.1 部署配置

本文档详细说明 DTC 独立站系统的部署配置方案。

## 目录

1. [架构概览](#架构概览)
2. [Cloudflare Pages 部署](#cloudflare-pages-部署)
3. [Cloudflare Workers 部署](#cloudflare-workers-部署)
4. [多域名绑定](#多域名绑定)
5. [GitHub Actions CI/CD](#github-actions-cicd)
6. [环境变量管理](#环境变量管理)

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        Cloudflare Edge                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────┐         ┌──────────────────┐              │
│  │  Cloudflare      │         │  Cloudflare      │              │
│  │  Pages           │         │  Workers         │              │
│  │  (Frontend)      │◄───────►│  (API)           │              │
│  └────────┬─────────┘         └────────┬─────────┘              │
│           │                            │                         │
│  ┌────────┴─────────┐         ┌────────┴─────────┐              │
│  │  brand1.com      │         │  api.brand1.com  │              │
│  │  brand2.com      │         │  api.brand2.com  │              │
│  │  brand3.com      │         │  api.brand3.com  │              │
│  └──────────────────┘         └──────────────────┘              │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │         Supabase              │
                    │  (PostgreSQL + pgvector)      │
                    └───────────────────────────────┘
```

---

## Cloudflare Pages 部署

### 初次部署

1. **通过 Cloudflare Dashboard**

```bash
# 登录 Cloudflare
wrangler login

# 创建 Pages 项目
cd frontend
npm run build
wrangler pages project create dtc-ecommerce

# 部署
wrangler pages deploy dist --project-name=dtc-ecommerce
```

2. **连接 GitHub 仓库（推荐）**

- 进入 Cloudflare Dashboard → Pages
- 点击 "Create a project" → "Connect to Git"
- 选择仓库和分支
- 配置构建设置：
  - Framework preset: Astro
  - Build command: `npm run build`
  - Build output directory: `dist`
  - Root directory: `frontend`

### 环境变量配置

在 Cloudflare Dashboard → Pages → Settings → Environment variables 中配置：

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `PUBLIC_API_URL` | API 服务地址 | `https://api.yourdomain.com` |
| `PUBLIC_SITE_URL` | 前端站点地址 | `https://yourdomain.com` |
| `PUBLIC_STRIPE_PUBLISHABLE_KEY` | Stripe 公钥 | `pk_live_xxx` |

### 自定义域名

```bash
# 添加自定义域名
wrangler pages project list
wrangler pages deployment tail dtc-ecommerce
```

在 Dashboard 中：Pages → 项目 → Custom domains → Add custom domain

---

## Cloudflare Workers 部署

### 初次部署

```bash
# 进入 Worker 目录
cd worker

# 安装依赖
npm install

# 部署到开发环境
wrangler deploy

# 部署到 staging
wrangler deploy --env staging

# 部署到生产环境
wrangler deploy --env production
```

### 配置 Secrets

```bash
# 设置必要的 secrets
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_SERVICE_KEY
wrangler secret put STRIPE_SECRET_KEY
wrangler secret put STRIPE_WEBHOOK_SECRET
wrangler secret put RESEND_API_KEY
wrangler secret put DEEPSEEK_API_KEY

# 为生产环境设置 secrets
wrangler secret put SUPABASE_URL --env production
wrangler secret put SUPABASE_SERVICE_KEY --env production
# ... 其他 secrets
```

### KV Namespace 创建

```bash
# 创建 KV namespace
wrangler kv:namespace create "CACHE"
wrangler kv:namespace create "CACHE" --preview

# 创建生产环境 KV
wrangler kv:namespace create "CACHE" --env production
```

将返回的 ID 填入 `wrangler.toml`：

```toml
[[kv_namespaces]]
binding = "CACHE"
id = "your-kv-namespace-id"
preview_id = "your-preview-kv-namespace-id"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "your-prod-kv-namespace-id"
```

---

## 多域名绑定

### 前端多域名（Cloudflare Pages）

每个品牌可以有独立域名，但共用同一个 Pages 项目：

1. **在 Cloudflare Dashboard 添加域名**

   Pages → 项目 → Custom domains → Add custom domain
   
   添加所有品牌域名：
   - `brand1.com`
   - `brand2.com`
   - `www.brand1.com`
   - `www.brand2.com`

2. **DNS 配置**

   确保每个域名的 DNS 配置正确：
   
   | 类型 | 名称 | 内容 |
   |------|------|------|
   | CNAME | @ | dtc-ecommerce.pages.dev |
   | CNAME | www | dtc-ecommerce.pages.dev |

### API 多域名（Cloudflare Workers）

编辑 `worker/wrangler.toml`：

```toml
[env.production]
name = "dtc-ecommerce-api"
routes = [
  { pattern = "api.brand1.com/*", zone_name = "brand1.com" },
  { pattern = "api.brand2.com/*", zone_name = "brand2.com" },
  { pattern = "api.yourdomain.com/*", zone_name = "yourdomain.com" }
]
```

或使用 Custom Domain：

```bash
# 添加 custom domain
wrangler deploy --env production
# 然后在 Dashboard → Workers → 项目 → Triggers → Custom Domains 添加
```

### 多域名品牌识别

系统通过请求的 Host 头自动识别品牌：

```typescript
// worker/src/middleware/brand.ts
const host = request.headers.get('host');
const brand = await getBrandByDomain(host);
```

确保数据库中 `brand_domains` 表配置正确：

```sql
INSERT INTO brand_domains (brand_id, domain, is_primary) VALUES
  ('brand1-uuid', 'brand1.com', true),
  ('brand1-uuid', 'www.brand1.com', false),
  ('brand2-uuid', 'brand2.com', true);
```

---

## GitHub Actions CI/CD

### 工作流文件

项目包含以下 GitHub Actions 工作流：

| 文件 | 用途 |
|------|------|
| `.github/workflows/ci.yml` | 持续集成（lint、type check、build） |
| `.github/workflows/frontend-deploy.yml` | 前端部署到 Cloudflare Pages |
| `.github/workflows/worker-deploy.yml` | Worker 部署到 Cloudflare Workers |

### 配置 GitHub Secrets

在 GitHub 仓库 → Settings → Secrets and variables → Actions 中配置：

**Cloudflare 相关：**
- `CLOUDFLARE_API_TOKEN`: Cloudflare API Token（需要 Pages 和 Workers 权限）
- `CLOUDFLARE_ACCOUNT_ID`: Cloudflare 账户 ID

**前端相关：**
- `PUBLIC_API_URL`: API 地址
- `PUBLIC_SITE_URL`: 站点地址
- `PUBLIC_STRIPE_PUBLISHABLE_KEY`: Stripe 公钥

**Worker 相关：**
- `SUPABASE_URL`: Supabase 项目 URL
- `SUPABASE_SERVICE_KEY`: Supabase Service Role Key
- `STRIPE_SECRET_KEY`: Stripe 密钥（生产）
- `STRIPE_SECRET_KEY_STAGING`: Stripe 密钥（测试）
- `STRIPE_WEBHOOK_SECRET`: Stripe Webhook 密钥
- `STRIPE_WEBHOOK_SECRET_STAGING`: Stripe Webhook 密钥（测试）
- `RESEND_API_KEY`: Resend 邮件服务 API Key
- `DEEPSEEK_API_KEY`: DeepSeek AI API Key

### 创建 Cloudflare API Token

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)
2. 进入 My Profile → API Tokens
3. Create Token → Custom Token
4. 配置权限：
   - Account: Cloudflare Pages (Edit)
   - Account: Cloudflare Workers Scripts (Edit)
   - Account: Cloudflare Workers KV Storage (Edit)
   - Zone: DNS (Edit) - 如需自动配置 DNS

### 部署流程

```
Push to main
     │
     ├──► CI (lint, type check, build)
     │
     ├──► Frontend Deploy
     │        │
     │        └──► Cloudflare Pages
     │
     └──► Worker Deploy
              │
              ├──► Staging (自动)
              │
              └──► Production (需审批)
```

### 手动部署

```bash
# 触发手动部署
gh workflow run frontend-deploy.yml --ref main
gh workflow run worker-deploy.yml --ref main -f environment=production
```

---

## 环境变量管理

### 环境分类

| 环境 | 用途 | 数据 |
|------|------|------|
| `development` | 本地开发 | 测试数据 |
| `staging` | 预发布测试 | 测试数据 |
| `production` | 生产环境 | 真实数据 |

### 前端环境变量

创建 `.env` 文件（不提交到 Git）：

```bash
# frontend/.env.local
PUBLIC_API_URL=http://localhost:8787
PUBLIC_SITE_URL=http://localhost:4321
PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx
```

### Worker 环境变量

敏感变量通过 `wrangler secret put` 设置，非敏感变量在 `wrangler.toml` 中配置。

### 环境变量检查脚本

```bash
# scripts/check-env.sh
#!/bin/bash

REQUIRED_VARS=(
  "SUPABASE_URL"
  "SUPABASE_SERVICE_KEY"
  "STRIPE_SECRET_KEY"
  "STRIPE_WEBHOOK_SECRET"
  "RESEND_API_KEY"
  "DEEPSEEK_API_KEY"
)

for var in "${REQUIRED_VARS[@]}"; do
  wrangler secret list | grep -q "$var" || echo "Missing: $var"
done
```

---

## 快速开始清单

### 首次部署检查清单

- [ ] 创建 Cloudflare 账户
- [ ] 获取 Cloudflare Account ID
- [ ] 创建 Cloudflare API Token
- [ ] 配置 GitHub Secrets
- [ ] 创建 Supabase 项目并运行数据库迁移
- [ ] 配置 Stripe 账户和 Webhook
- [ ] 配置 Resend 邮件服务
- [ ] 配置 DeepSeek API
- [ ] 创建 KV Namespace
- [ ] 添加品牌域名到 DNS
- [ ] 运行首次部署

### 常用命令

```bash
# 本地开发
cd frontend && npm run dev
cd worker && npm run dev

# 部署预览
wrangler pages deploy frontend/dist --project-name=dtc-ecommerce --branch=preview
wrangler deploy --env staging

# 生产部署
wrangler pages deploy frontend/dist --project-name=dtc-ecommerce --branch=main
wrangler deploy --env production

# 查看日志
wrangler tail
wrangler tail --env production

# 管理 secrets
wrangler secret list
wrangler secret put SECRET_NAME
wrangler secret delete SECRET_NAME
```
