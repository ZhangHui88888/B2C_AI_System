# 功能依赖关系图

> 本文档展示系统各功能模块之间的依赖关系，帮助理解开发顺序和模块耦合度

---

## 核心依赖层级

```
第0层（基础设施）
├── Supabase 数据库
├── Cloudflare Workers
├── Cloudflare Pages
└── 环境变量配置

第1层（核心服务）
├── 品牌识别中间件 ⭐
├── Supabase 客户端封装
├── 响应工具函数
└── 错误处理

第2层（基础数据）
├── 产品管理
├── 分类管理
├── 品牌管理
└── 客户管理

第3层（业务功能）
├── 订单系统
├── 支付集成
├── 购物车
└── 邮件通知

第4层（AI 功能）
├── AI 客服
├── 知识库管理
├── 内容生成
└── 向量检索

第5层（管理后台）
├── 后台框架
├── 数据分析
├── 系统设置
└── 权限管理

第6层（高级功能）
├── SEO 工具
├── 评价系统
├── 作者管理
└── 优惠券系统
```

---

## 详细依赖关系

### 1. 品牌识别中间件 ⭐（核心依赖）

**被依赖方：** 几乎所有后端 API

**依赖项：**
- Supabase 客户端
- Cloudflare KV（可选）
- brands 表

**依赖它的模块：**
- 产品 API
- 订单 API
- AI 客服 API
- 知识库 API
- 所有管理后台 API

**说明：** 这是多品牌架构的核心，所有 API 都需要通过它获取 `brand_id`

---

### 2. 产品管理

**依赖项：**
- 品牌识别中间件 ⭐
- 分类管理
- products 表
- categories 表

**被依赖方：**
- 购物车
- 订单系统
- 知识库同步
- 内容生成
- 评价系统

**依赖关系图：**
```
品牌识别 → 产品管理 → 购物车 → 订单系统
              ↓
           知识库同步
              ↓
           AI 客服
```

---

### 3. 订单系统

**依赖项：**
- 品牌识别中间件 ⭐
- 产品管理（验证产品、库存）
- 客户管理
- Stripe 支付
- 邮件通知
- 优惠券系统（可选）
- orders 表
- customers 表

**被依赖方：**
- 评价系统（验证购买）
- 数据分析
- 邮件营销（弃购挽回）

**依赖关系图：**
```
产品管理 ──┐
           ├→ 订单创建 → Stripe 支付 → Webhook → 邮件通知
客户管理 ──┤                                ↓
           │                            库存扣减
优惠券 ────┘                                ↓
                                        评价邀请
```

---

### 4. AI 客服

**依赖项：**
- 品牌识别中间件 ⭐
- 知识库管理
- DeepSeek API
- 系统设置（AI 配置）
- conversations 表
- knowledge_base 表
- settings 表

**被依赖方：**
- 前端聊天组件

**依赖关系图：**
```
用户消息 → 品牌识别 → 加载品牌 AI 配置
                         ↓
                    向量检索知识库
                         ↓
                    获取对话历史
                         ↓
                    DeepSeek 生成回复
                         ↓
                    保存对话记录
```

---

### 5. 知识库管理

**依赖项：**
- 品牌识别中间件 ⭐
- DeepSeek API（Embedding）
- Supabase pgvector
- knowledge_base 表

**被依赖方：**
- AI 客服（RAG 检索）

**依赖关系图：**
```
产品数据 ──┐
FAQ 数据 ──┼→ 知识库同步 → DeepSeek Embedding → 存储向量
政策页面 ──┤                                      ↓
博客文章 ──┘                                  AI 客服检索
```

---

### 6. 内容生成

**依赖项：**
- 品牌识别中间件 ⭐
- 产品管理（获取产品数据）
- DeepSeek API
- 系统设置（AI 配置）
- content_library 表

**被依赖方：**
- 管理后台内容页面

**依赖关系图：**
```
产品数据 → 内容生成 API → DeepSeek → 生成脚本/文案
                                        ↓
                                    保存到内容库
                                        ↓
                                    人工审核
                                        ↓
                                    发布使用
```

---

### 7. 评价系统

**依赖项：**
- 品牌识别中间件 ⭐
- 产品管理
- 订单系统（验证购买）
- 邮件通知（邀请评价）
- reviews 表
- orders 表

**被依赖方：**
- 产品详情页（显示评价）
- 数据分析

**依赖关系图：**
```
订单完成 → 邮件邀请评价 → 用户提交评价 → 验证购买
                                          ↓
                                      后台审核
                                          ↓
                                      显示在产品页
```

---

### 8. 优惠券系统

**依赖项：**
- 品牌识别中间件 ⭐
- 产品管理（验证适用产品）
- coupons 表

**被依赖方：**
- 订单系统（结算时验证）
- 购物车（显示折扣）

**依赖关系图：**
```
创建优惠券 → 设置规则 → 用户输入优惠码 → 验证有效性
                                          ↓
                                      计算折扣
                                          ↓
                                      应用到订单
```

---

### 9. 数据分析

**依赖项：**
- 品牌识别中间件 ⭐
- 订单系统（销售数据）
- 产品管理（产品排行）
- 客户管理（客户分析）
- orders 表
- products 表
- customers 表

**被依赖方：**
- 管理后台仪表盘

**依赖关系图：**
```
订单数据 ──┐
产品数据 ──┼→ 数据聚合 → 生成报表 → 可视化图表
客户数据 ──┘
```

---

### 10. 管理后台框架

**依赖项：**
- Supabase Auth（登录认证）
- 品牌识别中间件 ⭐
- admin_users 表

**被依赖方：**
- 所有管理后台页面

**依赖关系图：**
```
用户登录 → Supabase Auth → 验证权限 → 加载后台布局
                                        ↓
                                    品牌切换器
                                        ↓
                                    各功能模块
```

---

## 开发顺序建议

基于依赖关系，推荐的开发顺序：

### 阶段 1：基础设施（必须最先完成）
1. 数据库表结构
2. 环境变量配置
3. Supabase 客户端封装
4. 响应工具函数

### 阶段 2：核心中间件（多品牌基础）
1. **品牌识别中间件** ⭐
2. 品牌管理 CRUD
3. KV 缓存集成

### 阶段 3：基础数据模块
1. 分类管理
2. 产品管理
3. 客户管理

### 阶段 4：核心业务功能
1. 购物车
2. 订单系统
3. Stripe 支付集成
4. 邮件通知

### 阶段 5：AI 功能
1. 知识库管理
2. AI 客服
3. 内容生成

### 阶段 6：管理后台
1. 后台框架和认证
2. 产品管理页面
3. 订单管理页面
4. 系统设置页面

### 阶段 7：高级功能
1. 评价系统
2. 作者管理
3. 优惠券系统
4. 数据分析

### 阶段 8：优化和扩展
1. SEO 工具
2. 性能优化
3. 安全加固

---

## 关键依赖说明

### ⭐ 品牌识别中间件

**为什么是核心依赖？**
- 多品牌架构的基础
- 所有 API 都需要 `brand_id` 来隔离数据
- 必须在任何业务功能之前实现

**影响范围：**
- 100% 的后端 API
- 所有数据库查询
- KV 缓存策略

### 🔗 产品管理

**为什么重要？**
- 电商系统的核心数据
- 被多个模块依赖（订单、购物车、知识库、评价）
- 数据质量直接影响用户体验

**影响范围：**
- 订单系统
- AI 客服
- 内容生成
- 评价系统

### 💳 订单系统

**为什么复杂？**
- 依赖多个模块（产品、客户、支付、邮件、优惠券）
- 涉及外部服务（Stripe）
- 需要处理异步回调（Webhook）
- 状态机管理复杂

**影响范围：**
- 评价系统
- 数据分析
- 邮件营销

---

## 循环依赖处理

### 产品 ↔ 知识库

**问题：**
- 产品数据需要同步到知识库
- 知识库用于 AI 客服回答产品问题

**解决方案：**
- 知识库作为独立模块
- 产品更新时触发知识库同步
- 单向依赖：产品 → 知识库

### 订单 ↔ 评价

**问题：**
- 订单完成后邀请评价
- 评价需要验证订单

**解决方案：**
- 评价系统依赖订单系统
- 订单系统通过邮件触发评价（松耦合）
- 单向依赖：评价 → 订单

---

## 模块独立性评估

### 高独立性（可独立开发/测试）
- 分类管理
- 作者管理
- 邮件模板管理
- 内容库管理

### 中独立性（需要少量依赖）
- 产品管理（依赖分类）
- 知识库管理（依赖 DeepSeek）
- 数据分析（依赖订单数据）

### 低独立性（强依赖其他模块）
- 订单系统（依赖产品、客户、支付、邮件）
- AI 客服（依赖知识库、设置、DeepSeek）
- 评价系统（依赖产品、订单）

---

## 外部服务依赖

### Stripe（支付）
**依赖它的模块：**
- 订单创建
- 订单状态更新（Webhook）
- 退款处理

**失败影响：**
- 无法创建支付
- 无法处理支付回调
- 订单状态不更新

### DeepSeek（AI）
**依赖它的模块：**
- AI 客服
- 内容生成
- 知识库 Embedding

**失败影响：**
- AI 客服无法回复
- 无法生成内容
- 无法添加知识库

### Resend（邮件）
**依赖它的模块：**
- 订单确认邮件
- 发货通知邮件
- 评价邀请邮件

**失败影响：**
- 用户收不到通知
- 不影响核心业务流程

---

## 数据库表依赖关系

```
brands（品牌）
  ↓
  ├─→ products（产品）
  │     ↓
  │     ├─→ orders（订单）
  │     │     ↓
  │     │     └─→ reviews（评价）
  │     │
  │     └─→ knowledge_base（知识库）
  │
  ├─→ categories（分类）
  │     ↓
  │     └─→ products
  │
  ├─→ customers（客户）
  │     ↓
  │     └─→ orders
  │
  ├─→ settings（设置）
  │
  ├─→ coupons（优惠券）
  │     ↓
  │     └─→ orders
  │
  ├─→ authors（作者）
  │
  ├─→ conversations（对话）
  │
  └─→ content_library（内容库）
```

---

## 更新日志

- 2025-12-25：初始版本