# 第3阶段：后端 API

本阶段完成所有后端API开发，包括多品牌识别、产品管理、订单支付和AI客服。

## 模块概述

- **3.1 域名品牌识别** - 多品牌域名识别中间件
- **3.2 基础 API** - 产品、分类、内容API
- **3.3 订单和支付** - 订单创建、Stripe支付、邮件通知
- **3.4 AI 客服** - 对话系统、知识库、RAG检索

## 功能列表

| 序号 | 功能文档 | 状态 | 说明 |
|------|---------|------|------|
| 3.1 | [域名品牌识别](./3.1-域名品牌识别.md) | ✅ 已完成 | 多品牌中间件、KV缓存 |
| 3.2 | [基础API](./3.2-基础API.md) | ✅ 已完成 | 产品、分类、内容API |
| 3.3 | [订单和支付](./3.3-订单和支付.md) | ✅ 已完成 | Stripe集成、Webhook |
| 3.4 | [AI客服](./3.4-AI客服.md) | ⏳ 待开发 | DeepSeek、RAG、流式响应 |
| 3.4+ | [AI客服系统实现指南](./3.4-AI客服系统实现指南.md) | ⏳ 待开发 | AI客服详细实现方案 |

## 技术栈

- **框架**: Hono (Cloudflare Workers)
- **数据库**: Supabase (PostgreSQL)
- **支付**: Stripe
- **AI**: DeepSeek API
- **向量检索**: pgvector
- **邮件**: Resend

## API规范

### 请求格式

**Headers**:
```
Content-Type: application/json
x-brand-id: <brand_id> (自动注入)
```

**Body**:
```json
{
  "data": {},
  "metadata": {}
}
```

### 响应格式

**成功响应**:
```json
{
  "success": true,
  "data": {},
  "message": "操作成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述"
  }
}
```

### 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

## 性能优化

### 缓存策略
- 品牌配置：KV缓存（1小时）
- 分类树：KV缓存（1小时）
- 产品列表：CDN缓存（5分钟）

### 数据库优化
- 使用索引优化查询
- 批量操作减少往返
- 连接池管理

### API限流
- 按IP限流
- 按用户限流
- 防止滥用

## 相关文档

- [Worker代码](../../worker/src/)
- [API路由](../../worker/src/routes/)
- [中间件](../../worker/src/middleware/)