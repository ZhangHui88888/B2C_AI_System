# 3.1 域名品牌识别

## 功能概述

实现多品牌域名识别中间件，支持一套代码服务多个品牌站点。

## 核心功能

### 品牌识别中间件 ([`brand.ts`](../../worker/src/middleware/brand.ts))

**工作流程**:
```
请求 → 获取Host → 查询品牌 → 注入brand_id → 后续处理
```

**实现逻辑**:
```typescript
export async function brandMiddleware(c: Context, next: Next) {
  // 1. 获取请求域名
  const host = new URL(c.req.url).hostname;
  
  // 2. 尝试从KV缓存获取
  const cacheKey = `brand:domain:${host}`;
  let brandId = await c.env.KV?.get(cacheKey);
  
  if (!brandId) {
    // 3. 查询数据库
    const { data } = await supabase
      .from('brands')
      .select('id')
      .eq('domain', host)
      .single();
    
    if (data) {
      brandId = data.id;
      //