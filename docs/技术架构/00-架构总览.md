# 技术架构总览（可供 AI 读取）

> 目的：把“系统怎么跑”“域名/环境变量怎么配”“前后端如何连接”写成单一真相（Single Source of Truth）。

## 1. 组件与职责边界

- **Cloudflare Pages（前端）**
  - 提供静态资源与页面路由（Astro）。
  - 包含后台 UI：`/admin/*`。
  - 不应直接读写 Supabase 业务表（后台也应通过 Worker Admin API）。

- **Cloudflare Worker（后端 API）**
  - 统一承载 `/api/*`。
  - 对外提供：
    - 公共 API：`/api/products`、`/api/orders`、`/api/chat`、...
    - 后台 API：`/api/admin/*`（必须 JWT 鉴权 + 多租户授权）。

- **Supabase（Auth + Postgres）**
  - Auth：前端登录（email/password），前端拿到 JWT。
  - Postgres：所有业务数据。
  - 后端 Worker 使用 Service Role Key 访问 DB。

## 2. 请求链路（关键）

### 2.1 生产环境推荐：Pages 反向代理（反代）到 Worker

- 浏览器访问：`https://<pages-domain>/api/...`
- Pages 把 `/api/*` 转发到 Worker：`https://<worker-domain>/api/...`
- 好处：
  - 前端同域访问 `/api/*`（跨域问题更少）
  - Worker 域名可以后续替换为自定义 `api.<domain>`

配置入口：`frontend/_redirects`

### 2.2 本地开发推荐：前端直连 Worker

- 前端 dev server：`http://localhost:4321`
- Worker dev server：`http://localhost:8787`

如果你不想依赖前端 dev server 的代理/反代，可在前端 `.env` 设置：

- `PUBLIC_API_URL=http://localhost:8787`

前端会把同域的 `/api/admin/*` 请求自动改写到 `PUBLIC_API_URL` 指向的 Worker。

## 3. 域名与 URL 对照表（示例）

> 这里的值因项目而异，你只需要维持“Pages 是 UI、Worker 是 API”这个关系。

- **Pages（线上后台入口）**
  - `https://<pages-project>.pages.dev/admin`

- **Worker（线上 API）**
  - `https://<worker-name>.<account>.workers.dev`

## 4. 环境变量对照表（前端）

前端（Astro）使用：`frontend/.env`（本地）或 Cloudflare Pages 环境变量（线上）

- `PUBLIC_SUPABASE_URL`
  - 用途：前端创建 Supabase client，登录/获取 session token
- `PUBLIC_SUPABASE_ANON_KEY`
  - 用途：同上
- `PUBLIC_API_URL`（可选）
  - 用途：本地/特殊场景直连 Worker
  - 生产环境如果使用 `_redirects` 反代，可留空

## 5. 环境变量对照表（Worker）

Worker 使用：Cloudflare Worker Settings → Variables / Secrets

- `SUPABASE_URL`（secret/plaintext）
- `SUPABASE_SERVICE_KEY`（secret）
- `OWNER_EMAIL`（plaintext）
  - 用途：识别平台 Owner（跨品牌管理权限）

## 6. 最小验证清单（上线/联调必做）

- **反代是否生效**
  - 打开：`https://<pages-domain>/api/health`
  - 预期：返回 JSON（来自 Worker），不是 404 HTML。

- **后台鉴权是否生效**
  - 在后台页面打开 DevTools → Network
  - 观察：`GET /api/admin/brands/available`
  - 预期：
    - 已登录：200 + JSON
    - 未登录：401

- **Owner 是否生效**
  - Worker 端配置 `OWNER_EMAIL` 后
  - 用 Owner 邮箱登录后台
  - 预期：BrandSwitcher 允许显示 All Brands（并且跨 brand 管理接口仍需 Owner）
