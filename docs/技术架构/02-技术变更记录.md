# 技术变更记录（Changelog）

> 目的：让后续 AI/人可以快速知道“改了什么、为什么、如何验证、如何回滚”。

## 2025-12-31（Admin Security / 多租户后台安全）

### 改动目标

- 后台所有数据访问改为走 Worker `/api/admin/*`。
- `/api/admin/*` 增加 Supabase JWT 鉴权 + brand 授权。
- BrandSwitcher 不再直连 Supabase brands 表，且仅 Owner 能看到 All Brands。
- 生产/本地解决：前端如何正确访问 Worker API（反代 or 直连）。

### 修改文件清单

- `worker/src/routes/admin-brands.ts`
  - 新增 `GET /api/admin/brands/available`（返回当前用户可管理品牌 + isOwner）。

- `worker/src/middleware/admin-auth.ts`
  - 后台 JWT 校验 + Owner 识别逻辑（依赖 `OWNER_EMAIL`）。

- `frontend/src/layouts/AdminLayout.astro`
  - 封装 fetch：对 `/api/admin/*` 自动注入 `Authorization` + `x-brand-id`。
  - 支持可选 `PUBLIC_API_URL`：把同域 `/api/admin/*` 改写到指定 Worker base（本地更稳）。

- `frontend/src/components/admin/BrandSwitcher.astro`
  - 改为调用 `/api/admin/brands/available` 获取品牌列表。
  - 仅当 `isOwner=true` 显示 All Brands。

- `frontend/_redirects`
  - 配置 Pages 将 `/api/*` 反代到 Worker（生产同域访问）。

### 为什么需要这些改动

- 防止 `/api/admin/*` 未鉴权/越权。
- 防止前端直连 Supabase 导致权限绕过。
- 解决本地开发时 `/api/*` 打到前端端口导致 404 的问题。

### 如何验证（最短路径）

- **生产反代**：
  - 访问：`https://<pages-domain>/api/health`
  - 预期：返回 JSON

- **后台品牌列表**：
  - 登录后台
  - Network 查看：`GET /api/admin/brands/available`
  - 预期：200 + JSON（含 brands 数组）

- **Owner 验证**：
  - Worker 配置 `OWNER_EMAIL`
  - 用该邮箱登录
  - BrandSwitcher 应显示 All Brands

### 如何回滚

- 前端反代回滚：删除 `frontend/_redirects` 中 `/api/*` 规则并重新部署 Pages。
- 本地直连回滚：移除 `.env` 中 `PUBLIC_API_URL`。
- 安全相关回滚不建议：会重新引入后台未鉴权/越权风险。
