# 系统流程说明图

> 完整的系统架构、API 请求流程、数据处理逻辑和数据库表映射

---

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户层                                       │
│  brand-a.com    brand-b.com    brand-c.com    /admin/*              │
└─────────────────────────────┬───────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Cloudflare Edge                                   │
│  ┌─────────────────────┐    ┌─────────────────────┐                 │
│  │  Pages (Astro SSR)  │    │  Workers (API)      │                 │
│  │  - 静态页面渲染      │    │  - 中间件: CORS     │                 │
│  │  - _redirects       │───▶│  - 中间件: Brand    │                 │
│  │    /api/* → Worker  │    │  - 中间件: Auth     │                 │
│  └─────────────────────┘    │  - 路由分发          │                 │
│                             └──────────┬──────────┘                 │
│  ┌─────────────────────┐               │                            │
│  │  KV 缓存             │◀──────────────┘                            │
│  │  brand:domain:host  │                                            │
│  └─────────────────────┘                                            │
└─────────────────────────────┬───────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Supabase PostgreSQL                               │
│  RLS: service_role only（仅 Worker 可访问）                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐               │
│  │ brands   │ │ products │ │ orders   │ │ customers│               │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘               │
└─────────────────────────────┬───────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    外部服务                                          │
│  Stripe(支付)  DeepSeek(AI)  Resend(邮件)  Pixel APIs(追踪)         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 请求处理流程

### 2.1 Public API 流程

```
请求: GET /api/products
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 1. CORS 中间件                                                       │
│    - OPTIONS 预检直接返回                                            │
│    - 设置 Access-Control-Allow-Headers                              │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 2. 品牌识别中间件                                                    │
│    Host: brand-a.com                                                │
│    ↓                                                                │
│    查 KV: brand:domain:brand-a.com → brand_id                       │
│    ↓ (未命中)                                                        │
│    查 DB: SELECT id FROM brands WHERE domain = 'brand-a.com'        │
│    ↓                                                                │
│    写 KV + 注入 x-brand-id header                                   │
│                                                                     │
│    涉及表: brands, brand_domains                                     │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 3. 路由分发 → routes/products.ts                                    │
│                                                                     │
│    const brandId = request.headers.get('x-brand-id');               │
│    SELECT * FROM products WHERE brand_id = brandId AND is_active;   │
│                                                                     │
│    涉及表: products                                                  │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 4. 返回 JSON                                                        │
│    { "success": true, "data": [...] }                               │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Admin API 流程

```
请求: GET /api/admin/products
      Headers: Authorization: Bearer <JWT>, x-brand-id: <uuid>
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 1. CORS 中间件 (同上)                                                │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 2. Admin 认证中间件                                                  │
│    ┌───────────────────────────────────────────────────────────┐    │
│    │ 1. 提取 JWT token                                         │    │
│    │ 2. supabase.auth.getUser(token) → user                   │    │
│    │ 3. 检查 isOwner: user.email === env.OWNER_EMAIL          │    │
│    │ 4. 查询 admin_users 表获取 role                           │    │
│    └───────────────────────────────────────────────────────────┘    │
│    涉及表: admin_users                                               │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 3. 品牌权限验证                                                      │
│    ┌───────────────────────────────────────────────────────────┐    │
│    │ Owner / super_admin → 通过                                │    │
│    │ 其他 → 查 brand_user_assignments 验证权限                  │    │
│    └───────────────────────────────────────────────────────────┘    │
│    涉及表: brand_user_assignments                                    │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 4. 业务处理                                                          │
│    SELECT * FROM products WHERE brand_id = ?;                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心业务流程

### 3.1 下单支付流程

```
用户 → 加购物车(localStorage) → 结算页面
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ POST /api/orders                                                    │
│                                                                     │
│ 入参:                                                               │
│ {                                                                   │
│   "items": [{"product_id": "uuid", "quantity": 2}],                │
│   "customer": {"email": "...", "name": "...", "phone": "..."},     │
│   "shipping_address": {"line1": "...", "city": "...", ...},        │
│   "coupon_code": "SAVE10"                                          │
│ }                                                                   │
│                                                                     │
│ 处理:                                                               │
│ 1. 验证产品存在 (products)                                          │
│ 2. 服务端计算金额 (不信任前端)                                       │
│ 3. 验证优惠券 (coupons)                                             │
│ 4. 创建客户 (customers)                                             │
│ 5. 创建订单 (orders, order_items)                                   │
│ 6. 创建 Stripe PaymentIntent                                       │
│                                                                     │
│ 出参:                                                               │
│ { "order": {...}, "client_secret": "pi_xxx_secret" }               │
│                                                                     │
│ 涉及表: products, customers, orders, order_items, coupons           │
└────────────────────────────────┬────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Stripe Webhook: POST /api/webhooks/stripe                          │
│                                                                     │
│ 入参: { "type": "payment_intent.succeeded", "data": {...} }        │
│                                                                     │
│ 处理:                                                               │
│ 1. 验证 Stripe 签名                                                 │
│ 2. 幂等检查 (stripe_events)                                         │
│ 3. 更新订单状态 (orders → paid)                                     │
│ 4. 发送确认邮件 (Resend)                                            │
│ 5. 发送转化事件 (pixel_events)                                      │
│                                                                     │
│ 涉及表: orders, stripe_events, pixel_events                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 AI 客服流程

```
用户点击聊天 → 创建会话 → 发送消息 → 获取 AI 回复
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ POST /api/chat/messages                                            │
│                                                                     │
│ 入参:                                                               │
│ { "conversation_id": "uuid", "message": "这款自行车有货吗？" }      │
│                                                                     │
│ 处理:                                                               │
│ 1. 保存用户消息 (conversations)                                     │
│ 2. 加载品牌 AI 设置 (settings)                                      │
│ 3. RAG 检索知识库 (knowledge_base + pgvector)                       │
│ 4. 构建 prompt + 调用 DeepSeek API                                 │
│ 5. 保存 AI 回复 (conversations)                                     │
│                                                                     │
│ 出参:                                                               │
│ { "reply": "是的，这款自行车有货，现在下单预计3天送达" }             │
│                                                                     │
│ 涉及表: conversations, settings, knowledge_base, products           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. API 入参出参汇总

详见下一部分: [API 详细说明](#5-api-详细说明)

---

## 5. API 详细说明

### 5.1 Public APIs

| 端点 | 方法 | 入参 | 出参 | 涉及表 |
|------|------|------|------|--------|
| `/api/products` | GET | `?category=slug&limit=20` | `{data: Product[]}` | products |
| `/api/products/:slug` | GET | - | `{data: Product}` | products |
| `/api/categories` | GET | - | `{data: Category[]}` | categories |
| `/api/orders` | POST | items[], customer, address | order, client_secret | orders, order_items, customers |
| `/api/chat/messages` | POST | conversation_id, message | reply | conversations, knowledge_base |
| `/api/coupons/validate` | POST | code, subtotal | discount, final_total | coupons |
| `/api/reviews` | GET | product_id | reviews[] | reviews |
| `/api/site-config` | GET | - | brand settings | brands, settings |

### 5.2 Admin APIs

| 端点 | 方法 | 入参 | 出参 | 涉及表 | 权限 |
|------|------|------|------|--------|------|
| `/api/admin/products` | GET | - | products[] | products | brand_manage |
| `/api/admin/products` | POST | name, price, ... | product | products | brand_manage |
| `/api/admin/orders` | GET | ?status=paid | orders[] | orders | brand_manage |
| `/api/admin/orders/:id/status` | PUT | status | order | orders | brand_admin |
| `/api/admin/brands` | GET | - | brands[] | brands | Owner only |
| `/api/admin/brands/:id/users` | GET | - | users[] | brand_user_assignments | brand_admin |
| `/api/admin/settings` | GET/PUT | settings | settings | settings | brand_admin |
| `/api/admin/coupons` | CRUD | code, discount, ... | coupon | coupons | brand_manage |

---

## 6. 数据库表映射

### 6.1 核心业务表

| 表名 | 说明 | 关键字段 | 关联表 |
|------|------|----------|--------|
| `brands` | 品牌 | id, name, domain, slug | 所有表通过 brand_id 关联 |
| `products` | 产品 | id, brand_id, name, price, slug | categories |
| `categories` | 分类 | id, brand_id, name, parent_id | products |
| `orders` | 订单 | id, brand_id, customer_id, status, total | order_items, customers |
| `order_items` | 订单项 | order_id, product_id, quantity, price | orders, products |
| `customers` | 客户 | id, brand_id, email, name | orders |
| `coupons` | 优惠券 | id, brand_id, code, discount_type, value | coupon_usages |

### 6.2 AI/内容表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `conversations` | 对话 | id, brand_id, messages (JSONB) |
| `knowledge_base` | 知识库 | id, brand_id, content, embedding (vector) |
| `content_library` | 内容库 | id, brand_id, type, content, status |
| `authors` | 作者 | id, brand_id, name, bio |

### 6.3 管理/权限表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `admin_users` | 管理员 | user_id, role, brand_id |
| `brand_user_assignments` | 品牌权限 | user_id, brand_id, role |
| `settings` | 品牌设置 | brand_id, settings (JSONB) |

### 6.4 营销/分析表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `utm_tracking` | UTM 追踪 | brand_id, source, medium, campaign |
| `pixel_events` | Pixel 事件 | brand_id, event_name, value |
| `abandoned_carts` | 弃购 | brand_id, email, cart_data |
| `email_sequences` | 邮件序列 | brand_id, type, step, template |

---

## 7. 权限模型

```
┌─────────────────────────────────────────────────────────────────────┐
│                         权限层级                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Owner (OWNER_EMAIL)                                               │
│     │                                                               │
│     ├── 所有品牌完全控制                                             │
│     ├── 创建/删除品牌                                                │
│     └── 管理 super_admin                                            │
│                                                                     │
│   super_admin                                                       │
│     │                                                               │
│     ├── 所有品牌管理权限                                             │
│     └── 不能创建/删除品牌                                            │
│                                                                     │
│   brand_admin                                                       │
│     │                                                               │
│     ├── 单品牌完全控制                                               │
│     ├── 管理品牌设置                                                 │
│     └── 管理品牌用户                                                 │
│                                                                     │
│   brand_manage                                                      │
│     │                                                               │
│     ├── 单品牌日常运营                                               │
│     ├── 产品/订单/内容管理                                           │
│     └── 不能修改品牌设置                                             │
│                                                                     │
│   brand_viewer                                                      │
│     │                                                               │
│     └── 单品牌只读                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 8. 完整 API 入参出参

### 8.1 订单 API

#### POST /api/orders (创建订单)

```typescript
// 入参
{
  items: [
    { product_id: string, quantity: number }
  ],
  customer: {
    email: string,
    name: string,
    phone?: string
  },
  shipping_address: {
    line1: string,
    line2?: string,
    city: string,
    state?: string,
    postal_code: string,
    country: string  // ISO 3166-1 alpha-2
  },
  coupon_code?: string
}

// 出参
{
  success: true,
  order: {
    id: string,
    order_number: string,      // "ORD-20260107-XXXX"
    status: "pending",
    subtotal: number,
    discount: number,
    shipping: number,
    total: number,
    currency: string
  },
  client_secret: string        // Stripe PaymentIntent
}

// 涉及表: products, customers, orders, order_items, coupons
```

#### PUT /api/admin/orders/:id/status (更新订单状态)

```typescript
// 入参
{
  status: "processing" | "shipped" | "delivered" | "cancelled" | "refunded",
  tracking_number?: string,    // 发货时必填
  tracking_url?: string,
  notes?: string
}

// 出参
{
  success: true,
  order: { id, status, updated_at }
}

// 涉及表: orders
// 触发: 状态变更邮件通知
```

### 8.2 产品 API

#### GET /api/products

```typescript
// 入参 (Query)
{
  category?: string,    // 分类 slug
  limit?: number,       // 默认 20
  offset?: number,
  sort?: "price_asc" | "price_desc" | "newest"
}

// 出参
{
  data: [
    {
      id: string,
      name: string,
      slug: string,
      price: number,
      compare_at_price?: number,
      images: string[],
      category: { id, name, slug }
    }
  ],
  total: number,
  limit: number,
  offset: number
}

// 涉及表: products, categories
```

#### POST /api/admin/products

```typescript
// 入参
{
  name: string,
  slug: string,
  description: string,
  short_description?: string,
  price: number,
  compare_at_price?: number,
  sku?: string,
  inventory_quantity: number,
  category_id?: string,
  images: string[],
  is_active: boolean,
  meta_title?: string,
  meta_description?: string,
  specifications?: Record<string, string>
}

// 出参
{
  success: true,
  product: { id, name, slug, ... }
}

// 涉及表: products
```

### 8.3 AI 客服 API

#### POST /api/chat/messages

```typescript
// 入参
{
  conversation_id: string,
  message: string,
  context?: {
    page_url: string,
    product_id?: string,
    order_id?: string
  }
}

// 出参
{
  reply: string,
  sources?: [              // RAG 引用来源
    { title: string, snippet: string }
  ],
  suggested_actions?: [    // 建议操作
    { type: "view_product", product_id: string },
    { type: "track_order", order_id: string }
  ]
}

// 涉及表: conversations, knowledge_base, products, orders
// 外部服务: DeepSeek API
```

### 8.4 优惠券 API

#### POST /api/coupons/validate

```typescript
// 入参
{
  code: string,
  subtotal: number,
  product_ids?: string[]   // 验证商品限制
}

// 出参 (成功)
{
  valid: true,
  coupon: {
    code: string,
    discount_type: "percentage" | "fixed",
    discount_value: number,
    minimum_order?: number
  },
  discount_amount: number,
  final_total: number
}

// 出参 (失败)
{
  valid: false,
  error: "EXPIRED" | "MINIMUM_NOT_MET" | "USAGE_LIMIT" | "NOT_FOUND"
}

// 涉及表: coupons, coupon_usages
```

### 8.5 营销追踪 API

#### POST /api/admin/marketing/tracking-pixels/config

```typescript
// 入参
{
  facebook_pixel_id?: string,
  facebook_access_token?: string,
  google_ads_id?: string,
  google_conversion_id?: string,
  tiktok_pixel_id?: string,
  tiktok_access_token?: string,
  pinterest_tag_id?: string,
  pinterest_access_token?: string
}

// 出参
{
  success: true,
  config: { ... }
}

// 涉及表: tracking_pixels_config
```

#### POST /api/conversions/facebook (服务端转化)

```typescript
// 入参
{
  event_name: "Purchase" | "AddToCart" | "InitiateCheckout" | "Lead",
  event_time: number,      // Unix timestamp
  user_data: {
    em?: string,           // hashed email
    ph?: string,           // hashed phone
    client_ip_address?: string,
    client_user_agent?: string,
    fbc?: string,          // Facebook click ID
    fbp?: string           // Facebook browser ID
  },
  custom_data: {
    currency: string,
    value: number,
    content_ids?: string[],
    content_type?: string
  }
}

// 出参
{
  success: true,
  events_received: 1
}

// 涉及表: pixel_events
// 外部服务: Facebook Conversions API
```

---

## 9. 数据流图

### 9.1 用户购物流程数据流

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  浏览器   │    │  Worker  │    │ Supabase │    │ Stripe   │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │
     │ GET /products │               │               │
     │──────────────▶│               │               │
     │               │ SELECT products               │
     │               │──────────────▶│               │
     │               │◀──────────────│               │
     │◀──────────────│               │               │
     │               │               │               │
     │ POST /orders  │               │               │
     │──────────────▶│               │               │
     │               │ INSERT customer               │
     │               │──────────────▶│               │
     │               │ INSERT order  │               │
     │               │──────────────▶│               │
     │               │               │               │
     │               │ Create PaymentIntent          │
     │               │──────────────────────────────▶│
     │               │◀──────────────────────────────│
     │◀──────────────│ client_secret                 │
     │               │               │               │
     │ confirmPayment│               │               │
     │──────────────────────────────────────────────▶│
     │               │               │               │
     │               │ Webhook       │               │
     │               │◀──────────────────────────────│
     │               │ UPDATE order  │               │
     │               │──────────────▶│               │
     │               │               │               │
```

### 9.2 Admin 数据管理流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Admin   │    │  Worker  │    │ Supabase │    │ Supabase │
│  前端     │    │  API     │    │   Auth   │    │    DB    │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │
     │ Authorization │               │               │
     │ Bearer <JWT>  │               │               │
     │──────────────▶│               │               │
     │               │ getUser(JWT)  │               │
     │               │──────────────▶│               │
     │               │◀──────────────│ user          │
     │               │               │               │
     │               │ SELECT admin_users            │
     │               │──────────────────────────────▶│
     │               │◀──────────────────────────────│
     │               │               │               │
     │               │ SELECT brand_user_assignments │
     │               │──────────────────────────────▶│
     │               │◀──────────────────────────────│
     │               │               │               │
     │               │ 业务查询 (带 brand_id)         │
     │               │──────────────────────────────▶│
     │               │◀──────────────────────────────│
     │◀──────────────│               │               │
     │               │               │               │
```

---

*文档更新: 2026-01-07*
