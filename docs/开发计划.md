# DTC 独立站系统 - 开发计划（结构化版本）

> 本文档提供结构化的开发提示词和性能优化建议
> 每个步骤包含：目标、输入、输出、注意事项、性能优化

---

## 📊 开发进度总览

### 进度图例

| 状态 | 说明 |
|------|------|
| ✅ | 已完成 |
| 🚧 | 进行中 |
| ⏳ | 待开发 |
| 🔄 | 需优化 |

---

## 完整功能进度追踪表

### 第1阶段：项目初始化

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **1.1 基础架构** | Astro 前端项目结构 | ✅ | 已完成 |
| | Cloudflare Worker 后端结构 | ✅ | 已完成 |
| | TailwindCSS 配置 | ✅ | 已完成 |
| | TypeScript 配置 | ✅ | 已完成 |
| | Wrangler 配置 | ✅ | 已完成 |
| | 环境变量模板 | ✅ | 已完成 |
| | 基础布局组件 | ✅ | 已完成 |
| | API 客户端封装 | ✅ | 已完成 |
| | 购物车状态管理 | ✅ | 已完成 |
| | Supabase 客户端 | ✅ | 已完成 |
| | 数据库类型定义 | ✅ | 已完成 |
| **1.2 数据库模型** | brands 表 | ✅ | 已完成 |
| | products 表 | ✅ | 已完成 |
| | categories 表 | ✅ | 已完成 |
| | orders 表 | ✅ | 已完成 |
| | customers 表 | ✅ | 已完成 |
| | conversations 表 | ✅ | 已完成 |
| | knowledge_base 表 | ✅ | 已完成 |
| | settings 表 | ✅ | 已完成 |
| | content_library 表 | ✅ | 已完成 |
| | reviews 表 | ✅ | 已完成 |
| | authors 表 | ✅ | 已完成 |
| | coupons 表 | ✅ | 已完成 |
| | admin_users 表 | ✅ | 已完成 |
| | RLS 策略 | ✅ | 已完成 |
| | pgvector 扩展 | ✅ | 已完成 |

### 第2阶段：前端页面 + 基础 SEO/GEO

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **2.1 基础 SEO** | 动态 title 标签 | ✅ | 已完成 |
| | meta description | ✅ | 已完成 |
| | Open Graph 标签 | ✅ | 已完成 |
| | Twitter Card | ✅ | 已完成 |
| | canonical 标签 | ✅ | 已完成 |
| | URL 参数索引策略 | ✅ | 已完成 |
| | Product Schema | ✅ | 已完成 |
| | BreadcrumbList Schema | ✅ | 已完成 |
| | Organization Schema | ✅ | 已完成 |
| | FAQ Schema | ✅ | 已完成 |
| | Article Schema | ✅ | 已完成 |
| | Person Schema | ✅ | 已完成 |
| | sitemap.xml 动态生成 | ✅ | 已完成 |
| | robots.txt | ✅ | 已完成 |
| **2.1 基础 GEO** | AI 爬虫 robots.txt | ✅ | 已完成 |
| | 发布日期组件 | ✅ | 已完成 |
| | 作者信息组件 | ✅ | 已完成 |
| | 摘要/TL;DR 区域 | ✅ | 已完成 |
| | 问答格式组件 | ✅ | 已完成 |
| | 定义式段落 | ✅ | 已完成 |
| **2.2 首页和布局** | 响应式 Header | ✅ | 已完成 |
| | 移动端汉堡菜单 | ✅ | 已完成 |
| | Footer | ✅ | 已完成 |
| | Hero 区域 | ✅ | 已完成 |
| | 热销产品轮播 | ✅ | 已完成 |
| | 分类展示网格 | ✅ | 已完成 |
| | 社会证明区域 | ✅ | 已完成 |
| | Email 订阅表单 | ✅ | 已完成 |
| | ProductCard 组件 | ✅ | 已完成 |
| | CategoryCard 组件 | ✅ | 已完成 |
| **2.3 产品页面** | 产品列表页 | ✅ | 已完成 |
| | 产品详情页 | ✅ | 已完成 |
| | 分类页面 | ✅ | 已完成 |
| | 筛选栏 | ✅ | 已完成 |
| | 分页组件 | ✅ | 已完成 |
| | 图片画廊 | ✅ | 已完成 |
| | 相关产品推荐 | ✅ | 已完成 |
| **2.4 购物车和结算** | 迷你购物车 | ✅ | 已完成 |
| | 购物车页面 | ✅ | 已完成 |
| | 优惠码输入 | ✅ | 已完成 |
| | 结算页面 | ✅ | 已完成 |
| | Stripe 支付集成 | ✅ | 已完成 |
| | 订单确认页 | ✅ | 已完成 |
| | 订单追踪页 | ✅ | 已完成 |
| **2.5 静态页面** | 关于我们 | ✅ | 已完成 |
| | 联系我们 | ✅ | 已完成 |
| | 隐私政策 | ✅ | 已完成 |
| | 服务条款 | ✅ | 已完成 |
| | 退换货政策 | ✅ | 已完成 |
| | 发货说明 | ✅ | 已完成 |
| | FAQ 页面 | ✅ | 已完成 |
| | 博客列表 | ✅ | 已完成 |
| | 博客详情 | ✅ | 已完成 |
| | 作者页面 | ✅ | 已完成 |
| **2.6 信任元素** | 安全支付徽章 | ✅ | 已完成 |
| | SSL 安全标识 | ✅ | 已完成 |
| | 社交媒体链接 | ✅ | 已完成 |
| | 媒体报道展示 | ✅ | 已完成 |
| | 产品认证标识 | ✅ | 已完成 |
| | 第三方评价入口 | ✅ | 已完成 |

### 第3阶段：后端 API

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **3.1 域名品牌识别** | 域名识别中间件 | ✅ | 已完成 |
| | 品牌信息缓存 | ✅ | 已完成（KV可选）|
| | 默认品牌回退 | ✅ | 已完成 |
| | 品牌上下文注入 | ✅ | 已完成 |
| **3.2 基础 API** | 产品列表 API | ✅ | 已完成 |
| | 产品详情 API | ✅ | 已完成 |
| | 分类列表 API | ✅ | 已完成 |
| | CORS 中间件 | ✅ | 已完成 |
| | 错误处理 | ✅ | 已完成 |
| **3.3 订单和支付** | 购物车验证 | ✅ | 已完成 |
| | 创建订单 | ✅ | 已完成 |
| | 订单详情 | ✅ | 已完成 |
| | Stripe Webhook | ✅ | 已完成 |
| | 库存扣减 | ✅ | 已完成 |
| | 邮件通知 | ✅ | 已完成 |
| **3.4 AI 客服** | 普通对话 API | ⏳ | 待开发 |
| | 流式响应 API | ⏳ | 待开发 |
| | 知识库 CRUD | ⏳ | 待开发 |
| | RAG 向量检索 | ⏳ | 待开发 |
| | 多语言支持 | ⏳ | 待开发 |
| | 人工转接 | ⏳ | 待开发 |
| | ChatWidget 组件 | ✅ | 已完成 |

### 第4阶段：管理后台

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **4.1 后台框架** | AdminLayout 布局 | ✅ | 已完成 |
| | 登录认证 | ✅ | 已完成 |
| | 仪表盘 | ✅ | 已完成 |
| | 品牌切换器 | ✅ | 已完成 |
| | 角色权限模型 | ✅ | 已完成（RLS） |
| **4.2 产品管理** | 产品列表 | ✅ | 已完成 |
| | 产品编辑 | ✅ | 已完成 |
| | 产品创建 | ✅ | 已完成 |
| | 批量操作 | ⏳ | 待开发 |
| | 分类管理 | ✅ | 已完成 |
| **4.3 订单管理** | 订单列表 | ✅ | 已完成 |
| | 订单详情 | ✅ | 已完成 |
| | 状态更新 | ✅ | 已完成 |
| | 物流信息填写 | ✅ | 已完成 |
| | 退款操作 | ✅ | 已完成 |
| **4.4 系统设置** | 店铺设置 | ✅ | 已完成 |
| | 支付设置 | ✅ | 已完成 |
| | 发货设置 | ✅ | 已完成 |
| | 邮件模板管理 | ✅ | 已完成 |
| **4.5 内容管理** | 作者管理 | ✅ | 已完成 |
| | 评价管理 | ✅ | 已完成 |
| | 评价审核 | ✅ | 已完成 |
| | 评价回复 | ✅ | 已完成 |
| | 信任元素管理 | ✅ | 已完成 |
| **4.6 优惠券管理** | 优惠券列表 | ✅ | 已完成 |
| | 创建/编辑优惠券 | ✅ | 已完成 |
| | 优惠券验证 | ✅ | 已完成 |
| **4.7 品牌管理** | 品牌列表 | ✅ | 已完成 |
| | 品牌 CRUD | ✅ | 已完成 |
| | 域名配置 | ✅ | 已完成 |

### 第5阶段：AI 内容工具

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **5.1 内容质量防护** | 人工审核流程 | ⏳ | 待开发 |
| | 原创度检测 | ⏳ | 待开发 |
| | AI 内容标识 | ⏳ | 待开发 |
| | 内容差异化引擎 | ⏳ | 待开发 |
| | 作者署名系统 | ⏳ | 待开发 |
| | 发布频率限制 | ⏳ | 待开发 |
| | 内容更新提醒 | ⏳ | 待开发 |
| **5.2 视频脚本生成** | 产品选择 | ✅ | 已完成 |
| | 视频类型选择 | ⏳ | 待开发 |
| | 脚本生成 | ⏳ | 待开发 |
| | 配乐推荐 | ⏳ | 待开发 |
| | Hashtag 推荐 | ⏳ | 待开发 |
| | 脚本库 | ⏳ | 待开发 |
| **5.3 文案生成** | 产品描述生成 | ⏳ | 待开发 |
| | 社交媒体文案 | ⏳ | 待开发 |
| | 邮件营销文案 | ⏳ | 待开发 |
| | 文案库 | ⏳ | 待开发 |
| | 语气风格调整 | ⏳ | 待开发 |

### 第6阶段：数据分析

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **6.1 数据看板** | 销售概览 | ✅ | 已完成 |
| | 销售趋势图 | ⏳ | 待开发 |
| | 产品排行榜 | ⏳ | 待开发 |
| | 客户分析 | ⏳ | 待开发 |
| | 转化漏斗 | ⏳ | 待开发 |

### 第7阶段：高级 SEO/GEO 工具（待开发）

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **7.1 页面级 SEO** | Title 标签编辑器 | ⏳ | 待开发 |
| | Description 编辑器 | ⏳ | 待开发 |
| | 关键词密度分析 | ⏳ | 待开发 |
| | 重复 Meta 检测 | ⏳ | 待开发 |
| | 批量 Meta 生成 | ⏳ | 待开发 |
| | Alt 文本检查 | ⏳ | 待开发 |
| | Alt 文本 AI 建议 | ⏳ | 待开发 |
| | 图片压缩 | ⏳ | 待开发 |
| | WebP 转换 | ⏳ | 待开发 |
| | 孤立页面检测 | ⏳ | 待开发 |
| | 内链密度分析 | ⏳ | 待开发 |
| | 相关内容推荐 | ⏳ | 待开发 |
| **7.2 技术 SEO** | Sitemap 管理界面 | ⏳ | 待开发 |
| | Sitemap 分片 | ⏳ | 待开发 |
| | Robots.txt 编辑器 | ⏳ | 待开发 |
| | 301 重定向管理 | ⏳ | 待开发 |
| | 404 页面监控 | ⏳ | 待开发 |
| | Core Web Vitals 监控 | ⏳ | 待开发 |
| **7.3 内容 SEO** | 关键词研究 | ⏳ | 待开发 |
| | 搜索意图分类 | ⏳ | 待开发 |
| | 内容评分系统 | ⏳ | 待开发 |
| | 可读性分析 | ⏳ | 待开发 |
| | E-E-A-T 评分 | ⏳ | 待开发 |
| **7.4 监控与报告** | 关键词排名监控 | ⏳ | 待开发 |
| | 索引状态检查 | ⏳ | 待开发 |
| | Search Console 集成 | ⏳ | 待开发 |
| | 自动化报告 | ⏳ | 待开发 |
| **7.5 GEO 优化** | AI 爬虫识别 | ⏳ | 待开发 |
| | 问答格式检测 | ⏳ | 待开发 |
| | 摘要生成 | ⏳ | 待开发 |
| | 品牌可见性优化 | ⏳ | 待开发 |
| | AI 引用追踪 | ⏳ | 待开发 |

### 第8阶段：多品牌管理（待开发）

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **8.1 品牌管理** | 品牌创建 | ⏳ | 待开发 |
| | 品牌编辑 | ⏳ | 待开发 |
| | 域名绑定配置 | ⏳ | 待开发 |
| | 品牌主题定制 | ⏳ | 待开发 |
| | 用户权限分配 | ⏳ | 待开发 |
| **8.2 协作管理** | 总后台 | ⏳ | 待开发 |
| | 品牌独立后台 | ⏳ | 待开发 |
| | 跨品牌数据看板 | ⏳ | 待开发 |
| | 知识库共享 | ⏳ | 待开发 |
| | 模板共享 | ⏳ | 待开发 |

### 第9阶段：流量与转化（待开发）

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **9.1 广告追踪** | Facebook Pixel | ⏳ | 待开发 |
| | Google Ads 转化 | ⏳ | 待开发 |
| | TikTok Pixel | ⏳ | 待开发 |
| | Pinterest Tag | ⏳ | 待开发 |
| | 服务端事件 | ⏳ | 待开发 |
| **9.2 UTM 追踪** | UTM 参数解析 | ⏳ | 待开发 |
| | 来源归因存储 | ⏳ | 待开发 |
| | 来源报表 | ⏳ | 待开发 |
| **9.3 邮件营销** | 订单确认邮件 | ✅ | 已完成 |
| | 发货通知邮件 | ✅ | 已完成 |
| | 弃购挽回 | ⏳ | 待开发 |
| | 欢迎邮件序列 | ⏳ | 待开发 |
| | 复购提醒 | ⏳ | 待开发 |
| | 退订管理 | ⏳ | 待开发 |
| **9.4 优惠券系统** | 优惠券创建 | ✅ | 已完成 |
| | 优惠码生成 | ✅ | 已完成 |
| | 优惠码验证 | ✅ | 已完成 |
| | 使用统计 | ✅ | 已完成 |
| **9.5 用户留存** | 积分系统 | ⏳ | 待开发 |
| | 会员等级 | ⏳ | 待开发 |
| | 推荐有礼 | ⏳ | 待开发 |

### 第10阶段：部署运维（待开发）

| 功能模块 | 子功能 | 状态 | 备注 |
|---------|--------|------|------|
| **10.1 部署配置** | Cloudflare Pages 部署 | ⏳ | 待开发 |
| | Cloudflare Workers 部署 | ⏳ | 待开发 |
| | 多域名绑定 | ⏳ | 待开发 |
| | GitHub Actions CI/CD | ⏳ | 待开发 |
| | 环境变量管理 | ⏳ | 待开发 |
| **10.2 监控维护** | 日志查看 | ⏳ | 待开发 |
| | 结构化日志 | ⏳ | 待开发 |
| | 性能监控 | ⏳ | 待开发 |
| | 备份策略 | ⏳ | 待开发 |
| | 安全检查 | ⏳ | 待开发 |
| | 告警配置 | ⏳ | 待开发 |

---

## 当前开发重点

### ✅ 已完成核心功能

**第1-4阶段核心功能已全部完成！**

系统现已具备完整的电商和管理功能：
- ✅ 完整的前端页面（产品浏览、购物车、结算）
- ✅ 完整的后端API（产品、订单、支付、优惠券）
- ✅ Stripe支付集成（含Webhook处理）
- ✅ 邮件通知系统
- ✅ 多品牌域名识别
- ✅ **完整的管理后台系统**
- ✅ SEO/GEO优化组件
- ✅ 订单全生命周期管理
- ✅ 评价审核和商家回复
- ✅ 多品牌管理和切换

### 🎯 下一步开发重点（按优先级）

1. **AI 客服系统** (3.4) - 高优先级
   - RAG 向量检索
   - 流式对话响应
   - 知识库管理
   - 多语言支持

2. **AI 内容工具** (5.1-5.3)
   - 内容质量防护
   - 视频脚本生成
   - 产品文案生成

3. **数据分析增强** (6.1)
   - 销售趋势图
   - 产品排行榜
   - 客户分析
   - 转化漏斗

4. **高级 SEO/GEO 工具** (7.1-7.5)
   - 页面级 SEO 优化
   - 技术 SEO 工具
   - 内容 SEO 分析
   - GEO 优化工具

---


## 提示词结构说明

每个开发步骤的提示词遵循以下结构：

```
**目标：** 简短描述要实现的功能
**输入：** 需要的前置条件和数据
**输出：** 期望的交付物
**注意事项：** 特殊要求和注意点
**性能优化：** 性能相关的最佳实践
```

---

## 第2阶段：前端页面 + 基础 SEO/GEO

### 步骤 2.1：基础 SEO/GEO 补充

**目标：** 实现基础 SEO 和 GEO 优化组件

**输入：**
- Layout.astro 基础布局
- 产品/分类/博客数据结构
- 品牌设置数据

**输出：**
- Schema 组件（Product、Breadcrumb、Organization、FAQ）
- sitemap.xml 动态生成端点
- robots.txt 配置
- GEO 相关组件（PublishDate、AuthorInfo、Summary 等）

**注意事项：**
- canonical 标签必须包含完整 URL（含协议和域名）
- Schema JSON-LD 必须符合 Google 规范
- robots.txt 需要允许 AI 爬虫（GPTBot、ClaudeBot 等）
- URL 参数策略：utm_* 参数使用 canonical 指向无参数 URL

**性能优化：**
- Schema 组件使用 `<script type="application/ld+json">` 内联，避免额外请求
- sitemap.xml 使用增量生成，避免每次全量查询
- 考虑使用 Cloudflare KV 缓存 sitemap 内容（TTL 1小时）
- robots.txt 使用静态文件，避免动态生成开销

**提示词：**
```
目标：实现基础 SEO 和 GEO 优化组件

输入：
- Layout.astro 基础布局
- 产品/分类/博客数据
- 品牌设置

输出：
1. Schema 组件（frontend/src/components/seo/）
   - ProductSchema.astro：根据产品数据生成 JSON-LD
   - BreadcrumbSchema.astro：根据页面路径生成
   - OrganizationSchema.astro：根据品牌设置生成
   - FAQSchema.astro：根据 FAQ 数据生成

2. sitemap.xml（frontend/src/pages/sitemap.xml.ts）
   - 动态生成所有产品/分类/博客 URL
   - 包含 lastmod、changefreq、priority
   - 考虑使用 KV 缓存（TTL 1小时）

3. robots.txt（frontend/src/pages/robots.txt.ts）
   - 允许 GPTBot、ClaudeBot、PerplexityBot
   - 指向 sitemap.xml

4. GEO 组件（frontend/src/components/geo/）
   - PublishDate.astro：显示发布/更新日期
   - AuthorInfo.astro：作者信息卡片
   - Summary.astro：摘要区域
   - QABlock.astro：问答格式
   - DefinitionParagraph.astro：定义式段落

注意事项：
- canonical 使用完整 URL
- Schema 符合 Google 规范
- utm_* 参数 canonical 到无参数 URL

性能优化：
- Schema 内联避免额外请求
- sitemap 增量生成 + KV 缓存
- robots.txt 使用静态文件
```

---

### 步骤 2.2：首页和布局组件

**目标：** 完善首页和通用布局组件

**输入：**
- 分类数据
- 热销产品数据
- 品牌设置

**输出：**
- Header 组件（响应式导航）
- Footer 组件
- 首页（Hero、产品轮播、分类网格）
- ProductCard、CategoryCard 组件

**注意事项：**
- 移动端导航使用汉堡菜单
- 购物车数量徽章实时更新
- 图片使用懒加载（loading="lazy"）
- 社交媒体链接添加 rel="noopener"

**性能优化：**
- Header 导航数据使用客户端缓存（localStorage）
- 首页 Hero 图片使用 WebP 格式 + 响应式图片（srcset）
- 产品轮播使用虚拟滚动，只渲染可见项
- 分类网格图片预加载前3个，其余懒加载
- 使用 Intersection Observer 实现懒加载
- 避免首屏加载过多 JavaScript

**提示词：**
```
目标：完善首页和通用布局组件

输入：
- 分类数据
- 热销产品数据（Top 8）
- 品牌设置

输出：
1. Header（frontend/src/components/layout/Header.astro）
   - 响应式导航（根据分类数据生成）
   - 移动端汉堡菜单
   - 购物车图标 + 数量徽章
   - 搜索框

2. Footer（frontend/src/components/layout/Footer.astro）
   - 链接分组
   - 社交媒体链接（rel="noopener"）
   - 支付方式图标
   - 版权信息

3. 首页（frontend/src/pages/index.astro）
   - Hero 区域（大图/视频 + CTA）
   - 热销产品轮播
   - 分类网格
   - 社会证明区域
   - Email 订阅表单

4. 通用组件
   - ProductCard.astro
   - CategoryCard.astro

注意事项：
- 图片使用 loading="lazy"
- 社交链接添加 rel="noopener"
- 购物车徽章实时更新

性能优化：
- Hero 图片使用 WebP + srcset
- 产品轮播使用虚拟滚动
- 分类图片前3个预加载，其余懒加载
- 使用 Intersection Observer 懒加载
- 导航数据客户端缓存（localStorage）
- 避免首屏过多 JavaScript
```

---

### 步骤 2.3：产品页面

**目标：** 实现产品列表、详情和分类页面

**输入：**
- 产品数据（含分类、价格、库存）
- 分类数据
- 相关产品算法

**输出：**
- 产品列表页（筛选、排序、分页）
- 产品详情页（图片画廊、规格、相关产品）
- 分类页面

**注意事项：**
- 筛选/排序/分页使用 URL 参数
- 产品详情页集成 ProductSchema
- 图片画廊支持缩放和切换
- 相关产品算法：同分类 + 相似价格区间

**性能优化：**
- 产品列表使用服务端分页，避免一次加载全部
- 筛选栏选项使用聚合查询，避免 N+1 问题
- 产品详情页图片使用渐进式加载
- 主图优先加载，缩略图懒加载
- 相关产品限制数量（4-6个），避免过多查询
- 使用 CDN 缓存产品图片
- 考虑使用 Cloudflare Images 自动优化

**提示词：**
```
目标：实现产品列表、详情和分类页面

输入：
- 产品数据
- 分类数据
- 相关产品算法

输出：
1. 产品列表页（/products）
   - 左侧筛选栏（分类、价格区间）
   - 产品网格（响应式 1/2/3/4 列）
   - 排序选择（价格、销量、上新）
   - 分页组件

2. 产品详情页（/products/[slug]）
   - 图片画廊（主图 + 缩略图）
   - 价格显示（原价/促销价）
   - 数量选择器
   - 加入购物车按钮
   - 产品 Tab（描述/规格/发货）
   - 相关产品推荐（4-6个）
   - ProductSchema

3. 分类页面（/category/[slug]）
   - 复用产品列表组件
   - 分类描述
   - 子分类导航

注意事项：
- 筛选/排序/分页使用 URL 参数
- 集成 ProductSchema
- 相关产品：同分类 + 相似价格

性能优化：
- 服务端分页，避免全量加载
- 筛选选项使用聚合查询
- 图片渐进式加载
- 主图优先，缩略图懒加载
- 相关产品限制 4-6 个
- 使用 CDN 缓存图片
- 考虑 Cloudflare Images 优化
```

---

### 步骤 2.4：购物车和结算

**目标：** 实现购物车和结算流程

**输入：**
- 购物车状态（localStorage）
- 产品数据
- Stripe 配置

**输出：**
- 迷你购物车侧边栏
- 购物车页面
- 结算页面
- 订单确认页
- 订单追踪页

**注意事项：**
- 购物车状态使用 localStorage 持久化
- 结算前验证库存和价格
- Stripe Elements 使用官方组件
- 支付成功后清空购物车

**性能优化：**
- 购物车数据使用防抖更新（500ms）
- 优惠码验证使用节流（1秒）
- Stripe Elements 按需加载
- 结算页面预加载 Stripe SDK
- 订单确认页使用服务端渲染，避免客户端查询
- 购物车图片使用缩略图，减少加载时间

**提示词：**
```
目标：实现购物车和结算流程

输入：
- 购物车状态（localStorage）
- 产品数据
- Stripe 配置

输出：
1. 迷你购物车（frontend/src/components/cart/MiniCart.astro）
   - 滑出式侧边栏
   - 商品列表
   - 数量调整 +/-
   - 删除按钮
   - 小计金额
   - 去结算按钮

2. 购物车页面（/cart）
   - 完整商品列表
   - 数量调整/删除
   - 优惠码输入
   - 订单摘要
   - 继续购物/去结算

3. 结算页面（/checkout）
   - 步骤指示器
   - 收货地址表单
   - 订单摘要
   - Stripe Elements 支付表单

4. 订单确认页（/order/[id]）
   - 订单号、状态
   - 商品清单
   - 收货地址
   - 支付信息

5. 订单追踪页（/order/[id]/track）
   - 物流状态时间线
   - 快递单号、物流链接

注意事项：
- 购物车使用 localStorage 持久化
- 结算前验证库存和价格
- 支付成功后清空购物车

性能优化：
- 购物车更新使用防抖（500ms）
- 优惠码验证使用节流（1秒）
- Stripe Elements 按需加载
- 结算页预加载 Stripe SDK
- 订单确认页服务端渲染
- 购物车图片使用缩略图
```

---

## 第3阶段：后端 API

### 步骤 3.1：域名品牌识别

**目标：** 实现多品牌域名识别中间件

**输入：**
- 请求 Host 头
- brands 表数据
- Cloudflare KV（可选）

**输出：**
- 品牌识别中间件
- KV 缓存逻辑
- 品牌上下文注入

**注意事项：**
- KV 缓存键必须包含域名（brand:domain:{host}）
- 生产环境未匹配域名返回 404
- 开发环境允许默认品牌回退

**性能优化：**
- 使用 KV 缓存品牌配置（TTL 1小时）
- 品牌查询使用索引（domain 字段）
- 避免每次请求都查询数据库
- KV 缓存未命中时才查询数据库
- 考虑使用 Durable Objects 存储品牌配置（更低延迟）

**提示词：**
```
目标：实现多品牌域名识别中间件

输入：
- 请求 Host 头
- brands 表
- Cloudflare KV（可选）

输出：
1. 域名识别中间件（worker/src/middleware/brand.ts）
   - 从 Host 头获取域名
   - 查询 brands.domain 获取 brand_id
   - 将 brand_id 注入请求头（x-brand-id）
   - 所有后续 API 自动携带 brand_id

2. KV 缓存逻辑
   - 首次查询后缓存（TTL 1小时）
   - KV key：brand:domain:{host}
   - 品牌更新时清除缓存

3. 默认品牌回退
   - 开发环境（localhost）使用默认品牌
   - 生产环境未匹配返回 404

4. 工具函数
   - getBrandId(request)
   - getBrandConfig(request)

注意事项：
- KV key 必须包含域名
- 生产环境未匹配返回 404
- 开发环境允许默认回退

性能优化：
- 使用 KV 缓存（TTL 1小时）
- domain 字段添加索引
- 避免每次请求查询数据库
- KV 未命中才查询数据库
- 考虑 Durable Objects（更低延迟）
```

---

### 步骤 3.2：基础 API 完善

**目标：** 完善产品和分类 API

**输入：**
- brand_id（来自中间件）
- 产品/分类数据

**输出：**
- 产品列表 API（支持筛选、排序、分页）
- 产品详情 API（含相关产品）
- 分类 API（层级结构）

**注意事项：**
- 所有查询必须包含 brand_id 过滤
- 分页使用 offset/limit
- 相关产品算法：同分类 + 价格相近

**性能优化：**
- 产品列表查询添加复合索引（brand_id, category_id, price）
- 使用 COUNT(*) OVER() 获取总数，避免额外查询
- 相关产品查询限制数量（LIMIT 6）
- 分类列表使用递归 CTE 或物化路径
- 考虑使用 Cloudflare KV 缓存分类树（变更频率低）
- 产品详情使用 JOIN 一次性获取分类信息

**提示词：**
```
目标：完善产品和分类 API

输入：
- brand_id（中间件注入）
- 产品/分类数据

输出：
1. 产品列表 API（POST /api/products/list）
   - 按 brand_id 过滤
   - 支持分页（page, pageSize）
   - 支持筛选（category_id, price_min, price_max）
   - 支持排序（price_asc, price_desc, newest, bestseller）
   - 返回：products[], total, page, pageSize

2. 产品详情 API（GET /api/products/:slug）
   - 按 brand_id 过滤
   - 返回完整产品信息 + 分类信息
   - 返回相关产品（同分类 + 价格相近，限制 6 个）

3. 分类 API（GET /api/categories）
   - 按 brand_id 过滤
   - 返回层级结构（parent_id 关联）
   - 包含每个分类的产品数量

注意事项：
- 所有查询包含 brand_id 过滤
- 分页使用 offset/limit
- 相关产品：同分类 + 价格相近

性能优化：
- 添加复合索引（brand_id, category_id, price）
- 使用 COUNT(*) OVER() 获取总数
- 相关产品 LIMIT 6
- 分类使用递归 CTE 或物化路径
- 考虑 KV 缓存分类树
- 产品详情使用 JOIN 获取分类
```

---

### 步骤 3.3：订单和支付

**目标：** 实现订单创建和 Stripe 支付集成

**输入：**
- 购物车数据
- 客户信息
- Stripe 配置

**输出：**
- 购物车验证 API
- 创建订单 API
- 订单详情 API
- Stripe Webhook 处理
- 邮件通知

**注意事项：**
- 订单金额必须服务端计算，不信任前端
- Webhook 必须验证签名
- 实现幂等性（stripe_event_id 去重）
- 订单状态机校验（pending→paid→shipped→delivered）
- 支付成功后扣减库存

**性能优化：**
- 购物车验证使用批量查询（IN 子句）
- 订单创建使用事务，确保原子性
- Webhook 处理使用数据库级幂等（UNIQUE 约束）
- 库存扣减使用乐观锁（WHERE stock >= quantity）
- 邮件发送使用异步队列（避免阻塞响应）
- Stripe API 调用添加超时和重试
- 订单详情查询使用 JOIN，避免 N+1

**提示词：**
```
目标：实现订单创建和 Stripe 支付集成

输入：
- 购物车数据
- 客户信息
- Stripe 配置

输出：
1. 购物车验证 API（POST /api/cart/validate）
   - 验证产品存在、上架
   - 验证库存充足
   - 验证价格正确
   - 返回验证结果 + 最新价格

2. 创建订单 API（POST /api/orders/create）
   - 接收：items[], shipping_address, email
   - 验证购物车
   - 服务端计算金额/币种（不信任前端）
   - 创建订单记录（状态：pending）
   - 创建 Stripe PaymentIntent
   - 返回：order_id, client_secret

3. 订单详情 API（GET /api/orders/:id）
   - 验证订单归属
   - 返回订单完整信息

4. Stripe Webhook（POST /api/stripe/webhook）
   - 验证 Stripe 签名
   - 幂等处理（stripe_event_id 去重）
   - 状态机校验
   - 处理 payment_intent.succeeded：
     - 更新订单状态为 paid
     - 扣减库存
     - 发送订单确认邮件
   - 处理 payment_intent.payment_failed：
     - 更新订单状态为 failed

5. 邮件通知（worker/src/utils/email.ts）
   - 使用 Resend API
   - 订单确认邮件模板
   - 发货通知邮件模板

注意事项：
- 订单金额服务端计算
- Webhook 验证签名
- 实现幂等性（stripe_event_id）
- 状态机校验
- 支付成功后扣减库存

性能优化：
- 购物车验证批量查询（IN）
- 订单创建使用事务
- Webhook 数据库级幂等（UNIQUE）
- 库存扣减乐观锁（WHERE stock >= quantity）
- 邮件异步队列
- Stripe API 超时和重试
- 订单详情使用 JOIN
```

---

### 步骤 3.4：AI 客服

**目标：** 实现多品牌 AI 客服系统

**输入：**
- brand_id
- 用户消息
- 品牌 AI 配置
- 知识库数据

**输出：**
- 普通对话 API
- 流式响应 API
- 知识库 CRUD API
- RAG 向量检索

**注意事项：**
- 每个品牌独立知识库（brand_id 隔离）
- 对话历史保留最近 N 条
- 支持多语言自动检测
- 人工转接关键词匹配

**性能优化：**
- 品牌 AI 配置使用 KV 缓存（TTL 1小时）
- 向量检索限制返回数量（Top 5）
- 对话历史查询添加索引（session_id, created_at）
- 使用连接池管理 DeepSeek API 连接
- 流式响应使用 SSE，减少延迟感知
- 知识库 Embedding 使用批量处理
- 考虑使用 Cloudflare AI 替代 DeepSeek（更低延迟）

**提示词：**
```
目标：实现多品牌 AI 客服系统

输入：
- brand_id
- 用户消息
- 品牌 AI 配置
- 知识库数据

输出：
1. 品牌级配置读取
   - 从 settings 表读取 AI 配置
   - 配置缺失使用默认值
   - 品牌信息注入 System Prompt

2. 普通对话 API（POST /api/chat）
   - 接收：message, sessionId
   - 读取品牌配置构建 System Prompt
   - pgvector 检索品牌知识库（按 brand_id 过滤）
   - 获取最近 N 条对话历史
   - 调用 DeepSeek API 生成回复
   - 保存对话到 conversations 表
   - 返回：reply, sessionId

3. 流式响应 API（POST /api/chat/stream）
   - 使用 Server-Sent Events
   - 实时流式输出 AI 回复
   - 支持 RAG + 对话历史

4. 知识库管理（Supabase pgvector）
   - knowledge_base 表添加 embedding 列
   - POST /api/knowledge：添加知识，调用 DeepSeek embedding
   - GET /api/knowledge：获取品牌知识列表
   - DELETE /api/knowledge/:id：删除知识
   - 向量检索函数：match_knowledge(query_embedding, brand_id, limit)

5. 意图识别与人工转接
   - AI 识别意图
   - 匹配 ai_handoff_keywords 时标记 needs_human
   - 返回转接提示

注意事项：
- 每品牌独立知识库（brand_id 隔离）
- 对话历史保留最近 N 条
- 支持多语言自动检测
- 人工转接关键词匹配

性能优化：
- AI 配置使用 KV 缓存（TTL 1小时）
- 向量检索限制 Top 5
- 对话历史索引（session_id, created_at）
- DeepSeek API 连接池
- 流式响应使用 SSE
- Embedding 批量处理
- 考虑 Cloudflare AI（更低延迟）
```

---

## 第4阶段：管理后台

### 步骤 4.1：后台框架

**目标：** 搭建管理后台基础框架

**输入：**
- Supabase Auth 配置
- 品牌数据
- 用户权限数据

**输出：**
- 后台布局（AdminLayout）
- 登录认证
- 仪表盘
- 品牌切换器
- 权限模型

**注意事项：**
- 所有后台页面需要登录验证
- 权限检查：前端 UI + 后端 API 双重验证
- 与 RLS 策略对齐

**性能优化：**
- 仪表盘统计数据使用物化视图或定时聚合
- 登录状态使用 Session Storage，减少验证请求
- 侧边栏导航使用客户端路由，避免整页刷新
- 统计卡片数据使用 SWR 策略（Stale-While-Revalidate）
- 销售趋势图数据按天聚合，避免实时计算
- 品牌切换使用乐观更新，提升响应速度

**提示词：**
```
目标：搭建管理后台基础框架

输入：
- Supabase Auth 配置
- 品牌数据
- 用户权限数据

输出：
1. 后台路由和布局（frontend/src/pages/admin/）
   - AdminLayout.astro：侧边栏 + 顶栏 + 内容区
   - 侧边栏导航：仪表盘、产品、订单、客户、内容、设置

2. Supabase Auth 登录
   - /admin/login 登录页
   - 邮箱 + 密码登录
   - 登录状态检查中间件
   - 登出功能

3. 仪表盘（/admin）
   - 统计卡片：今日销售额、订单数、访客数、转化率
   - 销售趋势图（近 7 天/30 天）
   - 最近订单列表
   - 待处理事项提醒

4. 通用组件（frontend/src/components/admin/）
   - DataTable.astro：数据表格（排序、筛选、分页）
   - Modal.astro：模态框
   - Toast.astro：消息提示
   - Form 组件：Input、Select、Textarea、Switch

5. 品牌切换器
   - 顶栏显示当前品牌
   - 下拉切换品牌（超级管理员可见）
   - 切换后刷新数据

6. 角色权限模型（RBAC）
   - 定义权限边界
   - 后台 UI 与 API 权限一致
   - 与 RLS 策略对齐

注意事项：
- 所有后台页面需登录验证
- 权限检查：前端 + 后端双重验证
- 与 RLS 策略对齐

性能优化：
- 仪表盘统计使用物化视图或定时聚合
- 登录状态使用 Session Storage
- 侧边栏使用客户端路由
- 统计数据使用 SWR 策略
- 趋势图按天聚合
- 品牌切换乐观更新
```

---

## 性能优化总结

### 数据库优化

1. **索引策略**
   - 为常用查询字段添加索引（brand_id, category_id, created_at）
   - 使用复合索引优化多条件查询
   - 定期分析慢查询日志

2. **查询优化**
   - 使用 JOIN 避免 N+1 问题
   - 使用 COUNT(*) OVER() 避免额外计数查询
   - 限制返回数量（LIMIT）
   - 使用批量查询（IN 子句）