# 1.2 数据库模型

## 功能概述

设计完整的数据库表结构，支持多品牌电商系统的所有功能需求。

## 数据库架构

### 核心表结构

#### 1. brands（品牌表）
**用途**: 多品牌管理，支持域名识别

**字段**:
- `id` (UUID) - 主键
- `name` (TEXT) - 品牌名称
- `domain` (TEXT) - 绑定域名（唯一索引）
- `logo_url` (TEXT) - Logo URL
- `settings` (JSONB) - 品牌配置
- `created_at` (TIMESTAMP)

**索引**: `domain` (UNIQUE)

#### 2. products（产品表）
**用途**: 存储产品信息

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID（外键）
- `category_id` (UUID) - 分类ID（外键）
- `name` (TEXT) - 产品名称
- `slug` (TEXT) - URL友好标识
- `description` (TEXT) - 产品描述
- `price` (DECIMAL) - 价格
- `compare_at_price` (DECIMAL) - 原价
- `images` (TEXT[]) - 图片URL数组
- `stock` (INTEGER) - 库存
- `is_active` (BOOLEAN) - 是否上架
- `metadata` (JSONB) - 扩展字段
- `created_at` (TIMESTAMP)

**索引**: 
- `(brand_id, slug)` (UNIQUE)
- `(brand_id, category_id, price)`
- `(brand_id, is_active)`

#### 3. categories（分类表）
**用途**: 产品分类管理

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `parent_id` (UUID) - 父分类ID（支持层级）
- `name` (TEXT) - 分类名称
- `slug` (TEXT) - URL标识
- `description` (TEXT) - 分类描述
- `image_url` (TEXT) - 分类图片
- `sort_order` (INTEGER) - 排序
- `created_at` (TIMESTAMP)

**索引**: `(brand_id, slug)` (UNIQUE)

#### 4. orders（订单表）
**用途**: 订单管理

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `order_number` (TEXT) - 订单号（唯一）
- `customer_email` (TEXT) - 客户邮箱
- `customer_name` (TEXT) - 客户姓名
- `shipping_address` (JSONB) - 收货地址
- `items` (JSONB) - 订单商品
- `subtotal` (DECIMAL) - 小计
- `shipping_fee` (DECIMAL) - 运费
- `discount` (DECIMAL) - 折扣
- `total` (DECIMAL) - 总计
- `currency` (TEXT) - 币种
- `status` (TEXT) - 订单状态
- `payment_intent_id` (TEXT) - Stripe支付ID
- `tracking_number` (TEXT) - 物流单号
- `created_at` (TIMESTAMP)

**索引**: 
- `order_number` (UNIQUE)
- `(brand_id, status, created_at)`
- `customer_email`

**状态流转**: pending → paid → shipped → delivered

#### 5. customers（客户表）
**用途**: 客户信息管理

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `email` (TEXT) - 邮箱（唯一）
- `name` (TEXT) - 姓名
- `phone` (TEXT) - 电话
- `addresses` (JSONB) - 地址列表
- `total_orders` (INTEGER) - 订单总数
- `total_spent` (DECIMAL) - 消费总额
- `created_at` (TIMESTAMP)

**索引**: `(brand_id, email)` (UNIQUE)

#### 6. conversations（对话表）
**用途**: AI客服对话记录

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `session_id` (TEXT) - 会话ID
- `role` (TEXT) - 角色（user/assistant）
- `content` (TEXT) - 消息内容
- `metadata` (JSONB) - 元数据
- `created_at` (TIMESTAMP)

**索引**: `(session_id, created_at)`

#### 7. knowledge_base（知识库表）
**用途**: AI客服知识库（支持RAG）

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `title` (TEXT) - 标题
- `content` (TEXT) - 内容
- `embedding` (VECTOR) - 向量嵌入（pgvector）
- `metadata` (JSONB) - 元数据
- `created_at` (TIMESTAMP)

**索引**: 
- `brand_id`
- `embedding` (HNSW向量索引)

#### 8. content_library（内容库表）
**用途**: 博客文章和SEO内容

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `author_id` (UUID) - 作者ID
- `type` (TEXT) - 内容类型（blog/page）
- `title` (TEXT) - 标题
- `slug` (TEXT) - URL标识
- `content` (TEXT) - 内容
- `excerpt` (TEXT) - 摘要
- `featured_image` (TEXT) - 特色图片
- `seo_title` (TEXT) - SEO标题
- `seo_description` (TEXT) - SEO描述
- `status` (TEXT) - 状态（draft/published）
- `published_at` (TIMESTAMP) - 发布时间
- `created_at` (TIMESTAMP)

**索引**: `(brand_id, slug)` (UNIQUE)

#### 9. authors（作者表）
**用途**: 内容作者管理

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `name` (TEXT) - 姓名
- `slug` (TEXT) - URL标识
- `bio` (TEXT) - 简介
- `avatar_url` (TEXT) - 头像
- `social_links` (JSONB) - 社交链接
- `created_at` (TIMESTAMP)

**索引**: `(brand_id, slug)` (UNIQUE)

#### 10. reviews（评价表）
**用途**: 产品评价管理

**字段**:
- `id` (UUID) - 主键
- `product_id` (UUID) - 产品ID
- `order_id` (UUID) - 订单ID
- `customer_name` (TEXT) - 客户姓名
- `rating` (INTEGER) - 评分（1-5）
- `title` (TEXT) - 标题
- `content` (TEXT) - 内容
- `images` (TEXT[]) - 图片
- `is_verified` (BOOLEAN) - 是否认证购买
- `status` (TEXT) - 状态（pending/approved/rejected）
- `created_at` (TIMESTAMP)

**索引**: `(product_id, status, created_at)`

#### 11. coupons（优惠券表）
**用途**: 优惠券管理

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID
- `code` (TEXT) - 优惠码（唯一）
- `type` (TEXT) - 类型（percentage/fixed）
- `value` (DECIMAL) - 折扣值
- `min_purchase` (DECIMAL) - 最低消费
- `max_uses` (INTEGER) - 最大使用次数
- `used_count` (INTEGER) - 已使用次数
- `valid_from` (TIMESTAMP) - 生效时间
- `valid_until` (TIMESTAMP) - 失效时间
- `is_active` (BOOLEAN) - 是否启用
- `created_at` (TIMESTAMP)

**索引**: `code` (UNIQUE)

#### 12. admin_users（管理员表）
**用途**: 后台管理员账户

**字段**:
- `id` (UUID) - 主键
- `email` (TEXT) - 邮箱（唯一）
- `role` (TEXT) - 角色（super_admin/brand_admin）
- `brand_ids` (UUID[]) - 可管理的品牌ID列表
- `created_at` (TIMESTAMP)

**索引**: `email` (UNIQUE)

#### 13. settings（系统设置表）
**用途**: 品牌级系统配置

**字段**:
- `id` (UUID) - 主键
- `brand_id` (UUID) - 品牌ID（唯一）
- `store_name` (TEXT) - 店铺名称
- `store_description` (TEXT) - 店铺描述
- `contact_email` (TEXT) - 联系邮箱
- `ai_config` (JSONB) - AI配置
- `payment_config` (JSONB) - 支付配置
- `shipping_config` (JSONB) - 物流配置
- `updated_at` (TIMESTAMP)

**索引**: `brand_id` (UNIQUE)

### 扩展功能

#### pgvector扩展
**用途**: 支持向量检索（RAG）

**安装**: 
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

**向量检索函数**:
```sql
CREATE OR REPLACE FUNCTION match_knowledge(
  query_embedding vector(1536),
  match_brand_id uuid,
  match_threshold float,
  match_count int
)
RETURNS TABLE (
  id uuid,
  content text,
  similarity float
)
```

### RLS策略

**Row Level Security（行级安全）**

所有表都启用RLS策略，确保：
1. 品牌数据隔离（按brand_id过滤）
2. 管理员权限控制
3. 客户数据保护

**示例策略**:
```sql
-- 产品表RLS
CREATE POLICY "品牌隔离" ON products
  FOR ALL
  USING (brand_id = current_setting('app.brand_id')::uuid);

-- 管理员访问
CREATE POLICY "管理员访问" ON products
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM admin_users
      WHERE id = auth.uid()
      AND brand_id = ANY(brand_ids)
    )
  );
```

## 数据库脚本

所有SQL脚本位于 [`docs/database/`](../database/) 目录：

1. [`001_initial_schema.sql`](../database/001_initial_schema.sql) - 基础表结构
2. [`002_rls_policies.sql`](../database/002_rls_policies.sql) - RLS策略
3. [`003_sample_data.sql`](../database/003_sample_data.sql) - 示例数据
4. [`004_pgvector_ai.sql`](../database/004_pgvector_ai.sql) - pgvector配置
5. [`005_orders_payment.sql`](../database/005_orders_payment.sql) - 订单支付
6. [`006_reviews.sql`](../database/006_reviews.sql) - 评价系统
7. [`007_coupons.sql`](../database/007_coupons.sql) - 优惠券
8. [`008_admin_users.sql`](../database/008_admin_users.sql) - 管理员
9. [`009_blog_support.sql`](../database/009_blog_support.sql) - 博客支持

## 性能优化

### 索引策略
- 所有外键添加索引
- 常用查询字段添加复合索引
- 向量字段使用HNSW索引

### 查询优化
- 使用JOIN避免N+1问题
- 使用COUNT(*) OVER()避免额外计数
- 限制返回数量（LIMIT）

### 缓存策略
- 品牌配置使用KV缓存
- 分类树使用KV缓存
- 热门产品使用CDN缓存

## 相关文档

- [基础架构](./1.1-基础架构.md)
- [数据库脚本](../database/)
- [API文档](../03-后端API/)

## 状态

✅ **已完成** - 所有数据库表和策略已创建