---
// Main Layout - placeholder for Step 2.1
import '@styles/global.css';
import Header from '@components/layout/Header.astro';
import Footer from '@components/layout/Footer.astro';
import ChatWidget from '@components/chat/ChatWidget.astro';
// Categories fetched via Worker API
import { canonicalFor, shouldNoIndex } from '@lib/seo';
import { fetchSiteConfig } from '@lib/site-config';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  lang?: string;
}

const { title, description = 'DTC E-commerce Store', image, lang = 'en' } = Astro.props;
const siteName = import.meta.env.PUBLIC_SITE_NAME || 'DTC Store';
let siteUrl = 'https://example.com';
try {
  siteUrl = new URL(Astro.request.url).origin;
} catch {}
const fullTitle = `${title} | ${siteName}`;

const canonicalUrl = canonicalFor(Astro.url, siteUrl);
const noindex = shouldNoIndex(Astro.url);

const siteConfig = await fetchSiteConfig(Astro.request);
if (!siteConfig?.brand) {
  return new Response('Site not found', { status: 404 });
}

const brand = siteConfig.brand;

const resolvedSiteName = brand.name || siteName;
const resolvedFullTitle = `${title} | ${resolvedSiteName}`;

const defaultTheme = {
  primaryColor: '#4F46E5',
  secondaryColor: '#10B981',
  accentColor: '#F59E0B',
  fontFamily: 'Inter',
  headerStyle: 'default',
  footerStyle: 'default',
  buttonStyle: 'rounded',
};

const theme = { ...defaultTheme, ...(brand.theme || {}) };

const brandCssVars = `:root{--brand-primary:${theme.primaryColor};--brand-secondary:${theme.secondaryColor};--brand-accent:${theme.accentColor};--brand-font:${theme.fontFamily};}`;
const brandThemeOverrides = `
  body{font-family:var(--brand-font),ui-sans-serif,system-ui,sans-serif;}

  .text-primary-600{color:var(--brand-primary)!important;}
  .text-primary-700{color:var(--brand-primary)!important;}
  .bg-primary-600{background-color:var(--brand-primary)!important;}
  .bg-primary-700{background-color:var(--brand-primary)!important;}
  .border-primary-500{border-color:var(--brand-primary)!important;}

  .text-secondary-600{color:var(--brand-secondary)!important;}
  .text-secondary-700{color:var(--brand-secondary)!important;}
  .bg-secondary-600{background-color:var(--brand-secondary)!important;}
  .bg-secondary-700{background-color:var(--brand-secondary)!important;}
  .border-secondary-500{border-color:var(--brand-secondary)!important;}

  .hover\\:bg-primary-700:hover{background-color:var(--brand-primary)!important;}
  .hover\\:bg-primary-600:hover{background-color:var(--brand-primary)!important;}
  .hover\\:text-primary-600:hover{color:var(--brand-primary)!important;}
  .hover\\:text-primary-700:hover{color:var(--brand-primary)!important;}
  .hover\\:border-primary-500:hover{border-color:var(--brand-primary)!important;}

  .focus\\:ring-primary-500:focus{--tw-ring-color:var(--brand-primary)!important;}
  .focus\\:ring-secondary-500:focus{--tw-ring-color:var(--brand-secondary)!important;}

  .from-primary-600{--tw-gradient-from:var(--brand-primary)!important;--tw-gradient-to:rgb(0 0 0 / 0)!important;--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)!important;}
  .to-secondary-600{--tw-gradient-to:var(--brand-secondary)!important;}
`;
const brandCustomCss = typeof brand.custom_css === 'string' ? brand.custom_css : '';

// Fetch categories via Worker API (SSR)
const apiUrl = import.meta.env.PUBLIC_API_URL || '';
let categories: Array<{ id: string; name: string; slug: string; parent_id: string | null; sort_order: number; is_active: boolean; children?: any[] }> = [];
if (apiUrl) {
  try {
    const res = await fetch(`${apiUrl}/api/categories`, {
      headers: { 'x-brand-id': brand.id },
    });
    if (res.ok) {
      const json = await res.json() as { categories?: typeof categories };
      categories = json.categories || [];
    }
  } catch (e) {
    console.error('Failed to fetch categories via API:', e);
  }
}
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex,follow" />}
    
    <!-- Open Graph -->
    <meta property="og:title" content={resolvedFullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    {image && <meta property="og:image" content={image} />}
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={resolvedFullTitle} />
    <meta name="twitter:description" content={description} />
    {image && <meta name="twitter:image" content={image} />}
    
    <!-- Favicon -->
    <link rel="icon" href={brand.favicon_url || '/favicon.svg'} />

    <style>{brandCssVars}</style>
    <style>{brandThemeOverrides}</style>
    {brandCustomCss && <style>{brandCustomCss}</style>}
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet" />
    
    <title>{resolvedFullTitle}</title>
    <slot name="head" />
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- Header placeholder - to be implemented in Step 2.1 -->
    <Header siteName={brand.name || siteName} categories={categories || []} />
    
    <!-- Main content -->
    <main class="flex-1">
      <slot />
    </main>
    
    <!-- Footer placeholder - to be implemented in Step 2.1 -->
    <Footer siteName={brand.name || siteName} socialLinks={brand.social_links || {}} />
    
    <!-- AI Chat Widget -->
    <ChatWidget />
  </body>
</html>
