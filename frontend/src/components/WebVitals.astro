---
/**
 * Web Vitals Component
 * Collects Core Web Vitals metrics and sends to backend
 * Include this at the end of the <body> in your layout
 */

interface Props {
  enabled?: boolean;
  pageType?: string;
  debug?: boolean;
}

const { enabled = true, pageType = 'other', debug = false } = Astro.props;
---

{enabled && (
  <script define:vars={{ pageType, debug }}>
    // Web Vitals collection using web-vitals library
    async function initWebVitals() {
      const API_BASE = import.meta.env?.PUBLIC_API_URL || '';
      
      // Dynamically import web-vitals
      const { onCLS, onFID, onLCP, onINP, onTTFB, onFCP } = await import('https://unpkg.com/web-vitals@3/dist/web-vitals.attribution.js?module');
      
      const metrics = {};
      let sendTimeout;
      
      function getDeviceType() {
        const ua = navigator.userAgent;
        if (/tablet|ipad|playbook|silk/i.test(ua)) return 'tablet';
        if (/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(ua)) return 'mobile';
        return 'desktop';
      }
      
      function getConnectionType() {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        return connection?.effectiveType || 'unknown';
      }
      
      function sendMetrics() {
        if (Object.keys(metrics).length === 0) return;
        
        const data = {
          page_url: window.location.href,
          page_path: window.location.pathname,
          page_type: pageType,
          device_type: getDeviceType(),
          connection_type: getConnectionType(),
          effective_type: navigator.connection?.effectiveType,
          user_agent: navigator.userAgent,
          session_id: sessionStorage.getItem('dtc_session_id'),
          ...metrics,
        };
        
        if (debug) {
          console.log('[WebVitals]', data);
        }
        
        // Use sendBeacon for reliability
        if (navigator.sendBeacon) {
          navigator.sendBeacon(
            `${API_BASE}/api/vitals`,
            JSON.stringify(data)
          );
        } else {
          fetch(`${API_BASE}/api/vitals`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
            keepalive: true,
          }).catch(() => {});
        }
      }
      
      function queueSend() {
        clearTimeout(sendTimeout);
        sendTimeout = setTimeout(sendMetrics, 3000);
      }
      
      // Collect metrics
      onLCP((metric) => {
        metrics.lcp = Math.round(metric.value);
        if (debug) console.log('[WebVitals] LCP:', metric.value);
        queueSend();
      });
      
      onFID((metric) => {
        metrics.fid = Math.round(metric.value);
        if (debug) console.log('[WebVitals] FID:', metric.value);
        queueSend();
      });
      
      onCLS((metric) => {
        metrics.cls = parseFloat(metric.value.toFixed(4));
        if (debug) console.log('[WebVitals] CLS:', metric.value);
        queueSend();
      });
      
      onINP((metric) => {
        metrics.inp = Math.round(metric.value);
        if (debug) console.log('[WebVitals] INP:', metric.value);
        queueSend();
      });
      
      onTTFB((metric) => {
        metrics.ttfb = Math.round(metric.value);
        if (debug) console.log('[WebVitals] TTFB:', metric.value);
        queueSend();
      });
      
      onFCP((metric) => {
        metrics.fcp = Math.round(metric.value);
        if (debug) console.log('[WebVitals] FCP:', metric.value);
        queueSend();
      });
      
      // Send on page hide (user leaving)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          sendMetrics();
        }
      });
      
      // Send before page unload
      window.addEventListener('pagehide', sendMetrics);
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'complete') {
      initWebVitals();
    } else {
      window.addEventListener('load', initWebVitals);
    }
  </script>
)}
