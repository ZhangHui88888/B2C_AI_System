---
export const prerender = false;

import Layout from '@layouts/Layout.astro';
import { supabase } from '@lib/supabase';
import ProductCard from '@components/catalog/ProductCard.astro';
import BreadcrumbSchema from '@components/seo/BreadcrumbSchema.astro';
import { fetchSiteConfig } from '@lib/site-config';

const siteName = import.meta.env.PUBLIC_SITE_NAME || 'DTC Store';
let siteUrl = 'https://example.com';
try {
  siteUrl = new URL(Astro.request.url).origin;
} catch {}

const pageSize = 12;

const { slug } = Astro.params;

const siteConfig = await fetchSiteConfig(Astro.request);
const brand = siteConfig?.brand;
if (!brand) {
  return new Response('Site not found', { status: 404 });
}

const { data: category } = await supabase
  .from('categories')
  .select('*')
  .eq('brand_id', brand.id)
  .eq('slug', slug)
  .eq('is_active', true)
  .single();

if (!category) {
  return Astro.redirect('/products');
}

const { data: subcategories } = await supabase
  .from('categories')
  .select('*')
  .eq('brand_id', brand.id)
  .eq('is_active', true)
  .eq('parent_id', category.id)
  .order('sort_order', { ascending: true });

const { data: products } = await supabase
  .from('products')
  .select('*')
  .eq('brand_id', brand.id)
  .eq('is_active', true)
  .eq('category_id', category.id)
  .order('created_at', { ascending: false })
  .range(0, pageSize - 1);

const { data: minPriceRows } = await supabase
  .from('products')
  .select('price')
  .eq('brand_id', brand.id)
  .eq('is_active', true)
  .eq('category_id', category.id)
  .order('price', { ascending: true })
  .limit(1);

const { data: maxPriceRows } = await supabase
  .from('products')
  .select('price')
  .eq('brand_id', brand.id)
  .eq('is_active', true)
  .eq('category_id', category.id)
  .order('price', { ascending: false })
  .limit(1);

const initialMinPrice = minPriceRows?.[0]?.price !== undefined ? Number(minPriceRows?.[0]?.price) : undefined;
const initialMaxPrice = maxPriceRows?.[0]?.price !== undefined ? Number(maxPriceRows?.[0]?.price) : undefined;

const { count: totalCount } = await supabase
  .from('products')
  .select('id', { count: 'exact', head: true })
  .eq('brand_id', brand.id)
  .eq('is_active', true)
  .eq('category_id', category.id);

const initialTotalPages = Math.max(1, Math.ceil((totalCount || 0) / pageSize));

const breadcrumbItems = [
  { name: 'Home', url: siteUrl },
  { name: 'Products', url: new URL('/products', siteUrl).toString() },
  { name: category.name, url: new URL(`/category/${category.slug}`, siteUrl).toString() },
];
---

<Layout title={category.name} description={category.description || `Browse ${category.name} at ${siteName}.`}>
  <Fragment slot="head">
    <BreadcrumbSchema items={breadcrumbItems} />
  </Fragment>

  <main class="container-custom">
    <section class="section pb-8">
      <div class="flex items-end justify-between gap-4">
        <div>
          <h1>{category.name}</h1>
          {category.description && <p class="mt-3 text-gray-600 max-w-2xl">{category.description}</p>}
        </div>
        <a href="/products" class="btn-outline py-2 px-4 text-sm">All products</a>
      </div>

      {(subcategories || []).length > 0 && (
        <div class="mt-6">
          <div class="text-sm font-semibold text-gray-900">Subcategories</div>
          <div class="mt-3 flex flex-wrap gap-2">
            {(subcategories || []).map((c) => (
              <a href={`/category/${c.slug}`} class="btn-ghost py-2 px-3 text-sm">{c.name}</a>
            ))}
          </div>
        </div>
      )}

      <div class="mt-6 card p-4">
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
          <input id="category-search" class="input py-2" type="search" placeholder="Search" />
          <div class="grid grid-cols-2 gap-3">
            <input
              id="category-price-min"
              class="input py-2"
              type="number"
              inputmode="decimal"
              placeholder={typeof initialMinPrice === 'number' ? `Min ${initialMinPrice}` : 'Min'}
            />
            <input
              id="category-price-max"
              class="input py-2"
              type="number"
              inputmode="decimal"
              placeholder={typeof initialMaxPrice === 'number' ? `Max ${initialMaxPrice}` : 'Max'}
            />
          </div>
          <select id="category-sort" class="input py-2">
            <option value="newest">Newest</option>
            <option value="best_selling">Best selling</option>
            <option value="featured">Featured</option>
            <option value="price_asc">Price: Low to High</option>
            <option value="price_desc">Price: High to Low</option>
          </select>
          <div class="flex items-center justify-between gap-3">
            <button id="category-apply" class="btn-primary py-2 px-4 text-sm" type="button">Apply</button>
            <button id="category-reset" class="btn-ghost py-2 px-4 text-sm" type="button">Reset</button>
          </div>
        </div>
      </div>
    </section>

    <section class="pb-8">
      <div id="category-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {(products || []).map((p) => (
          <ProductCard product={p} />
        ))}
      </div>

      <div id="category-empty" class="hidden text-center py-16 text-gray-600">No products found.</div>

      <div id="category-pagination" class="mt-10 flex items-center justify-center gap-2">
        <button class="btn-ghost py-2 px-3 text-sm" type="button" data-page="prev">Prev</button>
        <span id="category-page" class="text-sm text-gray-700">1 / {initialTotalPages}</span>
        <button class="btn-ghost py-2 px-3 text-sm" type="button" data-page="next">Next</button>
      </div>
    </section>
  </main>

  <script define:vars={{ categorySlug: category.slug }}>
    const pageSize = 12;

    const searchEl = document.getElementById('category-search');
    const priceMinEl = document.getElementById('category-price-min');
    const priceMaxEl = document.getElementById('category-price-max');
    const sortEl = document.getElementById('category-sort');
    const applyBtn = document.getElementById('category-apply');
    const resetBtn = document.getElementById('category-reset');

    const grid = document.getElementById('category-grid');
    const emptyEl = document.getElementById('category-empty');
    const pageEl = document.getElementById('category-page');
    const pagination = document.getElementById('category-pagination');

    let currentPage = 1;
    let totalPages = Number(pageEl?.textContent?.split('/')[1]) || 1;

    function readQuery() {
      const u = new URL(window.location.href);
      return {
        search: u.searchParams.get('search') || '',
        price_min: u.searchParams.get('price_min') ? Number(u.searchParams.get('price_min')) : undefined,
        price_max: u.searchParams.get('price_max') ? Number(u.searchParams.get('price_max')) : undefined,
        sort: u.searchParams.get('sort') || 'newest',
        page: Number(u.searchParams.get('page') || '1') || 1,
      };
    }

    function writeQuery(next) {
      const u = new URL(window.location.href);
      u.searchParams.delete('search');
      u.searchParams.delete('price_min');
      u.searchParams.delete('price_max');
      u.searchParams.delete('sort');
      u.searchParams.delete('page');

      if (next.search) u.searchParams.set('search', next.search);
      if (typeof next.price_min === 'number' && Number.isFinite(next.price_min)) u.searchParams.set('price_min', String(next.price_min));
      if (typeof next.price_max === 'number' && Number.isFinite(next.price_max)) u.searchParams.set('price_max', String(next.price_max));
      if (next.sort && next.sort !== 'newest') u.searchParams.set('sort', next.sort);
      if (next.page && next.page > 1) u.searchParams.set('page', String(next.page));

      history.pushState({}, '', u.pathname + u.search);
    }

    function renderCards(products) {
      if (!grid) return;
      if (!products || products.length === 0) {
        grid.innerHTML = '';
        emptyEl?.classList.remove('hidden');
        return;
      }

      emptyEl?.classList.add('hidden');
      grid.innerHTML = products
        .map((p) => {
          const img = p.main_image_url
            ? `<img src="${p.main_image_url}" alt="${p.name}" class="h-full w-full object-cover" loading="lazy" />`
            : `<div class="h-full w-full flex items-center justify-center text-gray-400 text-sm">No image</div>`;

          const compare = p.compare_price
            ? `<span class="text-sm text-gray-500 line-through">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(p.compare_price))}</span>`
            : '';

          const price = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(p.price));

          return `
            <article class="card">
              <a href="/products/${p.slug}" class="block">
                <div class="aspect-square bg-gray-100 overflow-hidden">${img}</div>
                <div class="p-4">
                  <h3 class="text-lg font-display font-bold line-clamp-2">${p.name}</h3>
                  ${p.short_description ? `<p class="mt-2 text-sm text-gray-600 line-clamp-2">${p.short_description}</p>` : ''}
                  <div class="mt-3 flex items-center gap-2">
                    <span class="text-lg font-semibold text-gray-900">${price}</span>
                    ${compare}
                  </div>
                </div>
              </a>
            </article>
          `;
        })
        .join('');
    }

    async function fetchProducts(params) {
      const res = await api.getProducts({
        category: categorySlug,
        page: params.page,
        limit: pageSize,
        sort: params.sort,
        search: params.search || undefined,
        price_min: typeof params.price_min === 'number' && Number.isFinite(params.price_min) ? params.price_min : undefined,
        price_max: typeof params.price_max === 'number' && Number.isFinite(params.price_max) ? params.price_max : undefined,
      });

      if (!res.success || !res.data) return null;
      return res.data;
    }

    async function refresh(fromQuery = false) {
      const q = fromQuery
        ? readQuery()
        : {
            search: String(searchEl?.value || ''),
            price_min: priceMinEl?.value ? Number(priceMinEl.value) : undefined,
            price_max: priceMaxEl?.value ? Number(priceMaxEl.value) : undefined,
            sort: String(sortEl?.value || 'newest'),
            page: currentPage,
          };

      const data = await fetchProducts(q);
      if (!data) return;

      const products = data.products || [];
      const paginationData = data.pagination || { page: 1, totalPages: 1 };

      currentPage = paginationData.page || 1;
      totalPages = paginationData.totalPages || 1;

      if (!fromQuery) {
        writeQuery({ ...q, page: currentPage });
      }

      renderCards(products);
      if (pageEl) pageEl.textContent = `${currentPage} / ${totalPages}`;

      const prevBtn = pagination?.querySelector('button[data-page="prev"]');
      const nextBtn = pagination?.querySelector('button[data-page="next"]');

      if (prevBtn) prevBtn.classList.toggle('opacity-50', currentPage <= 1);
      if (prevBtn) prevBtn.classList.toggle('pointer-events-none', currentPage <= 1);
      if (nextBtn) nextBtn.classList.toggle('opacity-50', currentPage >= totalPages);
      if (nextBtn) nextBtn.classList.toggle('pointer-events-none', currentPage >= totalPages);
    }

    function syncControlsFromQuery() {
      const q = readQuery();
      if (searchEl) searchEl.value = q.search;
      if (priceMinEl) priceMinEl.value = typeof q.price_min === 'number' && Number.isFinite(q.price_min) ? String(q.price_min) : '';
      if (priceMaxEl) priceMaxEl.value = typeof q.price_max === 'number' && Number.isFinite(q.price_max) ? String(q.price_max) : '';
      if (sortEl) sortEl.value = q.sort;
      currentPage = q.page;
    }

    applyBtn?.addEventListener('click', async () => {
      currentPage = 1;
      await refresh(false);
    });

    resetBtn?.addEventListener('click', async () => {
      if (searchEl) searchEl.value = '';
      if (priceMinEl) priceMinEl.value = '';
      if (priceMaxEl) priceMaxEl.value = '';
      if (sortEl) sortEl.value = 'newest';
      currentPage = 1;
      writeQuery({ search: '', sort: 'newest', page: 1, price_min: undefined, price_max: undefined });
      await refresh(true);
    });

    pagination?.querySelector('button[data-page="prev"]')?.addEventListener('click', async () => {
      if (currentPage <= 1) return;
      currentPage -= 1;
      await refresh(false);
    });

    pagination?.querySelector('button[data-page="next"]')?.addEventListener('click', async () => {
      if (currentPage >= totalPages) return;
      currentPage += 1;
      await refresh(false);
    });

    window.addEventListener('popstate', async () => {
      syncControlsFromQuery();
      await refresh(true);
    });

    syncControlsFromQuery();
    const q = readQuery();
    const hasParams = Array.from(new URL(window.location.href).searchParams.keys()).length > 0;
    if (hasParams && (q.search || q.sort !== 'newest' || q.page > 1 || typeof q.price_min === 'number' || typeof q.price_max === 'number')) {
      await refresh(true);
    }
  </script>
</Layout>
