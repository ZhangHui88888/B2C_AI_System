---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
---

<AdminLayout title="品牌管理" activePage="brands">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">品牌</h2>
        <p class="text-sm text-gray-600">管理您的店铺品牌及其设置</p>
      </div>
      <button id="add-brand-btn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        添加品牌
      </button>
    </div>

    <!-- Brands Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div id="brands-grid" class="contents"></div>
      <div id="brands-empty" class="col-span-full bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center hidden">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-1">暂无品牌</h3>
        <p class="text-gray-500 mb-4">创建您的第一个品牌开始</p>
        <button id="add-brand-empty-btn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">添加品牌
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Brand Modal -->
  <div id="brand-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100">
          <h3 id="modal-title" class="text-lg font-semibold text-gray-900">添加品牌</h3>
        </div>
        
        <form id="brand-form" class="p-6 space-y-4">
          <input type="hidden" id="brand-id" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">品牌名称 *</label>
            <input type="text" id="brand-name" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="我的店铺" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">别名 *</label>
            <input type="text" id="brand-slug" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 font-mono text-sm" placeholder="my-store" />
            <p class="text-xs text-gray-500 mt-1">URL 友好的标识符（从名称自动生成）</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">自定义域名</label>
            <input type="text" id="brand-domain" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="www.mystore.com" />
            <p class="text-xs text-gray-500 mt-1">可选：您的自定义域名（不含 https://）</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Logo 网址</label>
            <input type="url" id="brand-logo" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="https://..." />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">所有者邮箱 *</label>
            <input type="email" id="brand-owner" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="owner@example.com" />
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="brand-active" checked class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" />
            <label for="brand-active" class="ml-2 text-sm text-gray-700">活跃</label>
          </div>
          
          <div class="flex gap-3 pt-4">
            <button type="button" id="cancel-btn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
              取消
            </button>
            <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">保存品牌
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const apiBase = API_URL && API_URL.trim() ? API_URL.trim().replace(/\/$/, '') : '';
    const api = (path) => (apiBase ? `${apiBase}${path}` : path);
    const brandsGrid = document.getElementById('brands-grid');
    const brandsEmpty = document.getElementById('brands-empty');
    const modal = document.getElementById('brand-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('brand-form');
    const brandIdInput = document.getElementById('brand-id');
    const brandNameInput = document.getElementById('brand-name');
    const brandSlugInput = document.getElementById('brand-slug');
    const brandDomainInput = document.getElementById('brand-domain');
    const brandLogoInput = document.getElementById('brand-logo');
    const brandOwnerInput = document.getElementById('brand-owner');
    const brandActiveInput = document.getElementById('brand-active');

    function openModal(brand) {
      if (brand) {
        if (modalTitle) modalTitle.textContent = '编辑品牌';
        if (brandIdInput) brandIdInput.value = brand.id;
        if (brandNameInput) brandNameInput.value = brand.name;
        if (brandSlugInput) brandSlugInput.value = brand.slug;
        if (brandDomainInput) brandDomainInput.value = brand.domain || '';
        if (brandLogoInput) brandLogoInput.value = brand.logo_url || '';
        if (brandOwnerInput) brandOwnerInput.value = brand.owner_email;
        if (brandActiveInput) brandActiveInput.checked = brand.is_active;
      } else {
        if (modalTitle) modalTitle.textContent = '添加品牌';
        form?.reset();
        if (brandIdInput) brandIdInput.value = '';
        if (brandActiveInput) brandActiveInput.checked = true;
      }
      modal?.classList.remove('hidden');
    }

    function closeModal() {
      modal?.classList.add('hidden');
    }

    function generateSlug(name) {
      return name
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
    }

    // Auto-generate slug from name
    brandNameInput?.addEventListener('input', () => {
      if (brandIdInput && !brandIdInput.value) {
        if (brandSlugInput) brandSlugInput.value = generateSlug(brandNameInput.value);
      }
    });

    // Open modal buttons
    document.getElementById('add-brand-btn')?.addEventListener('click', () => openModal());
    document.getElementById('add-brand-empty-btn')?.addEventListener('click', () => openModal());
    document.getElementById('cancel-btn')?.addEventListener('click', closeModal);
    document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);

    function bindBrandRowEvents() {
      document.querySelectorAll('.edit-brand-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const raw = btn.dataset.brand || '';
          if (!raw) return;
          try {
            const brand = JSON.parse(decodeURIComponent(raw));
            openModal(brand);
          } catch {
            openModal();
          }
        });
      });

      document.querySelectorAll('.delete-brand-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const name = btn.dataset.name;
          if (!id) return;

          if (!confirm(`确定要删除 "${name || ''}" 吗？这将删除所有关联数据，包括产品、订单和设置。`)) {
            return;
          }

          try {
            const res = await fetch(api(`/api/admin/brands/${id}`), {
              method: 'DELETE',
            });

            if (res.ok) {
              window.location.reload();
            } else {
              const data = await res.json();
              alert(data.error || '删除品牌失败');
            }
          } catch {
            alert('删除品牌失败');
          }
        });
      });
    }

    function renderBrands(brands) {
      if (!brandsGrid) return;

      if (!brands || brands.length === 0) {
        brandsGrid.innerHTML = '';
        brandsEmpty?.classList.remove('hidden');
        return;
      }

      brandsEmpty?.classList.add('hidden');

      brandsGrid.innerHTML = brands
        .map((brand) => {
          const safeBrand = encodeURIComponent(JSON.stringify(brand));
          const logo = brand.logo_url
            ? `<img src="${brand.logo_url}" alt="${brand.name}" class="w-16 h-16 rounded-lg object-cover" />`
            : `<div class="w-16 h-16 bg-primary-100 rounded-lg flex items-center justify-center"><span class="text-2xl font-bold text-primary-600">${(brand.name || 'B').charAt(0)}</span></div>`;
          const domain = brand.domain
            ? `<a href="https://${brand.domain}" target="_blank" class="text-sm text-primary-600 hover:underline truncate block">${brand.domain}</a>`
            : '';
          const badge = brand.is_active
            ? 'bg-green-100 text-green-700'
            : 'bg-gray-100 text-gray-600';
          const badgeText = brand.is_active ? '活跃' : '停用';

          return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow">
              <div class="p-6">
                <div class="flex items-start gap-4">
                  ${logo}
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-900 truncate">${brand.name || ''}</h3>
                    <p class="text-sm text-gray-500 truncate">${brand.slug || ''}</p>
                    ${domain}
                  </div>
                  <span class="px-2 py-1 text-xs font-medium rounded-full ${badge}">${badgeText}</span>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100">
                  <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span class="text-gray-500">所有者</span>
                      <p class="font-medium text-gray-900 truncate" title="${brand.owner_email || ''}">${brand.owner_email || ''}</p>
                    </div>
                    <div>
                      <span class="text-gray-500">创建时间</span>
                      <p class="font-medium text-gray-900">${brand.created_at ? new Date(brand.created_at).toLocaleDateString() : ''}</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="px-6 py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
                <button class="edit-brand-btn text-sm text-primary-600 hover:text-primary-700 font-medium" data-brand="${safeBrand}">编辑</button>
                <div class="flex items-center gap-3">
                  <a href="/admin/brands/${brand.id}/settings" class="text-sm text-gray-600 hover:text-gray-700">设置</a>
                  <button class="delete-brand-btn text-sm text-red-600 hover:text-red-700" data-id="${brand.id}" data-name="${brand.name || ''}">删除</button>
                </div>
              </div>
            </div>
          `;
        })
        .join('');

      bindBrandRowEvents();
    }

    async function loadBrands() {
      try {
        const res = await fetch(api('/api/admin/brands'), { method: 'GET' });
        if (!res.ok) {
          renderBrands([]);
          return;
        }

        const data = await res.json();
        const brands = Array.isArray(data) ? data : (data?.brands || data?.data || []);
        renderBrands(brands);
      } catch {
        renderBrands([]);
      }
    }

    loadBrands();

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = brandIdInput ? brandIdInput.value : '';
      const data = {
        name: brandNameInput ? brandNameInput.value.trim() : '',
        slug: brandSlugInput ? brandSlugInput.value.trim() : '',
        domain: brandDomainInput ? (brandDomainInput.value.trim() || null) : null,
        logo_url: brandLogoInput ? (brandLogoInput.value.trim() || null) : null,
        owner_email: brandOwnerInput ? brandOwnerInput.value.trim() : '',
        is_active: brandActiveInput ? brandActiveInput.checked : true,
      };

      try {
        const url = id ? api(`/api/admin/brands/${id}`) : api('/api/admin/brands');
        
        const res = await fetch(url, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const result = await res.json();
          alert(result.error || '保存品牌失败');
        }
      } catch (err) {
        alert('保存品牌失败');
      }
    });
  </script>
</AdminLayout>
