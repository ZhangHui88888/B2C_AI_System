---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const chartData: any[] = [];

// Get date ranges
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

// Fetch orders for the last 30 days
const orders: any[] = [];

// Calculate stats
const totalRevenue = 0;
const totalOrders = 0;
const avgOrderValue = 0;

// Today's stats
const todayOrders: any[] = [];
const todayRevenue = 0;

// Last 7 days stats
const last7DaysOrders: any[] = [];
const last7DaysRevenue = 0;

// Customer count
const customerCount = 0;

// Product count
const productCount = 0;

// Group orders by date for chart
const dailyData = new Map();

// Fill missing dates
const current = new Date(thirtyDaysAgo);
while (current <= now) {
  const key = current.toISOString().split('T')[0];
  if (!dailyData.has(key)) {
    dailyData.set(key, { revenue: 0, orders: 0 });
  }
  current.setDate(current.getDate() + 1);
}

// chartData is client-loaded

// Product rankings from order items
const productSales = new Map();

const topProducts: any[] = [];

// Order status breakdown
const statusCounts: Record<string, number> = {};

function formatCurrency(value: number): string {
  return `$${value.toFixed(2)}`;
}

function formatChange(current: number, previous: number): { value: string; positive: boolean } {
  if (previous === 0) return { value: '+0%', positive: true };
  const change = ((current - previous) / previous) * 100;
  return {
    value: `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`,
    positive: change >= 0
  };
}
---

<AdminLayout title="数据分析" activePage="analytics">
  <!-- Time Range Selector -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-900">数据分析</h1>
    <select id="time-range" class="border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
      <option value="7">最近 7 天</option>
      <option value="30" selected>最近 30 天</option>
      <option value="90">最近 90 天</option>
    </select>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">总收入</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-total-revenue">{formatCurrency(totalRevenue)}</p>
          <p class="text-sm text-gray-500 mt-1">最近 30 天</p>
        </div>
        <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">总订单</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-total-orders">{totalOrders}</p>
          <p class="text-sm text-gray-500 mt-1">最近 30 天</p>
        </div>
        <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">平均订单金额</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-avg-order">{formatCurrency(avgOrderValue)}</p>
          <p class="text-sm text-gray-500 mt-1">最近 30 天</p>
        </div>
        <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">今日</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-today-revenue">{formatCurrency(todayRevenue)}</p>
          <p class="text-sm text-gray-500 mt-1"><span id="stat-today-orders">{todayOrders.length}</span> 笔订单</p>
        </div>
        <div class="w-12 h-12 bg-orange-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Sales Trend Chart -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">销售趋势</h2>
        <div class="flex gap-2">
          <button class="chart-toggle px-3 py-1 text-sm rounded-lg bg-primary-100 text-primary-700" data-metric="revenue">收入</button>
          <button class="chart-toggle px-3 py-1 text-sm rounded-lg text-gray-600 hover:bg-gray-100" data-metric="orders">订单</button>
        </div>
      </div>
      <div class="h-64">
        <canvas id="sales-chart"></canvas>
      </div>
    </div>

    <!-- Order Status Breakdown -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">订单状态</h2>
      <div class="space-y-3" id="status-breakdown"></div>
      <p class="text-sm text-gray-500 text-center py-4" id="status-empty">暂无订单</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Products -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">热销商品</h2>
        <span class="text-sm text-gray-500">按收入排序</span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-left text-sm text-gray-500 border-b">
              <th class="pb-3 font-medium">商品</th>
              <th class="pb-3 font-medium text-right">数量</th>
              <th class="pb-3 font-medium text-right">收入</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr>
              <td colspan="3" class="py-8 text-center text-sm text-gray-500" id="top-products-loading">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">快速统计</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">总客户数</p>
          <p class="text-xl font-bold text-gray-900" id="count-customers">{customerCount || 0}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">上架商品</p>
          <p class="text-xl font-bold text-gray-900" id="count-products">{productCount || 0}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">7日收入</p>
          <p class="text-xl font-bold text-gray-900" id="stat-7d-revenue">{formatCurrency(last7DaysRevenue)}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">7日订单</p>
          <p class="text-xl font-bold text-gray-900" id="stat-7d-orders">{last7DaysOrders.length}</p>
        </div>
      </div>

      <!-- Conversion Funnel Preview -->
      <div class="mt-6 pt-6 border-t border-gray-100">
        <h3 class="text-sm font-medium text-gray-900 mb-3">转化漏斗</h3>
        <div class="space-y-2" id="funnel-steps"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const apiBase = API_URL && API_URL.trim() ? API_URL.trim().replace(/\/$/, '') : '';
    const api = (path) => (apiBase ? `${apiBase}${path}` : path);

    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatCurrency(value) {
      const n = typeof value === 'number' ? value : Number(value);
      const v = Number.isFinite(n) ? n : 0;
      return `$${v.toFixed(2)}`;
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = String(value ?? '');
    }

    function renderStatusBreakdown(statusCounts, totalOrders) {
      const list = document.getElementById('status-breakdown');
      const empty = document.getElementById('status-empty');
      if (!list || !empty) return;

      const entries = statusCounts && typeof statusCounts === 'object' ? Object.entries(statusCounts) : [];
      if (!entries.length) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');

      const colors = {
        pending: 'bg-yellow-500',
        paid: 'bg-blue-500',
        shipped: 'bg-purple-500',
        delivered: 'bg-green-500',
      };

      list.innerHTML = entries
        .map(([status, count]) => {
          const c = typeof count === 'number' ? count : Number(count) || 0;
          const pct = totalOrders > 0 ? (c / totalOrders) * 100 : 0;
          const barClass = colors[status] || 'bg-gray-500';
          return `
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="capitalize text-gray-600">${escapeHtml(status)}</span>
                <span class="font-medium">${escapeHtml(c)} (${escapeHtml(pct.toFixed(1))}%)</span>
              </div>
              <div class="w-full bg-gray-100 rounded-full h-2">
                <div class="${escapeHtml(barClass)} h-2 rounded-full" style="width: ${pct}%"></div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    function renderTopProducts(topProducts) {
      const tbody = document.querySelector('table.w-full tbody.divide-y.divide-gray-100');
      if (!tbody) return;

      if (!Array.isArray(topProducts) || topProducts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="py-8 text-center text-sm text-gray-500">暂无销售数据</td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = topProducts
        .map((product, index) => {
          const name = product?.name || '未知商品';
          const quantity = product?.quantity || 0;
          const revenue = product?.revenue || 0;
          return `
            <tr>
              <td class="py-3">
                <div class="flex items-center gap-2">
                  <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-medium text-gray-600">${index + 1}</span>
                  <span class="text-sm font-medium text-gray-900 truncate max-w-[200px]">${escapeHtml(name)}</span>
                </div>
              </td>
              <td class="py-3 text-sm text-right text-gray-600">${escapeHtml(quantity)}</td>
              <td class="py-3 text-sm text-right font-medium text-gray-900">${escapeHtml(formatCurrency(revenue))}</td>
            </tr>
          `;
        })
        .join('');
    }

    function renderFunnel(totalOrders, statusCounts) {
      const el = document.getElementById('funnel-steps');
      if (!el) return;
      const counts = statusCounts && typeof statusCounts === 'object' ? statusCounts : {};
      const paid = (counts['paid'] || 0) + (counts['shipped'] || 0) + (counts['delivered'] || 0);
      const shipped = (counts['shipped'] || 0) + (counts['delivered'] || 0);
      const delivered = counts['delivered'] || 0;

      const steps = [
        { stage: '已下单', count: totalOrders },
        { stage: '已支付', count: paid },
        { stage: '已发货', count: shipped },
        { stage: '已送达', count: delivered },
      ];

      el.innerHTML = steps
        .map((step) => {
          const pct = totalOrders > 0 ? (step.count / totalOrders) * 100 : 0;
          return `
            <div class="flex items-center gap-3">
              <div class="w-24 text-xs text-gray-500">${escapeHtml(step.stage)}</div>
              <div class="flex-1 bg-gray-100 rounded-full h-2">
                <div class="bg-primary-500 h-2 rounded-full transition-all" style="width: ${pct}%"></div>
              </div>
              <div class="w-12 text-xs text-right font-medium">${escapeHtml(step.count)}</div>
            </div>
          `;
        })
        .join('');
    }

    let chart = null;
    let currentMetric = 'revenue';
    let currentChartData = [];

    function initOrUpdateChart(chartData) {
      const ctx = document.getElementById('sales-chart');
      if (!ctx || typeof Chart === 'undefined') return;

      currentChartData = Array.isArray(chartData) ? chartData : [];

      const labels = currentChartData.map((d) => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });

      const series = currentChartData.map((d) => (currentMetric === 'orders' ? d.orders : d.revenue));

      if (!chart) {
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: currentMetric === 'orders' ? 'Orders' : 'Revenue',
                data: series,
                borderColor: 'rgb(79, 70, 229)',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.raw;
                    if (currentMetric === 'orders') return `${value}`;
                    return `$${Number(value || 0).toFixed(2)}`;
                  },
                },
              },
            },
            scales: {
              x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } },
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => (currentMetric === 'orders' ? value : `$${value}`),
                },
              },
            },
          },
        });
        return;
      }

      chart.data.labels = labels;
      chart.data.datasets[0].data = series;
      chart.data.datasets[0].label = currentMetric === 'orders' ? 'Orders' : 'Revenue';
      chart.update();
    }

    function bindChartToggles() {
      document.querySelectorAll('.chart-toggle').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.chart-toggle').forEach((b) => {
            b.classList.remove('bg-primary-100', 'text-primary-700');
            b.classList.add('text-gray-600');
          });

          const t = e.currentTarget;
          t.classList.add('bg-primary-100', 'text-primary-700');
          t.classList.remove('text-gray-600');

          currentMetric = t.dataset.metric || 'revenue';
          initOrUpdateChart(currentChartData);
        });
      });
    }

    async function loadPageData(days) {
      try {
        const res = await fetch(api(`/api/admin/analytics/page-data?days=${days}`));
        if (!res.ok) return;
        const data = await res.json();

        const stats = data?.stats || {};
        const counts = data?.counts || {};
        const statusCounts = data?.statusCounts || {};

        setText('stat-total-revenue', formatCurrency(stats.totalRevenue || 0));
        setText('stat-total-orders', stats.totalOrders || 0);
        setText('stat-avg-order', formatCurrency(stats.avgOrderValue || 0));
        setText('stat-today-revenue', formatCurrency(stats.todayRevenue || 0));
        setText('stat-today-orders', stats.todayOrders || 0);

        setText('count-customers', counts.customerCount || 0);
        setText('count-products', counts.productCount || 0);
        setText('stat-7d-revenue', formatCurrency(stats.last7DaysRevenue || 0));
        setText('stat-7d-orders', stats.last7DaysOrders || 0);

        renderStatusBreakdown(statusCounts, stats.totalOrders || 0);
        renderTopProducts(data?.topProducts || []);
        renderFunnel(stats.totalOrders || 0, statusCounts);

        initOrUpdateChart(data?.chartData || []);
      } catch {
        // ignore
      }
    }

    bindChartToggles();

    const range = document.getElementById('time-range');
    range?.addEventListener('change', () => {
      const days = Number(range.value || 30) || 30;
      loadPageData(days);
    });

    setTimeout(() => loadPageData(30), 0);
  </script>
</AdminLayout>
