---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Get date ranges
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

// Fetch orders for the last 30 days
const { data: orders } = await supabase
  .from('orders')
  .select('id, total, status, created_at, items, customer_email')
  .gte('created_at', thirtyDaysAgo.toISOString())
  .not('status', 'in', '("cancelled","refunded")')
  .order('created_at', { ascending: true });

// Calculate stats
const totalRevenue = orders?.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0) || 0;
const totalOrders = orders?.length || 0;
const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

// Today's stats
const todayOrders = orders?.filter(o => new Date(o.created_at) >= today) || [];
const todayRevenue = todayOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);

// Last 7 days stats
const last7DaysOrders = orders?.filter(o => new Date(o.created_at) >= sevenDaysAgo) || [];
const last7DaysRevenue = last7DaysOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);

// Customer count
const { count: customerCount } = await supabase
  .from('customers')
  .select('*', { count: 'exact', head: true });

// Product count
const { count: productCount } = await supabase
  .from('products')
  .select('*', { count: 'exact', head: true })
  .eq('is_active', true);

// Group orders by date for chart
const dailyData = new Map<string, { revenue: number; orders: number }>();
orders?.forEach(order => {
  const date = order.created_at.split('T')[0];
  const existing = dailyData.get(date) || { revenue: 0, orders: 0 };
  existing.revenue += parseFloat(order.total) || 0;
  existing.orders += 1;
  dailyData.set(date, existing);
});

// Fill missing dates
const current = new Date(thirtyDaysAgo);
while (current <= now) {
  const key = current.toISOString().split('T')[0];
  if (!dailyData.has(key)) {
    dailyData.set(key, { revenue: 0, orders: 0 });
  }
  current.setDate(current.getDate() + 1);
}

const chartData = Array.from(dailyData.entries())
  .sort((a, b) => a[0].localeCompare(b[0]))
  .map(([date, data]) => ({ date, ...data }));

// Product rankings from order items
const productSales = new Map<string, { name: string; quantity: number; revenue: number }>();
orders?.forEach(order => {
  const items = order.items || [];
  items.forEach((item: any) => {
    const id = item.product_id || item.id || 'unknown';
    const existing = productSales.get(id) || { name: item.name || '', quantity: 0, revenue: 0 };
    existing.quantity += item.quantity || 1;
    existing.revenue += (item.price || 0) * (item.quantity || 1);
    existing.name = item.name || existing.name;
    productSales.set(id, existing);
  });
});

const topProducts = Array.from(productSales.entries())
  .map(([id, data]) => ({ id, ...data }))
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 10);

// Order status breakdown
const statusCounts = orders?.reduce((acc, o) => {
  acc[o.status] = (acc[o.status] || 0) + 1;
  return acc;
}, {} as Record<string, number>) || {};

function formatCurrency(value: number): string {
  return `$${value.toFixed(2)}`;
}

function formatChange(current: number, previous: number): { value: string; positive: boolean } {
  if (previous === 0) return { value: '+0%', positive: true };
  const change = ((current - previous) / previous) * 100;
  return {
    value: `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`,
    positive: change >= 0
  };
}
---

<AdminLayout title="Analytics" activePage="analytics">
  <!-- Time Range Selector -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Analytics Dashboard</h1>
    <select id="time-range" class="border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
      <option value="7">Last 7 days</option>
      <option value="30" selected>Last 30 days</option>
      <option value="90">Last 90 days</option>
    </select>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Total Revenue</p>
          <p class="text-2xl font-bold text-gray-900 mt-1">{formatCurrency(totalRevenue)}</p>
          <p class="text-sm text-gray-500 mt-1">Last 30 days</p>
        </div>
        <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Total Orders</p>
          <p class="text-2xl font-bold text-gray-900 mt-1">{totalOrders}</p>
          <p class="text-sm text-gray-500 mt-1">Last 30 days</p>
        </div>
        <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Avg Order Value</p>
          <p class="text-2xl font-bold text-gray-900 mt-1">{formatCurrency(avgOrderValue)}</p>
          <p class="text-sm text-gray-500 mt-1">Last 30 days</p>
        </div>
        <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Today</p>
          <p class="text-2xl font-bold text-gray-900 mt-1">{formatCurrency(todayRevenue)}</p>
          <p class="text-sm text-gray-500 mt-1">{todayOrders.length} orders</p>
        </div>
        <div class="w-12 h-12 bg-orange-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Sales Trend Chart -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Sales Trend</h2>
        <div class="flex gap-2">
          <button class="chart-toggle px-3 py-1 text-sm rounded-lg bg-primary-100 text-primary-700" data-metric="revenue">Revenue</button>
          <button class="chart-toggle px-3 py-1 text-sm rounded-lg text-gray-600 hover:bg-gray-100" data-metric="orders">Orders</button>
        </div>
      </div>
      <div class="h-64">
        <canvas id="sales-chart"></canvas>
      </div>
    </div>

    <!-- Order Status Breakdown -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Order Status</h2>
      <div class="space-y-3">
        {Object.entries(statusCounts).map(([status, count]) => {
          const percentage = totalOrders > 0 ? (count / totalOrders * 100) : 0;
          const colors: Record<string, string> = {
            pending: 'bg-yellow-500',
            paid: 'bg-blue-500',
            shipped: 'bg-purple-500',
            delivered: 'bg-green-500',
          };
          return (
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="capitalize text-gray-600">{status}</span>
                <span class="font-medium">{count} ({percentage.toFixed(1)}%)</span>
              </div>
              <div class="w-full bg-gray-100 rounded-full h-2">
                <div class={`${colors[status] || 'bg-gray-500'} h-2 rounded-full`} style={`width: ${percentage}%`}></div>
              </div>
            </div>
          );
        })}
        {Object.keys(statusCounts).length === 0 && (
          <p class="text-sm text-gray-500 text-center py-4">No orders yet</p>
        )}
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Products -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Top Products</h2>
        <span class="text-sm text-gray-500">By revenue</span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-left text-sm text-gray-500 border-b">
              <th class="pb-3 font-medium">Product</th>
              <th class="pb-3 font-medium text-right">Qty</th>
              <th class="pb-3 font-medium text-right">Revenue</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {topProducts.length > 0 ? topProducts.map((product, index) => (
              <tr>
                <td class="py-3">
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-medium text-gray-600">
                      {index + 1}
                    </span>
                    <span class="text-sm font-medium text-gray-900 truncate max-w-[200px]">{product.name || 'Unknown'}</span>
                  </div>
                </td>
                <td class="py-3 text-sm text-right text-gray-600">{product.quantity}</td>
                <td class="py-3 text-sm text-right font-medium text-gray-900">{formatCurrency(product.revenue)}</td>
              </tr>
            )) : (
              <tr>
                <td colspan="3" class="py-8 text-center text-sm text-gray-500">No sales data yet</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Stats</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Total Customers</p>
          <p class="text-xl font-bold text-gray-900">{customerCount || 0}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">Active Products</p>
          <p class="text-xl font-bold text-gray-900">{productCount || 0}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">7-Day Revenue</p>
          <p class="text-xl font-bold text-gray-900">{formatCurrency(last7DaysRevenue)}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500">7-Day Orders</p>
          <p class="text-xl font-bold text-gray-900">{last7DaysOrders.length}</p>
        </div>
      </div>

      <!-- Conversion Funnel Preview -->
      <div class="mt-6 pt-6 border-t border-gray-100">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Conversion Funnel</h3>
        <div class="space-y-2">
          {[
            { stage: 'Orders Placed', count: totalOrders },
            { stage: 'Paid', count: statusCounts['paid'] || 0 + (statusCounts['shipped'] || 0) + (statusCounts['delivered'] || 0) },
            { stage: 'Shipped', count: (statusCounts['shipped'] || 0) + (statusCounts['delivered'] || 0) },
            { stage: 'Delivered', count: statusCounts['delivered'] || 0 },
          ].map((step, i) => (
            <div class="flex items-center gap-3">
              <div class="w-24 text-xs text-gray-500">{step.stage}</div>
              <div class="flex-1 bg-gray-100 rounded-full h-2">
                <div 
                  class="bg-primary-500 h-2 rounded-full transition-all" 
                  style={`width: ${totalOrders > 0 ? (step.count / totalOrders * 100) : 0}%`}
                ></div>
              </div>
              <div class="w-12 text-xs text-right font-medium">{step.count}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script define:vars={{ chartData }}>
    // Initialize chart
    const ctx = document.getElementById('sales-chart');
    if (ctx) {
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }),
          datasets: [{
            label: 'Revenue',
            data: chartData.map(d => d.revenue),
            borderColor: 'rgb(79, 70, 229)',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  return `$${value.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { maxTicksLimit: 10 }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: (value) => `$${value}`
              }
            }
          }
        }
      });

      // Toggle between revenue and orders
      document.querySelectorAll('.chart-toggle').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.chart-toggle').forEach(b => {
            b.classList.remove('bg-primary-100', 'text-primary-700');
            b.classList.add('text-gray-600');
          });
          e.target.classList.add('bg-primary-100', 'text-primary-700');
          e.target.classList.remove('text-gray-600');

          const metric = e.target.dataset.metric;
          chart.data.datasets[0].data = chartData.map(d => metric === 'orders' ? d.orders : d.revenue);
          chart.data.datasets[0].label = metric === 'orders' ? 'Orders' : 'Revenue';
          chart.options.scales.y.ticks.callback = metric === 'orders' 
            ? (value) => value 
            : (value) => `$${value}`;
          chart.update();
        });
      });
    }
  </script>
</AdminLayout>
