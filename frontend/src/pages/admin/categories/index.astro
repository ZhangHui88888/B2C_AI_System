---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const defaultBrandId = '';
---

<AdminLayout title="分类管理" activePage="categories">
  <div class="max-w-4xl">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <p id="categories-count" class="text-sm text-gray-500">加载中...</p>
      </div>
      <button id="add-category-btn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        添加分类
      </button>
    </div>

    <!-- Categories List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div id="categories-list" class="divide-y divide-gray-100"></div>
      <div id="categories-empty" class="px-6 py-12 text-center hidden">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">暂无分类</h3>
        <p class="mt-1 text-sm text-gray-500">创建一个新分类开始吧</p>
        <button id="add-category-empty" class="mt-4 inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">
          添加分类
        </button>
      </div>
    </div>
  </div>

  <!-- Category Modal -->
  <div id="category-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 id="modal-title" class="text-lg font-medium text-gray-900">添加分类</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <form id="category-form" class="p-6 space-y-4">
          <input type="hidden" id="category-id" name="id" />
          <input type="hidden" id="category-brand-id" name="brand_id" value={defaultBrandId} />
          
          <div>
            <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">名称 *</label>
            <input
              type="text"
              id="category-name"
              name="name"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="分类名称"
            />
          </div>

          <div>
            <label for="category-slug" class="block text-sm font-medium text-gray-700 mb-1">别名 *</label>
            <input
              type="text"
              id="category-slug"
              name="slug"
              required
              pattern="[a-z0-9-]+"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="category-slug"
            />
            <p class="mt-1 text-xs text-gray-500">只允许小写字母、数字和连字符</p>
          </div>

          <div>
            <label for="category-parent" class="block text-sm font-medium text-gray-700 mb-1">父分类</label>
            <select
              id="category-parent"
              name="parent_id"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">无（顶级分类）</option>
            </select>
          </div>

          <div>
            <label for="category-description" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
            <textarea
              id="category-description"
              name="description"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="分类描述..."
            ></textarea>
          </div>

          <div>
            <label for="category-image" class="block text-sm font-medium text-gray-700 mb-1">图片 URL</label>
            <input
              type="url"
              id="category-image"
              name="image_url"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="https://..."
            />
          </div>

          <div>
            <label for="category-sort" class="block text-sm font-medium text-gray-700 mb-1">排序</label>
            <input
              type="number"
              id="category-sort"
              name="sort_order"
              min="0"
              value="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
            <p class="mt-1 text-xs text-gray-500">数字越小排序越前</p>
          </div>

          <div class="flex items-center">
            <input
              type="checkbox"
              id="category-active"
              name="is_active"
              checked
              class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
            />
            <label for="category-active" class="ml-2 block text-sm text-gray-700">启用（在店铺中显示）</label>
          </div>

          <div class="pt-4 flex gap-3">
            <button type="button" id="cancel-modal" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              取消
            </button>
            <button type="submit" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
              保存
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50"></div>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const modal = document.getElementById('category-modal');
    const form = document.getElementById('category-form');
    const toast = document.getElementById('toast');
    const categoriesList = document.getElementById('categories-list');
    const categoriesEmpty = document.getElementById('categories-empty');
    const categoriesCount = document.getElementById('categories-count');

    const brandIdInput = document.getElementById('category-brand-id');
    const parentSelect = document.getElementById('category-parent');

    let categories = [];
    let isEditing = false;

    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }

    function showToast(message, type = 'success') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    function populateParentOptions(currentCategoryId) {
      if (!parentSelect) return;
      const topLevel = categories.filter((c) => !c.parent_id);
      parentSelect.innerHTML = '<option value="">无（顶级分类）</option>';
      topLevel.forEach((c) => {
        if (currentCategoryId && c.id === currentCategoryId) return;
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        parentSelect.appendChild(opt);
      });
    }

    function openModal(category) {
      if (!modal) return;
      isEditing = !!category;
      
      const title = document.getElementById('modal-title');
      if (title) title.textContent = isEditing ? '编辑分类' : '添加分类';
      
      form?.reset();

      const currentBrandId = getCookie('brand_id');
      if (brandIdInput && currentBrandId) {
        brandIdInput.value = currentBrandId;
      }

      populateParentOptions(category?.id);
      
      if (category) {
        const idEl = document.getElementById('category-id');
        const nameEl = document.getElementById('category-name');
        const slugEl = document.getElementById('category-slug');
        const parentEl = document.getElementById('category-parent');
        const descEl = document.getElementById('category-description');
        const imgEl = document.getElementById('category-image');
        const sortEl = document.getElementById('category-sort');
        const activeEl = document.getElementById('category-active');

        if (idEl) idEl.value = category.id || '';
        if (nameEl) nameEl.value = category.name || '';
        if (slugEl) slugEl.value = category.slug || '';
        if (parentEl) parentEl.value = category.parent_id || '';
        if (descEl) descEl.value = category.description || '';
        if (imgEl) imgEl.value = category.image_url || '';
        if (sortEl) sortEl.value = (category.sort_order ?? 0).toString();
        if (activeEl) activeEl.checked = category.is_active !== false;
      }
      
      modal.classList.remove('hidden');
    }

    function closeModal() {
      modal?.classList.add('hidden');
    }

    // Auto-generate slug
    document.getElementById('category-name')?.addEventListener('input', (e) => {
      const slugInput = document.getElementById('category-slug');
      if (slugInput && !slugInput.dataset.manuallyEdited) {
        slugInput.value = e.target.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
      }
    });

    document.getElementById('category-slug')?.addEventListener('input', (e) => {
      e.target.dataset.manuallyEdited = 'true';
    });

    // Open modal buttons
    document.getElementById('add-category-btn')?.addEventListener('click', () => openModal());
    document.getElementById('add-category-empty')?.addEventListener('click', () => openModal());

    // Close modal
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('cancel-modal')?.addEventListener('click', closeModal);
    document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);

    function bindRowEvents() {
      document.querySelectorAll('.edit-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const categoryData = e.currentTarget?.dataset?.category;
          if (!categoryData) return;
          try {
            const category = JSON.parse(decodeURIComponent(categoryData));
            openModal(category);
          } catch {
            showToast('加载分类数据失败', 'error');
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget?.dataset?.id;
          const name = e.currentTarget?.dataset?.name;

          if (!id || !confirm(`确定要删除「${name}」吗？`)) return;

          try {
            const res = await fetch(`${API_URL}/api/admin/categories/${id}`, { method: 'DELETE' });
            const result = await res.json();

            if (res.ok && result.success) {
              showToast('分类删除成功！');
              setTimeout(() => window.location.reload(), 500);
            } else {
              showToast(result.error || '删除分类失败', 'error');
            }
          } catch {
            showToast('删除分类失败', 'error');
          }
        });
      });
    }

    function buildTree(items) {
      const map = new Map();
      const roots = [];
      items.forEach((item) => map.set(item.id, { ...item, children: [] }));
      items.forEach((item) => {
        const node = map.get(item.id);
        if (item.parent_id && map.has(item.parent_id)) {
          map.get(item.parent_id).children.push(node);
        } else {
          roots.push(node);
        }
      });
      return roots;
    }

    function renderCategoryRow(category, isChild) {
      const safeCategory = encodeURIComponent(JSON.stringify(category));
      const badge = category.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
      const badgeText = category.is_active ? '已启用' : '已禁用';
      const productsCount = category.products?.[0]?.count || 0;
      const imgSize = isChild ? 'w-8 h-8' : 'w-10 h-10';
      const iconSize = isChild ? 'w-4 h-4' : 'w-5 h-5';
      const nameClass = isChild ? 'font-medium text-gray-900 text-sm' : 'font-medium text-gray-900';
      const metaClass = isChild ? 'text-xs text-gray-500' : 'text-sm text-gray-500';
      const image = category.image_url
        ? `<img src="${category.image_url}" alt="${category.name}" class="${imgSize} rounded-lg object-cover" />`
        : `<div class="${imgSize} rounded-lg bg-gray-100 flex items-center justify-center"><svg class="${iconSize} text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></div>`;
      const editIcon = isChild
        ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>'
        : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>';
      const delIcon = isChild
        ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>'
        : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';

      return `
        <div class="flex items-center justify-between px-6 ${isChild ? 'py-3' : 'py-4'} hover:bg-gray-50">
          <div class="flex items-center gap-4">
            ${image}
            <div>
              <div class="flex items-center gap-2">
                <span class="${nameClass}">${category.name}</span>
                <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full ${badge}">${badgeText}</span>
              </div>
              <div class="${metaClass}">/${category.slug} • ${productsCount} products</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="edit-btn p-2 text-gray-500 hover:text-primary-600 hover:bg-gray-100 rounded-lg" data-category="${safeCategory}">${editIcon}</button>
            <button class="delete-btn p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg" data-id="${category.id}" data-name="${category.name}">${delIcon}</button>
          </div>
        </div>
      `;
    }

    function renderCategories(tree) {
      if (!categoriesList) return;

      if (!tree || tree.length === 0) {
        categoriesList.innerHTML = '';
        categoriesEmpty?.classList.remove('hidden');
        if (categoriesCount) categoriesCount.textContent = '共 0 个分类';
        populateParentOptions();
        return;
      }

      categoriesEmpty?.classList.add('hidden');

      categoriesList.innerHTML = tree
        .map((category) => {
          const children = category.children || [];
          const childHtml = children.length
            ? `
              <div class="pl-10 border-l-2 border-gray-100 ml-6">
                ${children.map((child) => renderCategoryRow(child, true)).join('')}
              </div>
            `
            : '';

          return `
            <div class="category-item" data-id="${category.id}">
              ${renderCategoryRow(category, false)}
              ${childHtml}
            </div>
          `;
        })
        .join('');

      const total = categories.length;
      if (categoriesCount) categoriesCount.textContent = `共 ${total} 个分类`;
      populateParentOptions();
      bindRowEvents();
    }

    async function loadCategories() {
      const brandId = getCookie('brand_id');
      if (!brandId || brandId === 'all') {
        if (categoriesList) {
          categoriesList.innerHTML = '<div class="px-6 py-12 text-center text-gray-500">请先在右上角选择一个品牌</div>';
        }
        categoriesEmpty?.classList.add('hidden');
        if (categoriesCount) categoriesCount.textContent = '请选择品牌';
        populateParentOptions();
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/admin/categories`, { method: 'GET' });
        const result = await res.json();
        if (!res.ok || !result?.success) {
          categories = [];
          renderCategories([]);
          return;
        }

        categories = Array.isArray(result.categories) ? result.categories : [];
        const tree = buildTree(categories);
        renderCategories(tree);
      } catch {
        categories = [];
        renderCategories([]);
      }
    }

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const id = formData.get('id');
      const currentBrandId = getCookie('brand_id');
      
      const data = {
        brand_id: currentBrandId || formData.get('brand_id'),
        name: formData.get('name'),
        slug: formData.get('slug'),
        parent_id: formData.get('parent_id') || null,
        description: formData.get('description') || null,
        image_url: formData.get('image_url') || null,
        sort_order: parseInt(formData.get('sort_order') || '0') || 0,
        is_active: formData.has('is_active'),
      };

      try {
        const url = id ? `${API_URL}/api/admin/categories/${id}` : `${API_URL}/api/admin/categories`;
        const method = id ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (res.ok && result.success) {
          showToast(id ? '分类已更新！' : '分类已创建！');
          closeModal();
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || '保存分类失败', 'error');
        }
      } catch {
        showToast('保存分类失败', 'error');
      }
    });

    loadCategories();
  </script>
</AdminLayout>
