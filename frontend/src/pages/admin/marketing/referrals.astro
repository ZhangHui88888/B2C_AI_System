---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const statusColors: Record<string, string> = {
  pending: 'bg-yellow-100 text-yellow-700',
  completed: 'bg-green-100 text-green-700',
  expired: 'bg-gray-100 text-gray-700',
  cancelled: 'bg-red-100 text-red-700',
};
---

<AdminLayout title="推荐计划" activePage="marketing">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">推荐计划</h2>
      <p class="text-gray-600 mt-1">配置和管理您的推荐奖励</p>
    </div>
    <div class="flex gap-3">
      <a href="/admin/marketing/loyalty" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium">
        ← 会员计划
      </a>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">总推荐数</p>
      <p class="text-2xl font-bold text-gray-900" id="stat-total">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">已完成</p>
      <p class="text-2xl font-bold text-green-600" id="stat-completed">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">转化率</p>
      <p class="text-2xl font-bold text-blue-600"><span id="stat-conversion">0</span>%</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">推荐收入</p>
      <p class="text-2xl font-bold text-purple-600" id="stat-revenue">$0.00</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Configuration -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900">配置</h3>
          <span id="config-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">加载中</span>
        </div>
        <form id="config-form" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">推荐人奖励（积分）</label>
            <input type="number" name="referrer_points" value={100} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">被推荐人奖励（积分）</label>
            <input type="number" name="referee_points" value={50} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">或被推荐人折扣 (%)</label>
            <input type="number" name="referee_discount_percent" value={''} placeholder="e.g., 10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">最低订单金额</label>
            <input type="number" name="min_order_amount" value={0} step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">每客户最大推荐数</label>
            <input type="number" name="max_referrals_per_customer" value={''} placeholder="无限制" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">分享消息</label>
            <textarea name="share_message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">Join using my referral code and get a special discount!</textarea>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" name="require_first_purchase" id="require_first_purchase" checked={true} class="rounded border-gray-300 text-primary-600 focus:ring-primary-500" />
            <label for="require_first_purchase" class="text-sm text-gray-700">需要首次购买才能完成</label>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" name="is_active" id="is_active" checked={false} class="rounded border-gray-300 text-primary-600 focus:ring-primary-500" />
            <label for="is_active" class="text-sm text-gray-700">计划已启用</label>
          </div>

          <button type="submit" class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium">
            保存配置
          </button>
        </form>
      </div>
    </div>

    <!-- Referrals List -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100">
        <div class="px-6 py-4 border-b border-gray-100">
          <h3 class="font-semibold text-gray-900">最近推荐</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">推荐人</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">被推荐人</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">订单</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">日期</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <tr id="referrals-loading">
                <td colspan="5" class="px-6 py-12 text-center text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || '';
  const apiBase = API_URL && API_URL.trim() ? API_URL.trim().replace(/\/$/, '') : '';
  const api = (path) => (apiBase ? `${apiBase}${path}` : path);

  const STATUS_COLORS: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-700',
    completed: 'bg-green-100 text-green-700',
    expired: 'bg-gray-100 text-gray-700',
    cancelled: 'bg-red-100 text-red-700',
  };

  function escapeHtml(str: any) {
    return String(str ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatMoney(amount: any) {
    const n = typeof amount === 'number' ? amount : Number(amount);
    const v = Number.isFinite(n) ? n : 0;
    return `$${v.toFixed(2)}`;
  }

  function setText(id: string, value: any) {
    const el = document.getElementById(id);
    if (el) el.textContent = String(value ?? '');
  }

  function setConfigStatus(isActive: boolean | null | undefined) {
    const el = document.getElementById('config-status');
    if (!el) return;
    const active = !!isActive;
    el.textContent = active ? '活跃' : '停用';
    el.classList.remove('bg-green-100', 'text-green-700', 'bg-gray-100', 'text-gray-600');
    if (active) {
      el.classList.add('bg-green-100', 'text-green-700');
    } else {
      el.classList.add('bg-gray-100', 'text-gray-600');
    }
  }

  function setField(name: string, value: any) {
    const form = document.getElementById('config-form') as HTMLFormElement | null;
    const el = form?.querySelector(`[name="${name}"]`) as HTMLInputElement | HTMLTextAreaElement | null;
    if (!el) return;

    if (el instanceof HTMLInputElement && el.type === 'checkbox') {
      el.checked = !!value;
      return;
    }

    (el as any).value = value ?? '';
  }

  function renderReferrals(rows: any[]) {
    const tbody = document.querySelector('tbody.divide-y.divide-gray-100');
    if (!tbody) return;

    if (!Array.isArray(rows) || rows.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-12 text-center text-gray-500">暂无推荐。与客户分享推荐码开始。</td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = rows
      .map((r: any) => {
        const referrerName = `${r?.referrer?.first_name || ''} ${r?.referrer?.last_name || ''}`.trim();
        const refereeName = `${r?.referee?.first_name || ''} ${r?.referee?.last_name || ''}`.trim();
        const status = String(r?.status || '');
        const cls = STATUS_COLORS[status] || 'bg-gray-100';
        const orderAmount = r?.order_amount ? formatMoney(r.order_amount) : '-';
        const date = r?.referred_at ? new Date(r.referred_at).toLocaleDateString() : '-';

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <p class="text-sm font-medium text-gray-900">${escapeHtml(referrerName)}</p>
              <p class="text-xs text-gray-500">${escapeHtml(r?.referrer?.email || '')}</p>
            </td>
            <td class="px-6 py-4">
              <p class="text-sm font-medium text-gray-900">${escapeHtml(refereeName)}</p>
              <p class="text-xs text-gray-500">${escapeHtml(r?.referee?.email || '')}</p>
            </td>
            <td class="px-6 py-4">
              <span class="text-xs px-2 py-1 rounded ${escapeHtml(cls)}">${escapeHtml(status)}</span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(orderAmount)}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(date)}</td>
          </tr>
        `;
      })
      .join('');
  }

  async function loadPageData() {
    try {
      const res = await fetch(api('/api/admin/marketing/referrals/page-data'));
      if (!res.ok) return;
      const data = await res.json();

      const stats = data?.stats || {};
      setText('stat-total', stats.total || 0);
      setText('stat-completed', stats.completed || 0);
      setText('stat-conversion', stats.conversionRate || 0);
      setText('stat-revenue', formatMoney(stats.totalRevenue || 0));

      setConfigStatus(data?.config?.is_active);

      const cfg = data?.config || {};
      setField('referrer_points', cfg.referrer_points ?? 100);
      setField('referee_points', cfg.referee_points ?? 50);
      setField('referee_discount_percent', cfg.referee_discount_percent ?? '');
      setField('min_order_amount', cfg.min_order_amount ?? 0);
      setField('max_referrals_per_customer', cfg.max_referrals_per_customer ?? '');
      setField('share_message', cfg.share_message ?? 'Join using my referral code and get a special discount!');
      setField('require_first_purchase', cfg.require_first_purchase !== false);
      setField('is_active', !!cfg.is_active);

      renderReferrals(data?.referrals || []);
    } catch {
      // ignore
    }
  }

  document.getElementById('config-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);

    const config = {
      referrer_points: parseInt(formData.get('referrer_points') as string) || 0,
      referee_points: parseInt(formData.get('referee_points') as string) || 0,
      referee_discount_percent: parseFloat(formData.get('referee_discount_percent') as string) || null,
      min_order_amount: parseFloat(formData.get('min_order_amount') as string) || 0,
      max_referrals_per_customer: parseInt(formData.get('max_referrals_per_customer') as string) || null,
      share_message: formData.get('share_message') as string,
      require_first_purchase: formData.has('require_first_purchase'),
      is_active: formData.has('is_active'),
    };

    try {
      const response = await fetch(api('/api/admin/marketing/referrals/config'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config),
      });

      if (response.ok) {
        alert('配置已保存！');
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || '保存配置失败');
      }
    } catch (error) {
      alert('保存配置失败');
    }
  });

  setTimeout(loadPageData, 0);
</script>
