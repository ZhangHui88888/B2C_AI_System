---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 20;
const offset = (page - 1) * limit;

const { data: products, count } = await supabase
  .from('products')
  .select('id, name, slug, price, compare_price, is_active, is_featured, stock_quantity, created_at, images', { count: 'exact' })
  .order('created_at', { ascending: false })
  .range(offset, offset + limit - 1);

const totalPages = Math.ceil((count || 0) / limit);
---

<AdminLayout title="Products" activePage="products">
  <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <p class="text-sm text-gray-500">{count || 0} total products</p>
    </div>
    <div class="flex items-center gap-3">
      <!-- Batch Actions (hidden by default) -->
      <div id="batch-actions" class="hidden items-center gap-2">
        <span id="selected-count" class="text-sm text-gray-600">0 selected</span>
        <button id="batch-activate" class="px-3 py-1.5 text-sm font-medium text-green-700 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
          Activate
        </button>
        <button id="batch-deactivate" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
          Deactivate
        </button>
        <button id="batch-delete" class="px-3 py-1.5 text-sm font-medium text-red-700 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
          Delete
        </button>
      </div>
      <a href="/admin/products/new" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Add Product
      </a>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left">
            <input type="checkbox" id="select-all" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" />
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {products && products.length > 0 ? (
          products.map((product) => {
            const images = product.images as string[] | null;
            const thumbnail = images?.[0] || '/placeholder.jpg';
            return (
              <tr class="hover:bg-gray-50 product-row" data-id={product.id}>
                <td class="px-4 py-4">
                  <input type="checkbox" class="product-checkbox h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" data-id={product.id} />
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                      <img class="h-10 w-10 rounded-lg object-cover" src={thumbnail} alt={product.name} />
                    </div>
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900">{product.name}</div>
                      <div class="text-sm text-gray-500">{product.slug}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${product.price?.toFixed(2)}</div>
                  {product.compare_price && (
                    <div class="text-sm text-gray-500 line-through">${product.compare_price.toFixed(2)}</div>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {product.stock_quantity === null ? 'âˆž' : product.stock_quantity}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${product.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                    {product.is_active ? 'Active' : 'Draft'}
                  </span>
                  {product.is_featured && (
                    <span class="ml-1 inline-flex px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                      Featured
                    </span>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <a href={`/admin/products/${product.id}`} class="text-primary-600 hover:text-primary-900 mr-3">Edit</a>
                  <button class="text-red-600 hover:text-red-900 delete-btn" data-id={product.id}>Delete</button>
                </td>
              </tr>
            );
          })
        ) : (
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-gray-500">No products found</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50"></div>

  {totalPages > 1 && (
    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-500">
        Page {page} of {totalPages}
      </div>
      <div class="flex gap-2">
        {page > 1 && (
          <a href={`/admin/products?page=${page - 1}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
            Previous
          </a>
        )}
        {page < totalPages && (
          <a href={`/admin/products?page=${page + 1}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
            Next
          </a>
        )}
      </div>
    </div>
  )}

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const toast = document.getElementById('toast');
    const batchActions = document.getElementById('batch-actions');
    const selectedCountEl = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all') as HTMLInputElement;
    const productCheckboxes = document.querySelectorAll('.product-checkbox') as NodeListOf<HTMLInputElement>;

    function showToast(message: string, type = 'success') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    function getSelectedIds(): string[] {
      const ids: string[] = [];
      productCheckboxes.forEach((cb) => {
        if (cb.checked && cb.dataset.id) ids.push(cb.dataset.id);
      });
      return ids;
    }

    function updateBatchUI() {
      const selected = getSelectedIds();
      if (selected.length > 0) {
        batchActions?.classList.remove('hidden');
        batchActions?.classList.add('flex');
        if (selectedCountEl) selectedCountEl.textContent = `${selected.length} selected`;
      } else {
        batchActions?.classList.add('hidden');
        batchActions?.classList.remove('flex');
      }
      
      // Update select-all state
      const allChecked = selected.length === productCheckboxes.length && productCheckboxes.length > 0;
      const someChecked = selected.length > 0 && selected.length < productCheckboxes.length;
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked;
      }
    }

    // Select all
    selectAllCheckbox?.addEventListener('change', () => {
      const checked = selectAllCheckbox.checked;
      productCheckboxes.forEach((cb) => { cb.checked = checked; });
      updateBatchUI();
    });

    // Individual checkboxes
    productCheckboxes.forEach((cb) => {
      cb.addEventListener('change', updateBatchUI);
    });

    // Batch activate
    document.getElementById('batch-activate')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'activate', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`${ids.length} product(s) activated`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || 'Failed to activate products', 'error');
        }
      } catch {
        showToast('Failed to activate products', 'error');
      }
    });

    // Batch deactivate
    document.getElementById('batch-deactivate')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'deactivate', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`${ids.length} product(s) deactivated`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || 'Failed to deactivate products', 'error');
        }
      } catch {
        showToast('Failed to deactivate products', 'error');
      }
    });

    // Batch delete
    document.getElementById('batch-delete')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      if (!confirm(`Are you sure you want to delete ${ids.length} product(s)? This cannot be undone.`)) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`${ids.length} product(s) deleted`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || 'Failed to delete products', 'error');
        }
      } catch {
        showToast('Failed to delete products', 'error');
      }
    });

    // Single delete
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.target as HTMLElement).dataset.id;
        if (!id || !confirm('Are you sure you want to delete this product?')) return;
        
        try {
          const res = await fetch(`${API_URL}/api/admin/products/${id}`, { method: 'DELETE' });
          if (res.ok) {
            showToast('Product deleted');
            setTimeout(() => window.location.reload(), 500);
          } else {
            showToast('Failed to delete product', 'error');
          }
        } catch {
          showToast('Failed to delete product', 'error');
        }
      });
    });
  </script>
</AdminLayout>
