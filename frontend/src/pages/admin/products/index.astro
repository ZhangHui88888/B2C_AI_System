---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 20;
const offset = (page - 1) * limit;

const { data: products, count } = await supabase
  .from('products')
  .select('id, name, slug, price, compare_price, is_active, is_featured, stock_quantity, created_at, images', { count: 'exact' })
  .order('created_at', { ascending: false })
  .range(offset, offset + limit - 1);

const totalPages = Math.ceil((count || 0) / limit);
---

<AdminLayout title="Products" activePage="products">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <p class="text-sm text-gray-500">{count || 0} total products</p>
    </div>
    <a href="/admin/products/new" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      Add Product
    </a>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {products && products.length > 0 ? (
          products.map((product) => {
            const images = product.images as string[] | null;
            const thumbnail = images?.[0] || '/placeholder.jpg';
            return (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                      <img class="h-10 w-10 rounded-lg object-cover" src={thumbnail} alt={product.name} />
                    </div>
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900">{product.name}</div>
                      <div class="text-sm text-gray-500">{product.slug}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${product.price?.toFixed(2)}</div>
                  {product.compare_price && (
                    <div class="text-sm text-gray-500 line-through">${product.compare_price.toFixed(2)}</div>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {product.stock_quantity === null ? 'âˆž' : product.stock_quantity}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${product.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                    {product.is_active ? 'Active' : 'Draft'}
                  </span>
                  {product.is_featured && (
                    <span class="ml-1 inline-flex px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                      Featured
                    </span>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <a href={`/admin/products/${product.id}`} class="text-primary-600 hover:text-primary-900 mr-3">Edit</a>
                  <button class="text-red-600 hover:text-red-900 delete-btn" data-id={product.id}>Delete</button>
                </td>
              </tr>
            );
          })
        ) : (
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">No products found</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  {totalPages > 1 && (
    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-500">
        Page {page} of {totalPages}
      </div>
      <div class="flex gap-2">
        {page > 1 && (
          <a href={`/admin/products?page=${page - 1}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
            Previous
          </a>
        )}
        {page < totalPages && (
          <a href={`/admin/products?page=${page + 1}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
            Next
          </a>
        )}
      </div>
    </div>
  )}

  <script>
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.target as HTMLElement).dataset.id;
        if (!id || !confirm('Are you sure you want to delete this product?')) return;
        
        try {
          const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
          if (res.ok) {
            window.location.reload();
          } else {
            alert('Failed to delete product');
          }
        } catch {
          alert('Failed to delete product');
        }
      });
    });
  </script>
</AdminLayout>
