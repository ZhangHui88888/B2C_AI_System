---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

const page = parseInt(Astro.url.searchParams.get('page') || '1');
---

<AdminLayout title="商品管理" activePage="products">
  <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <p id="products-count" class="text-sm text-gray-500">加载中...</p>
    </div>
    <div class="flex items-center gap-3">
      <!-- Batch Actions (hidden by default) -->
      <div id="batch-actions" class="hidden items-center gap-2">
        <span id="selected-count" class="text-sm text-gray-600">已选择 0 个</span>
        <button id="batch-activate" class="px-3 py-1.5 text-sm font-medium text-green-700 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
          上架
        </button>
        <button id="batch-deactivate" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
          下架
        </button>
        <button id="batch-feature" class="px-3 py-1.5 text-sm font-medium text-yellow-700 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition-colors">
          设为精选
        </button>
        <button id="batch-unfeature" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
          取消精选
        </button>
        <button id="batch-delete" class="px-3 py-1.5 text-sm font-medium text-red-700 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
          删除
        </button>
      </div>
      <a href="/admin/products/new" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        添加商品
      </a>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left">
            <input type="checkbox" id="select-all" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" />
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">库存</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody id="products-tbody" class="bg-white divide-y divide-gray-200">
        <tr>
          <td colspan="6" class="px-6 py-8 text-center text-gray-500">加载中...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50"></div>

  <div id="products-pagination" class="mt-6 flex items-center justify-between hidden">
    <div id="products-pagination-text" class="text-sm text-gray-500"></div>
    <div id="products-pagination-actions" class="flex gap-2"></div>
  </div>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const toast = document.getElementById('toast');
    const batchActions = document.getElementById('batch-actions');
    const selectedCountEl = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all');
    const productsTbody = document.getElementById('products-tbody');
    const productsCount = document.getElementById('products-count');
    const pagination = document.getElementById('products-pagination');
    const paginationText = document.getElementById('products-pagination-text');
    const paginationActions = document.getElementById('products-pagination-actions');

    const currentPage = parseInt(new URLSearchParams(window.location.search).get('page') || '1');

    function showToast(message, type = 'success') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }

    function getSelectedIds() {
      const ids = [];
      document.querySelectorAll('.product-checkbox').forEach((cb) => {
        if (cb.checked && cb.dataset.id) ids.push(cb.dataset.id);
      });
      return ids;
    }

    function updateBatchUI() {
      const selected = getSelectedIds();
      if (selected.length > 0) {
        batchActions?.classList.remove('hidden');
        batchActions?.classList.add('flex');
        if (selectedCountEl) selectedCountEl.textContent = `已选择 ${selected.length} 个`;
      } else {
        batchActions?.classList.add('hidden');
        batchActions?.classList.remove('flex');
      }

      const checkboxes = document.querySelectorAll('.product-checkbox');
      const allChecked = selected.length === checkboxes.length && checkboxes.length > 0;
      const someChecked = selected.length > 0 && selected.length < checkboxes.length;
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked;
      }
    }

    function bindRowEvents() {
      document.querySelectorAll('.product-checkbox').forEach((cb) => {
        cb.addEventListener('change', updateBatchUI);
      });

      document.querySelectorAll('.delete-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const id = e.target?.dataset?.id;
          if (!id || !confirm('确定要删除这个商品吗？')) return;

          try {
            const res = await fetch(`${API_URL}/api/admin/products/${id}`, { method: 'DELETE' });
            if (res.ok) {
              showToast('商品已删除');
              setTimeout(() => window.location.reload(), 500);
            } else {
              showToast('删除商品失败', 'error');
            }
          } catch {
            showToast('删除商品失败', 'error');
          }
        });
      });
    }

    function renderProducts(products, paginationData) {
      if (!productsTbody) return;

      if (!products || products.length === 0) {
        productsTbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">暂无商品</td></tr>';
      } else {
        productsTbody.innerHTML = products
          .map((product) => {
            const images = Array.isArray(product.images) ? product.images : [];
            const thumbnail = images?.[0] || '/placeholder.jpg';
            const badge = product.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
            const badgeText = product.is_active ? '已上架' : '草稿';
            const featured = product.is_featured
              ? '<span class="ml-1 inline-flex px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">精选</span>'
              : '';
            const compare = product.compare_price
              ? `<div class="text-sm text-gray-500 line-through">$${Number(product.compare_price).toFixed(2)}</div>`
              : '';
            const stock = product.stock_quantity === null ? '∞' : (product.stock_quantity ?? '');

            return `
              <tr class="hover:bg-gray-50 product-row" data-id="${product.id}">
                <td class="px-4 py-4">
                  <input type="checkbox" class="product-checkbox h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" data-id="${product.id}" />
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                      <img class="h-10 w-10 rounded-lg object-cover" src="${thumbnail}" alt="${product.name || ''}" />
                    </div>
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900">${product.name || ''}</div>
                      <div class="text-sm text-gray-500">${product.slug || ''}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">$${Number(product.price || 0).toFixed(2)}</div>
                  ${compare}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stock}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${badge}">${badgeText}</span>
                  ${featured}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <a href="/admin/products/${product.id}" class="text-primary-600 hover:text-primary-900 mr-3">编辑</a>
                  <button class="text-red-600 hover:text-red-900 delete-btn" data-id="${product.id}">删除</button>
                </td>
              </tr>
            `;
          })
          .join('');
      }

      if (productsCount && paginationData) {
        productsCount.textContent = `共 ${paginationData.total || 0} 个商品`;
      }

      if (pagination && paginationText && paginationActions && paginationData) {
        if ((paginationData.totalPages || 0) <= 1) {
          pagination.classList.add('hidden');
        } else {
          pagination.classList.remove('hidden');
          paginationText.textContent = `第 ${paginationData.page} 页，共 ${paginationData.totalPages} 页`;
          const params = new URLSearchParams(window.location.search);
          const page = paginationData.page;
          paginationActions.innerHTML = '';
          if (page > 1) {
            params.set('page', String(page - 1));
            const href = `/admin/products?${params.toString()}`;
            paginationActions.insertAdjacentHTML('beforeend', `<a href="${href}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">上一页</a>`);
          }
          if (page < paginationData.totalPages) {
            params.set('page', String(page + 1));
            const href = `/admin/products?${params.toString()}`;
            paginationActions.insertAdjacentHTML('beforeend', `<a href="${href}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">下一页</a>`);
          }
        }
      }

      bindRowEvents();
      updateBatchUI();
    }

    async function loadProducts() {
      const brandId = getCookie('brand_id');
      if (brandId === 'all') {
        if (productsTbody) productsTbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">请先在右上角选择一个品牌</td></tr>';
        if (productsCount) productsCount.textContent = '请选择品牌';
        return;
      }

      try {
        const qs = new URLSearchParams();
        qs.set('page', String(currentPage));
        const res = await fetch(`${API_URL}/api/admin/products?${qs.toString()}`);
        if (!res.ok) {
          renderProducts([], { page: currentPage, totalPages: 1, total: 0 });
          return;
        }

        const data = await res.json();
        const products = data?.products || data?.data || [];
        const paginationData = data?.pagination || { page: currentPage, totalPages: 1, total: products.length };
        renderProducts(products, paginationData);
      } catch {
        renderProducts([], { page: currentPage, totalPages: 1, total: 0 });
      }
    }

    // Select all
    selectAllCheckbox?.addEventListener('change', () => {
      const checked = selectAllCheckbox.checked;
      document.querySelectorAll('.product-checkbox').forEach((cb) => {
        cb.checked = checked;
      });
      updateBatchUI();
    });

    loadProducts();

    // Batch activate
    document.getElementById('batch-activate')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'activate', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`已上架 ${ids.length} 个商品`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || '上架失败', 'error');
        }
      } catch {
        showToast('上架失败', 'error');
      }
    });

    // Batch deactivate
    document.getElementById('batch-deactivate')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'deactivate', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`已下架 ${ids.length} 个商品`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || '下架失败', 'error');
        }
      } catch {
        showToast('下架失败', 'error');
      }
    });

    // Batch feature
    document.getElementById('batch-feature')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'feature', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`已设为精选 ${ids.length} 个商品`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || '设为精选失败', 'error');
        }
      } catch {
        showToast('设为精选失败', 'error');
      }
    });

    // Batch unfeature
    document.getElementById('batch-unfeature')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'unfeature', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`已取消精选 ${ids.length} 个商品`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || '取消精选失败', 'error');
        }
      } catch {
        showToast('取消精选失败', 'error');
      }
    });

    // Batch delete
    document.getElementById('batch-delete')?.addEventListener('click', async () => {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      if (!confirm(`确定要删除 ${ids.length} 个商品吗？此操作不可撤销。`)) return;
      
      try {
        const res = await fetch(`${API_URL}/api/admin/products/batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', ids }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(`已删除 ${ids.length} 个商品`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || '删除失败', 'error');
        }
      } catch {
        showToast('删除失败', 'error');
      }
    });

    // Single delete
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.target as HTMLElement).dataset.id;
        if (!id || !confirm('确定要删除这个商品吗？')) return;
        
        try {
          const res = await fetch(`${API_URL}/api/admin/products/${id}`, { method: 'DELETE' });
          if (res.ok) {
            showToast('商品已删除');
            setTimeout(() => window.location.reload(), 500);
          } else {
            showToast('删除商品失败', 'error');
          }
        } catch {
          showToast('删除商品失败', 'error');
        }
      });
    });
  </script>
</AdminLayout>
