---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

// Data loaded dynamically via client-side API call
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const status = Astro.url.searchParams.get('status') || '';
const coupons: any[] = [];
const count = 0;
const totalPages = 1;

const statusOptions = [
  { value: '', label: '所有状态' },
  { value: 'active', label: '有效' },
  { value: 'inactive', label: '无效' },
  { value: 'expired', label: '已过期' },
];

const typeLabels: Record<string, string> = {
  percentage: '百分比折扣',
  fixed_amount: '固定金额',
  free_shipping: '免运费',
};
---

<AdminLayout title="优惠券" activePage="coupons">
  <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <p class="text-sm text-gray-500">共 {count || 0} 个优惠券</p>
    </div>
    <div class="flex items-center gap-3">
      <select id="status-filter" class="text-sm border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
        {statusOptions.map((opt) => (
          <option value={opt.value} selected={status === opt.value}>{opt.label}</option>
        ))}
      </select>
      <button id="add-coupon-btn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        添加优惠券
      </button>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">优惠码</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">折扣</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">使用次数</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">有效期</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {coupons && coupons.length > 0 ? (
          coupons.map((coupon) => {
            const isExpired = coupon.expires_at && new Date(coupon.expires_at) < new Date();
            return (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="font-mono text-sm font-medium text-gray-900 bg-gray-100 px-2 py-1 rounded inline-block">
                    {coupon.code}
                  </div>
                  {coupon.description && (
                    <div class="text-xs text-gray-500 mt-1">{coupon.description}</div>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">
                    {coupon.type === 'percentage' && `${coupon.value}% 折扣`}
                    {coupon.type === 'fixed_amount' && `$${coupon.value} 优惠`}
                    {coupon.type === 'free_shipping' && '免运费'}
                  </div>
                  {coupon.min_order_amount > 0 && (
                    <div class="text-xs text-gray-500">最低消费 ${coupon.min_order_amount}</div>
                  )}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {coupon.usage_count}{coupon.usage_limit ? ` / ${coupon.usage_limit}` : ' / ∞'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {coupon.expires_at ? new Date(coupon.expires_at).toLocaleDateString() : '永久有效'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                    isExpired ? 'bg-red-100 text-red-800' :
                    coupon.status === 'active' ? 'bg-green-100 text-green-800' :
                    coupon.status === 'inactive' ? 'bg-gray-100 text-gray-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    {isExpired ? '已过期' : coupon.status === 'active' ? '有效' : '无效'}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <button class="text-primary-600 hover:text-primary-900 mr-3 edit-btn" data-coupon={JSON.stringify(coupon)}>编辑</button>
                  <button class="text-red-600 hover:text-red-900 delete-btn" data-id={coupon.id}>删除</button>
                </td>
              </tr>
            );
          })
        ) : (
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-gray-500">暂无优惠券</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  {totalPages > 1 && (
    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-500">第 {page} 页，共 {totalPages} 页</div>
      <div class="flex gap-2">
        {page > 1 && (
          <a href={`/admin/coupons?page=${page - 1}${status ? `&status=${status}` : ''}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">上一页</a>
        )}
        {page < totalPages && (
          <a href={`/admin/coupons?page=${page + 1}${status ? `&status=${status}` : ''}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">下一页</a>
        )}
      </div>
    </div>
  )}

  <!-- Coupon Modal -->
  <div id="coupon-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 id="modal-title" class="text-lg font-medium text-gray-900">添加优惠券</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="coupon-form" class="p-6 space-y-4">
          <input type="hidden" name="id" value="" />
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">优惠码 *</label>
              <input type="text" name="code" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 uppercase" placeholder="SAVE20" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
              <select name="status" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                <option value="active">有效</option>
                <option value="inactive">无效</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
            <input type="text" name="description" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="订单享受 20% 折扣" />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">折扣类型 *</label>
              <select name="type" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                <option value="percentage">百分比 (%)</option>
                <option value="fixed_amount">固定金额 ($)</option>
                <option value="free_shipping">免运费</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">折扣值 *</label>
              <input type="number" name="value" required step="0.01" min="0" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="20" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">最低订单金额</label>
              <input type="number" name="min_order_amount" step="0.01" min="0" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="0" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">最高折扣 (百分比用)</label>
              <input type="number" name="max_discount_amount" step="0.01" min="0" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="无限制" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">总使用次数限制</label>
              <input type="number" name="usage_limit" min="0" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="无限制" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">每用户限制</label>
              <input type="number" name="usage_limit_per_customer" min="1" value="1" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
              <input type="datetime-local" name="starts_at" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">过期日期</label>
              <input type="datetime-local" name="expires_at" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" />
            </div>
          </div>

          <div class="flex items-center gap-4 pt-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" name="first_order_only" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500" />
              <span class="text-sm text-gray-700">仅首单</span>
            </label>
          </div>

          <div class="flex gap-3 pt-4 border-t">
            <button type="button" id="cancel-btn" class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">取消</button>
            <button type="submit" class="flex-1 px-4 py-2 text-white bg-primary-600 rounded-lg hover:bg-primary-700">保存优惠券</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50"></div>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const modal = document.getElementById('coupon-modal');
    const form = document.getElementById('coupon-form');
    const modalTitle = document.getElementById('modal-title');
    const toast = document.getElementById('toast');

    // Load coupons on init and render dynamically
    async function loadCoupons() {
      const url = new URL(window.location.href);
      const status = url.searchParams.get('status') || '';
      const page = url.searchParams.get('page') || '1';
      
      try {
        const params = new URLSearchParams({ page, limit: '20' });
        if (status) params.set('status', status);
        
        const res = await fetch(`/api/admin/coupons?${params}`);
        if (!res.ok) return;
        const json = await res.json();
        
        if (json.data) {
          renderCoupons(json.data, json.pagination);
        }
      } catch (e) {
        console.error('Failed to load coupons:', e);
      }
    }
    
    function renderCoupons(coupons, pagination) {
      const tbody = document.querySelector('tbody');
      const countEl = document.querySelector('.text-sm.text-gray-500');
      if (!tbody) return;
      
      if (countEl) countEl.textContent = `共 ${pagination?.total || coupons.length} 个优惠券`;
      
      if (coupons.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">暂无优惠券</td></tr>`;
        return;
      }
      
      tbody.innerHTML = coupons.map(coupon => {
        const isExpired = coupon.expires_at && new Date(coupon.expires_at) < new Date();
        const statusClass = coupon.status === 'active' && !isExpired 
          ? 'bg-green-100 text-green-800' 
          : 'bg-gray-100 text-gray-800';
        const statusText = isExpired ? '已过期' : (coupon.status === 'active' ? '有效' : '无效');
        
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="font-mono text-sm font-medium text-gray-900 bg-gray-100 px-2 py-1 rounded inline-block">${coupon.code}</div>
              ${coupon.description ? `<div class="text-xs text-gray-500 mt-1">${coupon.description}</div>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">
                ${coupon.type === 'percentage' ? `${coupon.value}% 折扣` : ''}
                ${coupon.type === 'fixed_amount' ? `$${coupon.value} 优惠` : ''}
                ${coupon.type === 'free_shipping' ? '免运费' : ''}
              </div>
              ${coupon.min_order_amount > 0 ? `<div class="text-xs text-gray-500">最低消费 $${coupon.min_order_amount}</div>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${coupon.usage_count}${coupon.usage_limit ? ` / ${coupon.usage_limit}` : ' / ∞'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${coupon.expires_at ? new Date(coupon.expires_at).toLocaleDateString() : '永久有效'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
              <button class="edit-btn text-primary-600 hover:text-primary-900 mr-3" data-coupon='${JSON.stringify(coupon)}'>编辑</button>
              <button class="delete-btn text-red-600 hover:text-red-900" data-id="${coupon.id}">删除</button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Re-attach event listeners
      attachCouponEventListeners();
    }
    
    function attachCouponEventListeners() {
      document.querySelectorAll('.edit-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const coupon = JSON.parse(btn.dataset?.coupon || '{}');
          openModal(coupon);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset?.id;
          if (!confirm('删除这个优惠券？')) return;
          
          try {
            const res = await fetch(`/api/admin/coupons/${id}`, { method: 'DELETE' });
            if (res.ok) {
              showToast('优惠券已删除');
              loadCoupons();
            } else {
              showToast('删除优惠券失败', 'error');
            }
          } catch {
            showToast('删除优惠券失败', 'error');
          }
        });
      });
    }
    
    // Load on init
    loadCoupons();

    function showToast(message, type = 'success') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    function openModal(coupon) {
      form?.reset();
      if (coupon) {
        if (modalTitle) modalTitle.textContent = '编辑优惠券';
        const getEl = (n) => form?.elements?.namedItem(n);
        if (getEl('id')) getEl('id').value = coupon.id;
        if (getEl('code')) getEl('code').value = coupon.code;
        if (getEl('description')) getEl('description').value = coupon.description || '';
        if (getEl('type')) getEl('type').value = coupon.type;
        if (getEl('value')) getEl('value').value = coupon.value;
        if (getEl('status')) getEl('status').value = coupon.status;
        if (getEl('min_order_amount')) getEl('min_order_amount').value = coupon.min_order_amount || '';
        if (getEl('max_discount_amount')) getEl('max_discount_amount').value = coupon.max_discount_amount || '';
        if (getEl('usage_limit')) getEl('usage_limit').value = coupon.usage_limit || '';
        if (getEl('usage_limit_per_customer')) getEl('usage_limit_per_customer').value = coupon.usage_limit_per_customer || '1';
        if (coupon.starts_at && getEl('starts_at')) {
          getEl('starts_at').value = new Date(coupon.starts_at).toISOString().slice(0, 16);
        }
        if (coupon.expires_at && getEl('expires_at')) {
          getEl('expires_at').value = new Date(coupon.expires_at).toISOString().slice(0, 16);
        }
        if (getEl('first_order_only')) getEl('first_order_only').checked = coupon.first_order_only;
      } else {
        if (modalTitle) modalTitle.textContent = '添加优惠券';
      }
      modal?.classList.remove('hidden');
    }

    function closeModal() {
      modal?.classList.add('hidden');
    }

    // Event listeners
    document.getElementById('add-coupon-btn')?.addEventListener('click', () => openModal());
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('cancel-btn')?.addEventListener('click', closeModal);
    document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);

    // Status filter
    document.getElementById('status-filter')?.addEventListener('change', (e) => {
      const value = e.target?.value;
      window.location.href = `/admin/coupons${value ? `?status=${value}` : ''}`;
    });

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const id = formData.get('id');
      
      const data = {
        code: String(formData.get('code') || '').toUpperCase(),
        description: formData.get('description') || null,
        type: formData.get('type'),
        value: parseFloat(formData.get('value')) || 0,
        status: formData.get('status'),
        min_order_amount: parseFloat(formData.get('min_order_amount')) || 0,
        max_discount_amount: formData.get('max_discount_amount') ? parseFloat(formData.get('max_discount_amount')) : null,
        usage_limit: formData.get('usage_limit') ? parseInt(formData.get('usage_limit')) : null,
        usage_limit_per_customer: parseInt(formData.get('usage_limit_per_customer')) || 1,
        starts_at: formData.get('starts_at') || null,
        expires_at: formData.get('expires_at') || null,
        first_order_only: formData.get('first_order_only') === 'on',
      };

      try {
        const url = id ? `${API_URL}/api/admin/coupons/${id}` : `${API_URL}/api/admin/coupons`;
        const method = id ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await res.json();
        if (res.ok && result.success) {
          showToast(id ? '优惠券已更新！' : '优惠券已创建！');
          closeModal();
          loadCoupons();
        } else {
          showToast(result.error || '保存优惠券失败', 'error');
        }
      } catch {
        showToast('保存优惠券失败', 'error');
      }
    });
  </script>
</AdminLayout>
