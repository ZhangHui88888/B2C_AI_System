---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

// Data loaded dynamically via client-side API calls
const currentBrandId = Astro.cookies.get('brand_id')?.value || '';
const isAllBrandsView = currentBrandId === 'all' || !currentBrandId;
const brands: any[] = [];
const enrichedTemplates: any[] = [];

const templateTypes: Record<string, { label: string; icon: string; color: string }> = {
  email: { label: 'Email', icon: 'mail', color: 'bg-blue-100 text-blue-700' },
  page: { label: 'Page', icon: 'file', color: 'bg-purple-100 text-purple-700' },
  content: { label: 'Content', icon: 'edit', color: 'bg-green-100 text-green-700' },
  script: { label: 'Script', icon: 'code', color: 'bg-orange-100 text-orange-700' }
};
---

<AdminLayout title="共享模板" activePage="templates">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">共享模板</h2>
        <p class="text-sm text-gray-600">
          {isAllBrandsView 
            ? '管理所有品牌的模板' 
            : '您品牌可用的模板'}
        </p>
      </div>
      <button id="create-template-btn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        创建模板
      </button>
    </div>

    <!-- Filter Tabs -->
    <div class="border-b border-gray-200">
      <nav class="flex space-x-8">
        <button class="filter-tab active py-4 px-1 border-b-2 font-medium text-sm border-primary-500 text-primary-600" data-filter="all">所有模板
        </button>
        <button class="filter-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700" data-filter="email">邮件
        </button>
        <button class="filter-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700" data-filter="page">页面
        </button>
        <button class="filter-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700" data-filter="content">内容
        </button>
        <button class="filter-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700" data-filter="script">脚本
        </button>
      </nav>
    </div>

    <!-- Templates Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="templates-grid">
      {enrichedTemplates.length > 0 ? (
        enrichedTemplates.map((template) => (
          <div 
            class="template-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow"
            data-type={template.template_type}
          >
            <div class="p-5">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-2">
                  <span class={`px-2 py-1 text-xs font-medium rounded-full ${templateTypes[template.template_type]?.color || 'bg-gray-100 text-gray-600'}`}>
                    {templateTypes[template.template_type]?.label || template.template_type}
                  </span>
                  {template.is_public && (
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                      公开
                    </span>
                  )}
                </div>
                <span class="text-xs text-gray-400">已使用 {template.use_count || 0} 次</span>
              </div>
              
              <h3 class="font-semibold text-gray-900 mb-2">{template.name}</h3>
              <p class="text-sm text-gray-600 line-clamp-2 mb-4">{template.description || '无描述'}</p>
              
              <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                <div class="flex items-center gap-2">
                  {template.ownerBrand?.logo_url ? (
                    <img src={template.ownerBrand.logo_url} alt="" class="w-5 h-5 rounded object-cover" />
                  ) : (
                    <div class="w-5 h-5 bg-primary-100 rounded flex items-center justify-center">
                      <span class="text-xs font-bold text-primary-600">{template.ownerBrand?.name?.charAt(0) || '?'}</span>
                    </div>
                  )}
                  <span class="text-xs text-gray-500">{template.ownerBrand?.name || 'Unknown'}</span>
                </div>
                
                <div class="flex items-center gap-2">
                  <button 
                    class="use-template-btn text-sm text-primary-600 hover:text-primary-700"
                    data-id={template.id}
                    data-content={JSON.stringify(template.content)}
                  >
                    使用
                  </button>
                  {(isAllBrandsView || template.owner_brand_id === currentBrandId) && (
                    <>
                      <button 
                        class="edit-template-btn text-sm text-gray-600 hover:text-gray-700"
                        data-template={JSON.stringify(template)}
                      >编辑
                      </button>
                      <button 
                        class="delete-template-btn text-sm text-red-600 hover:text-red-700"
                        data-id={template.id}
                        data-name={template.name}
                      >删除
                      </button>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        ))
      ) : (
        <div class="col-span-full bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-1">暂无模板</h3>
          <p class="text-gray-500 mb-4">创建您的第一个模板以在品牌间共享</p>
          <button id="create-template-empty-btn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">创建模板
          </button>
        </div>
      )}
    </div>
  </div>

  <!-- Create/Edit Template Modal -->
  <div id="template-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100">
          <h3 id="modal-title" class="text-lg font-semibold text-gray-900">创建模板</h3>
        </div>
        
        <form id="template-form" class="p-6 space-y-4">
          <input type="hidden" id="template-id" />
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">模板名称 *</label>
              <input type="text" id="template-name" required class="w-full border-gray-300 rounded-lg" placeholder="欢迎邮件" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">类型 *</label>
              <select id="template-type" required class="w-full border-gray-300 rounded-lg">
                <option value="email">邮件</option>
                <option value="page">页面</option>
                <option value="content">内容</option>
                <option value="script">脚本</option>
              </select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
            <textarea id="template-description" rows="2" class="w-full border-gray-300 rounded-lg" placeholder="此模板的简要描述"></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">内容 (JSON) *</label>
            <textarea id="template-content" rows="10" required class="w-full border-gray-300 rounded-lg font-mono text-sm" placeholder='{"subject": "欢迎！", "body": "..."}'></textarea>
            <p class="text-xs text-gray-500 mt-1">JSON 格式的模板内容</p>
          </div>
          
          <div class="flex items-center gap-6">
            <div class="flex items-center">
              <input type="checkbox" id="template-public" class="h-4 w-4 text-primary-600 rounded border-gray-300" />
              <label for="template-public" class="ml-2 text-sm text-gray-700">设为公开（所有品牌可用）</label>
            </div>
          </div>
          
          <div class="flex gap-3 pt-4">
            <button type="button" id="cancel-btn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              取消
            </button>
            <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">保存模板
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script define:vars={{ currentBrandId, isAllBrandsView }}>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const modal = document.getElementById('template-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('template-form');
    const templatesGrid = document.getElementById('templates-grid');

    // Load templates on init
    async function loadTemplates() {
      try {
        const res = await fetch(`/api/admin/templates`);
        if (!res.ok) return;
        const json = await res.json();
        if (json.data) renderTemplates(json.data);
      } catch (e) {
        console.error('Failed to load templates:', e);
      }
    }

    function renderTemplates(templates) {
      if (!templatesGrid) return;
      if (templates.length === 0) {
        templatesGrid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500">暂无模板</div>`;
        return;
      }
      const typeColors = {
        email: 'bg-blue-100 text-blue-700',
        page: 'bg-purple-100 text-purple-700',
        content: 'bg-green-100 text-green-700',
        script: 'bg-orange-100 text-orange-700'
      };
      templatesGrid.innerHTML = templates.map(t => `
        <div class="template-card bg-white rounded-xl shadow-sm border border-gray-100 p-6" data-type="${t.template_type}" data-id="${t.id}">
          <div class="flex items-start justify-between mb-3">
            <span class="px-2 py-1 text-xs font-medium rounded ${typeColors[t.template_type] || 'bg-gray-100 text-gray-700'}">${t.template_type}</span>
            ${t.is_public ? '<span class="px-2 py-1 text-xs bg-green-50 text-green-600 rounded">公开</span>' : ''}
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">${t.name}</h3>
          ${t.description ? `<p class="text-sm text-gray-600 line-clamp-2 mb-4">${t.description}</p>` : ''}
          <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
            <button class="edit-template text-sm text-primary-600 hover:underline" data-template='${JSON.stringify(t)}'>编辑</button>
            <button class="delete-template text-sm text-red-600 hover:underline" data-id="${t.id}">删除</button>
          </div>
        </div>
      `).join('');
      attachTemplateEventListeners();
    }

    function attachTemplateEventListeners() {
      document.querySelectorAll('.edit-template').forEach(btn => {
        btn.addEventListener('click', () => {
          const template = JSON.parse(btn.dataset?.template || '{}');
          openModal(template);
        });
      });
      document.querySelectorAll('.delete-template').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset?.id;
          if (!confirm('删除此模板？')) return;
          const res = await fetch(`/api/admin/templates/${id}`, { method: 'DELETE' });
          if (res.ok) loadTemplates();
        });
      });
    }

    loadTemplates();

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const filter = tab.dataset.filter;
        
        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(t => {
          t.classList.remove('active', 'border-primary-500', 'text-primary-600');
          t.classList.add('border-transparent', 'text-gray-500');
        });
        tab.classList.add('active', 'border-primary-500', 'text-primary-600');
        tab.classList.remove('border-transparent', 'text-gray-500');
        
        // Filter cards
        document.querySelectorAll('.template-card').forEach(card => {
          const cardType = card.dataset.type;
          if (filter === 'all' || cardType === filter) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      });
    });

    function openModal(template = null) {
      if (template) {
        modalTitle.textContent = '编辑模板';
        document.getElementById('template-id').value = template.id;
        document.getElementById('template-name').value = template.name;
        document.getElementById('template-type').value = template.template_type;
        document.getElementById('template-description').value = template.description || '';
        document.getElementById('template-content').value = JSON.stringify(template.content, null, 2);
        document.getElementById('template-public').checked = template.is_public;
      } else {
        modalTitle.textContent = '创建模板';
        form?.reset();
        document.getElementById('template-id').value = '';
        document.getElementById('template-content').value = '{\n  \n}';
      }
      modal?.classList.remove('hidden');
    }

    function closeModal() {
      modal?.classList.add('hidden');
    }

    // Open modal buttons
    document.getElementById('create-template-btn')?.addEventListener('click', () => openModal());
    document.getElementById('create-template-empty-btn')?.addEventListener('click', () => openModal());
    document.getElementById('cancel-btn')?.addEventListener('click', closeModal);
    document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);

    // Edit buttons
    document.querySelectorAll('.edit-template-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const template = JSON.parse(btn.dataset.template || '{}');
        openModal(template);
      });
    });

    // Delete buttons
    document.querySelectorAll('.delete-template-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        
        if (!confirm(`确定要删除 "${name}" 吗？`)) return;
        
        try {
          const res = await fetch(`${API_URL}/api/admin/templates/${id}`, {
            method: 'DELETE',
          });
          
          if (res.ok) {
            window.location.reload();
          } else {
            const data = await res.json();
            alert(data.error || '删除模板失败');
          }
        } catch (err) {
          alert('删除模板失败');
        }
      });
    });

    // Use template buttons
    document.querySelectorAll('.use-template-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const content = JSON.parse(btn.dataset.content || '{}');
        
        // Increment use count
        try {
          await fetch(`${API_URL}/api/admin/templates/${id}/use`, { method: 'POST' });
        } catch (e) {}
        
        // Copy content to clipboard
        try {
          await navigator.clipboard.writeText(JSON.stringify(content, null, 2));
          alert('模板内容已复制到剪贴板！');
        } catch (e) {
          alert('Template content:\n' + JSON.stringify(content, null, 2));
        }
      });
    });

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('template-id').value;
      let content;
      
      try {
        content = JSON.parse(document.getElementById('template-content').value);
      } catch (e) {
        alert('内容字段中的 JSON 无效');
        return;
      }
      
      const data = {
        name: document.getElementById('template-name').value.trim(),
        template_type: document.getElementById('template-type').value,
        description: document.getElementById('template-description').value.trim() || null,
        content,
        is_public: document.getElementById('template-public').checked,
        owner_brand_id: isAllBrandsView ? null : currentBrandId,
      };
      
      try {
        const url = id 
          ? `${API_URL}/api/admin/templates/${id}`
          : `${API_URL}/api/admin/templates`;
        
        const res = await fetch(url, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        
        if (res.ok) {
          window.location.reload();
        } else {
          const err = await res.json();
          alert(err.error || '保存模板失败');
        }
      } catch (err) {
        alert('保存模板失败');
      }
    });
  </script>
</AdminLayout>
