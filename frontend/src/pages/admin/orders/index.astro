---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const status = Astro.url.searchParams.get('status') || '';

const statusOptions = ['pending', 'processing', 'shipped', 'delivered', 'cancelled', 'failed'];

function getStatusColor(s: string): string {
  const colors: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    processing: 'bg-blue-100 text-blue-800',
    shipped: 'bg-purple-100 text-purple-800',
    delivered: 'bg-green-100 text-green-800',
    cancelled: 'bg-red-100 text-red-800',
    failed: 'bg-red-100 text-red-800',
  };
  return colors[s] || 'bg-gray-100 text-gray-800';
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
  });
}
---

<AdminLayout title="订单管理" activePage="orders">
  <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <p id="orders-count" class="text-sm text-gray-500">加载中...</p>
    </div>
    <div class="flex items-center gap-2">
      <select id="status-filter" class="text-sm border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
        <option value="">所有状态</option>
        {statusOptions.map((s) => (
          <option value={s} selected={status === s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>
        ))}
      </select>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单号</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody id="orders-tbody" class="bg-white divide-y divide-gray-200">
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-gray-500">加载中...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="orders-pagination" class="mt-6 flex items-center justify-between hidden">
    <div id="orders-pagination-text" class="text-sm text-gray-500"></div>
    <div id="orders-pagination-actions" class="flex gap-2"></div>
  </div>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const statusFilter = document.getElementById('status-filter');
    const ordersTbody = document.getElementById('orders-tbody');
    const ordersCount = document.getElementById('orders-count');
    const pagination = document.getElementById('orders-pagination');
    const paginationText = document.getElementById('orders-pagination-text');
    const paginationActions = document.getElementById('orders-pagination-actions');

    const currentPage = parseInt(new URLSearchParams(window.location.search).get('page') || '1');
    const currentStatus = new URLSearchParams(window.location.search).get('status') || '';

    statusFilter?.addEventListener('change', () => {
      const val = statusFilter.value;
      window.location.href = `/admin/orders${val ? `?status=${val}` : ''}`;
    });

    function getStatusColor(status) {
      const colors = {
        pending: 'bg-yellow-100 text-yellow-800',
        processing: 'bg-blue-100 text-blue-800',
        shipped: 'bg-purple-100 text-purple-800',
        delivered: 'bg-green-100 text-green-800',
        cancelled: 'bg-red-100 text-red-800',
        failed: 'bg-red-100 text-red-800',
      };
      return colors[status] || 'bg-gray-100 text-gray-800';
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    async function updateStatus(orderId, status) {
      const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });

      if (!res.ok) {
        throw new Error('Failed');
      }
    }

    function bindRowEvents() {
      document.querySelectorAll('.status-select').forEach((select) => {
        select.addEventListener('change', async (e) => {
          const el = e.target;
          const id = el.dataset.id;
          const newStatus = el.value;
          if (!id) return;

          try {
            await updateStatus(id, newStatus);
          } catch {
            alert('更新订单状态失败');
            window.location.reload();
          }
        });
      });
    }

    function renderOrders(orders, paginationData) {
      if (!ordersTbody) return;

      if (!orders || orders.length === 0) {
        ordersTbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">暂无订单</td></tr>';
      } else {
        ordersTbody.innerHTML = orders.map((order) => {
          const items = Array.isArray(order.items) ? order.items : [];
          const itemCount = items.reduce((sum, i) => sum + (i.quantity || 1), 0);
          const address = order.shipping_address || {};
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">#${(order.id || '').slice(0, 8)}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${order.customer_email || ''}</div>
                <div class="text-sm text-gray-500">${address.city || ''}, ${address.country || ''}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${itemCount} 件</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">$${Number(order.total_amount || 0).toFixed(2)}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <select class="status-select text-xs rounded-full px-2 py-1 border-0 font-medium cursor-pointer" data-id="${order.id}">
                  ${['pending','processing','shipped','delivered','cancelled','failed'].map((s) => {
                    const selected = order.status === s ? 'selected' : '';
                    return `<option value="${s}" ${selected} class="${getStatusColor(s)}">${s.charAt(0).toUpperCase() + s.slice(1)}</option>`;
                  }).join('')}
                </select>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.created_at ? formatDate(order.created_at) : ''}</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="/admin/orders/${order.id}" class="text-primary-600 hover:text-primary-900">查看</a>
              </td>
            </tr>
          `;
        }).join('');
      }

      if (ordersCount && paginationData) {
        ordersCount.textContent = `共 ${paginationData.total || 0} 个订单`;
      }

      if (!pagination || !paginationText || !paginationActions || !paginationData) return;
      if ((paginationData.totalPages || 0) <= 1) {
        pagination.classList.add('hidden');
      } else {
        pagination.classList.remove('hidden');
        paginationText.textContent = `第 ${paginationData.page} 页，共 ${paginationData.totalPages} 页`;
        const params = new URLSearchParams(window.location.search);
        const page = paginationData.page;
        paginationActions.innerHTML = '';
        if (page > 1) {
          params.set('page', String(page - 1));
          const href = `/admin/orders?${params.toString()}`;
          paginationActions.insertAdjacentHTML('beforeend', `<a href="${href}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">上一页</a>`);
        }
        if (page < paginationData.totalPages) {
          params.set('page', String(page + 1));
          const href = `/admin/orders?${params.toString()}`;
          paginationActions.insertAdjacentHTML('beforeend', `<a href="${href}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">下一页</a>`);
        }
      }

      bindRowEvents();
    }

    async function loadOrders() {
      try {
        const qs = new URLSearchParams();
        qs.set('page', String(currentPage));
        if (currentStatus) qs.set('status', currentStatus);
        const res = await fetch(`${API_URL}/api/admin/orders?${qs.toString()}`);
        if (!res.ok) {
          renderOrders([], { page: currentPage, totalPages: 1, total: 0 });
          return;
        }

        const data = await res.json();
        const orders = data?.orders || data?.data || [];
        const paginationData = data?.pagination || { page: currentPage, totalPages: 1, total: orders.length };
        renderOrders(orders, paginationData);
      } catch {
        renderOrders([], { page: currentPage, totalPages: 1, total: 0 });
      }
    }

    loadOrders();
  </script>
</AdminLayout>
