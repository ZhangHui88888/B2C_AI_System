---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const status = Astro.url.searchParams.get('status') || '';
const limit = 20;
const offset = (page - 1) * limit;

let query = supabase
  .from('orders')
  .select('id, total_amount, status, customer_email, shipping_address, created_at, items', { count: 'exact' })
  .order('created_at', { ascending: false });

if (status) {
  query = query.eq('status', status);
}

const { data: orders, count } = await query.range(offset, offset + limit - 1);
const totalPages = Math.ceil((count || 0) / limit);

const statusOptions = ['pending', 'processing', 'shipped', 'delivered', 'cancelled', 'failed'];

function getStatusColor(s: string): string {
  const colors: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    processing: 'bg-blue-100 text-blue-800',
    shipped: 'bg-purple-100 text-purple-800',
    delivered: 'bg-green-100 text-green-800',
    cancelled: 'bg-red-100 text-red-800',
    failed: 'bg-red-100 text-red-800',
  };
  return colors[s] || 'bg-gray-100 text-gray-800';
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
  });
}
---

<AdminLayout title="Orders" activePage="orders">
  <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <p class="text-sm text-gray-500">{count || 0} total orders</p>
    </div>
    <div class="flex items-center gap-2">
      <select id="status-filter" class="text-sm border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
        <option value="">All Status</option>
        {statusOptions.map((s) => (
          <option value={s} selected={status === s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>
        ))}
      </select>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {orders && orders.length > 0 ? (
          orders.map((order) => {
            const items = order.items as any[] | null;
            const itemCount = items?.reduce((sum, i) => sum + (i.quantity || 1), 0) || 0;
            const address = order.shipping_address as any;
            return (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">#{order.id.slice(0, 8)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">{order.customer_email}</div>
                  <div class="text-sm text-gray-500">{address?.city}, {address?.country}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {itemCount} item{itemCount !== 1 ? 's' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  ${order.total_amount?.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <select class="status-select text-xs rounded-full px-2 py-1 border-0 font-medium cursor-pointer" data-id={order.id}>
                    {statusOptions.map((s) => (
                      <option value={s} selected={order.status === s} class={getStatusColor(s)}>
                        {s.charAt(0).toUpperCase() + s.slice(1)}
                      </option>
                    ))}
                  </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {formatDate(order.created_at)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <a href={`/admin/orders/${order.id}`} class="text-primary-600 hover:text-primary-900">View</a>
                </td>
              </tr>
            );
          })
        ) : (
          <tr>
            <td colspan="7" class="px-6 py-8 text-center text-gray-500">No orders found</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  {totalPages > 1 && (
    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-500">Page {page} of {totalPages}</div>
      <div class="flex gap-2">
        {page > 1 && (
          <a href={`/admin/orders?page=${page - 1}${status ? `&status=${status}` : ''}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Previous</a>
        )}
        {page < totalPages && (
          <a href={`/admin/orders?page=${page + 1}${status ? `&status=${status}` : ''}`} class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Next</a>
        )}
      </div>
    </div>
  )}

  <script>
    const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
    statusFilter?.addEventListener('change', () => {
      const val = statusFilter.value;
      window.location.href = `/admin/orders${val ? `?status=${val}` : ''}`;
    });

    document.querySelectorAll('.status-select').forEach((select) => {
      select.addEventListener('change', async (e) => {
        const el = e.target as HTMLSelectElement;
        const id = el.dataset.id;
        const newStatus = el.value;
        
        try {
          const res = await fetch(`/api/orders/${id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus }),
          });
          if (!res.ok) {
            alert('Failed to update order status');
            window.location.reload();
          }
        } catch {
          alert('Failed to update order status');
          window.location.reload();
        }
      });
    });
  </script>
</AdminLayout>
