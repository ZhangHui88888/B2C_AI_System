---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

const { id } = Astro.params;
---

<AdminLayout title={`Order #${id?.slice(0, 8)}`} activePage="orders">
  <div class="max-w-5xl">
    <!-- Header -->
    <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <a href="/admin/orders" class="text-gray-500 hover:text-gray-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </a>
        <div>
          <h2 id="order-title" class="text-lg font-medium text-gray-900">加载中...</h2>
          <p id="order-date" class="text-sm text-gray-500"></p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="order-status-badge" class="inline-flex px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800">...</span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div id="order-main" class="lg:col-span-2 space-y-6"></div>

      <!-- Sidebar -->
      <div id="order-sidebar" class="space-y-6"></div>
    </div>
  </div>

  <!-- Tracking Modal -->
  <div id="tracking-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="tracking-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-900">添加物流信息</h3>
          <button id="close-tracking-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="tracking-form" class="p-6 space-y-4">
          <div>
            <label for="tracking-number" class="block text-sm font-medium text-gray-700 mb-1">物流单号 *</label>
            <input
              type="text"
              id="tracking-number"
              name="tracking_number"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="输入物流单号"
            />
          </div>
          <div>
            <label for="tracking-url" class="block text-sm font-medium text-gray-700 mb-1">物流跟踪网址</label>
            <input
              type="url"
              id="tracking-url"
              name="tracking_url"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="https://..."
            />
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              id="mark-shipped"
              name="mark_shipped"
              checked
              class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
            />
            <label for="mark-shipped" class="ml-2 block text-sm text-gray-700">标记订单为已发货</label>
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              id="send-notification"
              name="send_notification"
              checked
              class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
            />
            <label for="send-notification" class="ml-2 block text-sm text-gray-700">发送发货通知邮件</label>
          </div>
          <div class="pt-4 flex gap-3">
            <button type="button" id="cancel-tracking" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              取消
            </button>
            <button type="submit" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
              保存并发货
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50"></div>

  <script define:vars={{ orderId: id }}>
    const API_URL = import.meta.env.PUBLIC_API_URL || '';
    const toast = document.getElementById('toast');
    const trackingModal = document.getElementById('tracking-modal');
    const orderMain = document.getElementById('order-main');
    const orderSidebar = document.getElementById('order-sidebar');
    const orderTitle = document.getElementById('order-title');
    const orderDate = document.getElementById('order-date');
    const orderStatusBadge = document.getElementById('order-status-badge');

    const statusOptions = [
      { value: 'pending', label: '待处理', color: 'bg-yellow-100 text-yellow-800' },
      { value: 'paid', label: '已支付', color: 'bg-blue-100 text-blue-800' },
      { value: 'processing', label: '处理中', color: 'bg-indigo-100 text-indigo-800' },
      { value: 'shipped', label: '已发货', color: 'bg-purple-100 text-purple-800' },
      { value: 'delivered', label: '已送达', color: 'bg-green-100 text-green-800' },
      { value: 'cancelled', label: '已取消', color: 'bg-red-100 text-red-800' },
      { value: 'refunded', label: '已退款', color: 'bg-gray-100 text-gray-800' },
      { value: 'failed', label: '失败', color: 'bg-red-100 text-red-800' },
    ];

    function getStatusMeta(status) {
      return statusOptions.find((s) => s.value === status) || { value: status, label: status, color: 'bg-gray-100 text-gray-800' };
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function money(v) {
      return Number(v || 0).toFixed(2);
    }

    function showToast(message, type = 'success') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    async function loadOrder() {
      try {
        const res = await fetch(`${API_URL}/api/admin/orders/${orderId}`);
        if (!res.ok) {
          window.location.href = '/admin/orders';
          return;
        }

        const result = await res.json();
        const order = result?.order || result?.data || result;
        if (!order) {
          window.location.href = '/admin/orders';
          return;
        }

        const statusMeta = getStatusMeta(order.status);
        if (orderTitle) orderTitle.textContent = `Order #${order.order_number || (order.id || '').slice(0, 8)}`;
        if (orderDate) orderDate.textContent = order.created_at ? formatDate(order.created_at) : '';
        if (orderStatusBadge) {
          orderStatusBadge.className = `inline-flex px-3 py-1 text-sm font-medium rounded-full ${statusMeta.color}`;
          orderStatusBadge.textContent = statusMeta.label;
        }

        const items = Array.isArray(order.items) ? order.items : [];
        const shippingAddress = order.shipping_address || null;
        const canAddTracking = order.status === 'paid';

        if (orderMain) {
          orderMain.innerHTML = `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-base font-medium text-gray-900">订单商品</h3>
              </div>
              <div class="divide-y divide-gray-100">
                ${items.map((item) => {
                  const image = item.image
                    ? `<img src="${item.image}" alt="${item.name || ''}" class="w-full h-full object-cover" />`
                    : '<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>';
                  return `
                    <div class="px-6 py-4 flex items-center gap-4">
                      <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">${image}</div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${item.name || '商品'}</p>
                        <p class="text-sm text-gray-500">数量: ${item.quantity || 1}</p>
                      </div>
                      <div class="text-right">
                        <p class="text-sm font-medium text-gray-900">$${money(item.line_total)}</p>
                        <p class="text-xs text-gray-500">单价 $${money(item.unit_price)}</p>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              <div class="px-6 py-4 bg-gray-50 space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">小计</span>
                  <span class="text-gray-900">$${money(order.subtotal)}</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">运费</span>
                  <span class="text-gray-900">$${money(order.shipping_cost)}</span>
                </div>
                ${(order.discount_amount || 0) > 0 ? `
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-500">折扣</span>
                    <span class="text-green-600">-$${money(order.discount_amount)}</span>
                  </div>
                ` : ''}
                <div class="flex justify-between text-base font-medium pt-2 border-t border-gray-200">
                  <span class="text-gray-900">总计</span>
                  <span class="text-gray-900">$${money(order.total || order.total_amount)}</span>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-medium text-gray-900">物流信息</h3>
                ${canAddTracking ? '<button id="add-tracking-btn" class="text-sm text-primary-600 hover:text-primary-700 font-medium">添加跟踪</button>' : ''}
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p class="text-sm text-gray-500 mb-1">收货地址</p>
                  <p class="text-sm text-gray-900">${order.customer_name || ''}</p>
                  ${shippingAddress ? `
                    <p class="text-sm text-gray-900">${shippingAddress.address || ''}</p>
                    <p class="text-sm text-gray-900">${shippingAddress.city || ''}${shippingAddress.state ? `, ${shippingAddress.state}` : ''} ${shippingAddress.postal_code || ''}</p>
                    <p class="text-sm text-gray-900">${shippingAddress.country || ''}</p>
                  ` : ''}
                </div>

                <div>
                  <p class="text-sm text-gray-500 mb-1">物流跟踪</p>
                  ${order.tracking_number ? `
                    <div>
                      <p class="text-sm text-gray-900 font-medium">${order.tracking_number}</p>
                      ${order.tracking_url ? `<a href="${order.tracking_url}" target="_blank" rel="noopener noreferrer" class="text-sm text-primary-600 hover:text-primary-700">跟踪包裹 →</a>` : ''}
                    </div>
                  ` : '<p class="text-sm text-gray-400 italic">暂无物流信息</p>'}
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="text-base font-medium text-gray-900 mb-4">订单时间线</h3>
              <div class="space-y-4">
                <div class="flex gap-4">
                  <div class="flex flex-col items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <div class="w-0.5 h-full bg-gray-200 mt-1"></div>
                  </div>
                  <div class="pb-4">
                    <p class="text-sm font-medium text-gray-900">订单创建</p>
                    <p class="text-xs text-gray-500">${order.created_at ? formatDate(order.created_at) : ''}</p>
                  </div>
                </div>
                ${order.status !== 'pending' ? `
                  <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                      <div class="w-3 h-3 rounded-full ${order.status === 'cancelled' || order.status === 'failed' ? 'bg-red-500' : 'bg-green-500'}"></div>
                      <div class="w-0.5 h-full bg-gray-200 mt-1"></div>
                    </div>
                    <div class="pb-4">
                      <p class="text-sm font-medium text-gray-900">${
                        order.status === 'paid' ? '收到付款' :
                        order.status === 'cancelled' ? '订单已取消' :
                        order.status === 'failed' ? '支付失败' :
                        order.status === 'refunded' ? '订单已退款' :
                        '状态已更新'
                      }</p>
                      <p class="text-xs text-gray-500">${formatDate(order.updated_at || order.created_at)}</p>
                    </div>
                  </div>
                ` : ''}
                ${order.tracking_number ? `
                  <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                      <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                      ${order.status !== 'delivered' ? '<div class="w-0.5 h-full bg-gray-200 mt-1"></div>' : ''}
                    </div>
                    <div class="pb-4">
                      <p class="text-sm font-medium text-gray-900">已发货</p>
                      <p class="text-xs text-gray-500">跟踪号: ${order.tracking_number}</p>
                    </div>
                  </div>
                ` : ''}
                ${order.status === 'delivered' ? `
                  <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                      <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-900">已送达</p>
                      <p class="text-xs text-gray-500">${formatDate(order.updated_at || order.created_at)}</p>
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        if (orderSidebar) {
          const showRefund = order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered';
          const canInviteReview = order.status === 'delivered' && !order.review_invited_at;
          const reviewInvited = !!order.review_invited_at;

          orderSidebar.innerHTML = `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="text-base font-medium text-gray-900 mb-4">客户信息</h3>
              <div class="space-y-3">
                <div>
                  <p class="text-sm text-gray-500">姓名</p>
                  <p class="text-sm font-medium text-gray-900">${order.customer_name || ''}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">邮箱</p>
                  <a href="mailto:${order.customer_email || ''}" class="text-sm font-medium text-primary-600 hover:text-primary-700">${order.customer_email || ''}</a>
                </div>
                ${order.customer_phone ? `
                  <div>
                    <p class="text-sm text-gray-500">电话</p>
                    <a href="tel:${order.customer_phone}" class="text-sm font-medium text-gray-900">${order.customer_phone}</a>
                  </div>
                ` : ''}
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="text-base font-medium text-gray-900 mb-4">支付信息</h3>
              <div class="space-y-3">
                <div>
                  <p class="text-sm text-gray-500">状态</p>
                  <p class="text-sm font-medium ${order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered' ? 'text-green-600' : order.status === 'failed' ? 'text-red-600' : 'text-yellow-600'}">
                    ${order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered' ? '已支付' : order.status === 'failed' ? '失败' : order.status === 'refunded' ? '已退款' : '待支付'}
                  </p>
                </div>
                ${order.payment_intent_id ? `
                  <div>
                    <p class="text-sm text-gray-500">支付 ID</p>
                    <p class="text-xs font-mono text-gray-600 break-all">${order.payment_intent_id}</p>
                  </div>
                ` : ''}
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="text-base font-medium text-gray-900 mb-4">操作</h3>
              <div class="space-y-3">
                <div>
                  <label for="status-select" class="block text-sm text-gray-500 mb-1">更新状态</label>
                  <select id="status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    ${statusOptions.map((s) => `<option value="${s.value}" ${order.status === s.value ? 'selected' : ''}>${s.label}</option>`).join('')}
                  </select>
                </div>

                ${showRefund ? '<button id="refund-btn" class="w-full px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">发起退款</button>' : ''}

                <button id="resend-email-btn" class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">重发确认邮件</button>

                ${canInviteReview ? '<button id="invite-review-btn" class="w-full px-4 py-2 text-sm font-medium text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors">邀请评价</button>' : ''}
                ${reviewInvited ? '<p class="text-xs text-gray-500 text-center">评价邀请已发送</p>' : ''}
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="text-base font-medium text-gray-900 mb-4">备注</h3>
              <textarea id="order-notes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="添加内部备注...">${order.notes || ''}</textarea>
              <button id="save-notes-btn" class="mt-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">保存备注</button>
            </div>
          `;
        }

        // Status update
        document.getElementById('status-select')?.addEventListener('change', async (e) => {
          const newStatus = e.target.value;
          try {
            const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/status`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: newStatus }),
            });
            const result = await res.json();
            if (res.ok && result.success) {
              showToast('状态更新成功');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              showToast(result.error || '更新状态失败', 'error');
            }
          } catch {
            showToast('更新状态失败', 'error');
          }
        });

        // Tracking modal
        document.getElementById('add-tracking-btn')?.addEventListener('click', () => {
          trackingModal?.classList.remove('hidden');
        });

        // Save notes
        document.getElementById('save-notes-btn')?.addEventListener('click', async () => {
          const notes = document.getElementById('order-notes')?.value || '';
          try {
            const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/notes`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ notes }),
            });
            const result = await res.json();
            if (res.ok && result.success) {
              showToast('备注已保存');
            } else {
              showToast(result.error || '保存备注失败', 'error');
            }
          } catch {
            showToast('保存备注失败', 'error');
          }
        });

        // Refund button
        document.getElementById('refund-btn')?.addEventListener('click', async () => {
          if (!confirm('确定要发起退款吗？此操作不可撤销。')) return;
          try {
            const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/refund`, { method: 'POST' });
            const result = await res.json();
            if (res.ok && result.success) {
              showToast('退款已发起');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              showToast(result.error || '退款处理失败', 'error');
            }
          } catch {
            showToast('退款处理失败', 'error');
          }
        });

        // Resend email
        document.getElementById('resend-email-btn')?.addEventListener('click', async () => {
          try {
            const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/resend-email`, { method: 'POST' });
            const result = await res.json();
            if (res.ok && result.success) {
              showToast('确认邮件已发送');
            } else {
              showToast(result.error || '发送邮件失败', 'error');
            }
          } catch {
            showToast('发送邮件失败', 'error');
          }
        });

        // Invite review
        document.getElementById('invite-review-btn')?.addEventListener('click', async () => {
          try {
            const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/invite-review`, { method: 'POST' });
            const result = await res.json();
            if (res.ok && result.success) {
              showToast('评价邀请已发送！');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              showToast(result.error || '发送邀请失败', 'error');
            }
          } catch {
            showToast('发送邀请失败', 'error');
          }
        });
      } catch {
        window.location.href = '/admin/orders';
      }
    }

    // Tracking modal
    document.getElementById('close-tracking-modal')?.addEventListener('click', () => {
      trackingModal?.classList.add('hidden');
    });
    document.getElementById('cancel-tracking')?.addEventListener('click', () => {
      trackingModal?.classList.add('hidden');
    });
    document.getElementById('tracking-backdrop')?.addEventListener('click', () => {
      trackingModal?.classList.add('hidden');
    });

    // Tracking form
    document.getElementById('tracking-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const data = {
        tracking_number: formData.get('tracking_number'),
        tracking_url: formData.get('tracking_url') || null,
        mark_shipped: formData.has('mark_shipped'),
        send_notification: formData.has('send_notification'),
      };

      try {
        const res = await fetch(`${API_URL}/api/admin/orders/${orderId}/shipping`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('物流信息已保存');
          trackingModal?.classList.add('hidden');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(result.error || '保存物流信息失败', 'error');
        }
      } catch {
        showToast('保存物流信息失败', 'error');
      }
    });

    loadOrder();
  </script>
</AdminLayout>
