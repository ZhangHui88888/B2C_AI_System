---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const { id } = Astro.params;

// Fetch order
const { data: order, error } = await supabase
  .from('orders')
  .select('*')
  .eq('id', id)
  .single();

if (error || !order) {
  return Astro.redirect('/admin/orders');
}

const statusOptions = [
  { value: 'pending', label: 'Pending', color: 'bg-yellow-100 text-yellow-800' },
  { value: 'paid', label: 'Paid', color: 'bg-blue-100 text-blue-800' },
  { value: 'processing', label: 'Processing', color: 'bg-indigo-100 text-indigo-800' },
  { value: 'shipped', label: 'Shipped', color: 'bg-purple-100 text-purple-800' },
  { value: 'delivered', label: 'Delivered', color: 'bg-green-100 text-green-800' },
  { value: 'cancelled', label: 'Cancelled', color: 'bg-red-100 text-red-800' },
  { value: 'refunded', label: 'Refunded', color: 'bg-gray-100 text-gray-800' },
];

function getStatusColor(status: string): string {
  return statusOptions.find(s => s.value === status)?.color || 'bg-gray-100 text-gray-800';
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
  });
}

const items = (order.items || []) as Array<{
  product_id?: string;
  name?: string;
  quantity?: number;
  unit_price?: number;
  line_total?: number;
  image?: string;
}>;

const shippingAddress = order.shipping_address as {
  address?: string;
  city?: string;
  state?: string;
  postal_code?: string;
  country?: string;
} | null;
---

<AdminLayout title={`Order #${order.order_number || id.slice(0, 8)}`} activePage="orders">
  <div class="max-w-5xl">
    <!-- Header -->
    <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <a href="/admin/orders" class="text-gray-500 hover:text-gray-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </a>
        <div>
          <h2 class="text-lg font-medium text-gray-900">Order #{order.order_number || id.slice(0, 8)}</h2>
          <p class="text-sm text-gray-500">{formatDate(order.created_at)}</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class={`inline-flex px-3 py-1 text-sm font-medium rounded-full ${getStatusColor(order.status)}`}>
          {statusOptions.find(s => s.value === order.status)?.label || order.status}
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Order Items -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-base font-medium text-gray-900">Order Items</h3>
          </div>
          <div class="divide-y divide-gray-100">
            {items.map((item) => (
              <div class="px-6 py-4 flex items-center gap-4">
                <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                  {item.image ? (
                    <img src={item.image} alt={item.name} class="w-full h-full object-cover" />
                  ) : (
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  )}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">{item.name || 'Product'}</p>
                  <p class="text-sm text-gray-500">Qty: {item.quantity || 1}</p>
                </div>
                <div class="text-right">
                  <p class="text-sm font-medium text-gray-900">${(item.line_total || 0).toFixed(2)}</p>
                  <p class="text-xs text-gray-500">${(item.unit_price || 0).toFixed(2)} each</p>
                </div>
              </div>
            ))}
          </div>
          <div class="px-6 py-4 bg-gray-50 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Subtotal</span>
              <span class="text-gray-900">${(order.subtotal || 0).toFixed(2)}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Shipping</span>
              <span class="text-gray-900">${(order.shipping_cost || 0).toFixed(2)}</span>
            </div>
            {order.discount_amount > 0 && (
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Discount</span>
                <span class="text-green-600">-${order.discount_amount.toFixed(2)}</span>
              </div>
            )}
            <div class="flex justify-between text-base font-medium pt-2 border-t border-gray-200">
              <span class="text-gray-900">Total</span>
              <span class="text-gray-900">${(order.total || order.total_amount || 0).toFixed(2)}</span>
            </div>
          </div>
        </div>

        <!-- Shipping Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-base font-medium text-gray-900">Shipping Information</h3>
            {order.status === 'paid' && (
              <button id="add-tracking-btn" class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                Add Tracking
              </button>
            )}
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <p class="text-sm text-gray-500 mb-1">Shipping Address</p>
              <p class="text-sm text-gray-900">{order.customer_name}</p>
              {shippingAddress && (
                <>
                  <p class="text-sm text-gray-900">{shippingAddress.address}</p>
                  <p class="text-sm text-gray-900">
                    {shippingAddress.city}{shippingAddress.state ? `, ${shippingAddress.state}` : ''} {shippingAddress.postal_code}
                  </p>
                  <p class="text-sm text-gray-900">{shippingAddress.country}</p>
                </>
              )}
            </div>
            
            <div>
              <p class="text-sm text-gray-500 mb-1">Tracking Information</p>
              {order.tracking_number ? (
                <div>
                  <p class="text-sm text-gray-900 font-medium">{order.tracking_number}</p>
                  {order.tracking_url && (
                    <a href={order.tracking_url} target="_blank" rel="noopener noreferrer" class="text-sm text-primary-600 hover:text-primary-700">
                      Track Package â†’
                    </a>
                  )}
                </div>
              ) : (
                <p class="text-sm text-gray-400 italic">No tracking information yet</p>
              )}
            </div>
          </div>
        </div>

        <!-- Order Timeline -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-base font-medium text-gray-900 mb-4">Order Timeline</h3>
          <div class="space-y-4">
            <div class="flex gap-4">
              <div class="flex flex-col items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <div class="w-0.5 h-full bg-gray-200 mt-1"></div>
              </div>
              <div class="pb-4">
                <p class="text-sm font-medium text-gray-900">Order Created</p>
                <p class="text-xs text-gray-500">{formatDate(order.created_at)}</p>
              </div>
            </div>
            {order.status !== 'pending' && (
              <div class="flex gap-4">
                <div class="flex flex-col items-center">
                  <div class={`w-3 h-3 rounded-full ${order.status === 'cancelled' || order.status === 'failed' ? 'bg-red-500' : 'bg-green-500'}`}></div>
                  <div class="w-0.5 h-full bg-gray-200 mt-1"></div>
                </div>
                <div class="pb-4">
                  <p class="text-sm font-medium text-gray-900">
                    {order.status === 'paid' ? 'Payment Received' : 
                     order.status === 'cancelled' ? 'Order Cancelled' :
                     order.status === 'failed' ? 'Payment Failed' :
                     order.status === 'refunded' ? 'Order Refunded' :
                     'Status Updated'}
                  </p>
                  <p class="text-xs text-gray-500">{formatDate(order.updated_at || order.created_at)}</p>
                </div>
              </div>
            )}
            {order.tracking_number && (
              <div class="flex gap-4">
                <div class="flex flex-col items-center">
                  <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                  {order.status !== 'delivered' && <div class="w-0.5 h-full bg-gray-200 mt-1"></div>}
                </div>
                <div class="pb-4">
                  <p class="text-sm font-medium text-gray-900">Shipped</p>
                  <p class="text-xs text-gray-500">Tracking: {order.tracking_number}</p>
                </div>
              </div>
            )}
            {order.status === 'delivered' && (
              <div class="flex gap-4">
                <div class="flex flex-col items-center">
                  <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-900">Delivered</p>
                  <p class="text-xs text-gray-500">{formatDate(order.updated_at || order.created_at)}</p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Customer Info -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-base font-medium text-gray-900 mb-4">Customer</h3>
          <div class="space-y-3">
            <div>
              <p class="text-sm text-gray-500">Name</p>
              <p class="text-sm font-medium text-gray-900">{order.customer_name}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Email</p>
              <a href={`mailto:${order.customer_email}`} class="text-sm font-medium text-primary-600 hover:text-primary-700">
                {order.customer_email}
              </a>
            </div>
            {order.customer_phone && (
              <div>
                <p class="text-sm text-gray-500">Phone</p>
                <a href={`tel:${order.customer_phone}`} class="text-sm font-medium text-gray-900">
                  {order.customer_phone}
                </a>
              </div>
            )}
          </div>
        </div>

        <!-- Payment Info -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-base font-medium text-gray-900 mb-4">Payment</h3>
          <div class="space-y-3">
            <div>
              <p class="text-sm text-gray-500">Status</p>
              <p class={`text-sm font-medium ${order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered' ? 'text-green-600' : order.status === 'failed' ? 'text-red-600' : 'text-yellow-600'}`}>
                {order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered' ? 'Paid' : 
                 order.status === 'failed' ? 'Failed' : 
                 order.status === 'refunded' ? 'Refunded' : 'Pending'}
              </p>
            </div>
            {order.payment_intent_id && (
              <div>
                <p class="text-sm text-gray-500">Payment ID</p>
                <p class="text-xs font-mono text-gray-600 break-all">{order.payment_intent_id}</p>
              </div>
            )}
          </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-base font-medium text-gray-900 mb-4">Actions</h3>
          <div class="space-y-3">
            <div>
              <label for="status-select" class="block text-sm text-gray-500 mb-1">Update Status</label>
              <select id="status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                {statusOptions.map((s) => (
                  <option value={s.value} selected={order.status === s.value}>{s.label}</option>
                ))}
              </select>
            </div>
            
            {(order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered') && (
              <button id="refund-btn" class="w-full px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                Issue Refund
              </button>
            )}
            
            <button id="resend-email-btn" class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              Resend Confirmation Email
            </button>
            
            {order.status === 'delivered' && !order.review_invited_at && (
              <button id="invite-review-btn" class="w-full px-4 py-2 text-sm font-medium text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors">
                Invite to Review
              </button>
            )}
            
            {order.review_invited_at && (
              <p class="text-xs text-gray-500 text-center">Review invitation sent</p>
            )}
          </div>
        </div>

        <!-- Notes -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-base font-medium text-gray-900 mb-4">Notes</h3>
          <textarea
            id="order-notes"
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            placeholder="Add internal notes..."
          >{order.notes || ''}</textarea>
          <button id="save-notes-btn" class="mt-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
            Save Notes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracking Modal -->
  <div id="tracking-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" id="tracking-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-900">Add Tracking Information</h3>
          <button id="close-tracking-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="tracking-form" class="p-6 space-y-4">
          <div>
            <label for="tracking-number" class="block text-sm font-medium text-gray-700 mb-1">Tracking Number *</label>
            <input
              type="text"
              id="tracking-number"
              name="tracking_number"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="Enter tracking number"
            />
          </div>
          <div>
            <label for="tracking-url" class="block text-sm font-medium text-gray-700 mb-1">Tracking URL</label>
            <input
              type="url"
              id="tracking-url"
              name="tracking_url"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="https://..."
            />
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              id="mark-shipped"
              name="mark_shipped"
              checked
              class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
            />
            <label for="mark-shipped" class="ml-2 block text-sm text-gray-700">Mark order as shipped</label>
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              id="send-notification"
              name="send_notification"
              checked
              class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
            />
            <label for="send-notification" class="ml-2 block text-sm text-gray-700">Send shipping notification email</label>
          </div>
          <div class="pt-4 flex gap-3">
            <button type="button" id="cancel-tracking" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              Cancel
            </button>
            <button type="submit" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
              Save & Ship
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50"></div>

  <script define:vars={{ orderId: order.id }}>
    const toast = document.getElementById('toast');
    const trackingModal = document.getElementById('tracking-modal');

    function showToast(message, type = 'success') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
      }`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    // Status update
    document.getElementById('status-select')?.addEventListener('change', async (e) => {
      const newStatus = (e.target as HTMLSelectElement).value;
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('Status updated successfully');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(result.error || 'Failed to update status', 'error');
        }
      } catch {
        showToast('Failed to update status', 'error');
      }
    });

    // Tracking modal
    document.getElementById('add-tracking-btn')?.addEventListener('click', () => {
      trackingModal?.classList.remove('hidden');
    });
    document.getElementById('close-tracking-modal')?.addEventListener('click', () => {
      trackingModal?.classList.add('hidden');
    });
    document.getElementById('cancel-tracking')?.addEventListener('click', () => {
      trackingModal?.classList.add('hidden');
    });
    document.getElementById('tracking-backdrop')?.addEventListener('click', () => {
      trackingModal?.classList.add('hidden');
    });

    // Tracking form
    document.getElementById('tracking-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      
      const data = {
        tracking_number: formData.get('tracking_number'),
        tracking_url: formData.get('tracking_url') || null,
        mark_shipped: formData.has('mark_shipped'),
        send_notification: formData.has('send_notification'),
      };

      try {
        const res = await fetch(`/api/admin/orders/${orderId}/shipping`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('Tracking information saved');
          trackingModal?.classList.add('hidden');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(result.error || 'Failed to save tracking', 'error');
        }
      } catch {
        showToast('Failed to save tracking', 'error');
      }
    });

    // Save notes
    document.getElementById('save-notes-btn')?.addEventListener('click', async () => {
      const notes = (document.getElementById('order-notes') as HTMLTextAreaElement)?.value || '';
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/notes`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes }),
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('Notes saved');
        } else {
          showToast(result.error || 'Failed to save notes', 'error');
        }
      } catch {
        showToast('Failed to save notes', 'error');
      }
    });

    // Refund button
    document.getElementById('refund-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to issue a refund? This action cannot be undone.')) return;
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/refund`, { method: 'POST' });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('Refund initiated successfully');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(result.error || 'Failed to process refund', 'error');
        }
      } catch {
        showToast('Failed to process refund', 'error');
      }
    });

    // Resend email
    document.getElementById('resend-email-btn')?.addEventListener('click', async () => {
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/resend-email`, { method: 'POST' });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('Confirmation email sent');
        } else {
          showToast(result.error || 'Failed to send email', 'error');
        }
      } catch {
        showToast('Failed to send email', 'error');
      }
    });

    // Invite review
    document.getElementById('invite-review-btn')?.addEventListener('click', async () => {
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/invite-review`, { method: 'POST' });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast('Review invitation sent!');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(result.error || 'Failed to send invitation', 'error');
        }
      } catch {
        showToast('Failed to send invitation', 'error');
      }
    });
  </script>
</AdminLayout>
