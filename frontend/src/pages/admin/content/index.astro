---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Get products for the generator
const { data: products } = await supabase
  .from('products')
  .select('id, name')
  .eq('is_active', true)
  .order('name');

// Get saved content
const { data: content } = await supabase
  .from('content_library')
  .select('id, type, product_id, content, platform, status, created_at')
  .order('created_at', { ascending: false })
  .limit(20);
---

<AdminLayout title="Content Generator" activePage="content">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Generator Panel -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Generate Content</h2>
      
      <form id="generate-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Select Product</label>
          <select id="product-select" name="productId" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="">Choose a product...</option>
            {products?.map((p) => (
              <option value={p.id}>{p.name}</option>
            ))}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
          <select id="content-type" name="contentType" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="">Select type...</option>
            <optgroup label="Video Scripts">
              <option value="script_unboxing">Unboxing Video Script</option>
              <option value="script_review">Review Video Script</option>
              <option value="script_tutorial">Tutorial Video Script</option>
              <option value="script_promo">Promo Video Script</option>
            </optgroup>
            <optgroup label="Marketing Copy">
              <option value="copy_long">Long Product Description</option>
              <option value="copy_short">Short Description</option>
              <option value="copy_social">Social Media Post</option>
              <option value="copy_email">Email Marketing</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
          <select id="platform" name="platform" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="tiktok">TikTok</option>
            <option value="instagram">Instagram</option>
            <option value="youtube">YouTube</option>
            <option value="facebook">Facebook</option>
            <option value="pinterest">Pinterest</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tone</label>
          <select id="tone" name="tone" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="casual">Casual & Friendly</option>
            <option value="professional">Professional</option>
            <option value="playful">Playful & Fun</option>
            <option value="luxury">Luxury & Premium</option>
            <option value="informative">Informative</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
          <select id="language" name="language" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="English">English</option>
            <option value="Chinese">Chinese (中文)</option>
            <option value="Spanish">Spanish</option>
            <option value="French">French</option>
          </select>
        </div>

        <button type="submit" id="generate-btn" class="w-full px-4 py-2 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          Generate Content
        </button>
      </form>

      <!-- Result -->
      <div id="result-panel" class="hidden mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-gray-700">Generated Content</h3>
          <div class="flex gap-2">
            <button id="copy-btn" class="text-xs text-primary-600 hover:text-primary-700">Copy</button>
            <button id="save-btn" class="text-xs text-green-600 hover:text-green-700">Save to Library</button>
          </div>
        </div>
        <div id="result-content" class="p-4 bg-gray-50 rounded-lg text-sm text-gray-800 whitespace-pre-wrap max-h-96 overflow-y-auto"></div>
      </div>
    </div>

    <!-- Saved Content -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Content Library</h2>
      
      <div id="content-list" class="space-y-3 max-h-[600px] overflow-y-auto">
        {content && content.length > 0 ? (
          content.map((item) => (
            <div class="p-3 bg-gray-50 rounded-lg group" data-id={item.id}>
              <div class="flex items-start justify-between mb-2">
                <div>
                  <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded bg-primary-100 text-primary-800">
                    {item.type}
                  </span>
                  {item.platform && (
                    <span class="ml-1 inline-flex px-2 py-0.5 text-xs font-medium rounded bg-gray-200 text-gray-700">
                      {item.platform}
                    </span>
                  )}
                  <span class={`ml-1 inline-flex px-2 py-0.5 text-xs font-medium rounded ${
                    item.status === 'approved' ? 'bg-green-100 text-green-800' :
                    item.status === 'published' ? 'bg-blue-100 text-blue-800' :
                    'bg-yellow-100 text-yellow-800'
                  }`}>
                    {item.status}
                  </span>
                </div>
                <button class="delete-content text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-id={item.id}>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
              <p class="text-sm text-gray-600 line-clamp-3">{item.content}</p>
              <p class="text-xs text-gray-400 mt-2">{new Date(item.created_at).toLocaleDateString()}</p>
            </div>
          ))
        ) : (
          <p class="text-sm text-gray-500 text-center py-8">No saved content yet</p>
        )}
      </div>
    </div>
  </div>

  <script>
    import { api } from '@lib/api';

    const form = document.getElementById('generate-form') as HTMLFormElement;
    const generateBtn = document.getElementById('generate-btn') as HTMLButtonElement;
    const resultPanel = document.getElementById('result-panel');
    const resultContent = document.getElementById('result-content');
    const copyBtn = document.getElementById('copy-btn');
    const saveBtn = document.getElementById('save-btn');

    let currentResult = { content: '', type: '', productId: '', platform: '' };

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const productId = formData.get('productId') as string;
      const contentType = formData.get('contentType') as string;
      const platform = formData.get('platform') as string;
      const tone = formData.get('tone') as string;
      const language = formData.get('language') as string;

      if (!productId || !contentType) return;

      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      try {
        let result;
        if (contentType.startsWith('script_')) {
          const videoType = contentType.replace('script_', '') as any;
          result = await api.generateScript({ productId, videoType, platform, tone, language });
          if (result.success && result.data) {
            currentResult = { 
              content: result.data.script, 
              type: 'script', 
              productId, 
              platform 
            };
          }
        } else {
          const copyType = contentType.replace('copy_', '');
          const copyTypeMap: Record<string, any> = {
            long: 'long_description',
            short: 'short_description',
            social: 'social_post',
            email: 'email',
          };
          result = await api.generateCopy({ 
            productId, 
            copyType: copyTypeMap[copyType], 
            platform, 
            tone, 
            language 
          });
          if (result.success && result.data) {
            currentResult = { 
              content: result.data.copy, 
              type: copyType === 'social' ? 'caption' : 'description', 
              productId, 
              platform 
            };
          }
        }

        if (currentResult.content) {
          resultContent!.textContent = currentResult.content;
          resultPanel?.classList.remove('hidden');
        } else {
          alert('Failed to generate content');
        }
      } catch (error) {
        console.error('Generation error:', error);
        alert('Failed to generate content');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Content';
      }
    });

    copyBtn?.addEventListener('click', () => {
      navigator.clipboard.writeText(currentResult.content);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
    });

    saveBtn?.addEventListener('click', async () => {
      if (!currentResult.content) return;
      
      try {
        const result = await api.saveContent({
          type: currentResult.type as any,
          content: currentResult.content,
          product_id: currentResult.productId,
          platform: currentResult.platform as any,
          status: 'draft',
        });
        
        if (result.success) {
          saveBtn.textContent = 'Saved!';
          setTimeout(() => { 
            saveBtn.textContent = 'Save to Library';
            window.location.reload();
          }, 1000);
        } else {
          alert('Failed to save content');
        }
      } catch {
        alert('Failed to save content');
      }
    });

    document.querySelectorAll('.delete-content').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        if (!id || !confirm('Delete this content?')) return;
        
        try {
          const result = await api.deleteContent(id);
          if (result.success) {
            window.location.reload();
          }
        } catch {
          alert('Failed to delete');
        }
      });
    });
  </script>
</AdminLayout>
