---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Get products for the generator
const { data: products } = await supabase
  .from('products')
  .select('id, name')
  .eq('is_active', true)
  .order('name');

// Get authors for assignment
const { data: authors } = await supabase
  .from('authors')
  .select('id, name')
  .eq('is_active', true)
  .order('name');

// Get saved content with author info
const { data: content } = await supabase
  .from('content_library')
  .select('id, type, product_id, content, platform, status, is_ai_generated, author_id, title, created_at, author:authors(id, name)')
  .order('created_at', { ascending: false })
  .limit(20);
---

<AdminLayout title="å†…å®¹ç”Ÿæˆå™¨" activePage="content">
  <!-- Header with Quality Tools Link -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">å†…å®¹ç”Ÿæˆå™¨</h1>
      <p class="text-sm text-gray-500 mt-1">AI é©±åŠ¨çš„è§†é¢‘è„šæœ¬å’Œè¥é”€æ–‡æ¡ˆ</p>
    </div>
    <a href="/admin/content/quality" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      è´¨é‡å·¥å…·
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Generator Panel -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">ç”Ÿæˆå†…å®¹</h2>
      
      <form id="generate-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©äº§å“</label>
          <select id="product-select" name="productId" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="">é€‰æ‹©ä¸€ä¸ªäº§å“...</option>
            {products?.map((p) => (
              <option value={p.id}>{p.name}</option>
            ))}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹ç±»å‹</label>
          <select id="content-type" name="contentType" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="">é€‰æ‹©ç±»å‹...</option>
            <optgroup label="è§†é¢‘è„šæœ¬">
              <option value="script_unboxing">å¼€ç®±è§†é¢‘è„šæœ¬</option>
              <option value="script_review">è¯„æµ‹è§†é¢‘è„šæœ¬</option>
              <option value="script_tutorial">æ•™ç¨‹è§†é¢‘è„šæœ¬</option>
              <option value="script_promo">ä¿ƒé”€è§†é¢‘è„šæœ¬</option>
            </optgroup>
            <optgroup label="è¥é”€æ–‡æ¡ˆ">
              <option value="copy_long">é•¿äº§å“æè¿°</option>
              <option value="copy_short">çŸ­æè¿°</option>
              <option value="copy_social">ç¤¾äº¤åª’ä½“å¸–å­</option>
              <option value="copy_email">é‚®ä»¶è¥é”€</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å¹³å°</label>
          <select id="platform" name="platform" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="tiktok">TikTok</option>
            <option value="instagram">Instagram</option>
            <option value="youtube">YouTube</option>
            <option value="facebook">Facebook</option>
            <option value="pinterest">Pinterest</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">è¯­æ°”</label>
          <select id="tone" name="tone" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="casual">ä¼‘é—²å‹å¥½</option>
            <option value="professional">ä¸“ä¸š</option>
            <option value="playful">æ´»æ³¼æœ‰è¶£</option>
            <option value="luxury">å¥¢åé«˜ç«¯</option>
            <option value="informative">ä¿¡æ¯æ€§</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">è¯­è¨€</label>
          <select id="language" name="language" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="English">è‹±æ–‡</option>
            <option value="Chinese">ä¸­æ–‡</option>
            <option value="Spanish">è¥¿ç­ç‰™è¯­</option>
            <option value="French">æ³•è¯­</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é…ä½œè€…ï¼ˆå¯é€‰ï¼‰</label>
          <select id="author-select" name="authorId" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
            <option value="">æ— ä½œè€…</option>
            {authors?.map((a) => (
              <option value={a.id}>{a.name}</option>
            ))}
          </select>
        </div>

        <button type="submit" id="generate-btn" class="w-full px-4 py-2 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          ç”Ÿæˆå†…å®¹
        </button>
      </form>

      <!-- Result -->
      <div id="result-panel" class="hidden mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-gray-700">ç”Ÿæˆçš„å†…å®¹</h3>
          <div class="flex gap-2">
            <button id="copy-btn" class="text-xs text-primary-600 hover:text-primary-700">å¤åˆ¶</button>
            <button id="save-btn" class="text-xs text-green-600 hover:text-green-700">ä¿å­˜åˆ°åº“</button>
          </div>
        </div>
        <div id="result-content" class="p-4 bg-gray-50 rounded-lg text-sm text-gray-800 whitespace-pre-wrap max-h-96 overflow-y-auto"></div>
      </div>
    </div>

    <!-- Saved Content -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">å†…å®¹åº“</h2>
      
      <div id="content-list" class="space-y-3 max-h-[600px] overflow-y-auto">
        {content && content.length > 0 ? (
          content.map((item) => {
            const author = item.author as { id: string; name: string } | null;
            return (
              <div class="p-3 bg-gray-50 rounded-lg group" data-id={item.id}>
                <div class="flex items-start justify-between mb-2">
                  <div class="flex flex-wrap gap-1">
                    <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded bg-primary-100 text-primary-800">
                      {item.type}
                    </span>
                    {item.platform && (
                      <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded bg-gray-200 text-gray-700">
                        {item.platform}
                      </span>
                    )}
                    {item.is_ai_generated && (
                      <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded bg-purple-100 text-purple-800" title="AI Generated">
                        ğŸ¤– AI
                      </span>
                    )}
                    <span class={`inline-flex px-2 py-0.5 text-xs font-medium rounded ${
                      item.status === 'approved' ? 'bg-green-100 text-green-800' :
                      item.status === 'published' ? 'bg-blue-100 text-blue-800' :
                      'bg-yellow-100 text-yellow-800'
                    }`}>
                      {item.status}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    {item.status === 'draft' && (
                      <button class="approve-content text-green-600 hover:text-green-700 text-xs font-medium" data-id={item.id}>å®¡æ‰¹</button>
                    )}
                    {item.status === 'approved' && (
                      <button class="publish-content text-blue-600 hover:text-blue-700 text-xs font-medium" data-id={item.id}>å‘å¸ƒ</button>
                    )}
                    <button class="delete-content text-gray-400 hover:text-red-600" data-id={item.id}>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                </div>
                {item.title && <p class="text-sm font-medium text-gray-900 mb-1">{item.title}</p>}
                <p class="text-sm text-gray-600 line-clamp-3">{item.content}</p>
                <div class="flex items-center justify-between mt-2">
                  <p class="text-xs text-gray-400">
                    {new Date(item.created_at).toLocaleDateString()}
                    {author && <span class="ml-2">by {author.name}</span>}
                  </p>
                </div>
              </div>
            );
          })
        ) : (
          <p class="text-sm text-gray-500 text-center py-8">æš‚æ— ä¿å­˜çš„å†…å®¹</p>
        )}
      </div>
    </div>
  </div>

  <script>
    import { api } from '@lib/api';

    const form = document.getElementById('generate-form') as HTMLFormElement;
    const generateBtn = document.getElementById('generate-btn') as HTMLButtonElement;
    const resultPanel = document.getElementById('result-panel');
    const resultContent = document.getElementById('result-content');
    const copyBtn = document.getElementById('copy-btn');
    const saveBtn = document.getElementById('save-btn');

    let currentResult = { content: '', type: '', productId: '', platform: '' };

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const productId = formData.get('productId') as string;
      const contentType = formData.get('contentType') as string;
      const platform = formData.get('platform') as string;
      const tone = formData.get('tone') as string;
      const language = formData.get('language') as string;

      if (!productId || !contentType) return;

      generateBtn.disabled = true;
      generateBtn.textContent = 'ç”Ÿæˆä¸­...';

      try {
        let result;
        if (contentType.startsWith('script_')) {
          const videoType = contentType.replace('script_', '') as any;
          result = await api.generateScript({ productId, videoType, platform, tone, language });
          if (result.success && result.data) {
            currentResult = { 
              content: result.data.script, 
              type: 'script', 
              productId, 
              platform 
            };
          }
        } else {
          const copyType = contentType.replace('copy_', '');
          const copyTypeMap: Record<string, any> = {
            long: 'long_description',
            short: 'short_description',
            social: 'social_post',
            email: 'email',
          };
          result = await api.generateCopy({ 
            productId, 
            copyType: copyTypeMap[copyType], 
            platform, 
            tone, 
            language 
          });
          if (result.success && result.data) {
            currentResult = { 
              content: result.data.copy, 
              type: copyType === 'social' ? 'caption' : 'description', 
              productId, 
              platform 
            };
          }
        }

        if (currentResult.content) {
          resultContent!.textContent = currentResult.content;
          resultPanel?.classList.remove('hidden');
        } else {
          alert('ç”Ÿæˆå†…å®¹å¤±è´¥');
        }
      } catch (error) {
        console.error('Generation error:', error);
        alert('ç”Ÿæˆå†…å®¹å¤±è´¥');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ç”Ÿæˆå†…å®¹';
      }
    });

    copyBtn?.addEventListener('click', () => {
      navigator.clipboard.writeText(currentResult.content);
      copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
      setTimeout(() => { copyBtn.textContent = 'å¤åˆ¶'; }, 2000);
    });

    saveBtn?.addEventListener('click', async () => {
      if (!currentResult.content) return;
      
      try {
        const result = await api.saveContent({
          type: currentResult.type as any,
          content: currentResult.content,
          product_id: currentResult.productId,
          platform: currentResult.platform as any,
          status: 'draft',
        });
        
        if (result.success) {
          saveBtn.textContent = 'å·²ä¿å­˜ï¼';
          setTimeout(() => { 
            saveBtn.textContent = 'ä¿å­˜åˆ°åº“';
            window.location.reload();
          }, 1000);
        } else {
          alert('ä¿å­˜å†…å®¹å¤±è´¥');
        }
      } catch {
        alert('ä¿å­˜å†…å®¹å¤±è´¥');
      }
    });

    document.querySelectorAll('.delete-content').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        if (!id || !confirm('åˆ é™¤æ­¤å†…å®¹ï¼Ÿ')) return;
        
        try {
          const result = await api.deleteContent(id);
          if (result.success) {
            window.location.reload();
          }
        } catch {
          alert('åˆ é™¤å¤±è´¥');
        }
      });
    });

    // Approve content (draft -> approved)
    document.querySelectorAll('.approve-content').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        if (!id) return;
        
        try {
          const result = await api.updateContent(id, { status: 'approved' });
          if (result.success) {
            window.location.reload();
          } else {
            alert('å®¡æ‰¹å†…å®¹å¤±è´¥');
          }
        } catch {
          alert('å®¡æ‰¹å†…å®¹å¤±è´¥');
        }
      });
    });

    // Publish content (approved -> published)
    document.querySelectorAll('.publish-content').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        if (!id) return;
        
        try {
          const result = await api.updateContent(id, { status: 'published' });
          if (result.success) {
            window.location.reload();
          } else {
            alert('å‘å¸ƒå†…å®¹å¤±è´¥');
          }
        } catch {
          alert('å‘å¸ƒå†…å®¹å¤±è´¥');
        }
      });
    });
  </script>
</AdminLayout>
