---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

// Data loaded dynamically via client-side API calls
const products: any[] = [];
const staleCount = 0;
---

<AdminLayout title="å†…å®¹è´¨é‡" activePage="content">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">å†…å®¹è´¨é‡å·¥å…·</h1>
        <p class="text-sm text-gray-500 mt-1">åˆ†æåŸåˆ›æ€§å¹¶ç”Ÿæˆå·®å¼‚åŒ–å†…å®¹</p>
      </div>
      <a href="/admin/content" class="text-sm text-primary-600 hover:text-primary-700">
        â† è¿”å›å†…å®¹ç”Ÿæˆå™¨
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Originality Checker -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center gap-2 mb-4">
          <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h2 class="text-lg font-semibold text-gray-900">åŸåˆ›æ€§æ£€æŸ¥å™¨</h2>
        </div>
        <p class="text-sm text-gray-500 mb-4">åˆ†æå†…å®¹çš„ AI æ¨¡å¼ã€é€šç”¨çŸ­è¯­å’Œç‹¬ç‰¹æ€§</p>
        
        <form id="originality-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è¦åˆ†æçš„å†…å®¹</label>
            <textarea 
              id="originality-content" 
              name="content" 
              rows="8" 
              required
              placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥å†…å®¹ï¼ˆè‡³å°‘ 50 ä¸ªå­—ç¬¦ï¼‰..."
              class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm"
            ></textarea>
          </div>
          
          <button type="submit" id="check-originality-btn" class="w-full px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            æ£€æŸ¥åŸåˆ›æ€§
          </button>
        </form>

        <!-- Originality Results -->
        <div id="originality-results" class="hidden mt-6 space-y-4">
          <!-- Score -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm font-medium text-gray-600">åŸåˆ›æ€§åˆ†æ•°</p>
              <p id="originality-score" class="text-3xl font-bold text-gray-900">--</p>
            </div>
            <div id="score-indicator" class="w-16 h-16 rounded-full flex items-center justify-center">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>

          <!-- Flags -->
          <div class="grid grid-cols-2 gap-2" id="originality-flags">
          </div>

          <!-- Assessment -->
          <div>
            <p class="text-sm font-medium text-gray-700 mb-1">è¯„ä¼°</p>
            <p id="originality-assessment" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg"></p>
          </div>

          <!-- Patterns Found -->
          <div id="patterns-section" class="hidden">
            <p class="text-sm font-medium text-gray-700 mb-1">æ£€æµ‹åˆ°çš„é€šç”¨æ¨¡å¼</p>
            <ul id="patterns-list" class="text-sm text-red-600 bg-red-50 p-3 rounded-lg space-y-1"></ul>
          </div>

          <!-- Suggestions -->
          <div id="suggestions-section" class="hidden">
            <p class="text-sm font-medium text-gray-700 mb-1">æ”¹è¿›å»ºè®®</p>
            <ul id="suggestions-list" class="text-sm text-blue-600 bg-blue-50 p-3 rounded-lg space-y-1"></ul>
          </div>
        </div>
      </div>

      <!-- Content Differentiation Engine -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center gap-2 mb-4">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          <h2 class="text-lg font-semibold text-gray-900">å·®å¼‚åŒ–å¼•æ“</h2>
        </div>
        <p class="text-sm text-gray-500 mb-4">ä½¿ç”¨çœŸå®äº§å“æ•°æ®ã€è¯„è®ºå’Œè§„æ ¼ç”Ÿæˆç‹¬ç‰¹å†…å®¹</p>
        
        <form id="differentiate-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©äº§å“</label>
            <select id="diff-product" name="productId" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
              <option value="">é€‰æ‹©ä¸€ä¸ªäº§å“...</option>
              {products?.map((p) => (
                <option value={p.id}>{p.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹ç±»å‹</label>
            <select id="diff-type" name="contentType" required class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
              <option value="description">äº§å“æè¿°</option>
              <option value="social_post">ç¤¾äº¤åª’ä½“å¸–å­</option>
              <option value="email">è¥é”€é‚®ä»¶</option>
              <option value="blog">åšå®¢æ–‡ç« </option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è¯­æ°”</label>
            <select id="diff-tone" name="tone" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
              <option value="professional">ä¸“ä¸š</option>
              <option value="casual">ä¼‘é—²å‹å¥½</option>
              <option value="playful">æ´»æ³¼æœ‰è¶£</option>
              <option value="luxury">å¥¢åé«˜ç«¯</option>
              <option value="informative">ä¿¡æ¯æ€§</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è¯­è¨€</label>
            <select id="diff-language" name="language" class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
              <option value="English">è‹±æ–‡</option>
              <option value="Chinese">ä¸­æ–‡</option>
              <option value="Spanish">è¥¿ç­ç‰™è¯­</option>
              <option value="French">æ³•è¯­</option>
            </select>
          </div>

          <!-- Data Sources -->
          <div class="space-y-2">
            <p class="text-sm font-medium text-gray-700">åŒ…å«æ•°æ®æº</p>
            <div class="flex flex-wrap gap-4">
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="include-reviews" name="includeReviews" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">å®¢æˆ·è¯„è®º
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="include-specs" name="includeSpecs" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">è§„æ ¼å‚æ•°
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="include-comparisons" name="includeComparisons" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">äº§å“å¯¹æ¯”
              </label>
            </div>
          </div>

          <!-- Optional: Base Content to Improve -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è¦æ”¹è¿›çš„åŸºç¡€å†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
            <textarea 
              id="base-content" 
              name="baseContent" 
              rows="3" 
              placeholder="ç²˜è´´ç°æœ‰å†…å®¹ä»¥ä½¿ç”¨çœŸå®æ•°æ®å¢å¼º..."
              class="w-full border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm"
            ></textarea>
          </div>
          
          <button type="submit" id="differentiate-btn" class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            ç”Ÿæˆå·®å¼‚åŒ–å†…å®¹
          </button>
        </form>

        <!-- Differentiation Results -->
        <div id="diff-results" class="hidden mt-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-700">ç”Ÿæˆçš„å†…å®¹</h3>
            <div class="flex gap-2">
              <button id="copy-diff-btn" class="text-xs text-primary-600 hover:text-primary-700">å¤åˆ¶</button>
              <button id="check-diff-originality-btn" class="text-xs text-purple-600 hover:text-purple-700">æ£€æŸ¥åŸåˆ›æ€§</button>
              <button id="save-diff-btn" class="text-xs text-green-600 hover:text-green-700">ä¿å­˜åˆ°åº“</button>
            </div>
          </div>
          <div id="diff-content" class="p-4 bg-gray-50 rounded-lg text-sm text-gray-800 whitespace-pre-wrap max-h-96 overflow-y-auto"></div>
          
          <!-- Metadata -->
          <div id="diff-metadata" class="mt-3 flex flex-wrap gap-2 text-xs">
          </div>
        </div>
      </div>
    </div>

    <!-- Stale Content Alert -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h2 class="text-lg font-semibold text-gray-900">å†…å®¹æ–°é²œåº¦</h2>
          {staleCount && staleCount > 0 && (
            <span class="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">
              {staleCount} éœ€è¦å…³æ³¨
            </span>
          )}
        </div>
        <button id="load-stale-btn" class="text-sm text-primary-600 hover:text-primary-700">
          åŠ è½½è¿‡æ—¶å†…å®¹ â†’
        </button>
      </div>

      <div id="stale-content-list" class="hidden space-y-3">
        <!-- Stale content items will be loaded here -->
      </div>
      <div id="stale-empty" class="hidden text-center py-8 text-sm text-gray-500">
        æ‰€æœ‰å·²å‘å¸ƒå†…å®¹éƒ½æ˜¯æœ€æ–°çš„ï¼
      </div>
    </div>
  </div>

  <script>
    import { api } from '@lib/api';

    // Originality Check
    const originalityForm = document.getElementById('originality-form') as HTMLFormElement;
    const checkOriginalityBtn = document.getElementById('check-originality-btn') as HTMLButtonElement;
    const originalityResults = document.getElementById('originality-results');

    originalityForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = (document.getElementById('originality-content') as HTMLTextAreaElement).value;
      
      if (content.length < 50) {
        alert('å†…å®¹è‡³å°‘éœ€è¦ 50 ä¸ªå­—ç¬¦');
        return;
      }

      checkOriginalityBtn.disabled = true;
      checkOriginalityBtn.textContent = 'åˆ†æä¸­...';

      try {
        const result = await api.checkOriginality(content);
        
        if (result.success && result.data) {
          displayOriginalityResults(result.data);
          originalityResults?.classList.remove('hidden');
        } else {
          alert('æ£€æŸ¥åŸåˆ›æ€§å¤±è´¥');
        }
      } catch (error) {
        console.error('Originality check error:', error);
        alert('æ£€æŸ¥åŸåˆ›æ€§å¤±è´¥');
      } finally {
        checkOriginalityBtn.disabled = false;
        checkOriginalityBtn.textContent = 'æ£€æŸ¥åŸåˆ›æ€§';
      }
    });

    function displayOriginalityResults(data: any) {
      const score = data.score;
      const scoreEl = document.getElementById('originality-score');
      const indicatorEl = document.getElementById('score-indicator');
      
      if (scoreEl) scoreEl.textContent = `${score}/100`;
      
      if (indicatorEl) {
        if (score >= 70) {
          indicatorEl.className = 'w-16 h-16 rounded-full flex items-center justify-center bg-green-100 text-green-600';
        } else if (score >= 40) {
          indicatorEl.className = 'w-16 h-16 rounded-full flex items-center justify-center bg-yellow-100 text-yellow-600';
        } else {
          indicatorEl.className = 'w-16 h-16 rounded-full flex items-center justify-center bg-red-100 text-red-600';
        }
      }

      // Flags
      const flagsEl = document.getElementById('originality-flags');
      if (flagsEl) {
        const flags = data.flags;
        flagsEl.innerHTML = `
          <div class="flex items-center gap-2 p-2 rounded ${flags.hasGenericOpening ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
            <span class="text-lg">${flags.hasGenericOpening ? 'âš ï¸' : 'âœ“'}</span>
            <span class="text-xs">Generic Opening</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded ${flags.hasRepetitiveStructure ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
            <span class="text-lg">${flags.hasRepetitiveStructure ? 'âš ï¸' : 'âœ“'}</span>
            <span class="text-xs">Repetitive Structure</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded ${flags.lacksSpecificDetails ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
            <span class="text-lg">${flags.lacksSpecificDetails ? 'âš ï¸' : 'âœ“'}</span>
            <span class="text-xs">Specific Details</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded ${flags.hasAIPatterns ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
            <span class="text-lg">${flags.hasAIPatterns ? 'âš ï¸' : 'âœ“'}</span>
            <span class="text-xs">AI Patterns</span>
          </div>
        `;
      }

      // Assessment
      const assessmentEl = document.getElementById('originality-assessment');
      if (assessmentEl) assessmentEl.textContent = data.analysis.overallAssessment;

      // Patterns
      const patternsSection = document.getElementById('patterns-section');
      const patternsList = document.getElementById('patterns-list');
      if (data.analysis.commonPatterns?.length > 0) {
        patternsSection?.classList.remove('hidden');
        if (patternsList) {
          patternsList.innerHTML = data.analysis.commonPatterns.map((p: string) => `<li>â€¢ ${p}</li>`).join('');
        }
      } else {
        patternsSection?.classList.add('hidden');
      }

      // Suggestions
      const suggestionsSection = document.getElementById('suggestions-section');
      const suggestionsList = document.getElementById('suggestions-list');
      if (data.analysis.suggestions?.length > 0) {
        suggestionsSection?.classList.remove('hidden');
        if (suggestionsList) {
          suggestionsList.innerHTML = data.analysis.suggestions.map((s: string) => `<li>â€¢ ${s}</li>`).join('');
        }
      } else {
        suggestionsSection?.classList.add('hidden');
      }
    }

    // Content Differentiation
    const differentiateForm = document.getElementById('differentiate-form') as HTMLFormElement;
    const differentiateBtn = document.getElementById('differentiate-btn') as HTMLButtonElement;
    const diffResults = document.getElementById('diff-results');
    const diffContent = document.getElementById('diff-content');
    const diffMetadata = document.getElementById('diff-metadata');

    let currentDiffResult = { content: '', productId: '', contentType: '' };

    differentiateForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const productId = (document.getElementById('diff-product') as HTMLSelectElement).value;
      const contentType = (document.getElementById('diff-type') as HTMLSelectElement).value as any;
      const tone = (document.getElementById('diff-tone') as HTMLSelectElement).value as any;
      const language = (document.getElementById('diff-language') as HTMLSelectElement).value;
      const includeReviews = (document.getElementById('include-reviews') as HTMLInputElement).checked;
      const includeSpecs = (document.getElementById('include-specs') as HTMLInputElement).checked;
      const includeComparisons = (document.getElementById('include-comparisons') as HTMLInputElement).checked;
      const baseContent = (document.getElementById('base-content') as HTMLTextAreaElement).value || undefined;

      if (!productId) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªäº§å“');
        return;
      }

      differentiateBtn.disabled = true;
      differentiateBtn.textContent = 'ç”Ÿæˆä¸­...';

      try {
        const result = await api.differentiateContent({
          productId,
          contentType,
          tone,
          language,
          includeReviews,
          includeSpecs,
          includeComparisons,
          baseContent,
        });

        if (result.success && result.data) {
          currentDiffResult = {
            content: result.data.content,
            productId: result.data.metadata.productId,
            contentType: result.data.metadata.contentType,
          };
          
          if (diffContent) diffContent.textContent = result.data.content;
          
          if (diffMetadata) {
            const meta = result.data.metadata;
            diffMetadata.innerHTML = `
              <span class="px-2 py-1 bg-gray-100 rounded">${meta.contentType}</span>
              <span class="px-2 py-1 bg-gray-100 rounded">${meta.tone}</span>
              <span class="px-2 py-1 bg-gray-100 rounded">${meta.language}</span>
              ${meta.dataUsed.hasReviews ? `<span class="px-2 py-1 bg-green-100 text-green-800 rounded">ğŸ“ ${meta.dataUsed.reviewCount} reviews</span>` : ''}
              ${meta.dataUsed.hasSpecs ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">ğŸ“Š Specs included</span>' : ''}
              ${meta.dataUsed.hasComparisons ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded">âš–ï¸ Comparisons</span>' : ''}
            `;
          }
          
          diffResults?.classList.remove('hidden');
        } else {
          alert('ç”Ÿæˆå†…å®¹å¤±è´¥');
        }
      } catch (error) {
        console.error('Differentiation error:', error);
        alert('ç”Ÿæˆå·®å¼‚åŒ–å†…å®¹å¤±è´¥');
      } finally {
        differentiateBtn.disabled = false;
        differentiateBtn.textContent = 'ç”Ÿæˆå·®å¼‚åŒ–å†…å®¹';
      }
    });

    // Copy differentiated content
    document.getElementById('copy-diff-btn')?.addEventListener('click', () => {
      navigator.clipboard.writeText(currentDiffResult.content);
      const btn = document.getElementById('copy-diff-btn');
      if (btn) {
        btn.textContent = 'å·²å¤åˆ¶ï¼';
        setTimeout(() => { btn.textContent = 'å¤åˆ¶'; }, 2000);
      }
    });

    // Check originality of differentiated content
    document.getElementById('check-diff-originality-btn')?.addEventListener('click', () => {
      if (currentDiffResult.content) {
        (document.getElementById('originality-content') as HTMLTextAreaElement).value = currentDiffResult.content;
        originalityForm?.dispatchEvent(new Event('submit'));
      }
    });

    // Save differentiated content
    document.getElementById('save-diff-btn')?.addEventListener('click', async () => {
      if (!currentDiffResult.content) return;
      
      const typeMap: Record<string, string> = {
        description: 'description',
        social_post: 'caption',
        email: 'description',
        blog: 'description',
      };
      
      try {
        const result = await api.saveContent({
          type: typeMap[currentDiffResult.contentType] as any || 'description',
          content: currentDiffResult.content,
          product_id: currentDiffResult.productId,
          status: 'draft',
        });
        
        if (result.success) {
          const btn = document.getElementById('save-diff-btn');
          if (btn) {
            btn.textContent = 'å·²ä¿å­˜ï¼';
            setTimeout(() => { btn.textContent = 'ä¿å­˜åˆ°åº“'; }, 2000);
          }
        } else {
          alert('ä¿å­˜å†…å®¹å¤±è´¥');
        }
      } catch {
        alert('ä¿å­˜å†…å®¹å¤±è´¥');
      }
    });

    // Load stale content
    document.getElementById('load-stale-btn')?.addEventListener('click', async () => {
      const listEl = document.getElementById('stale-content-list');
      const emptyEl = document.getElementById('stale-empty');
      const btn = document.getElementById('load-stale-btn') as HTMLButtonElement;
      
      btn.textContent = 'åŠ è½½ä¸­...';
      
      try {
        const result = await api.getStaleContent({ days: 30, limit: 10 });
        
        if (result.success && result.data) {
          if (result.data.data.length === 0) {
            listEl?.classList.add('hidden');
            emptyEl?.classList.remove('hidden');
          } else {
            emptyEl?.classList.add('hidden');
            listEl?.classList.remove('hidden');
            
            if (listEl) {
              listEl.innerHTML = result.data.data.map((item: any) => `
                <div class="p-3 bg-gray-50 rounded-lg flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-sm font-medium text-gray-900">${item.title || 'Untitled'}</span>
                      <span class="px-2 py-0.5 text-xs rounded ${
                        item.staleness === 'critical' ? 'bg-red-100 text-red-800' :
                        item.staleness === 'high' ? 'bg-orange-100 text-orange-800' :
                        'bg-yellow-100 text-yellow-800'
                      }">${item.staleness}</span>
                      ${item.needsOriginalityCheck ? '<span class="px-2 py-0.5 text-xs bg-purple-100 text-purple-800 rounded">Needs Check</span>' : ''}
                    </div>
                    <p class="text-xs text-gray-500">${item.type} â€¢ Last updated ${item.daysSinceUpdate} days ago</p>
                    <p class="text-sm text-gray-600 mt-1 line-clamp-2">${item.content?.slice(0, 150) || ''}...</p>
                  </div>
                </div>
              `).join('');
            }
          }
        }
      } catch (error) {
        console.error('Failed to load stale content:', error);
      } finally {
        btn.textContent = 'åŠ è½½è¿‡æ—¶å†…å®¹ â†’';
      }
    });
  </script>
</AdminLayout>
