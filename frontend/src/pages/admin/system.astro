---
/**
 * Admin System Monitoring Page
 * Displays health status, metrics, and system information
 */
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="系统监控">
  <div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">系统监控</h1>
        <p class="text-gray-500 mt-1">查看系统健康状态、性能指标和日志</p>
      </div>
      <button
        id="refresh-btn"
        class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        刷新数据
      </button>
    </div>

    <!-- Health Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Overall Status -->
      <div id="status-card" class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">系统状态</p>
            <p id="system-status" class="text-2xl font-bold text-green-600">健康</p>
          </div>
          <div id="status-icon" class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Response Time -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <p class="text-sm text-gray-500">平均响应时间</p>
        <p id="avg-latency" class="text-2xl font-bold text-gray-900">-- ms</p>
        <p class="text-xs text-gray-400 mt-1">P95: <span id="p95-latency">--</span> ms</p>
      </div>

      <!-- Request Count -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <p class="text-sm text-gray-500">总请求数</p>
        <p id="total-requests" class="text-2xl font-bold text-gray-900">--</p>
        <p class="text-xs text-gray-400 mt-1">成功率: <span id="success-rate">--</span>%</p>
      </div>

      <!-- Error Count -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <p class="text-sm text-gray-500">错误请求</p>
        <p id="error-count" class="text-2xl font-bold text-red-600">--</p>
        <p class="text-xs text-gray-400 mt-1">最近 1 小时</p>
      </div>
    </div>

    <!-- Health Checks -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">依赖服务状态</h2>
      <div id="health-checks" class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center">
            <div class="w-3 h-3 bg-gray-300 rounded-full mr-3 animate-pulse"></div>
            <span class="text-gray-600">加载中...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Metrics Chart -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Status Code Distribution -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">状态码分布</h2>
        <div id="status-chart" class="space-y-2">
          <p class="text-gray-500 text-sm">加载中...</p>
        </div>
      </div>

      <!-- Top Endpoints -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">热门端点 (Top 10)</h2>
        <div id="endpoints-list" class="space-y-2">
          <p class="text-gray-500 text-sm">加载中...</p>
        </div>
      </div>
    </div>

    <!-- System Info -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">系统信息</h2>
      <div id="system-info" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
          <p class="text-sm text-gray-500">运行环境</p>
          <p id="env-name" class="font-medium">--</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">运行时</p>
          <p id="runtime" class="font-medium">--</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">版本</p>
          <p id="version" class="font-medium">--</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">最后更新</p>
          <p id="last-update" class="font-medium">--</p>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">快速操作</h2>
      <div class="flex flex-wrap gap-3">
        <a
          href="/api/health/detailed"
          target="_blank"
          class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          健康检查 JSON
        </a>
        <a
          href="/api/metrics"
          target="_blank"
          class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          性能指标 JSON
        </a>
        <a
          href="/api/metrics/prometheus"
          target="_blank"
          class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
          </svg>
          Prometheus 格式
        </a>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const API_BASE = import.meta.env.PUBLIC_API_URL || '';

  async function fetchHealthStatus() {
    try {
      const response = await fetch(`${API_BASE}/api/health/detailed`);
      const data = await response.json();
      
      // Update status card
      const statusCard = document.getElementById('status-card');
      const statusText = document.getElementById('system-status');
      const statusIcon = document.getElementById('status-icon');
      
      if (data.status === 'healthy') {
        statusCard?.classList.remove('border-yellow-500', 'border-red-500');
        statusCard?.classList.add('border-green-500');
        statusText!.textContent = '健康';
        statusText!.className = 'text-2xl font-bold text-green-600';
        statusIcon!.className = 'w-12 h-12 bg-green-100 rounded-full flex items-center justify-center';
        statusIcon!.innerHTML = '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
      } else if (data.status === 'degraded') {
        statusCard?.classList.remove('border-green-500', 'border-red-500');
        statusCard?.classList.add('border-yellow-500');
        statusText!.textContent = '降级';
        statusText!.className = 'text-2xl font-bold text-yellow-600';
        statusIcon!.className = 'w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center';
        statusIcon!.innerHTML = '<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
      } else {
        statusCard?.classList.remove('border-green-500', 'border-yellow-500');
        statusCard?.classList.add('border-red-500');
        statusText!.textContent = '异常';
        statusText!.className = 'text-2xl font-bold text-red-600';
        statusIcon!.className = 'w-12 h-12 bg-red-100 rounded-full flex items-center justify-center';
        statusIcon!.innerHTML = '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
      }
      
      // Update health checks
      const healthChecks = document.getElementById('health-checks');
      if (data.checks && healthChecks) {
        healthChecks.innerHTML = Object.entries(data.checks).map(([name, check]: [string, any]) => {
          const statusColor = check.status === 'healthy' ? 'green' : check.status === 'degraded' ? 'yellow' : 'red';
          return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center">
                <div class="w-3 h-3 bg-${statusColor}-500 rounded-full mr-3"></div>
                <span class="font-medium capitalize">${name}</span>
              </div>
              <div class="text-sm text-gray-500">
                ${check.latency ? `${check.latency}ms` : ''}
                ${check.error ? `<span class="text-red-500">${check.error}</span>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }
    } catch (error) {
      console.error('Failed to fetch health status:', error);
    }
  }

  async function fetchMetrics() {
    try {
      const response = await fetch(`${API_BASE}/api/metrics?period=1h`);
      const data = await response.json();
      const metrics = data.metrics;
      
      // Update metric cards
      document.getElementById('avg-latency')!.textContent = `${metrics.averageLatency || 0} ms`;
      document.getElementById('p95-latency')!.textContent = String(metrics.p95Latency || 0);
      document.getElementById('total-requests')!.textContent = String(metrics.totalRequests || 0);
      document.getElementById('error-count')!.textContent = String(metrics.failedRequests || 0);
      
      const successRate = metrics.totalRequests > 0 
        ? ((metrics.successfulRequests / metrics.totalRequests) * 100).toFixed(1)
        : '100';
      document.getElementById('success-rate')!.textContent = successRate;
      
      // Update status code chart
      const statusChart = document.getElementById('status-chart');
      if (metrics.statusCodes && statusChart) {
        const total = Object.values(metrics.statusCodes as Record<string, number>).reduce((a, b) => a + b, 0);
        statusChart.innerHTML = Object.entries(metrics.statusCodes)
          .sort(([a], [b]) => Number(a) - Number(b))
          .map(([code, count]) => {
            const percentage = total > 0 ? ((count as number) / total * 100).toFixed(1) : 0;
            const color = code.startsWith('2') ? 'green' : code.startsWith('3') ? 'blue' : code.startsWith('4') ? 'yellow' : 'red';
            return `
              <div class="flex items-center">
                <span class="w-12 text-sm font-medium text-gray-600">${code}</span>
                <div class="flex-1 mx-3 h-4 bg-gray-100 rounded-full overflow-hidden">
                  <div class="h-full bg-${color}-500" style="width: ${percentage}%"></div>
                </div>
                <span class="w-20 text-sm text-right text-gray-500">${count} (${percentage}%)</span>
              </div>
            `;
          }).join('');
      }
    } catch (error) {
      console.error('Failed to fetch metrics:', error);
    }
  }

  async function fetchEndpoints() {
    try {
      const response = await fetch(`${API_BASE}/api/metrics/endpoints`);
      const data = await response.json();
      
      const endpointsList = document.getElementById('endpoints-list');
      if (data.endpoints && endpointsList) {
        endpointsList.innerHTML = data.endpoints.slice(0, 10).map((ep: any) => `
          <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate">${ep.endpoint}</p>
              <p class="text-xs text-gray-500">${ep.count} 次请求</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-medium text-gray-900">${ep.averageLatency}ms</p>
              <p class="text-xs ${ep.errors > 0 ? 'text-red-500' : 'text-gray-500'}">${ep.errorRate} 错误</p>
            </div>
          </div>
        `).join('') || '<p class="text-gray-500 text-sm">暂无数据</p>';
      }
    } catch (error) {
      console.error('Failed to fetch endpoints:', error);
    }
  }

  async function fetchSystemInfo() {
    try {
      const response = await fetch(`${API_BASE}/api/system`);
      const data = await response.json();
      
      document.getElementById('env-name')!.textContent = data.environment || '--';
      document.getElementById('runtime')!.textContent = data.runtime || '--';
      document.getElementById('version')!.textContent = data.version || '--';
      document.getElementById('last-update')!.textContent = new Date(data.timestamp).toLocaleString('zh-CN');
    } catch (error) {
      console.error('Failed to fetch system info:', error);
    }
  }

  async function refreshAll() {
    await Promise.all([
      fetchHealthStatus(),
      fetchMetrics(),
      fetchEndpoints(),
      fetchSystemInfo(),
    ]);
  }

  // Initial load
  refreshAll();

  // Refresh button
  document.getElementById('refresh-btn')?.addEventListener('click', () => {
    refreshAll();
  });

  // Auto-refresh every 30 seconds
  setInterval(refreshAll, 30000);
</script>
