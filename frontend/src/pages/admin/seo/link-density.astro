---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
---

<AdminLayout title="å†…é“¾å¯†åº¦åˆ†æ" activePage="seo">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">å†…é“¾å¯†åº¦åˆ†æ</h2>
      <p class="text-gray-600 mt-1">åˆ†æé¡µé¢å†…éƒ¨é“¾æ¥ç»“æ„ï¼Œä¼˜åŒ–é“¾æ¥åˆ†å¸ƒ</p>
    </div>
    <button
      id="crawl-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium flex items-center gap-2"
    >
      <span>ğŸ”„</span>
      <span>çˆ¬å–é“¾æ¥å›¾è°±</span>
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">æ€»é¡µé¢æ•°</p>
      <p class="text-2xl font-bold text-gray-900" id="stat-total">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">å¹³å‡å¯†åº¦</p>
      <p class="text-2xl font-bold text-gray-900" id="stat-avg">0%</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">é“¾æ¥è¿‡å°‘</p>
      <p class="text-2xl font-bold text-red-600" id="stat-too-low">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">é“¾æ¥é€‚ä¸­</p>
      <p class="text-2xl font-bold text-green-600" id="stat-optimal">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">é“¾æ¥è¿‡å¤š</p>
      <p class="text-2xl font-bold text-orange-600" id="stat-too-high">0</p>
    </div>
  </div>

  <!-- Info Box -->
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
    <div class="flex gap-3">
      <span class="text-2xl">ğŸ“Š</span>
      <div>
        <p class="font-medium text-blue-800">ä»€ä¹ˆæ˜¯é“¾æ¥å¯†åº¦ï¼Ÿ</p>
        <p class="text-sm text-blue-700 mt-1">
          é“¾æ¥å¯†åº¦æ˜¯æŒ‡é¡µé¢ä¸­é“¾æ¥æ•°é‡ä¸å­—æ•°çš„æ¯”ä¾‹ï¼ˆé“¾æ¥æ•°/100å­—ï¼‰ã€‚
          <strong>æ¨èèŒƒå›´ï¼š1-3%</strong>ï¼ˆæ¯100å­—1-3ä¸ªé“¾æ¥ï¼‰ã€‚
          é“¾æ¥è¿‡å°‘ä¸åˆ©äºSEOå’Œç”¨æˆ·å¯¼èˆªï¼Œé“¾æ¥è¿‡å¤šä¼šç¨€é‡Šæƒé‡å¹¶å½±å“é˜…è¯»ä½“éªŒã€‚
        </p>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="flex gap-2 mb-4">
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-primary-600 text-white" data-filter="all">
      å…¨éƒ¨ (<span id="tab-total">0</span>)
    </button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="too_low">
      é“¾æ¥è¿‡å°‘ (<span id="tab-too-low">0</span>)
    </button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="optimal">
      é“¾æ¥é€‚ä¸­ (<span id="tab-optimal">0</span>)
    </button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="too_high">
      é“¾æ¥è¿‡å¤š (<span id="tab-too-high">0</span>)
    </button>
  </div>

  <!-- Density Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¡µé¢</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç±»å‹</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">å­—æ•°</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">å†…é“¾</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">å¤–é“¾</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">å¯†åº¦</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">åˆ†ææ—¶é—´</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="density-table">
          <tr>
            <td colspan="8" class="px-6 py-12 text-center text-gray-500">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="empty-state" class="px-6 py-12 text-center hidden">
      <div class="text-4xl mb-4">ğŸ“Š</div>
      <p class="text-gray-500">æš‚æ— åˆ†ææ•°æ®</p>
      <p class="text-sm text-gray-400 mt-1">ç‚¹å‡»"çˆ¬å–é“¾æ¥å›¾è°±"æŒ‰é’®å¼€å§‹åˆ†æ</p>
    </div>
  </div>

  <!-- Link Suggestions Section -->
  <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold text-gray-900">å†…é“¾å»ºè®®</h3>
      <button
        id="get-suggestions-btn"
        class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
      >
        è·å–å»ºè®®
      </button>
    </div>
    <div id="suggestions-container" class="text-center text-gray-500 py-4">
      ç‚¹å‡»"è·å–å»ºè®®"æŸ¥çœ‹å†…é“¾ä¼˜åŒ–å»ºè®®
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
      <span id="toast-icon">âœ“</span>
      <span id="toast-message">æ“ä½œæˆåŠŸ</span>
    </div>
  </div>
</AdminLayout>

<script>
  function showToast(message: string, isSuccess = true) {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const msg = document.getElementById('toast-message');
    if (toast && icon && msg) {
      icon.textContent = isSuccess ? 'âœ“' : 'âœ—';
      msg.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
  }

  // Crawl button
  document.getElementById('crawl-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('crawl-btn') as HTMLButtonElement;
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin">â³</span> çˆ¬å–ä¸­...';

    try {
      const res = await fetch(`/api/admin/seo/links/graph/crawl`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await res.json();
      
      if (data.success) {
        showToast(`çˆ¬å–å®Œæˆï¼å‘ç° ${data.links_found} ä¸ªé“¾æ¥`);
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(data.error || 'çˆ¬å–å¤±è´¥', false);
      }
    } catch (error) {
      showToast('çˆ¬å–å¤±è´¥', false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>ğŸ”„</span><span>çˆ¬å–é“¾æ¥å›¾è°±</span>';
    }
  });

  // Get suggestions
  document.getElementById('get-suggestions-btn')?.addEventListener('click', async () => {
    const container = document.getElementById('suggestions-container');
    if (!container) return;

    container.innerHTML = '<p class="text-gray-400">åŠ è½½ä¸­...</p>';

    try {
      const res = await fetch(`/api/admin/seo/links/suggestions`);
      const data = await res.json();

      if (data.suggestions && data.suggestions.length > 0) {
        container.innerHTML = data.suggestions.map((s: any) => `
          <div class="text-left border-b border-gray-100 pb-4 mb-4 last:border-0 last:pb-0 last:mb-0">
            <p class="font-medium text-gray-900">${s.page_url}</p>
            <p class="text-sm text-gray-500 mb-2">å»ºè®®æ·»åŠ ä»¥ä¸‹é“¾æ¥ï¼š</p>
            <div class="flex flex-wrap gap-2">
              ${s.suggested_links.map((link: any) => `
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded">
                  <span>â†’</span>
                  <span>${link.target_title}</span>
                </span>
              `).join('')}
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<p class="text-green-600">ğŸ‰ æ‰€æœ‰é¡µé¢çš„é“¾æ¥å¯†åº¦éƒ½å¾ˆå¥åº·ï¼</p>';
      }
    } catch (error) {
      container.innerHTML = '<p class="text-red-500">è·å–å»ºè®®å¤±è´¥</p>';
    }
  });

  // Filter tabs
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const filter = target.dataset.filter;

      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('bg-primary-600', 'text-white');
        b.classList.add('bg-gray-100', 'text-gray-700');
      });
      target.classList.remove('bg-gray-100', 'text-gray-700');
      target.classList.add('bg-primary-600', 'text-white');

      document.querySelectorAll('.density-row').forEach(row => {
        const el = row as HTMLElement;
        const status = el.dataset.status;

        if (filter === 'all') {
          el.style.display = '';
        } else {
          el.style.display = status === filter ? '' : 'none';
        }
      });
    });
  });

  async function loadDensity() {
    const tbody = document.getElementById('density-table');
    const empty = document.getElementById('empty-state');
    try {
      const res = await fetch('/api/admin/seo/links/density');
      const data = await res.json().catch(() => null);
      const pages = Array.isArray(data?.pages) ? data.pages : [];
      const summary = data?.summary || {
        total: pages.length,
        optimal: pages.filter((d: any) => d.density_status === 'optimal').length,
        too_low: pages.filter((d: any) => d.density_status === 'too_low').length,
        too_high: pages.filter((d: any) => d.density_status === 'too_high').length,
        avg_density: pages.length ? Math.round(pages.reduce((s: number, d: any) => s + (d.link_density || 0), 0) / pages.length * 100) / 100 : 0,
      };

      document.getElementById('stat-total')!.textContent = String(summary.total || 0);
      document.getElementById('stat-optimal')!.textContent = String(summary.optimal || 0);
      document.getElementById('stat-too-low')!.textContent = String(summary.too_low || 0);
      document.getElementById('stat-too-high')!.textContent = String(summary.too_high || 0);
      const avgEl = document.getElementById('stat-avg');
      if (avgEl) {
        avgEl.textContent = `${summary.avg_density || 0}%`;
        avgEl.className = `text-2xl font-bold ${(summary.avg_density || 0) >= 1 && (summary.avg_density || 0) <= 3 ? 'text-green-600' : 'text-yellow-600'}`;
      }
      document.getElementById('tab-total')!.textContent = String(summary.total || 0);
      document.getElementById('tab-optimal')!.textContent = String(summary.optimal || 0);
      document.getElementById('tab-too-low')!.textContent = String(summary.too_low || 0);
      document.getElementById('tab-too-high')!.textContent = String(summary.too_high || 0);

      if (!tbody) return;
      if (pages.length === 0) {
        tbody.innerHTML = '';
        empty?.classList.remove('hidden');
        return;
      }
      empty?.classList.add('hidden');
      tbody.innerHTML = pages.map((page: any) => {
        const typeClass = page.page_type === 'product'
          ? 'bg-blue-100 text-blue-700'
          : page.page_type === 'category'
            ? 'bg-purple-100 text-purple-700'
            : 'bg-indigo-100 text-indigo-700';
        const typeLabel = page.page_type === 'product' ? 'äº§å“' : page.page_type === 'category' ? 'åˆ†ç±»' : 'åšå®¢';
        const densityClass = page.density_status === 'optimal' ? 'text-green-600' : page.density_status === 'too_low' ? 'text-red-600' : 'text-orange-600';
        const statusBadge = page.density_status === 'optimal'
          ? '<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">âœ“ é€‚ä¸­</span>'
          : page.density_status === 'too_low'
            ? '<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">â†“ è¿‡å°‘</span>'
            : '<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700">â†‘ è¿‡å¤š</span>';
        return `
          <tr class="density-row hover:bg-gray-50" data-status="${page.density_status}">
            <td class="px-6 py-4"><a href="${page.page_url}" target="_blank" class="text-primary-600 hover:underline truncate block max-w-xs">${page.page_url}</a></td>
            <td class="px-6 py-4"><span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${typeClass}">${typeLabel}</span></td>
            <td class="px-6 py-4 text-center text-gray-600">${(page.word_count || 0).toLocaleString()}</td>
            <td class="px-6 py-4 text-center"><span class="font-medium text-blue-600">${page.internal_links_count}</span></td>
            <td class="px-6 py-4 text-center"><span class="text-gray-600">${page.external_links_count}</span></td>
            <td class="px-6 py-4 text-center"><span class="font-bold ${densityClass}">${page.link_density}%</span></td>
            <td class="px-6 py-4 text-center">${statusBadge}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${new Date(page.analyzed_at).toLocaleDateString('zh-CN')}</td>
          </tr>
        `;
      }).join('');
    } catch (e) {
      console.error('Failed to load density:', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-12 text-center text-red-600">åŠ è½½å¤±è´¥</td></tr>`;
    }
  }

  loadDensity();
</script>
