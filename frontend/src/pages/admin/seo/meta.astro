---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const allPages: any[] = [];
const productsMeta: any[] = [];
const categoriesMeta: any[] = [];
---

<AdminLayout title="Meta 标签编辑器" activePage="seo">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
        <a href="/admin/seo" class="hover:text-primary-600">SEO 工具</a>
        <span>/</span>
        <span>Meta 标签</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Meta 标签编辑器</h2>
    </div>
    <button 
      id="bulk-generate-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
      AI 生成所有缺失
    </button>
  </div>

  <!-- Filter Tabs -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="flex border-b border-gray-100">
      <button class="tab-btn px-6 py-3 text-sm font-medium text-primary-600 border-b-2 border-primary-600" data-tab="all">
        全部 (<span id="count-all">0</span>)
      </button>
      <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="products">
        商品 (<span id="count-products">0</span>)
      </button>
      <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="categories">
        分类 (<span id="count-categories">0</span>)
      </button>
      <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="missing">
        缺失 Meta (<span id="count-missing">0</span>)
      </button>
    </div>
  </div>

  <!-- Pages Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">页面</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标题标签</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meta 描述</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="pages-tbody">
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">加载中...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900" id="modal-title">编辑 Meta 标签</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="meta-form" class="p-6 space-y-4">
          <input type="hidden" id="page-id" name="page_id" />
          <input type="hidden" id="page-type" name="page_type" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Meta 标题
              <span class="text-gray-400 font-normal" id="title-count">(0/60)</span>
            </label>
            <input 
              type="text" 
              id="meta-title" 
              name="meta_title"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="输入页面标题..."
              maxlength="70"
            />
            <p class="text-xs text-gray-500 mt-1">建议：50-60 字符</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Meta Description
              <span class="text-gray-400 font-normal" id="desc-count">(0/160)</span>
            </label>
            <textarea 
              id="meta-desc" 
              name="meta_description"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="输入 Meta 描述..."
              maxlength="200"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">建议：140-160 字符</p>
          </div>

          <!-- Preview -->
          <div class="bg-gray-50 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase mb-2">Google 预览</p>
            <div class="space-y-1">
              <p class="text-lg text-blue-600 hover:underline cursor-pointer truncate" id="preview-title">Page Title</p>
              <p class="text-sm text-green-700" id="preview-url">example.com › page</p>
              <p class="text-sm text-gray-600 line-clamp-2" id="preview-desc">Meta description will appear here...</p>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              取消
            </button>
            <button type="button" id="ai-suggest-btn" class="px-4 py-2 border border-indigo-300 text-indigo-700 rounded-lg hover:bg-indigo-50 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              AI 建议
            </button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
              保存更改
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const modal = document.getElementById('edit-modal');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const closeBtn = document.getElementById('close-modal');
  const cancelBtn = document.getElementById('cancel-btn');
  const form = document.getElementById('meta-form');
  const tbody = document.getElementById('pages-tbody');
  const bulkGenerateBtn = document.getElementById('bulk-generate-btn');

  const countAllEl = document.getElementById('count-all');
  const countProductsEl = document.getElementById('count-products');
  const countCategoriesEl = document.getElementById('count-categories');
  const countMissingEl = document.getElementById('count-missing');

  let allPages = [];
  let productsMeta = [];
  let categoriesMeta = [];
  const titleInput = document.getElementById('meta-title');
  const descInput = document.getElementById('meta-desc');
  const titleCount = document.getElementById('title-count');
  const descCount = document.getElementById('desc-count');
  const previewTitle = document.getElementById('preview-title');
  const previewDesc = document.getElementById('preview-desc');
  const previewUrl = document.getElementById('preview-url');

  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      
      // Update active tab style
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('text-primary-600', 'border-b-2', 'border-primary-600');
        b.classList.add('text-gray-500');
      });
      btn.classList.add('text-primary-600', 'border-b-2', 'border-primary-600');
      btn.classList.remove('text-gray-500');

      // Filter rows
      document.querySelectorAll('.page-row').forEach(row => {
        const type = row.dataset.type;
        const title = row.querySelector('td:nth-child(2) p:first-child').textContent;
        const desc = row.querySelector('td:nth-child(3) p:first-child').textContent;
        const hasMissing = title.includes('缺失') || desc.includes('缺失');

        let show = true;
        if (tab === 'products') show = type === 'product';
        else if (tab === 'categories') show = type === 'category';
        else if (tab === 'missing') show = hasMissing;

        row.style.display = show ? '' : 'none';
      });
    });
  });

  // Edit button click
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      openModal(btn.dataset);
    });
  });

  // AI Generate button click
  function bindRowActions() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        openModal(btn.dataset);
      });
    });

    document.querySelectorAll('.ai-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const { id, type, name } = btn.dataset;
        btn.textContent = 'AI 生成中...';
        btn.disabled = true;

        try {
          const response = await fetch(`/api/admin/seo/generate-meta`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ page_id: id, page_type: type, page_name: name })
          });

          if (response.ok) {
            const data = await response.json();
            openModal({ id, type, name, title: data.meta_title, desc: data.meta_description });
          } else {
            alert('生成 Meta 标签失败');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('生成 Meta 标签失败');
        } finally {
          btn.textContent = 'AI 生成';
          btn.disabled = false;
        }
      });
    });
  }

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function renderTable() {
    if (!tbody) return;
    if (!Array.isArray(allPages) || allPages.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">暂无数据</td></tr>`;
      return;
    }

    tbody.innerHTML = allPages
      .map((page) => {
        const title = page.meta_title || '';
        const desc = page.meta_description || '';
        const titleLen = Number(page.title_length) || 0;
        const descLen = Number(page.desc_length) || 0;
        const titleColor = titleLen > 60 ? 'text-red-500' : titleLen > 50 ? 'text-yellow-500' : 'text-gray-400';
        const descColor = descLen > 160 ? 'text-red-500' : descLen > 140 ? 'text-yellow-500' : 'text-gray-400';
        const hasFull = !!(title && desc);

        return `
          <tr class="page-row hover:bg-gray-50" data-type="${escapeHtml(page.type)}" data-id="${escapeHtml(page.id)}">
            <td class="px-6 py-4">
              <div>
                <p class="text-sm font-medium text-gray-900">${escapeHtml(page.name)}</p>
                <p class="text-xs text-gray-500">${escapeHtml(page.url)}</p>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="max-w-xs">
                <p class="text-sm text-gray-900 truncate" title="${escapeHtml(title)}">${title ? escapeHtml(title) : '<span class="text-red-500 italic">缺失</span>'}</p>
                <p class="text-xs ${titleColor}">${escapeHtml(titleLen)}/60 chars</p>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="max-w-md">
                <p class="text-sm text-gray-900 truncate" title="${escapeHtml(desc)}">${desc ? escapeHtml(desc) : '<span class="text-red-500 italic">缺失</span>'}</p>
                <p class="text-xs ${descColor}">${escapeHtml(descLen)}/160 chars</p>
              </div>
            </td>
            <td class="px-6 py-4">
              ${hasFull ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">完整</span>' : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">不完整</span>'}
              ${page.has_override ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-1">自定义</span>' : ''}
            </td>
            <td class="px-6 py-4 text-right">
              <button class="text-primary-600 hover:text-primary-700 text-sm font-medium mr-3 edit-btn"
                data-id="${escapeHtml(page.id)}"
                data-type="${escapeHtml(page.type)}"
                data-name="${escapeHtml(page.name)}"
                data-title="${escapeHtml(title)}"
                data-desc="${escapeHtml(desc)}">编辑</button>
              <button class="text-indigo-600 hover:text-indigo-700 text-sm font-medium ai-btn"
                data-id="${escapeHtml(page.id)}"
                data-type="${escapeHtml(page.type)}"
                data-name="${escapeHtml(page.name)}">AI 生成</button>
            </td>
          </tr>
        `;
      })
      .join('');

    bindRowActions();
  }

  function updateCounts() {
    const missing = allPages.filter((p) => !p.meta_title || !p.meta_description).length;
    if (countAllEl) countAllEl.textContent = String(allPages.length);
    if (countProductsEl) countProductsEl.textContent = String(productsMeta.length);
    if (countCategoriesEl) countCategoriesEl.textContent = String(categoriesMeta.length);
    if (countMissingEl) countMissingEl.textContent = String(missing);
  }

  async function loadPageData() {
    try {
      const res = await fetch('/api/admin/seo/meta/page-data');
      const json = await res.json().catch(() => null);
      if (!res.ok || !json?.success) throw new Error('load failed');

      const products = Array.isArray(json.products) ? json.products : [];
      const categories = Array.isArray(json.categories) ? json.categories : [];
      const seoMeta = Array.isArray(json.seoMeta) ? json.seoMeta : [];

      const seoMetaMap = new Map();
      seoMeta.forEach((meta) => {
        const key = `${meta.page_type}-${meta.page_id || meta.page_slug}`;
        seoMetaMap.set(key, meta);
      });

      productsMeta = products.map((p) => {
        const override = seoMetaMap.get(`product-${p.id}`);
        const meta_title = (override?.meta_title || p.meta_title || '') as string;
        const meta_description = (override?.meta_description || p.meta_description || '') as string;
        return {
          id: p.id,
          type: 'product',
          name: p.name,
          slug: p.slug,
          url: `/products/${p.slug}`,
          meta_title,
          meta_description,
          has_override: !!override,
          title_length: meta_title.length,
          desc_length: meta_description.length,
        };
      });

      categoriesMeta = categories.map((c) => {
        const override = seoMetaMap.get(`category-${c.id}`);
        const meta_title = (override?.meta_title || c.meta_title || '') as string;
        const meta_description = (override?.meta_description || c.meta_description || '') as string;
        return {
          id: c.id,
          type: 'category',
          name: c.name,
          slug: c.slug,
          url: `/category/${c.slug}`,
          meta_title,
          meta_description,
          has_override: !!override,
          title_length: meta_title.length,
          desc_length: meta_description.length,
        };
      });

      allPages = [...productsMeta, ...categoriesMeta];
      updateCounts();
      renderTable();
    } catch (e) {
      console.error('Failed to load meta page data:', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-red-600">加载失败</td></tr>`;
    }
  }

  function openModal(data) {
    document.getElementById('page-id').value = data.id;
    document.getElementById('page-type').value = data.type;
    document.getElementById('modal-title').textContent = `Edit: ${data.name}`;
    titleInput.value = data.title || '';
    descInput.value = data.desc || '';
    previewUrl.textContent = `example.com › ${data.type}s › ...`;
    updateModalCounts();
    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
  }

  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  modalBackdrop?.addEventListener('click', closeModal);

  // Character counts and preview
  function updateModalCounts() {
    const titleLen = titleInput.value.length;
    const descLen = descInput.value.length;
    
    titleCount.textContent = `(${titleLen}/60)`;
    titleCount.className = titleLen > 60 ? 'text-red-500 font-normal' : titleLen > 50 ? 'text-yellow-500 font-normal' : 'text-gray-400 font-normal';
    
    descCount.textContent = `(${descLen}/160)`;
    descCount.className = descLen > 160 ? 'text-red-500 font-normal' : descLen > 140 ? 'text-yellow-500 font-normal' : 'text-gray-400 font-normal';

    previewTitle.textContent = titleInput.value || 'Page Title';
    previewDesc.textContent = descInput.value || 'Meta description will appear here...';
  }

  titleInput?.addEventListener('input', updateModalCounts);
  descInput?.addEventListener('input', updateModalCounts);

  // AI Suggest in modal
  document.getElementById('ai-suggest-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('ai-suggest-btn');
    const pageId = document.getElementById('page-id').value;
    const pageType = document.getElementById('page-type').value;
    const pageName = document.getElementById('modal-title').textContent.replace('Edit: ', '');

    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';

    try {
      const response = await fetch(`/api/admin/seo/generate-meta`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ page_id: pageId, page_type: pageType, page_name: pageName })
      });

      if (response.ok) {
        const data = await response.json();
        titleInput.value = data.meta_title || '';
        descInput.value = data.meta_description || '';
        updateModalCounts();
      } else {
        alert('Failed to generate suggestions');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to generate suggestions');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> AI Suggest';
    }
  });

  // Form submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch(`/api/admin/seo/meta`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        closeModal();
        window.location.reload();
      } else {
        alert('保存失败');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('保存失败');
    }
  });

  bulkGenerateBtn?.addEventListener('click', async () => {
    bulkGenerateBtn.disabled = true;
    bulkGenerateBtn.textContent = '生成中...';

    try {
      const response = await fetch(`/api/admin/seo/bulk-generate-meta`, { method: 'POST' });
      if (response.ok) {
        window.location.reload();
      } else {
        alert('批量生成 Meta 标签失败');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('批量生成 Meta 标签失败');
    } finally {
      bulkGenerateBtn.disabled = false;
      bulkGenerateBtn.textContent = 'AI 生成所有缺失';
    }
  });

  loadPageData();
</script>
