---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const allScores: any[] = [];
---

<AdminLayout title="E-E-A-T 评分" activePage="seo">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">E-E-A-T 评分</h2>
      <p class="text-gray-600 mt-1">经验、专业、权威、可信度分析</p>
    </div>
    <button
      id="analyze-all-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium"
    >
      分析所有内容
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">平均分</p>
      <p class="text-2xl font-bold text-gray-900" id="avg-score">0/100</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">优秀 (80+)</p>
      <p class="text-2xl font-bold text-green-600" id="count-excellent">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">良好 (60-79)</p>
      <p class="text-2xl font-bold text-blue-600" id="count-good">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">需改进 (40-59)</p>
      <p class="text-2xl font-bold text-yellow-600" id="count-needsWork">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">较差 (&lt;40)</p>
      <p class="text-2xl font-bold text-red-600" id="count-poor">0</p>
    </div>
  </div>

  <!-- E-E-A-T Explanation -->
  <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 mb-6">
    <h3 class="font-semibold text-gray-900 mb-3">什么是 E-E-A-T？</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <p class="font-medium text-purple-700">经验 (Experience)</p>
        <p class="text-gray-600">对该主题的亲身经历</p>
      </div>
      <div>
        <p class="font-medium text-indigo-700">专业 (Expertise)</p>
        <p class="text-gray-600">该领域的知识和技能</p>
      </div>
      <div>
        <p class="font-medium text-blue-700">权威 (Authoritativeness)</p>
        <p class="text-gray-600">作为可信赖来源的认可度</p>
      </div>
      <div>
        <p class="font-medium text-green-700">可信 (Trustworthiness)</p>
        <p class="text-gray-600">准确性、透明度、合法性</p>
      </div>
    </div>
  </div>

  <!-- Scores Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900">内容 E-E-A-T 评分</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">内容</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">经验</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">专业</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">权威</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">可信</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">总分</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="scores-tbody">
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-gray-500">加载中...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recommendations Modal -->
  <div id="recommendations-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">改进建议</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="recommendations-content" class="p-6">
        Loading...
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const tbody = document.getElementById('scores-tbody');
  const avgEl = document.getElementById('avg-score');
  const excellentEl = document.getElementById('count-excellent');
  const goodEl = document.getElementById('count-good');
  const needsWorkEl = document.getElementById('count-needsWork');
  const poorEl = document.getElementById('count-poor');

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function overallBarClass(score) {
    const v = Number(score) || 0;
    if (v >= 80) return 'bg-green-500';
    if (v >= 60) return 'bg-blue-500';
    if (v >= 40) return 'bg-yellow-500';
    return 'bg-red-500';
  }

  function textScoreClass(score) {
    const v = Number(score) || 0;
    if (v >= 60) return 'text-green-600';
    if (v >= 40) return 'text-yellow-600';
    return 'text-red-600';
  }

  function renderRows(scores) {
    if (!tbody) return;
    if (!Array.isArray(scores) || scores.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">暂无 E-E-A-T 评分。点击"分析所有内容"开始。</td></tr>`;
      return;
    }

    tbody.innerHTML = scores
      .map((score) => {
        const overall = Number(score.overall_score) || 0;
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <p class="text-sm font-medium text-gray-900 capitalize">${escapeHtml(score.content_type)}</p>
              <p class="text-xs text-gray-500">${escapeHtml(String(score.content_id || '').substring(0, 8))}...</p>
            </td>
            <td class="px-6 py-4 text-center"><span class="text-sm font-medium ${textScoreClass(score.experience_score)}">${escapeHtml(score.experience_score)}</span></td>
            <td class="px-6 py-4 text-center"><span class="text-sm font-medium ${textScoreClass(score.expertise_score)}">${escapeHtml(score.expertise_score)}</span></td>
            <td class="px-6 py-4 text-center"><span class="text-sm font-medium ${textScoreClass(score.authoritativeness_score)}">${escapeHtml(score.authoritativeness_score)}</span></td>
            <td class="px-6 py-4 text-center"><span class="text-sm font-medium ${textScoreClass(score.trustworthiness_score)}">${escapeHtml(score.trustworthiness_score)}</span></td>
            <td class="px-6 py-4 text-center">
              <div class="flex items-center justify-center gap-2">
                <div class="w-16 bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ${overallBarClass(overall)}" style="width: ${escapeHtml(overall)}%"></div></div>
                <span class="text-sm font-bold">${escapeHtml(overall)}</span>
              </div>
            </td>
            <td class="px-6 py-4">
              <button class="text-primary-600 hover:text-primary-700 text-sm" data-type="${escapeHtml(score.content_type)}" data-id="${escapeHtml(score.content_id)}" data-action="recommend">获取建议</button>
            </td>
          </tr>
        `;
      })
      .join('');
  }

  function bindRecommendHandlers() {
    document.querySelectorAll('[data-action="recommend"]').forEach((btn) => {
      btn.addEventListener('click', () => getRecommendations(btn));
    });
  }

  async function loadScores() {
    try {
      const response = await fetch('/api/admin/eeat/scores');
      const data = await response.json().catch(() => null);
      const scores = Array.isArray(data?.scores) ? data.scores : [];

      const avgScore = scores.length ? Math.round(scores.reduce((sum, s) => sum + (Number(s.overall_score) || 0), 0) / scores.length) : 0;
      const dist = {
        excellent: scores.filter((s) => (Number(s.overall_score) || 0) >= 80).length,
        good: scores.filter((s) => (Number(s.overall_score) || 0) >= 60 && (Number(s.overall_score) || 0) < 80).length,
        needsWork: scores.filter((s) => (Number(s.overall_score) || 0) >= 40 && (Number(s.overall_score) || 0) < 60).length,
        poor: scores.filter((s) => (Number(s.overall_score) || 0) < 40).length,
      };

      if (avgEl) {
        avgEl.textContent = `${avgScore}/100`;
        avgEl.className = `text-2xl font-bold ${avgScore >= 60 ? 'text-green-600' : avgScore >= 40 ? 'text-yellow-600' : 'text-red-600'}`;
      }
      if (excellentEl) excellentEl.textContent = String(dist.excellent);
      if (goodEl) goodEl.textContent = String(dist.good);
      if (needsWorkEl) needsWorkEl.textContent = String(dist.needsWork);
      if (poorEl) poorEl.textContent = String(dist.poor);

      renderRows(scores);
      bindRecommendHandlers();
    } catch (e) {
      console.error('Failed to load E-E-A-T scores:', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-red-600">加载失败</td></tr>`;
    }
  }

  document.getElementById('analyze-all-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('analyze-all-btn') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = '分析中...';

    try {
      const response = await fetch('/api/admin/eeat/analyze-all', { method: 'POST' });
      const data = await response.json();

      if (response.ok) {
        alert(`已分析 ${data.analyzed} 项。正在刷新...`);
        window.location.reload();
      } else {
        alert(data.error || '分析失败');
      }
    } catch (error) {
      alert('分析内容失败');
    } finally {
      btn.disabled = false;
      btn.textContent = '分析所有内容';
    }
  });

  async function getRecommendations(btn: HTMLElement) {
    const contentType = btn.dataset.type;
    const contentId = btn.dataset.id;
    const modal = document.getElementById('recommendations-modal');
    const content = document.getElementById('recommendations-content');

    if (!modal || !content) return;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    content.innerHTML = '<div class="text-center py-8">加载建议中...</div>';

    try {
      const response = await fetch('/api/admin/eeat/recommendations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content_type: contentType, content_id: contentId }),
      });

      const data = await response.json();

      if (response.ok && data.recommendations) {
        content.innerHTML = `
          <div class="mb-4">
            <p class="text-sm text-gray-500">当前分数</p>
            <p class="text-2xl font-bold ${data.current_score >= 60 ? 'text-green-600' : 'text-yellow-600'}">${data.current_score}/100</p>
          </div>
          <div class="space-y-3">
            ${data.recommendations.map((r: any) => `
              <div class="p-3 bg-gray-50 rounded-lg">
                <div class="flex items-start gap-2">
                  <span class="text-xs px-2 py-0.5 rounded ${
                    r.priority === 'high' ? 'bg-red-100 text-red-700' :
                    r.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'
                  }">${r.priority || 'tip'}</span>
                  <p class="text-sm text-gray-700">${r.action}</p>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        content.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || '加载建议失败'}</div>`;
      }
    } catch (error) {
      content.innerHTML = '<div class="text-center py-8 text-red-500">加载建议失败</div>';
    }
  }

  function closeModal() {
    const modal = document.getElementById('recommendations-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  (window as any).getRecommendations = getRecommendations;
  (window as any).closeModal = closeModal;

  loadScores();
</script>
