---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

// Get URL parameter for pre-filling source path
const sourceParam = Astro.url.searchParams.get('source') || '';

const redirects: any[] = [];
---

<AdminLayout title="URL 重定向" activePage="seo">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
        <a href="/admin/seo" class="hover:text-primary-600">SEO 工具</a>
        <span>/</span>
        <span>重定向</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">URL 重定向</h2>
      <p class="text-gray-600 mt-1">管理网站的 301 和 302 重定向</p>
    </div>
    <button 
      id="add-redirect-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      添加重定向
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">总重定向数</p>
      <p class="text-2xl font-bold text-gray-900 mt-1" id="redirects-total">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">活跃重定向</p>
      <p class="text-2xl font-bold text-green-600 mt-1" id="redirects-active">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">总访问数</p>
      <p class="text-2xl font-bold text-blue-600 mt-1" id="redirects-hits">0</p>
    </div>
  </div>

  <!-- Redirects Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">源路径</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">目标 URL</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">访问数</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="redirects-tbody">
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500">加载中...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="redirect-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900" id="modal-title">添加重定向</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="redirect-form" class="p-6 space-y-4">
          <input type="hidden" id="redirect-id" name="id" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">源路径</label>
            <input 
              type="text" 
              id="source-path" 
              name="source_path"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="/old-page"
              required
            />
            <p class="text-xs text-gray-500 mt-1">原始 URL 路径（不含域名）</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">目标 URL</label>
            <input 
              type="text" 
              id="target-url" 
              name="target_url"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="/new-page or https://example.com/page"
              required
            />
            <p class="text-xs text-gray-500 mt-1">新 URL（路径或完整 URL）</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">重定向类型</label>
            <select 
              id="redirect-type" 
              name="redirect_type"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="301">301 - 永久重定向</option>
              <option value="302">302 - 临时重定向</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">永久移动用 301，临时用 302</p>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="is-active" name="is_active" checked class="rounded border-gray-300" />
            <label for="is-active" class="text-sm text-gray-700">活跃</label>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              取消
            </button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">保存重定向
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ sourceParam }}>
  const tbody = document.getElementById('redirects-tbody');
  const totalEl = document.getElementById('redirects-total');
  const activeEl = document.getElementById('redirects-active');
  const hitsEl = document.getElementById('redirects-hits');

  const modal = document.getElementById('redirect-modal');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const closeBtn = document.getElementById('close-modal');
  const cancelBtn = document.getElementById('cancel-btn');
  const form = document.getElementById('redirect-form');
  const modalTitle = document.getElementById('modal-title');

  let redirects = [];
  const redirectById = new Map();

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function openModal(redirect = null) {
    if (redirect) {
      modalTitle.textContent = '编辑重定向';
      document.getElementById('redirect-id').value = redirect.id;
      document.getElementById('source-path').value = redirect.source_path;
      document.getElementById('target-url').value = redirect.target_url;
      document.getElementById('redirect-type').value = redirect.redirect_type;
      document.getElementById('is-active').checked = redirect.is_active;
    } else {
      modalTitle.textContent = '添加重定向';
      form.reset();
      document.getElementById('redirect-id').value = '';
      document.getElementById('is-active').checked = true;
      // Pre-fill source path if provided via URL
      if (sourceParam) {
        document.getElementById('source-path').value = sourceParam;
      }
    }
    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
  }

  // Event listeners
  document.getElementById('add-redirect-btn')?.addEventListener('click', () => openModal());
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  modalBackdrop?.addEventListener('click', closeModal);

  function renderRows() {
    if (!tbody) return;
    if (!Array.isArray(redirects) || redirects.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">尚未配置重定向</td></tr>`;
      return;
    }

    tbody.innerHTML = redirects
      .map((r) => {
        const typeBadgeClass = Number(r.redirect_type) === 301 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
        const statusBadgeClass = r.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
        const statusLabel = r.is_active ? '活跃' : '停用';
        return `
          <tr class="hover:bg-gray-50" data-id="${escapeHtml(r.id)}">
            <td class="px-6 py-4"><code class="text-sm bg-gray-100 px-2 py-1 rounded">${escapeHtml(r.source_path)}</code></td>
            <td class="px-6 py-4"><p class="text-sm text-gray-900 truncate max-w-md" title="${escapeHtml(r.target_url)}">${escapeHtml(r.target_url)}</p></td>
            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass}">${escapeHtml(r.redirect_type)}</span></td>
            <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(r.hit_count || 0)}</td>
            <td class="px-6 py-4">
              <button class="toggle-status-btn" data-id="${escapeHtml(r.id)}" data-active="${r.is_active ? 'true' : 'false'}">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer ${statusBadgeClass}">${statusLabel}</span>
              </button>
            </td>
            <td class="px-6 py-4 text-right">
              <button class="text-primary-600 hover:text-primary-700 text-sm font-medium mr-3 edit-btn" data-id="${escapeHtml(r.id)}">编辑</button>
              <button class="text-red-600 hover:text-red-700 text-sm font-medium delete-btn" data-id="${escapeHtml(r.id)}">删除</button>
            </td>
          </tr>
        `;
      })
      .join('');

    // Edit buttons
    document.querySelectorAll('.edit-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (!id) return;
        const redirect = redirectById.get(id);
        openModal(redirect || null);
      });
    });

    // Delete buttons
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        if (!confirm('确定要删除此重定向吗？')) return;
        const id = btn.dataset.id;
        if (!id) return;

        try {
          const response = await fetch(`/api/admin/seo/redirects/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if (response.ok) {
            window.location.reload();
          } else {
            alert('删除重定向失败');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('删除重定向失败');
        }
      });
    });

    // Toggle status buttons
    document.querySelectorAll('.toggle-status-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const currentActive = btn.dataset.active === 'true';
        if (!id) return;

        try {
          const response = await fetch(`/api/admin/seo/redirects/${encodeURIComponent(id)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: !currentActive }),
          });
          if (response.ok) {
            window.location.reload();
          } else {
            alert('更新状态失败');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('更新状态失败');
        }
      });
    });
  }

  // Form submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = {
      id: formData.get('id') || undefined,
      source_path: formData.get('source_path'),
      target_url: formData.get('target_url'),
      redirect_type: parseInt(formData.get('redirect_type')),
      is_active: formData.get('is_active') === 'on'
    };

    try {
      const response = await fetch(`/api/admin/seo/redirects`, {
        method: data.id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('保存重定向失败');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('保存重定向失败');
    }
  });

  // Open modal if source param is provided
  if (sourceParam) {
    openModal();
  }

  async function load() {
    if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">加载中...</td></tr>`;
    try {
      const res = await fetch('/api/admin/seo/redirects');
      const json = await res.json().catch(() => null);
      redirects = Array.isArray(json?.redirects) ? json.redirects : [];
      redirectById.clear();
      redirects.forEach((r) => r?.id && redirectById.set(r.id, r));

      const active = redirects.filter((r) => r.is_active).length;
      const hits = redirects.reduce((sum, r) => sum + (Number(r.hit_count) || 0), 0);
      if (totalEl) totalEl.textContent = String(redirects.length);
      if (activeEl) activeEl.textContent = String(active);
      if (hitsEl) hitsEl.textContent = String(hits);

      renderRows();
    } catch (e) {
      console.error('Failed to load redirects:', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-red-600">加载失败</td></tr>`;
    }
  }

  load();
</script>
