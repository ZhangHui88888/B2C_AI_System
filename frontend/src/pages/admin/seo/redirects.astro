---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Get URL parameter for pre-filling source path
const sourceParam = Astro.url.searchParams.get('source') || '';

// Get all redirects
const { data: redirects } = await supabase
  .from('url_redirects')
  .select('*')
  .order('created_at', { ascending: false });

const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';
---

<AdminLayout title="URL Redirects" activePage="seo">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
        <a href="/admin/seo" class="hover:text-primary-600">SEO Tools</a>
        <span>/</span>
        <span>Redirects</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">URL Redirects</h2>
      <p class="text-gray-600 mt-1">Manage 301 and 302 redirects for your site</p>
    </div>
    <button 
      id="add-redirect-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      Add Redirect
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">Total Redirects</p>
      <p class="text-2xl font-bold text-gray-900 mt-1">{redirects?.length || 0}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">Active Redirects</p>
      <p class="text-2xl font-bold text-green-600 mt-1">{redirects?.filter(r => r.is_active).length || 0}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">Total Hits</p>
      <p class="text-2xl font-bold text-blue-600 mt-1">{redirects?.reduce((sum, r) => sum + (r.hit_count || 0), 0) || 0}</p>
    </div>
  </div>

  <!-- Redirects Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source Path</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target URL</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hits</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="redirects-tbody">
          {redirects && redirects.length > 0 ? (
            redirects.map((redirect) => (
              <tr class="hover:bg-gray-50" data-id={redirect.id}>
                <td class="px-6 py-4">
                  <code class="text-sm bg-gray-100 px-2 py-1 rounded">{redirect.source_path}</code>
                </td>
                <td class="px-6 py-4">
                  <p class="text-sm text-gray-900 truncate max-w-md" title={redirect.target_url}>
                    {redirect.target_url}
                  </p>
                </td>
                <td class="px-6 py-4">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    redirect.redirect_type === 301 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                  }`}>
                    {redirect.redirect_type}
                  </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  {redirect.hit_count || 0}
                </td>
                <td class="px-6 py-4">
                  <button 
                    class="toggle-status-btn"
                    data-id={redirect.id}
                    data-active={redirect.is_active}
                  >
                    <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer ${
                      redirect.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                    }`}>
                      {redirect.is_active ? 'Active' : 'Inactive'}
                    </span>
                  </button>
                </td>
                <td class="px-6 py-4 text-right">
                  <button 
                    class="text-primary-600 hover:text-primary-700 text-sm font-medium mr-3 edit-btn"
                    data-redirect={JSON.stringify(redirect)}
                  >
                    Edit
                  </button>
                  <button 
                    class="text-red-600 hover:text-red-700 text-sm font-medium delete-btn"
                    data-id={redirect.id}
                  >
                    Delete
                  </button>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                No redirects configured yet
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="redirect-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900" id="modal-title">Add Redirect</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="redirect-form" class="p-6 space-y-4">
          <input type="hidden" id="redirect-id" name="id" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Source Path</label>
            <input 
              type="text" 
              id="source-path" 
              name="source_path"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="/old-page"
              required
            />
            <p class="text-xs text-gray-500 mt-1">The original URL path (without domain)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Target URL</label>
            <input 
              type="text" 
              id="target-url" 
              name="target_url"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              placeholder="/new-page or https://example.com/page"
              required
            />
            <p class="text-xs text-gray-500 mt-1">The new URL (path or full URL)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Redirect Type</label>
            <select 
              id="redirect-type" 
              name="redirect_type"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="301">301 - Permanent Redirect</option>
              <option value="302">302 - Temporary Redirect</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Use 301 for permanent moves, 302 for temporary</p>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="is-active" name="is_active" checked class="rounded border-gray-300" />
            <label for="is-active" class="text-sm text-gray-700">Active</label>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
              Save Redirect
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ apiUrl, sourceParam }}>
  const modal = document.getElementById('redirect-modal');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const closeBtn = document.getElementById('close-modal');
  const cancelBtn = document.getElementById('cancel-btn');
  const form = document.getElementById('redirect-form');
  const modalTitle = document.getElementById('modal-title');

  function openModal(redirect = null) {
    if (redirect) {
      modalTitle.textContent = 'Edit Redirect';
      document.getElementById('redirect-id').value = redirect.id;
      document.getElementById('source-path').value = redirect.source_path;
      document.getElementById('target-url').value = redirect.target_url;
      document.getElementById('redirect-type').value = redirect.redirect_type;
      document.getElementById('is-active').checked = redirect.is_active;
    } else {
      modalTitle.textContent = 'Add Redirect';
      form.reset();
      document.getElementById('redirect-id').value = '';
      document.getElementById('is-active').checked = true;
      // Pre-fill source path if provided via URL
      if (sourceParam) {
        document.getElementById('source-path').value = sourceParam;
      }
    }
    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
  }

  // Event listeners
  document.getElementById('add-redirect-btn')?.addEventListener('click', () => openModal());
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  modalBackdrop?.addEventListener('click', closeModal);

  // Edit buttons
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const redirect = JSON.parse(btn.dataset.redirect);
      openModal(redirect);
    });
  });

  // Delete buttons
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this redirect?')) return;
      
      const id = btn.dataset.id;
      try {
        const response = await fetch(`${apiUrl}/api/seo/redirects/${id}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to delete redirect');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete redirect');
      }
    });
  });

  // Toggle status buttons
  document.querySelectorAll('.toggle-status-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const currentActive = btn.dataset.active === 'true';
      
      try {
        const response = await fetch(`${apiUrl}/api/seo/redirects/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: !currentActive })
        });
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to update status');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to update status');
      }
    });
  });

  // Form submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = {
      id: formData.get('id') || undefined,
      source_path: formData.get('source_path'),
      target_url: formData.get('target_url'),
      redirect_type: parseInt(formData.get('redirect_type')),
      is_active: formData.get('is_active') === 'on'
    };

    try {
      const response = await fetch(`${apiUrl}/api/seo/redirects`, {
        method: data.id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Failed to save redirect');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to save redirect');
    }
  });

  // Open modal if source param is provided
  if (sourceParam) {
    openModal();
  }
</script>
