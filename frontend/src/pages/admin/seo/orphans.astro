---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
---

<AdminLayout title="å­¤ç«‹é¡µé¢æ£€æµ‹" activePage="seo">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">å­¤ç«‹é¡µé¢æ£€æµ‹</h2>
      <p class="text-gray-600 mt-1">æ‰¾å‡ºæ²¡æœ‰å†…éƒ¨é“¾æ¥æŒ‡å‘çš„é¡µé¢ï¼Œæ”¹å–„ç½‘ç«™å†…é“¾ç»“æ„</p>
    </div>
    <button
      id="scan-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium flex items-center gap-2"
    >
      <span>ğŸ”</span>
      <span>æ‰«æå­¤ç«‹é¡µé¢</span>
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">æœªè§£å†³</p>
      <p class="text-2xl font-bold text-red-600" id="stat-unresolved">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">å·²è§£å†³</p>
      <p class="text-2xl font-bold text-green-600" id="stat-resolved">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">äº§å“é¡µ</p>
      <p class="text-2xl font-bold text-blue-600" id="stat-product">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">åˆ†ç±»é¡µ</p>
      <p class="text-2xl font-bold text-purple-600" id="stat-category">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">åšå®¢</p>
      <p class="text-2xl font-bold text-indigo-600" id="stat-blog">0</p>
    </div>
  </div>

  <!-- Info Box -->
  <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
    <div class="flex gap-3">
      <span class="text-2xl">ğŸ’¡</span>
      <div>
        <p class="font-medium text-amber-800">ä»€ä¹ˆæ˜¯å­¤ç«‹é¡µé¢ï¼Ÿ</p>
        <p class="text-sm text-amber-700 mt-1">
          å­¤ç«‹é¡µé¢æ˜¯æŒ‡æ²¡æœ‰ä»»ä½•å†…éƒ¨é“¾æ¥æŒ‡å‘çš„é¡µé¢ã€‚è¿™ç±»é¡µé¢éš¾ä»¥è¢«æœç´¢å¼•æ“å‘ç°å’Œæ”¶å½•ï¼Œ
          ä¹Ÿä¸åˆ©äºç”¨æˆ·æµè§ˆã€‚å»ºè®®ä¸ºæ¯ä¸ªé‡è¦é¡µé¢æ·»åŠ è‡³å°‘ 2-3 ä¸ªå†…éƒ¨é“¾æ¥ã€‚
        </p>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="flex gap-2 mb-4">
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-primary-600 text-white" data-filter="unresolved">
      æœªè§£å†³ (<span id="tab-unresolved">0</span>)
    </button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="resolved">
      å·²è§£å†³ (<span id="tab-resolved">0</span>)
    </button>
    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="all">
      å…¨éƒ¨ (<span id="tab-all">0</span>)
    </button>
  </div>

  <!-- Orphan Pages Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¡µé¢</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç±»å‹</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">å…¥é“¾æ•°</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ£€æµ‹æ—¶é—´</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="orphans-table">
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Scan Result Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
      <span id="toast-icon">âœ“</span>
      <span id="toast-message">æ“ä½œæˆåŠŸ</span>
    </div>
  </div>
</AdminLayout>

<script>
  function showToast(message: string, isSuccess = true) {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const msg = document.getElementById('toast-message');
    if (toast && icon && msg) {
      icon.textContent = isSuccess ? 'âœ“' : 'âœ—';
      msg.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
  }

  // Scan button
  document.getElementById('scan-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('scan-btn') as HTMLButtonElement;
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin">â³</span> æ‰«æä¸­...';

    try {
      const res = await fetch(`/api/admin/seo/links/orphans/scan`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await res.json();
      
      if (data.success) {
        showToast(`æ‰«æå®Œæˆï¼å‘ç° ${data.orphans_found} ä¸ªå­¤ç«‹é¡µé¢`);
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(data.error || 'æ‰«æå¤±è´¥', false);
      }
    } catch (error) {
      showToast('æ‰«æå¤±è´¥', false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>ğŸ”</span><span>æ‰«æå­¤ç«‹é¡µé¢</span>';
    }
  });

  function bindResolveButtons() {
    document.querySelectorAll('.resolve-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const id = target.dataset.id;
        const action = target.dataset.action;

        try {
          const res = await fetch(`/api/admin/seo/links/orphans/${id}/resolve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ resolution_action: action }),
          });

          if (res.ok) {
            showToast('å·²æ ‡è®°ä¸ºè§£å†³');
            const row = target.closest('tr');
            row?.remove();
          } else {
            showToast('æ“ä½œå¤±è´¥', false);
          }
        } catch (error) {
          showToast('æ“ä½œå¤±è´¥', false);
        }
      });
    });
  }

  async function loadOrphans() {
    try {
      const res = await fetch('/api/admin/seo/links/orphans?show_resolved=true');
      const data = await res.json().catch(() => null);
      const orphans = Array.isArray(data?.orphans) ? data.orphans : [];

      const unresolved = orphans.filter((p: any) => !p.is_resolved);
      const resolved = orphans.filter((p: any) => p.is_resolved);
      const byType = {
        product: unresolved.filter((p: any) => p.page_type === 'product').length,
        category: unresolved.filter((p: any) => p.page_type === 'category').length,
        blog: unresolved.filter((p: any) => p.page_type === 'blog').length,
      };

      document.getElementById('stat-unresolved')!.textContent = String(unresolved.length);
      document.getElementById('stat-resolved')!.textContent = String(resolved.length);
      document.getElementById('stat-product')!.textContent = String(byType.product);
      document.getElementById('stat-category')!.textContent = String(byType.category);
      document.getElementById('stat-blog')!.textContent = String(byType.blog);
      document.getElementById('tab-unresolved')!.textContent = String(unresolved.length);
      document.getElementById('tab-resolved')!.textContent = String(resolved.length);
      document.getElementById('tab-all')!.textContent = String(orphans.length);

      const tbody = document.getElementById('orphans-table');
      if (!tbody) return;

      tbody.innerHTML = orphans.map((page: any) => {
        const typeClass = page.page_type === 'product'
          ? 'bg-blue-100 text-blue-700'
          : page.page_type === 'category'
            ? 'bg-purple-100 text-purple-700'
            : 'bg-indigo-100 text-indigo-700';
        const typeLabel = page.page_type === 'product' ? 'äº§å“' : page.page_type === 'category' ? 'åˆ†ç±»' : 'åšå®¢';
        const statusHtml = page.is_resolved
          ? '<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">âœ“ å·²è§£å†³</span>'
          : '<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">å¾…å¤„ç†</span>';
        const actionsHtml = page.is_resolved
          ? ''
          : `
            <div class="flex items-center justify-center gap-2">
              <button class="resolve-btn px-3 py-1 text-xs font-medium text-green-600 hover:bg-green-50 rounded" data-id="${page.id}" data-action="links_added">å·²æ·»åŠ é“¾æ¥</button>
              <button class="resolve-btn px-3 py-1 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded" data-id="${page.id}" data-action="ignored">å¿½ç•¥</button>
            </div>
          `;
        return `
          <tr class="orphan-row hover:bg-gray-50" data-resolved="${page.is_resolved ? 'true' : 'false'}">
            <td class="px-6 py-4">
              <div>
                <p class="font-medium text-gray-900 truncate max-w-xs">${page.page_title || page.page_url}</p>
                <a href="${page.page_url}" target="_blank" class="text-sm text-primary-600 hover:underline truncate block max-w-xs">${page.page_url}</a>
              </div>
            </td>
            <td class="px-6 py-4"><span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${typeClass}">${typeLabel}</span></td>
            <td class="px-6 py-4 text-center"><span class="text-red-600 font-medium">${page.incoming_links_count}</span></td>
            <td class="px-6 py-4 text-center">${statusHtml}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${new Date(page.detected_at).toLocaleDateString('zh-CN')}</td>
            <td class="px-6 py-4 text-center">${actionsHtml}</td>
          </tr>
        `;
      }).join('');

      bindResolveButtons();
    } catch (e) {
      console.error('Failed to load orphans:', e);
      const tbody = document.getElementById('orphans-table');
      if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-red-600">åŠ è½½å¤±è´¥</td></tr>`;
    }
  }

  // Filter tabs
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const filter = target.dataset.filter;

      // Update button styles
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('bg-primary-600', 'text-white');
        b.classList.add('bg-gray-100', 'text-gray-700');
      });
      target.classList.remove('bg-gray-100', 'text-gray-700');
      target.classList.add('bg-primary-600', 'text-white');

      // Filter rows
      document.querySelectorAll('.orphan-row').forEach(row => {
        const el = row as HTMLElement;
        const isResolved = el.dataset.resolved === 'true';

        if (filter === 'all') {
          el.style.display = '';
        } else if (filter === 'resolved') {
          el.style.display = isResolved ? '' : 'none';
        } else {
          el.style.display = isResolved ? 'none' : '';
        }
      });
    });
  });

  loadOrphans();
</script>
