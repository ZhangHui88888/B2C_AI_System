---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';

const sitemapConfig: any[] = [];
const productCount = 0;
const categoryCount = 0;
const blogCount = 0;

// Default config for page types
const defaultConfig = [
  { page_type: 'products', is_included: true, changefreq: 'weekly', priority: 0.8, url_count: productCount || 0 },
  { page_type: 'categories', is_included: true, changefreq: 'weekly', priority: 0.7, url_count: categoryCount || 0 },
  { page_type: 'blogs', is_included: true, changefreq: 'daily', priority: 0.6, url_count: blogCount || 0 },
  { page_type: 'pages', is_included: true, changefreq: 'monthly', priority: 0.5, url_count: 6 }, // Static pages
];

// Merge with saved config
const configMap = new Map(sitemapConfig?.map(c => [c.page_type, c]) || []);
const pageTypes = defaultConfig.map(d => ({
  ...d,
  ...(configMap.get(d.page_type) || {}),
}));

const totalUrls = pageTypes.reduce((sum, p) => sum + (p.is_included ? p.url_count : 0), 0);

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://example.com';
---

<AdminLayout title="站点地图配置" activePage="seo">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
        <a href="/admin/seo" class="hover:text-primary-600">SEO 工具</a>
        <span>/</span>
        <span>站点地图</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">站点地图配置</h2>
      <p class="text-gray-600 mt-1">配置站点地图的生成方式</p>
    </div>
    <div class="flex gap-3">
      <a 
        href="/sitemap.xml"
        target="_blank"
        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
        查看站点地图
      </a>
      <button 
        id="regenerate-btn"
        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        重新生成站点地图
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">总 URL 数</p>
      <p class="text-2xl font-bold text-gray-900 mt-1" id="total-urls">{totalUrls}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">站点地图 URL</p>
      <p class="text-sm font-mono text-primary-600 mt-2 truncate">{siteUrl}/sitemap.xml</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">最后生成</p>
      <p class="text-sm text-gray-900 mt-2">按需自动生成</p>
    </div>
  </div>

  <!-- Configuration Form -->
  <form id="sitemap-form" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900">页面类型设置</h3>
      <p class="text-sm text-gray-500 mt-1">配置包含哪些页面及其站点地图属性</p>
    </div>

    <div class="divide-y divide-gray-100">
      {pageTypes.map((config) => (
        <div class="px-6 py-4 flex items-center justify-between" data-page-type={config.page_type}>
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2">
              <input 
                type="checkbox" 
                name={`${config.page_type}_included`}
                checked={config.is_included}
                class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
              />
              <span class="text-sm font-medium text-gray-900 capitalize">{config.page_type}</span>
            </label>
            <span class="text-sm text-gray-500">(<span id={`url-count-${config.page_type}`}>{config.url_count}</span> URLs)</span>
          </div>

          <div class="flex items-center gap-4">
            <div>
              <label class="text-xs text-gray-500 block mb-1">更新频率</label>
              <select 
                name={`${config.page_type}_changefreq`}
                class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              >
                <option value="always" selected={config.changefreq === 'always'}>Always</option>
                <option value="hourly" selected={config.changefreq === 'hourly'}>Hourly</option>
                <option value="daily" selected={config.changefreq === 'daily'}>Daily</option>
                <option value="weekly" selected={config.changefreq === 'weekly'}>Weekly</option>
                <option value="monthly" selected={config.changefreq === 'monthly'}>Monthly</option>
                <option value="yearly" selected={config.changefreq === 'yearly'}>Yearly</option>
                <option value="never" selected={config.changefreq === 'never'}>Never</option>
              </select>
            </div>

            <div>
              <label class="text-xs text-gray-500 block mb-1">优先级</label>
              <select 
                name={`${config.page_type}_priority`}
                class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              >
                <option value="1.0" selected={config.priority === 1.0}>1.0 (最高)</option>
                <option value="0.9" selected={config.priority === 0.9}>0.9</option>
                <option value="0.8" selected={config.priority === 0.8}>0.8</option>
                <option value="0.7" selected={config.priority === 0.7}>0.7</option>
                <option value="0.6" selected={config.priority === 0.6}>0.6</option>
                <option value="0.5" selected={config.priority === 0.5}>0.5 (默认)</option>
                <option value="0.4" selected={config.priority === 0.4}>0.4</option>
                <option value="0.3" selected={config.priority === 0.3}>0.3</option>
                <option value="0.2" selected={config.priority === 0.2}>0.2</option>
                <option value="0.1" selected={config.priority === 0.1}>0.1 (最低)</option>
              </select>
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="px-6 py-4 bg-gray-50 flex justify-end">
      <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
        保存配置
      </button>
    </div>
  </form>

  <!-- Sitemap Best Practices -->
  <div class="mt-6 bg-blue-50 rounded-xl p-6">
    <h3 class="font-semibold text-blue-900 mb-3">站点地图最佳实践</h3>
    <ul class="space-y-2 text-sm text-blue-800">
      <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>将站点地图提交到 Google Search Console 和 Bing 网站管理员工具</span>
      </li>
      <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>保持站点地图在 50,000 个 URL 和 50MB 未压缩以下</span>
      </li>
      <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>为重要页面（如商品和分类）使用更高优先级</span>
      </li>
      <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Reference your sitemap in robots.txt: <code class="bg-blue-100 px-1 rounded">Sitemap: {siteUrl}/sitemap.xml</code></span>
      </li>
    </ul>
  </div>
</AdminLayout>

<script>
  const form = document.getElementById('sitemap-form');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    // Build config array
    const pageTypes = ['products', 'categories', 'blogs', 'pages'];
    const configs = pageTypes.map(type => ({
      page_type: type,
      is_included: formData.get(`${type}_included`) === 'on',
      changefreq: formData.get(`${type}_changefreq`),
      priority: parseFloat(formData.get(`${type}_priority`))
    }));

    try {
      const response = await fetch(`/api/admin/seo/sitemap/config`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ configs })
      });

      if (response.ok) {
        alert('配置保存成功');
      } else {
        alert('保存配置失败');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('保存配置失败');
    }
  });

  document.getElementById('regenerate-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('regenerate-btn');
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Regenerating...';

    try {
      const response = await fetch(`/api/admin/seo/sitemap/regenerate`, {
        method: 'POST'
      });

      if (response.ok) {
        alert('站点地图重新生成成功');
        window.open('/sitemap.xml', '_blank');
      } else {
        alert('重新生成站点地图失败');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('重新生成站点地图失败');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Regenerate Sitemap';
    }
  });

  async function loadPageData() {
    try {
      const res = await fetch('/api/admin/seo/sitemap/page-data');
      const json = await res.json().catch(() => null);
      if (!json?.success) return;

      const cfgRows = Array.isArray(json.sitemapConfig) ? json.sitemapConfig : [];
      const counts = json.counts || {};

      const defaults = {
        products: { page_type: 'products', is_included: true, changefreq: 'weekly', priority: 0.8, url_count: Number(counts.products) || 0 },
        categories: { page_type: 'categories', is_included: true, changefreq: 'weekly', priority: 0.7, url_count: Number(counts.categories) || 0 },
        blogs: { page_type: 'blogs', is_included: true, changefreq: 'daily', priority: 0.6, url_count: Number(counts.blogs) || 0 },
        pages: { page_type: 'pages', is_included: true, changefreq: 'monthly', priority: 0.5, url_count: Number(counts.pages) || 0 },
      };

      const cfgMap = new Map(cfgRows.map((c) => [c.page_type, c]));
      const merged = ['products', 'categories', 'blogs', 'pages'].map((t) => ({ ...defaults[t], ...(cfgMap.get(t) || {}) }));

      // Update UI
      let total = 0;
      merged.forEach((c) => {
        const row = document.querySelector(`[data-page-type="${c.page_type}"]`);
        if (!row) return;

        const cb = row.querySelector(`input[name="${c.page_type}_included"]`);
        if (cb) cb.checked = !!c.is_included;

        const changefreq = row.querySelector(`select[name="${c.page_type}_changefreq"]`);
        if (changefreq) changefreq.value = c.changefreq || 'weekly';

        const priority = row.querySelector(`select[name="${c.page_type}_priority"]`);
        if (priority) priority.value = String(c.priority ?? '0.5');

        const countEl = document.getElementById(`url-count-${c.page_type}`);
        if (countEl) countEl.textContent = String(c.url_count || 0);

        if (c.is_included) total += Number(c.url_count) || 0;
      });

      const totalEl = document.getElementById('total-urls');
      if (totalEl) totalEl.textContent = String(total);
    } catch {
      // ignore
    }
  }

  loadPageData();
</script>
