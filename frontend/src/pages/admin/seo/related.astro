---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
---

<AdminLayout title="ç›¸å…³å†…å®¹æ¨è" activePage="seo">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">ç›¸å…³å†…å®¹æ¨è</h2>
      <p class="text-gray-600 mt-1">ä½¿ç”¨ AI ç”Ÿæˆäº§å“å’Œå†…å®¹ä¹‹é—´çš„æ™ºèƒ½æ¨èå…³ç³»</p>
    </div>
    <button
      id="generate-all-btn"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium flex items-center gap-2"
    >
      <span>ğŸ¤–</span>
      <span>æ‰¹é‡ç”Ÿæˆæ¨è</span>
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">æ¨èå…³ç³»æ€»æ•°</p>
      <p class="text-2xl font-bold text-gray-900" id="stat-total">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">AI ç”Ÿæˆ</p>
      <p class="text-2xl font-bold text-blue-600" id="stat-ai">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">æ‰‹åŠ¨è®¾ç½®</p>
      <p class="text-2xl font-bold text-purple-600" id="stat-manual">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
      <p class="text-sm text-gray-500">å¹³å‡ç›¸å…³åº¦</p>
      <p class="text-2xl font-bold text-green-600" id="stat-avg">0%</p>
    </div>
  </div>

  <!-- Relationship Types -->
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6">
    <h3 class="font-semibold text-gray-900 mb-3">æ¨èç±»å‹åˆ†å¸ƒ</h3>
    <div class="grid grid-cols-3 gap-4 text-center">
      <div>
        <p class="text-2xl font-bold text-blue-600" id="stat-similar">0</p>
        <p class="text-sm text-gray-600">ç›¸ä¼¼äº§å“</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-green-600" id="stat-complementary">0</p>
        <p class="text-sm text-gray-600">äº’è¡¥äº§å“</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-purple-600" id="stat-frequently">0</p>
        <p class="text-sm text-gray-600">ç»å¸¸ä¸€èµ·è´­ä¹°</p>
      </div>
    </div>
  </div>

  <!-- Generate for Single Item -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <h3 class="font-semibold text-gray-900 mb-4">ä¸ºå•ä¸ªå†…å®¹ç”Ÿæˆæ¨è</h3>
    <div class="flex flex-wrap gap-4">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹ç±»å‹</label>
        <select id="source-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
          <option value="product">äº§å“</option>
        </select>
      </div>
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©å†…å®¹</label>
        <select id="source-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
          <option value="">åŠ è½½ä¸­...</option>
        </select>
      </div>
      <div class="flex items-end">
        <button
          id="generate-single-btn"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
        >
          ç”Ÿæˆæ¨è
        </button>
      </div>
    </div>
    <div id="single-result" class="mt-4 hidden">
      <div class="p-4 bg-green-50 text-green-700 rounded-lg text-sm"></div>
    </div>
  </div>

  <!-- Related Content List -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
      <h3 class="font-semibold text-gray-900">ç°æœ‰æ¨èå…³ç³»</h3>
      <span class="text-sm text-gray-500"><span id="stat-sources">0</span> ä¸ªæ¥æº</span>
    </div>

    <div id="related-container" class="divide-y divide-gray-100">
      <div class="px-6 py-12 text-center text-gray-500">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
      <span id="toast-icon">âœ“</span>
      <span id="toast-message">æ“ä½œæˆåŠŸ</span>
    </div>
  </div>
</AdminLayout>

<script>
  let products: any[] = [];
  let related: any[] = [];

  function escapeHtml(s: any) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function showToast(message, isSuccess = true) {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const msg = document.getElementById('toast-message');
    if (toast && icon && msg) {
      icon.textContent = isSuccess ? 'âœ“' : 'âœ—';
      msg.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
  }

  function setText(id: string, v: any) {
    const el = document.getElementById(id);
    if (el) el.textContent = String(v);
  }

  function populateProducts() {
    const select = document.getElementById('source-id') as HTMLSelectElement | null;
    if (!select) return;
    select.innerHTML = '';
    products.forEach((p) => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.name;
      select.appendChild(option);
    });
  }

  function renderRelated() {
    const container = document.getElementById('related-container');
    if (!container) return;

    const filtered = related.filter((r) => r.source_type === 'product' && r.related_type === 'product');

    const stats = {
      totalRelations: filtered.length,
      aiGenerated: filtered.filter((r) => !!r.is_ai_generated).length,
      manualOverride: filtered.filter((r) => !r.is_ai_generated).length,
      avgRelevance: filtered.length ? Math.round(filtered.reduce((s, r) => s + (Number(r.relevance_score) || 0), 0) / filtered.length * 100) : 0,
    };
    const relationshipTypes = {
      similar: filtered.filter((r) => r.relationship_type === 'similar').length,
      complementary: filtered.filter((r) => r.relationship_type === 'complementary').length,
      frequently_bought: filtered.filter((r) => r.relationship_type === 'frequently_bought_together').length,
    };

    const grouped = filtered.reduce((acc: any, item: any) => {
      const key = `${item.source_type}:${item.source_id}`;
      if (!acc[key]) acc[key] = { source_type: item.source_type, source_id: item.source_id, items: [] };
      acc[key].items.push(item);
      return acc;
    }, {});

    const groups = Object.values(grouped) as any[];
    const productNameById = new Map(products.map((p) => [p.id, p.name]));

    setText('stat-total', stats.totalRelations);
    setText('stat-ai', stats.aiGenerated);
    setText('stat-manual', stats.manualOverride);
    setText('stat-avg', `${stats.avgRelevance}%`);
    setText('stat-similar', relationshipTypes.similar);
    setText('stat-complementary', relationshipTypes.complementary);
    setText('stat-frequently', relationshipTypes.frequently_bought);
    setText('stat-sources', groups.length);

    if (groups.length === 0) {
      container.innerHTML = `
        <div class="px-6 py-12 text-center">
          <div class="text-4xl mb-4">ğŸ”—</div>
          <p class="text-gray-500">æš‚æ— æ¨èå…³ç³»</p>
          <p class="text-sm text-gray-400 mt-1">ç‚¹å‡»"æ‰¹é‡ç”Ÿæˆæ¨è"å¼€å§‹ä¸ºæ‰€æœ‰äº§å“ç”Ÿæˆæ™ºèƒ½æ¨è</p>
        </div>
      `;
      return;
    }

    container.innerHTML = groups.slice(0, 20).map((group: any) => {
      const sourceName = productNameById.get(group.source_id) || group.source_id;
      const itemsHtml = group.items.map((item: any) => {
        const relatedName = productNameById.get(item.related_id) || item.related_id;
        const dot = item.relationship_type === 'similar' ? 'bg-blue-500' : item.relationship_type === 'complementary' ? 'bg-green-500' : 'bg-purple-500';
        return `
          <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-gray-50 rounded-lg text-sm">
            <span class="w-2 h-2 rounded-full ${dot}"></span>
            <span class="text-gray-700">${escapeHtml(relatedName)}</span>
            <span class="text-gray-400">(${Math.round((Number(item.relevance_score) || 0) * 100)}%)</span>
            <button class="delete-btn text-red-400 hover:text-red-600" data-id="${escapeHtml(item.id)}" title="åˆ é™¤">Ã—</button>
          </div>
        `;
      }).join('');
      return `
        <div class="px-6 py-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">äº§å“</span>
              <span class="font-medium text-gray-900">${escapeHtml(sourceName)}</span>
            </div>
            <span class="text-sm text-gray-500">${group.items.length} ä¸ªæ¨è</span>
          </div>
          <div class="flex flex-wrap gap-2">${itemsHtml}</div>
        </div>
      `;
    }).join('');

    bindDeleteButtons();
  }

  async function loadPageData() {
    try {
      const [productsRes, relatedRes] = await Promise.all([
        fetch('/api/admin/products?limit=100&page=1'),
        fetch('/api/admin/related-content?source_type=product'),
      ]);

      const productsJson = await productsRes.json().catch(() => null);
      products = Array.isArray(productsJson?.products) ? productsJson.products : [];
      populateProducts();

      const relatedJson = await relatedRes.json().catch(() => null);
      related = Array.isArray(relatedJson?.related_content) ? relatedJson.related_content : [];

      renderRelated();
    } catch (e) {
      console.error('Failed to load related page data:', e);
      const container = document.getElementById('related-container');
      if (container) container.innerHTML = '<div class="px-6 py-12 text-center text-red-600">åŠ è½½å¤±è´¥</div>';
    }
  }

  // Generate for all
  document.getElementById('generate-all-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('generate-all-btn') as HTMLButtonElement;
    
    if (!confirm('è¿™å°†ä¸ºæ‰€æœ‰äº§å“ç”Ÿæˆ AI æ¨èï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin">â³</span> ç”Ÿæˆä¸­...';

    try {
      const res = await fetch('/api/admin/related-content/generate-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await res.json();
      
      if (data.success) {
        showToast(`ç”Ÿæˆå®Œæˆï¼å·²å¤„ç† ${data.products_processed} ä¸ªäº§å“`);
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(data.error || 'ç”Ÿæˆå¤±è´¥', false);
      }
    } catch (error) {
      showToast('ç”Ÿæˆå¤±è´¥', false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>ğŸ¤–</span><span>æ‰¹é‡ç”Ÿæˆæ¨è</span>';
    }
  });

  // Generate for single
  document.getElementById('generate-single-btn')?.addEventListener('click', async () => {
    const sourceType = (document.getElementById('source-type') as HTMLSelectElement).value;
    const sourceId = (document.getElementById('source-id') as HTMLSelectElement).value;
    const resultDiv = document.getElementById('single-result');
    const resultContent = resultDiv?.querySelector('div');

    if (!sourceId) {
      showToast('è¯·é€‰æ‹©å†…å®¹', false);
      return;
    }

    const btn = document.getElementById('generate-single-btn') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';

    try {
      const res = await fetch('/api/admin/related-content/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          source_type: sourceType,
          source_id: sourceId,
          count: 5,
        }),
      });
      const data = await res.json();
      
      if (data.related_items) {
        resultDiv?.classList.remove('hidden');
        if (resultContent) {
          resultContent.textContent = `âœ“ å·²ä¸º "${data.source.name}" ç”Ÿæˆ ${data.count} ä¸ªæ¨è`;
        }
        setTimeout(() => location.reload(), 2000);
      } else {
        showToast(data.error || 'ç”Ÿæˆå¤±è´¥', false);
      }
    } catch (error) {
      showToast('ç”Ÿæˆå¤±è´¥', false);
    } finally {
      btn.disabled = false;
      btn.textContent = 'ç”Ÿæˆæ¨è';
    }
  });

  function bindDeleteButtons() {
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const id = target.dataset.id;
        if (!id) return;

        if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¨èå…³ç³»ï¼Ÿ')) return;

        try {
          const res = await fetch(`/api/admin/related-content/${id}`, { method: 'DELETE' });

          if (res.ok) {
            showToast('å·²åˆ é™¤');
            target.closest('.inline-flex')?.remove();
          } else {
            showToast('åˆ é™¤å¤±è´¥', false);
          }
        } catch (error) {
          showToast('åˆ é™¤å¤±è´¥', false);
        }
      });
    });
  }

  loadPageData();
</script>
