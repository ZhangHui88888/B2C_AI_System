---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Get robots config
const { data: robotsConfig } = await supabase
  .from('robots_config')
  .select('*')
  .single();

const config = robotsConfig || {
  allow_gptbot: true,
  allow_claudebot: true,
  allow_perplexitybot: true,
  allow_googlebot: true,
  allow_bingbot: true,
  disallow_paths: ['/admin', '/api', '/checkout'],
  custom_content: null
};

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://example.com';
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

// Generate preview
function generateRobotsPreview(cfg: any): string {
  let content = `# robots.txt for ${siteUrl}\n`;
  content += `# Generated by DTC Admin\n\n`;
  
  // Default rules for all bots
  content += `User-agent: *\n`;
  (cfg.disallow_paths || []).forEach((path: string) => {
    content += `Disallow: ${path}\n`;
  });
  content += `Allow: /\n\n`;
  
  // AI bots
  if (!cfg.allow_gptbot) {
    content += `User-agent: GPTBot\nDisallow: /\n\n`;
  }
  if (!cfg.allow_claudebot) {
    content += `User-agent: Claude-Web\nDisallow: /\n\n`;
    content += `User-agent: ClaudeBot\nDisallow: /\n\n`;
  }
  if (!cfg.allow_perplexitybot) {
    content += `User-agent: PerplexityBot\nDisallow: /\n\n`;
  }
  if (!cfg.allow_googlebot) {
    content += `User-agent: Googlebot\nDisallow: /\n\n`;
  }
  if (!cfg.allow_bingbot) {
    content += `User-agent: Bingbot\nDisallow: /\n\n`;
  }
  
  content += `# Sitemap\n`;
  content += `Sitemap: ${siteUrl}/sitemap.xml\n`;
  
  return content;
}

const robotsPreview = generateRobotsPreview(config);
---

<AdminLayout title="Robots.txt 编辑器" activePage="seo">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
        <a href="/admin/seo" class="hover:text-primary-600">SEO 工具</a>
        <span>/</span>
        <span>Robots.txt</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Robots.txt 编辑器</h2>
      <p class="text-gray-600 mt-1">控制搜索引擎和 AI 机器人如何爬取您的网站</p>
    </div>
    <a 
      href="/robots.txt"
      target="_blank"
      class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
      查看 robots.txt
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Configuration -->
    <div class="space-y-6">
      <!-- AI Crawler Settings -->
      <form id="robots-form" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
          <h3 class="font-semibold text-gray-900">AI 爬虫设置</h3>
          <p class="text-sm text-gray-500 mt-1">控制哪些 AI 机器人可以访问您的内容</p>
        </div>

        <div class="p-6 space-y-4">
          <div class="flex items-center justify-between py-2">
            <div>
              <p class="text-sm font-medium text-gray-900">GPTBot (OpenAI)</p>
              <p class="text-xs text-gray-500">ChatGPT 和 OpenAI 产品</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="allow_gptbot" checked={config.allow_gptbot} class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-2">
            <div>
              <p class="text-sm font-medium text-gray-900">ClaudeBot (Anthropic)</p>
              <p class="text-xs text-gray-500">Claude AI 助手</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="allow_claudebot" checked={config.allow_claudebot} class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-2">
            <div>
              <p class="text-sm font-medium text-gray-900">PerplexityBot</p>
              <p class="text-xs text-gray-500">Perplexity AI 搜索</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="allow_perplexitybot" checked={config.allow_perplexitybot} class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>

          <hr class="my-4" />

          <div class="flex items-center justify-between py-2">
            <div>
              <p class="text-sm font-medium text-gray-900">Googlebot</p>
              <p class="text-xs text-gray-500">Google 搜索爬虫</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="allow_googlebot" checked={config.allow_googlebot} class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-2">
            <div>
              <p class="text-sm font-medium text-gray-900">Bingbot</p>
              <p class="text-xs text-gray-500">Bing 搜索爬虫</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="allow_bingbot" checked={config.allow_bingbot} class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
        </div>

        <!-- Disallow Paths -->
        <div class="px-6 py-4 border-t border-gray-100">
          <h4 class="text-sm font-medium text-gray-900 mb-3">禁止路径</h4>
          <div id="disallow-paths" class="space-y-2">
            {(config.disallow_paths || []).map((path: string, i: number) => (
              <div class="flex gap-2 path-item">
                <input 
                  type="text" 
                  name="disallow_paths[]"
                  value={path}
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  placeholder="/path-to-block"
                />
                <button type="button" class="remove-path-btn px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            ))}
          </div>
          <button type="button" id="add-path-btn" class="mt-3 text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            添加路径
          </button>
        </div>

        <div class="px-6 py-4 bg-gray-50 flex justify-end">
          <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
            保存配置
          </button>
        </div>
      </form>
    </div>

    <!-- Preview -->
    <div class="space-y-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900">robots.txt 预览</h3>
          <button id="copy-btn" class="text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            复制
          </button>
        </div>
        <div class="p-4">
          <pre id="robots-preview" class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono whitespace-pre-wrap">{robotsPreview}</pre>
        </div>
      </div>

      <!-- GEO Tips -->
      <div class="bg-green-50 rounded-xl p-6">
        <h3 class="font-semibold text-green-900 mb-3">GEO 优化提示</h3>
        <ul class="space-y-2 text-sm text-green-800">
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>允许 AI 爬虫帮助您的内容出现在 AI 驱动的搜索结果中</span>
          </li>
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>GPTBot 为 ChatGPT 浏览提供支持，有利于品牌曝光</span>
          </li>
          <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>PerplexityBot 帮助您的内容出现在 Perplexity AI 回答中</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ apiUrl, siteUrl }}>
  const form = document.getElementById('robots-form');
  const preview = document.getElementById('robots-preview');

  function generatePreview() {
    const formData = new FormData(form);
    const cfg = {
      allow_gptbot: formData.get('allow_gptbot') === 'on',
      allow_claudebot: formData.get('allow_claudebot') === 'on',
      allow_perplexitybot: formData.get('allow_perplexitybot') === 'on',
      allow_googlebot: formData.get('allow_googlebot') === 'on',
      allow_bingbot: formData.get('allow_bingbot') === 'on',
      disallow_paths: formData.getAll('disallow_paths[]').filter(p => p)
    };

    let content = `# robots.txt for ${siteUrl}\n`;
    content += `# Generated by DTC Admin\n\n`;
    
    content += `User-agent: *\n`;
    cfg.disallow_paths.forEach(path => {
      content += `Disallow: ${path}\n`;
    });
    content += `Allow: /\n\n`;
    
    if (!cfg.allow_gptbot) content += `User-agent: GPTBot\nDisallow: /\n\n`;
    if (!cfg.allow_claudebot) {
      content += `User-agent: Claude-Web\nDisallow: /\n\n`;
      content += `User-agent: ClaudeBot\nDisallow: /\n\n`;
    }
    if (!cfg.allow_perplexitybot) content += `User-agent: PerplexityBot\nDisallow: /\n\n`;
    if (!cfg.allow_googlebot) content += `User-agent: Googlebot\nDisallow: /\n\n`;
    if (!cfg.allow_bingbot) content += `User-agent: Bingbot\nDisallow: /\n\n`;
    
    content += `# Sitemap\nSitemap: ${siteUrl}/sitemap.xml\n`;
    
    preview.textContent = content;
  }

  // Update preview on any change
  form?.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('change', generatePreview);
  });

  // Add path button
  document.getElementById('add-path-btn')?.addEventListener('click', () => {
    const container = document.getElementById('disallow-paths');
    const newItem = document.createElement('div');
    newItem.className = 'flex gap-2 path-item';
    newItem.innerHTML = `
      <input 
        type="text" 
        name="disallow_paths[]"
        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
        placeholder="/path-to-block"
      />
      <button type="button" class="remove-path-btn px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>
    `;
    container?.appendChild(newItem);
    attachRemoveListeners();
    generatePreview();
  });

  function attachRemoveListeners() {
    document.querySelectorAll('.remove-path-btn').forEach(btn => {
      btn.onclick = () => {
        btn.closest('.path-item')?.remove();
        generatePreview();
      };
    });
  }
  attachRemoveListeners();

  // Copy button
  document.getElementById('copy-btn')?.addEventListener('click', () => {
    navigator.clipboard.writeText(preview?.textContent || '');
    alert('已复制到剪贴板！');
  });

  // Form submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    const data = {
      allow_gptbot: formData.get('allow_gptbot') === 'on',
      allow_claudebot: formData.get('allow_claudebot') === 'on',
      allow_perplexitybot: formData.get('allow_perplexitybot') === 'on',
      allow_googlebot: formData.get('allow_googlebot') === 'on',
      allow_bingbot: formData.get('allow_bingbot') === 'on',
      disallow_paths: formData.getAll('disallow_paths[]').filter(p => p)
    };

    try {
      const response = await fetch(`${apiUrl}/api/seo/robots/config`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('配置保存成功');
      } else {
        alert('保存配置失败');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('保存配置失败');
    }
  });
</script>
