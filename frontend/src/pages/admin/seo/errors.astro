---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const errors: any[] = [];
const unresolvedErrors: any[] = [];
const resolvedErrors: any[] = [];
const totalHits = 0;
---

<AdminLayout title="404 错误" activePage="seo">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
        <a href="/admin/seo" class="hover:text-primary-600">SEO 工具</a>
        <span>/</span>
        <span>404 错误</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">404 错误监控</h2>
      <p class="text-gray-600 mt-1">跟踪并修复网站上的断开链接</p>
    </div>
    <button 
      id="clear-resolved-btn"
      class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      清除已解决
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">总错误数</p>
      <p class="text-2xl font-bold text-gray-900 mt-1" id="total-errors">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">未解决</p>
      <p class="text-2xl font-bold text-red-600 mt-1" id="unresolved-errors">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">已解决</p>
      <p class="text-2xl font-bold text-green-600 mt-1" id="resolved-errors">0</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <p class="text-sm font-medium text-gray-500">总访问数</p>
      <p class="text-2xl font-bold text-blue-600 mt-1" id="total-hits">0</p>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="flex border-b border-gray-100">
      <button class="tab-btn px-6 py-3 text-sm font-medium text-primary-600 border-b-2 border-primary-600" data-tab="unresolved">
        未解决 ({unresolvedErrors.length})
      </button>
      <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="resolved">
        已解决 ({resolvedErrors.length})
      </button>
      <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="all">
        全部 ({errors?.length || 0})
      </button>
    </div>
  </div>

  <!-- Errors Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">路径</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">来源</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">访问数</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">首次出现</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后出现</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="errors-tbody">
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-gray-500">加载中...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>

<script>
  const tbody = document.getElementById('errors-tbody');
  const totalEl = document.getElementById('total-errors');
  const unresolvedEl = document.getElementById('unresolved-errors');
  const resolvedEl = document.getElementById('resolved-errors');
  const hitsEl = document.getElementById('total-hits');

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function fmtDate(s) {
    try {
      return new Date(s).toLocaleDateString();
    } catch {
      return '';
    }
  }

  function hitClass(hit) {
    const h = Number(hit) || 0;
    if (h > 50) return 'bg-red-100 text-red-800';
    if (h > 10) return 'bg-yellow-100 text-yellow-800';
    return 'bg-gray-100 text-gray-800';
  }

  function updateTabLabels(total, unresolved, resolved) {
    const tabs = Array.from(document.querySelectorAll('.tab-btn'));
    tabs.forEach((btn) => {
      const tab = btn.dataset.tab;
      if (tab === 'unresolved') btn.textContent = `未解决 (${unresolved})`;
      if (tab === 'resolved') btn.textContent = `已解决 (${resolved})`;
      if (tab === 'all') btn.textContent = `全部 (${total})`;
    });
  }

  function renderRows(errors) {
    if (!tbody) return;
    if (!Array.isArray(errors) || errors.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-12 text-center text-gray-500">
            <svg class="w-12 h-12 text-green-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            未记录 404 错误
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = errors
      .map((e) => {
        const resolved = !!e.is_resolved;
        const statusBadge = resolved
          ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">已解决</span>'
          : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">未解决</span>';

        const actions = resolved
          ? `<button class="text-yellow-600 hover:text-yellow-700 text-sm font-medium mark-unresolved-btn" data-id="${escapeHtml(e.id)}">重新打开</button>`
          : `
            <a href="/admin/seo/redirects?source=${encodeURIComponent(e.request_path || '')}" class="text-primary-600 hover:text-primary-700 text-sm font-medium mr-3">创建重定向</a>
            <button class="text-green-600 hover:text-green-700 text-sm font-medium mark-resolved-btn" data-id="${escapeHtml(e.id)}">标记已解决</button>
          `;

        return `
          <tr class="error-row hover:bg-gray-50" data-id="${escapeHtml(e.id)}" data-resolved="${resolved ? 'true' : 'false'}">
            <td class="px-6 py-4"><code class="text-sm bg-gray-100 px-2 py-1 rounded">${escapeHtml(e.request_path)}</code></td>
            <td class="px-6 py-4"><p class="text-sm text-gray-500 truncate max-w-xs" title="${escapeHtml(e.referrer || 'Direct')}">${escapeHtml(e.referrer || 'Direct')}</p></td>
            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${hitClass(e.hit_count)}">${escapeHtml(e.hit_count || 0)}</span></td>
            <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(fmtDate(e.first_seen_at))}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(fmtDate(e.last_seen_at))}</td>
            <td class="px-6 py-4">${statusBadge}</td>
            <td class="px-6 py-4 text-right">${actions}</td>
          </tr>
        `;
      })
      .join('');
  }

  function applyTabFilter(tab) {
    document.querySelectorAll('.error-row').forEach((row) => {
      const isResolved = row.dataset.resolved === 'true';
      let show = true;
      if (tab === 'unresolved') show = !isResolved;
      else if (tab === 'resolved') show = isResolved;
      row.style.display = show ? '' : 'none';
    });
  }

  function bindHandlers() {
    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab || 'unresolved';
        document.querySelectorAll('.tab-btn').forEach((b) => {
          b.classList.remove('text-primary-600', 'border-b-2', 'border-primary-600');
          b.classList.add('text-gray-500');
        });
        btn.classList.add('text-primary-600', 'border-b-2', 'border-primary-600');
        btn.classList.remove('text-gray-500');
        applyTabFilter(tab);
      });
    });

    document.querySelectorAll('.mark-resolved-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (!id) return;
        try {
          const response = await fetch(`/api/admin/seo/errors/${encodeURIComponent(id)}/resolve`, { method: 'POST' });
          if (response.ok) window.location.reload();
          else alert('更新状态失败');
        } catch (e) {
          console.error('Error:', e);
          alert('更新状态失败');
        }
      });
    });

    document.querySelectorAll('.mark-unresolved-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (!id) return;
        try {
          const response = await fetch(`/api/admin/seo/errors/${encodeURIComponent(id)}/reopen`, { method: 'POST' });
          if (response.ok) window.location.reload();
          else alert('更新状态失败');
        } catch (e) {
          console.error('Error:', e);
          alert('更新状态失败');
        }
      });
    });
  }

  async function load() {
    if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">加载中...</td></tr>`;

    try {
      const response = await fetch('/api/admin/seo/errors');
      const json = await response.json().catch(() => null);
      const errors = Array.isArray(json?.errors) ? json.errors : [];

      const unresolved = errors.filter((e) => !e.is_resolved);
      const resolved = errors.filter((e) => e.is_resolved);
      const hits = errors.reduce((sum, e) => sum + (Number(e.hit_count) || 0), 0);

      if (totalEl) totalEl.textContent = String(errors.length);
      if (unresolvedEl) unresolvedEl.textContent = String(unresolved.length);
      if (resolvedEl) resolvedEl.textContent = String(resolved.length);
      if (hitsEl) hitsEl.textContent = String(hits);
      updateTabLabels(errors.length, unresolved.length, resolved.length);

      renderRows(errors);
      bindHandlers();

      // Default tab: unresolved
      applyTabFilter('unresolved');
    } catch (e) {
      console.error('Failed to load 404 errors:', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-red-600">加载失败</td></tr>`;
    }
  }

  document.getElementById('clear-resolved-btn')?.addEventListener('click', async () => {
    if (!confirm('确定要删除所有已解决的 404 错误吗？')) return;
    try {
      const response = await fetch(`/api/admin/seo/errors/clear-resolved`, { method: 'DELETE' });
      if (response.ok) window.location.reload();
      else alert('清除已解决错误失败');
    } catch (e) {
      console.error('Error:', e);
      alert('清除已解决错误失败');
    }
  });

  load();
</script>
