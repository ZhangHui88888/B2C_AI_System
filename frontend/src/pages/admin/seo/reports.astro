---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

const { data: reportConfigs } = await supabase
  .from('automated_reports')
  .select('*')
  .order('created_at', { ascending: false });

const { data: reportHistory } = await supabase
  .from('report_history')
  .select('*')
  .order('generated_at', { ascending: false })
  .limit(20);

const configs = reportConfigs || [];
const history = reportHistory || [];

const frequencyLabels: Record<string, string> = {
  daily: 'Daily',
  weekly: 'Weekly',
  monthly: 'Monthly',
};
---

<AdminLayout title="SEO æŠ¥å‘Š" activePage="seo">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">è‡ªåŠ¨åŒ– SEO æŠ¥å‘Š</h2>
      <p class="text-gray-600 mt-1">é…ç½®å’Œè®¡åˆ’è‡ªåŠ¨åŒ– SEO æŠ¥å‘Š</p>
    </div>
    <div class="flex gap-3">
      <button
        id="generate-now-btn"
        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
      >
        ç«‹å³ç”Ÿæˆ
      </button>
      <button
        id="new-report-btn"
        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium"
      >
        æ–°æŠ¥å‘Šé…ç½®
      </button>
    </div>
  </div>

  <!-- Report Configurations -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="px-6 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900">æŠ¥å‘Šé…ç½®</h3>
    </div>
    <div class="divide-y divide-gray-100">
      {configs.length > 0 ? (
        configs.map((config: any) => (
          <div class="px-6 py-4 flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900">{config.report_name}</p>
              <p class="text-sm text-gray-500">
                {frequencyLabels[config.schedule_frequency] || config.schedule_frequency} â€¢ 
                {config.recipients?.length || 0} ä¸ªæ”¶ä»¶äºº
              </p>
            </div>
            <div class="flex items-center gap-4">
              <span class={`text-xs px-2 py-1 rounded ${config.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>
                {config.is_active ? 'æ´»è·ƒ' : 'æš‚åœ'}
              </span>
              <button
                class="text-sm text-primary-600 hover:text-primary-700"
                data-id={config.id}
                onclick="editConfig(this)"
              >
                ç¼–è¾‘
              </button>
              <button
                class="text-sm text-red-600 hover:text-red-700"
                data-id={config.id}
                onclick="deleteConfig(this)"
              >åˆ é™¤
              </button>
            </div>
          </div>
        ))
      ) : (
        <div class="px-6 py-12 text-center text-gray-500">
          æš‚æ— æŠ¥å‘Šé…ç½®ã€‚åˆ›å»ºä¸€ä¸ªå¼€å§‹ã€‚
        </div>
      )}
    </div>
  </div>

  <!-- Report History -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900">æŠ¥å‘Šå†å²</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¥æœŸ</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SEO åˆ†æ•°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¡µé¢æ•°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é—®é¢˜æ•°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {history.length > 0 ? (
            history.map((report: any) => (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <p class="text-sm text-gray-900">{new Date(report.generated_at).toLocaleDateString()}</p>
                  <p class="text-xs text-gray-500">{new Date(report.generated_at).toLocaleTimeString()}</p>
                </td>
                <td class="px-6 py-4">
                  <span class={`text-lg font-bold ${
                    report.overall_seo_score >= 80 ? 'text-green-600' :
                    report.overall_seo_score >= 60 ? 'text-blue-600' :
                    report.overall_seo_score >= 40 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {report.overall_seo_score}
                  </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-600">{report.total_pages_analyzed}</td>
                <td class="px-6 py-4">
                  <span class={`text-sm ${report.issues_found > 0 ? 'text-red-600' : 'text-green-600'}`}>
                    {report.issues_found}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <span class={`text-xs px-2 py-1 rounded ${
                    report.delivery_status === 'sent' ? 'bg-green-100 text-green-700' :
                    report.delivery_status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'
                  }`}>
                    {report.delivery_status}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <button
                    class="text-sm text-primary-600 hover:text-primary-700"
                    data-id={report.id}
                    onclick="viewReport(this)"
                  >
                    æŸ¥çœ‹
                  </button>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                æš‚æ— ç”Ÿæˆçš„æŠ¥å‘Šã€‚
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- New Report Modal -->
  <div id="new-report-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">æ–°æŠ¥å‘Šé…ç½®</h3>
        <button onclick="closeModal('new-report-modal')" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="new-report-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æŠ¥å‘Šåç§°</label>
          <input type="text" name="report_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" placeholder="æ¯å‘¨ SEO æ‘˜è¦" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æŠ¥å‘Šç±»å‹</label>
          <select name="report_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="weekly_summary">æ¯å‘¨æ‘˜è¦</option>
            <option value="monthly_audit">æœˆåº¦å®¡è®¡</option>
            <option value="keyword_tracking">å…³é”®è¯è·Ÿè¸ª</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¢‘ç‡</label>
          <select name="schedule_frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="daily">æ¯æ—¥</option>
            <option value="weekly" selected>æ¯å‘¨</option>
            <option value="monthly">æ¯æœˆ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ”¶ä»¶äººï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input type="text" name="recipients" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="email1@example.com, email2@example.com" />
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeModal('new-report-modal')" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
            å–æ¶ˆ
          </button>
          <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">åˆ›å»º
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Report Modal -->
  <div id="view-report-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white">
        <h3 class="font-semibold text-gray-900">æŠ¥å‘Šè¯¦æƒ…</h3>
        <button onclick="closeModal('view-report-modal')" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="report-content" class="p-6">
        åŠ è½½ä¸­...
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  document.getElementById('new-report-btn')?.addEventListener('click', () => {
    const modal = document.getElementById('new-report-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  });

  document.getElementById('new-report-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);

    const recipients = (formData.get('recipients') as string || '')
      .split(',')
      .map(e => e.trim())
      .filter(e => e);

    try {
      const response = await fetch('/api/seo-reports/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          report_name: formData.get('report_name'),
          report_type: formData.get('report_type'),
          schedule_frequency: formData.get('schedule_frequency'),
          recipients,
        }),
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'åˆ›å»ºæŠ¥å‘Šå¤±è´¥');
      }
    } catch (error) {
      alert('åˆ›å»ºæŠ¥å‘Šå¤±è´¥');
    }
  });

  document.getElementById('generate-now-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('generate-now-btn') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';

    try {
      const response = await fetch('/api/seo-reports/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          report_type: 'weekly_summary',
          include_sections: ['overview', 'rankings', 'issues', 'recommendations'],
        }),
      });

      if (response.ok) {
        alert('æŠ¥å‘Šå·²ç”Ÿæˆï¼æ­£åœ¨åˆ·æ–°...');
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
      }
    } catch (error) {
      alert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ç«‹å³ç”Ÿæˆ';
    }
  });

  async function viewReport(btn: HTMLElement) {
    const id = btn.dataset.id;
    const modal = document.getElementById('view-report-modal');
    const content = document.getElementById('report-content');

    if (!modal || !content) return;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    content.innerHTML = '<div class="text-center py-8">åŠ è½½æŠ¥å‘Šä¸­...</div>';

    try {
      const response = await fetch(`/api/seo-reports/${id}`);
      const data = await response.json();

      if (response.ok && data.report_data) {
        const report = data.report_data;
        content.innerHTML = `
          <div class="space-y-6">
            ${report.overview ? `
              <div>
                <h4 class="font-medium text-gray-900 mb-3">Overview</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">SEO Score</p>
                    <p class="text-xl font-bold text-primary-600">${report.overview.average_seo_score}</p>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Index Rate</p>
                    <p class="text-xl font-bold text-green-600">${report.overview.index_rate}%</p>
                  </div>
                </div>
              </div>
            ` : ''}
            
            ${report.issues ? `
              <div>
                <h4 class="font-medium text-gray-900 mb-3">Issues Found (${report.issues.total})</h4>
                <ul class="space-y-2 text-sm">
                  ${report.issues.orphan_pages ? `<li>ğŸ”— ${report.issues.orphan_pages} orphan pages</li>` : ''}
                  ${report.issues.not_indexed ? `<li>ğŸ” ${report.issues.not_indexed} pages not indexed</li>` : ''}
                  ${report.issues.low_eeat ? `<li>â­ ${report.issues.low_eeat} low E-E-A-T scores</li>` : ''}
                </ul>
              </div>
            ` : ''}
            
            ${report.recommendations?.length ? `
              <div>
                <h4 class="font-medium text-gray-900 mb-3">Recommendations</h4>
                <ul class="space-y-2">
                  ${report.recommendations.map((r: string) => `
                    <li class="text-sm p-2 bg-blue-50 text-blue-700 rounded">${r}</li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
      } else {
        content.innerHTML = '<div class="text-center py-8 text-red-500">åŠ è½½æŠ¥å‘Šå¤±è´¥</div>';
      }
    } catch (error) {
      content.innerHTML = '<div class="text-center py-8 text-red-500">åŠ è½½æŠ¥å‘Šå¤±è´¥</div>';
    }
  }

  async function deleteConfig(btn: HTMLElement) {
    const id = btn.dataset.id;
    if (!confirm('åˆ é™¤æ­¤æŠ¥å‘Šé…ç½®ï¼Ÿ')) return;

    try {
      const response = await fetch(`/api/seo-reports/config/${id}`, { method: 'DELETE' });
      if (response.ok) {
        window.location.reload();
      }
    } catch (error) {
      console.error('Failed to delete config:', error);
    }
  }

  function editConfig(btn: HTMLElement) {
    alert('ç¼–è¾‘åŠŸèƒ½å³å°†æ¨å‡ºï¼');
  }

  function closeModal(modalId: string) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  (window as any).viewReport = viewReport;
  (window as any).deleteConfig = deleteConfig;
  (window as any).editConfig = editConfig;
  (window as any).closeModal = closeModal;
</script>
