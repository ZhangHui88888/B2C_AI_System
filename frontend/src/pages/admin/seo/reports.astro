---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const configs: any[] = [];
const history: any[] = [];

const frequencyLabels: Record<string, string> = {};
---

<AdminLayout title="SEO æŠ¥å‘Š" activePage="seo">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">è‡ªåŠ¨åŒ– SEO æŠ¥å‘Š</h2>
      <p class="text-gray-600 mt-1">é…ç½®å’Œè®¡åˆ’è‡ªåŠ¨åŒ– SEO æŠ¥å‘Š</p>
    </div>
    <div class="flex gap-3">
      <button
        id="generate-now-btn"
        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
      >
        ç«‹å³ç”Ÿæˆ
      </button>
      <button
        id="new-report-btn"
        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium"
      >
        æ–°æŠ¥å‘Šé…ç½®
      </button>
    </div>
  </div>

  <!-- Report Configurations -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="px-6 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900">æŠ¥å‘Šé…ç½®</h3>
    </div>
    <div class="divide-y divide-gray-100" id="configs-list">
      <div class="px-6 py-12 text-center text-gray-500">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- Report History -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900">æŠ¥å‘Šå†å²</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¥æœŸ</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SEO åˆ†æ•°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¡µé¢æ•°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é—®é¢˜æ•°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="history-tbody">
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- New Report Modal -->
  <div id="new-report-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">æ–°æŠ¥å‘Šé…ç½®</h3>
        <button onclick="closeModal('new-report-modal')" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="new-report-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æŠ¥å‘Šåç§°</label>
          <input type="text" name="report_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" placeholder="æ¯å‘¨ SEO æ‘˜è¦" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æŠ¥å‘Šç±»å‹</label>
          <select name="report_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="weekly_summary">æ¯å‘¨æ‘˜è¦</option>
            <option value="monthly_audit">æœˆåº¦å®¡è®¡</option>
            <option value="keyword_tracking">å…³é”®è¯è·Ÿè¸ª</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¢‘ç‡</label>
          <select name="schedule_frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="daily">æ¯æ—¥</option>
            <option value="weekly" selected>æ¯å‘¨</option>
            <option value="monthly">æ¯æœˆ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ”¶ä»¶äººï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input type="text" name="recipients" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="email1@example.com, email2@example.com" />
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeModal('new-report-modal')" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
            å–æ¶ˆ
          </button>
          <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">åˆ›å»º
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Report Modal -->
  <div id="view-report-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white">
        <h3 class="font-semibold text-gray-900">æŠ¥å‘Šè¯¦æƒ…</h3>
        <button onclick="closeModal('view-report-modal')" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="report-content" class="p-6">
        åŠ è½½ä¸­...
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const configsList = document.getElementById('configs-list');
  const historyTbody = document.getElementById('history-tbody');

  const frequencyLabels = {
    daily: 'æ¯æ—¥',
    weekly: 'æ¯å‘¨',
    monthly: 'æ¯æœˆ',
  };

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function renderConfigs(configs) {
    if (!configsList) return;
    if (!Array.isArray(configs) || configs.length === 0) {
      configsList.innerHTML = '<div class="px-6 py-12 text-center text-gray-500">æš‚æ— æŠ¥å‘Šé…ç½®ã€‚åˆ›å»ºä¸€ä¸ªå¼€å§‹ã€‚</div>';
      return;
    }

    configsList.innerHTML = configs
      .map((config) => {
        const statusClass = config.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700';
        const statusText = config.is_active ? 'æ´»è·ƒ' : 'æš‚åœ';
        const freq = frequencyLabels[config.schedule_frequency] || config.schedule_frequency;
        const recipientsCount = Array.isArray(config.recipients) ? config.recipients.length : 0;
        return `
          <div class="px-6 py-4 flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900">${escapeHtml(config.report_name)}</p>
              <p class="text-sm text-gray-500">${escapeHtml(freq)} â€¢ ${escapeHtml(recipientsCount)} ä¸ªæ”¶ä»¶äºº</p>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-xs px-2 py-1 rounded ${statusClass}">${statusText}</span>
              <button class="text-sm text-primary-600 hover:text-primary-700" data-id="${escapeHtml(config.id)}" data-action="edit">ç¼–è¾‘</button>
              <button class="text-sm text-red-600 hover:text-red-700" data-id="${escapeHtml(config.id)}" data-action="delete">åˆ é™¤</button>
            </div>
          </div>
        `;
      })
      .join('');

    configsList.querySelectorAll('[data-action="delete"]').forEach((btn) => {
      btn.addEventListener('click', () => deleteConfig(btn));
    });
    configsList.querySelectorAll('[data-action="edit"]').forEach((btn) => {
      btn.addEventListener('click', () => editConfig(btn));
    });
  }

  function scoreColor(score) {
    const v = Number(score) || 0;
    if (v >= 80) return 'text-green-600';
    if (v >= 60) return 'text-blue-600';
    if (v >= 40) return 'text-yellow-600';
    return 'text-red-600';
  }

  function renderHistory(history) {
    if (!historyTbody) return;
    if (!Array.isArray(history) || history.length === 0) {
      historyTbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">æš‚æ— ç”Ÿæˆçš„æŠ¥å‘Šã€‚</td></tr>';
      return;
    }

    historyTbody.innerHTML = history
      .map((report) => {
        const dt = report.generated_at ? new Date(report.generated_at) : null;
        const dateStr = dt ? dt.toLocaleDateString() : '-';
        const timeStr = dt ? dt.toLocaleTimeString() : '';

        const deliveryClass = report.delivery_status === 'sent'
          ? 'bg-green-100 text-green-700'
          : report.delivery_status === 'pending'
            ? 'bg-yellow-100 text-yellow-700'
            : 'bg-gray-100 text-gray-700';

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4"><p class="text-sm text-gray-900">${escapeHtml(dateStr)}</p><p class="text-xs text-gray-500">${escapeHtml(timeStr)}</p></td>
            <td class="px-6 py-4"><span class="text-lg font-bold ${scoreColor(report.overall_seo_score)}">${escapeHtml(report.overall_seo_score)}</span></td>
            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(report.total_pages_analyzed)}</td>
            <td class="px-6 py-4"><span class="text-sm ${Number(report.issues_found) > 0 ? 'text-red-600' : 'text-green-600'}">${escapeHtml(report.issues_found)}</span></td>
            <td class="px-6 py-4"><span class="text-xs px-2 py-1 rounded ${deliveryClass}">${escapeHtml(report.delivery_status)}</span></td>
            <td class="px-6 py-4"><button class="text-sm text-primary-600 hover:text-primary-700" data-id="${escapeHtml(report.id)}" data-action="view">æŸ¥çœ‹</button></td>
          </tr>
        `;
      })
      .join('');

    historyTbody.querySelectorAll('[data-action="view"]').forEach((btn) => {
      btn.addEventListener('click', () => viewReport(btn));
    });
  }

  async function loadPageData() {
    try {
      const [cfgRes, histRes] = await Promise.all([
        fetch('/api/admin/seo-reports/config'),
        fetch('/api/admin/seo-reports/history?limit=20'),
      ]);

      const cfgJson = await cfgRes.json().catch(() => null);
      const histJson = await histRes.json().catch(() => null);

      renderConfigs(Array.isArray(cfgJson?.configs) ? cfgJson.configs : []);
      renderHistory(Array.isArray(histJson?.history) ? histJson.history : []);
    } catch (e) {
      console.error('Failed to load report page data:', e);
      if (configsList) configsList.innerHTML = '<div class="px-6 py-12 text-center text-red-600">åŠ è½½å¤±è´¥</div>';
      if (historyTbody) historyTbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-red-600">åŠ è½½å¤±è´¥</td></tr>';
    }
  }

  document.getElementById('new-report-btn')?.addEventListener('click', () => {
    const modal = document.getElementById('new-report-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  });

  document.getElementById('new-report-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);

    const recipients = (formData.get('recipients') as string || '')
      .split(',')
      .map(e => e.trim())
      .filter(e => e);

    try {
      const response = await fetch('/api/admin/seo-reports/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          report_name: formData.get('report_name'),
          report_type: formData.get('report_type'),
          schedule_frequency: formData.get('schedule_frequency'),
          recipients,
        }),
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'åˆ›å»ºæŠ¥å‘Šå¤±è´¥');
      }
    } catch (error) {
      alert('åˆ›å»ºæŠ¥å‘Šå¤±è´¥');
    }
  });

  document.getElementById('generate-now-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('generate-now-btn') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';

    try {
      const response = await fetch('/api/admin/seo-reports/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          report_type: 'weekly_summary',
          include_sections: ['overview', 'rankings', 'issues', 'recommendations'],
        }),
      });

      if (response.ok) {
        alert('æŠ¥å‘Šå·²ç”Ÿæˆï¼æ­£åœ¨åˆ·æ–°...');
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
      }
    } catch (error) {
      alert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ç«‹å³ç”Ÿæˆ';
    }
  });

  async function viewReport(btn: HTMLElement) {
    const id = btn.dataset.id;
    const modal = document.getElementById('view-report-modal');
    const content = document.getElementById('report-content');

    if (!modal || !content) return;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    content.innerHTML = '<div class="text-center py-8">åŠ è½½æŠ¥å‘Šä¸­...</div>';

    try {
      const response = await fetch(`/api/admin/seo-reports/${id}`);
      const data = await response.json();

      if (response.ok && data.report_data) {
        const report = data.report_data;
        content.innerHTML = `
          <div class="space-y-6">
            ${report.overview ? `
              <div>
                <h4 class="font-medium text-gray-900 mb-3">Overview</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">SEO Score</p>
                    <p class="text-xl font-bold text-primary-600">${report.overview.average_seo_score}</p>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Index Rate</p>
                    <p class="text-xl font-bold text-green-600">${report.overview.index_rate}%</p>
                  </div>
                </div>
              </div>
            ` : ''}
            
            ${report.issues ? `
              <div>
                <h4 class="font-medium text-gray-900 mb-3">Issues Found (${report.issues.total})</h4>
                <ul class="space-y-2 text-sm">
                  ${report.issues.orphan_pages ? `<li>ğŸ”— ${report.issues.orphan_pages} orphan pages</li>` : ''}
                  ${report.issues.not_indexed ? `<li>ğŸ” ${report.issues.not_indexed} pages not indexed</li>` : ''}
                  ${report.issues.low_eeat ? `<li>â­ ${report.issues.low_eeat} low E-E-A-T scores</li>` : ''}
                </ul>
              </div>
            ` : ''}
            
            ${report.recommendations?.length ? `
              <div>
                <h4 class="font-medium text-gray-900 mb-3">Recommendations</h4>
                <ul class="space-y-2">
                  ${report.recommendations.map((r: string) => `
                    <li class="text-sm p-2 bg-blue-50 text-blue-700 rounded">${r}</li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
      } else {
        content.innerHTML = '<div class="text-center py-8 text-red-500">åŠ è½½æŠ¥å‘Šå¤±è´¥</div>';
      }
    } catch (error) {
      content.innerHTML = '<div class="text-center py-8 text-red-500">åŠ è½½æŠ¥å‘Šå¤±è´¥</div>';
    }
  }

  async function deleteConfig(btn: HTMLElement) {
    const id = btn.dataset.id;
    if (!confirm('åˆ é™¤æ­¤æŠ¥å‘Šé…ç½®ï¼Ÿ')) return;

    try {
      const response = await fetch(`/api/admin/seo-reports/config/${id}`, { method: 'DELETE' });
      if (response.ok) {
        window.location.reload();
      }
    } catch (error) {
      console.error('Failed to delete config:', error);
    }
  }

  function editConfig(btn: HTMLElement) {
    alert('ç¼–è¾‘åŠŸèƒ½å³å°†æ¨å‡ºï¼');
  }

  function closeModal(modalId: string) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  (window as any).viewReport = viewReport;
  (window as any).deleteConfig = deleteConfig;
  (window as any).editConfig = editConfig;
  (window as any).closeModal = closeModal;

  loadPageData();
</script>
