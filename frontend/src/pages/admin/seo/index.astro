---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
const seoStats = [
  {
    id: 'meta_complete',
    label: '已有 Meta 的页面',
    value: 0,
    total: 0,
    percentage: 0,
    color: 'green',
    icon: 'check',
  },
  {
    id: 'meta_missing',
    label: '缺少 Meta',
    value: 0,
    color: 'green',
    icon: 'alert',
  },
  {
    id: 'redirects',
    label: '活跃重定向',
    value: 0,
    color: 'blue',
    icon: 'redirect',
  },
  {
    id: 'errors_404',
    label: '404 错误',
    value: 0,
    color: 'green',
    icon: 'error',
  },
];

const issues: any[] = [];
const errors404: any[] = [];
---

<AdminLayout title="SEO 工具" activePage="seo">
  <!-- Header -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">SEO 仪表盘</h2>
    <p class="text-gray-600 mt-1">监控和优化网站的搜索引擎表现</p>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    {seoStats.map((stat) => (
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">{stat.label}</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">
              <span id={`stat-${stat.id}`}>{stat.value}</span>
              {stat.total !== undefined && <span class="text-sm text-gray-500">/<span id="stat-total">{stat.total}</span></span>}
            </p>
            {stat.percentage !== undefined && (
              <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                <div 
                  class={`h-2 rounded-full ${stat.percentage >= 80 ? 'bg-green-500' : stat.percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'}`}
                  style={`width: ${stat.percentage}%`}
                  id="stat-meta-progress"
                />
              </div>
            )}
          </div>
          <div class={`w-12 h-12 rounded-lg flex items-center justify-center ${
            stat.color === 'green' ? 'bg-green-50' : 
            stat.color === 'red' ? 'bg-red-50' : 
            stat.color === 'yellow' ? 'bg-yellow-50' : 'bg-blue-50'
          }`}>
            {stat.icon === 'check' && (
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            )}
            {stat.icon === 'alert' && (
              <svg class={`w-6 h-6 ${stat.color === 'red' ? 'text-red-600' : 'text-green-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            )}
            {stat.icon === 'redirect' && (
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            )}
            {stat.icon === 'error' && (
              <svg class={`w-6 h-6 ${stat.color === 'yellow' ? 'text-yellow-600' : 'text-green-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
            )}
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- Quick Actions Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Page SEO -->
    <a href="/admin/seo/meta" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">Meta 标签编辑器</h3>
          <p class="text-sm text-gray-500">编辑标题、描述和 OG 标签</p>
        </div>
      </div>
    </a>

    <!-- Redirects -->
    <a href="/admin/seo/redirects" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">URL 重定向</h3>
          <p class="text-sm text-gray-500">管理 301/302 重定向</p>
        </div>
      </div>
    </a>

    <!-- 404 Errors -->
    <a href="/admin/seo/errors" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-red-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">404 错误</h3>
          <p class="text-sm text-gray-500">监控和修复断开的链接</p>
        </div>
      </div>
    </a>

    <!-- Sitemap -->
    <a href="/admin/seo/sitemap" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">站点地图</h3>
          <p class="text-sm text-gray-500">配置站点地图设置</p>
        </div>
      </div>
    </a>

    <!-- Robots.txt -->
    <a href="/admin/seo/robots" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-yellow-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">Robots.txt</h3>
          <p class="text-sm text-gray-500">编辑 robots.txt 规则</p>
        </div>
      </div>
    </a>

    <!-- Content Analysis -->
    <a href="/admin/seo/analysis" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-indigo-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">内容分析</h3>
          <p class="text-sm text-gray-500">SEO 评分和可读性</p>
        </div>
      </div>
    </a>

    <!-- Advanced SEO Tools -->
    <a href="/admin/seo/advanced" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">高级 SEO</h3>
          <p class="text-sm text-gray-500">E-E-A-T、关键词、索引状态</p>
        </div>
      </div>
    </a>

    <!-- Keyword Research -->
    <a href="/admin/seo/keywords" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">关键词</h3>
          <p class="text-sm text-gray-500">研究和跟踪排名</p>
        </div>
      </div>
    </a>

    <!-- SEO Reports -->
    <a href="/admin/seo/reports" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-teal-50 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">SEO 报告</h3>
          <p class="text-sm text-gray-500">自动化报告调度</p>
        </div>
      </div>
    </a>
  </div>

  <!-- Issues and Recommendations -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- SEO Issues -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100">
        <h3 class="font-semibold text-gray-900">SEO 问题</h3>
      </div>
      <div class="p-6">
        {issues.length > 0 ? (
          <div class="space-y-3">
            {issues.map((issue) => (
              <div class={`flex items-start gap-3 p-3 rounded-lg ${
                issue.type === 'error' ? 'bg-red-50' : 
                issue.type === 'warning' ? 'bg-yellow-50' : 'bg-blue-50'
              }`}>
                {issue.type === 'error' && (
                  <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )}
                {issue.type === 'warning' && (
                  <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                )}
                {issue.type === 'info' && (
                  <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )}
                <span class={`text-sm ${
                  issue.type === 'error' ? 'text-red-700' : 
                  issue.type === 'warning' ? 'text-yellow-700' : 'text-blue-700'
                }`}>{issue.message}</span>
              </div>
            ))}
          </div>
        ) : (
          <div class="text-center py-8">
            <svg class="w-12 h-12 text-green-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-gray-500">未发现 SEO 问题！</p>
          </div>
        )}
      </div>
    </div>

    <!-- Recent 404 Errors -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">最近 404 错误</h3>
        <a href="/admin/seo/errors" class="text-sm text-primary-600 hover:text-primary-700">查看全部 →</a>
      </div>
      <div class="divide-y divide-gray-100" id="recent-404">
        <div class="px-6 py-8 text-center text-gray-500">加载中...</div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  function createRedirect(btn: HTMLElement) {
    const path = btn.dataset.path;
    if (path) {
      window.location.href = `/admin/seo/redirects?source=${encodeURIComponent(path)}`;
    }
  }
  // Make function available globally
  (window as any).createRedirect = createRedirect;

  async function loadSeoOverview() {
    try {
      const res = await fetch('/api/admin/seo/overview');
      const json = await res.json().catch(() => null);
      if (!res.ok || !json?.success) return;
      const s = json.stats || {};

      const total = Number(s.totalProducts) || 0;
      const complete = Number(s.productsWithMeta) || 0;
      const missing = Number(s.productsWithoutMeta) || 0;
      const redirects = Number(s.totalRedirects) || 0;
      const errors = Number(s.total404Errors) || 0;

      const percent = total > 0 ? Math.round((complete / total) * 100) : 0;

      const totalEl = document.getElementById('stat-total');
      if (totalEl) totalEl.textContent = String(total);

      const completeEl = document.getElementById('stat-meta_complete');
      if (completeEl) completeEl.textContent = String(complete);

      const missingEl = document.getElementById('stat-meta_missing');
      if (missingEl) missingEl.textContent = String(missing);

      const redirectsEl = document.getElementById('stat-redirects');
      if (redirectsEl) redirectsEl.textContent = String(redirects);

      const errorsEl = document.getElementById('stat-errors_404');
      if (errorsEl) errorsEl.textContent = String(errors);

      const bar = document.getElementById('stat-meta-progress');
      if (bar) {
        bar.style.width = `${percent}%`;
        bar.className = `h-2 rounded-full ${percent >= 80 ? 'bg-green-500' : percent >= 50 ? 'bg-yellow-500' : 'bg-red-500'}`;
      }
    } catch {
      // ignore
    }
  }

  async function loadRecent404() {
    const container = document.getElementById('recent-404');
    if (!container) return;

    try {
      const res = await fetch('/api/admin/seo/errors');
      const json = await res.json().catch(() => null);
      const errors = Array.isArray(json?.errors) ? json.errors : [];
      const top = errors.filter((e) => !e.is_resolved).slice(0, 5);

      if (top.length === 0) {
        container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500">未记录 404 错误</div>';
        return;
      }

      container.innerHTML = top
        .map((e) => {
          const path = e.request_path || '';
          const hits = e.hit_count || 0;
          return `
            <div class="px-6 py-3 flex items-center justify-between">
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-gray-900 truncate">${String(path).replaceAll('<', '&lt;').replaceAll('>', '&gt;')}</p>
                <p class="text-xs text-gray-500">${hits} 次访问</p>
              </div>
              <button class="text-xs text-primary-600 hover:text-primary-700 whitespace-nowrap ml-4" data-path="${String(path).replaceAll('"', '&quot;')}" onclick="createRedirect(this)">
                创建重定向
              </button>
            </div>
          `;
        })
        .join('');
    } catch {
      container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500">加载失败</div>';
    }
  }

  loadSeoOverview();
  loadRecent404();
</script>
