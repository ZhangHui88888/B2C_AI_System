---
import Layout from '@layouts/Layout.astro';
import BreadcrumbSchema from '@components/seo/BreadcrumbSchema.astro';
import SSLBadge from '@components/trust/SSLBadge.astro';
import SocialLinks from '@components/trust/SocialLinks.astro';
import { fetchSiteConfig } from '@lib/site-config';

const siteName = import.meta.env.PUBLIC_SITE_NAME || 'DTC Store';
let siteUrl = 'https://example.com';
try {
  siteUrl = new URL(Astro.request.url).origin;
} catch {}

const siteConfig = await fetchSiteConfig(Astro.request);
const brand = siteConfig?.brand;
const contactInfo = (brand?.contact_info as any) || {};
const socialLinks = (brand?.social_links as any) || {};

const breadcrumbItems = [
  { name: 'Home', url: siteUrl },
  { name: 'Contact', url: new URL('/contact', siteUrl).toString() },
];
---

<Layout title="Contact" description={`Contact ${siteName} support.`}>
  <Fragment slot="head">
    <BreadcrumbSchema items={breadcrumbItems} />
  </Fragment>

  <main class="container-custom">
    <section class="section">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div>
          <h1>Contact</h1>
          <p class="mt-3 text-gray-600 max-w-2xl">
            For order questions, returns, or product info, send us a message. We typically respond within 1-2 business days.
          </p>
        </div>
        <SSLBadge />
      </div>

      <div class="mt-10 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-7">
          <div class="card p-5">
            <div class="font-semibold text-gray-900">Send a message</div>
            <form id="contact-form" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium text-gray-900">Name</label>
                <input id="ct-name" class="input mt-2" type="text" autocomplete="name" required />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-900">Email</label>
                <input id="ct-email" class="input mt-2" type="email" autocomplete="email" required />
              </div>
              <div class="sm:col-span-2">
                <label class="text-sm font-medium text-gray-900">Message</label>
                <textarea id="ct-message" class="input mt-2" rows={6} required></textarea>
              </div>
              <div class="sm:col-span-2">
                <button class="btn-primary py-2 px-4 text-sm" type="submit">Send</button>
              </div>
            </form>

            <div id="contact-alert" class="hidden mt-6 card p-4 border border-amber-200 bg-amber-50 text-amber-900"></div>
          </div>
        </div>

        <aside class="lg:col-span-5">
          <div class="card p-5 sticky top-24">
            <div class="font-semibold text-gray-900">Support details</div>
            <div class="mt-4 space-y-2 text-sm text-gray-700">
              <div><span class="text-gray-500">Email:</span> {contactInfo.support_email || contactInfo.email || 'support@example.com'}</div>
              <div><span class="text-gray-500">Phone:</span> {contactInfo.phone || '+1 (555) 010-1234'}</div>
              <div><span class="text-gray-500">Address:</span> {contactInfo.address || '123 Market Street, Suite 5, San Francisco, CA'}</div>
              {contactInfo.hours && (
                <div><span class="text-gray-500">Hours:</span> {contactInfo.hours}</div>
              )}
            </div>

            <div class="mt-6">
              <div class="text-sm font-semibold text-gray-900">Follow us</div>
              <div class="mt-2">
                <SocialLinks links={socialLinks} />
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 gap-2 text-sm">
              <a class="btn-outline py-2 text-center" href="/order">Order lookup</a>
              <a class="btn-outline py-2 text-center" href="/returns">Returns</a>
              <a class="btn-outline py-2 text-center" href="/shipping">Shipping</a>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <script type="module">
    import { api } from '@lib/api';

    const form = document.getElementById('contact-form');
    const alertEl = document.getElementById('contact-alert');

    function setAlert(message) {
      if (!alertEl) return;
      if (!message) {
        alertEl.classList.add('hidden');
        alertEl.textContent = '';
        return;
      }
      alertEl.classList.remove('hidden');
      alertEl.textContent = message;
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      setAlert('');

      const name = String(document.getElementById('ct-name')?.value || '').trim();
      const email = String(document.getElementById('ct-email')?.value || '').trim();
      const message = String(document.getElementById('ct-message')?.value || '').trim();

      if (!name || !email || !message) {
        setAlert('Please fill in all fields.');
        return;
      }

      const res = await api.submitContact({ name, email, message });
      if (!res.success) {
        setAlert(res.error || 'Message sending is not available yet.');
        return;
      }

      setAlert('Message sent. We will get back to you soon.');
      form.reset();
    });
  </script>
</Layout>
