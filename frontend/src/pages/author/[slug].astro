---
export const prerender = false;

import Layout from '@layouts/Layout.astro';
import BreadcrumbSchema from '@components/seo/BreadcrumbSchema.astro';
import PersonSchema from '@components/seo/PersonSchema.astro';
import { api } from '@lib/api';

const siteName = import.meta.env.PUBLIC_SITE_NAME || 'DTC Store';
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://example.com';

const { slug } = Astro.params;

// Fetch author from API
let author: any = null;
let posts: any[] = [];
let error: string | null = null;

if (slug) {
  try {
    const response = await api.getAuthorBySlug(slug);
    
    if (response.success && response.data) {
      // The API returns { data: [author] } for list endpoint with slug filter
      const authors = response.data.data;
      author = Array.isArray(authors) && authors.length > 0 ? authors[0] : response.data.data;
      
      // Fetch author's blog posts
      if (author && author.id) {
        const postsResponse = await api.getBlogPosts({
          author_id: author.id,
          status: 'published',
          limit: 50
        });
        
        if (postsResponse.success && postsResponse.data) {
          posts = postsResponse.data.data || [];
          // Sort by published date (newest first)
          posts.sort((a, b) => {
            const dateA = new Date(a.published_at || a.created_at).getTime();
            const dateB = new Date(b.published_at || b.created_at).getTime();
            return dateB - dateA;
          });
        }
      }
    } else {
      error = response.error || 'Author not found';
    }
  } catch (e) {
    console.error('Error fetching author:', e);
    error = 'Failed to load author';
  }
}

if (!author) {
  return Astro.redirect('/blog');
}

const authorUrl = new URL(`/author/${author.slug}`, siteUrl).toString();
const sameAs: string[] = [];

// Build sameAs array from social_links
if (author.social_links && typeof author.social_links === 'object') {
  Object.values(author.social_links).forEach((url) => {
    if (typeof url === 'string' && url) {
      sameAs.push(url);
    }
  });
}

const breadcrumbItems = [
  { name: 'Home', url: siteUrl },
  { name: 'Author', url: authorUrl },
];
---

<Layout title={`${author.name} | ${siteName}`} description={author.bio || `About ${author.name}.`}>
  <Fragment slot="head">
    <BreadcrumbSchema items={breadcrumbItems} />
    <PersonSchema
      name={author.name}
      url={authorUrl}
      image={author.avatar_url}
      sameAs={sameAs}
      description={author.bio}
    />
  </Fragment>

  <main class="container-custom">
    <section class="section">
      <div class="flex items-start gap-4">
        <div class="h-16 w-16 rounded-full bg-gray-100 overflow-hidden flex items-center justify-center shrink-0">
          {author.avatar_url ? (
            <img src={author.avatar_url} alt={author.name} class="h-full w-full object-cover" />
          ) : (
            <span class="text-xl font-semibold text-gray-600">{author.name.slice(0, 1)}</span>
          )}
        </div>
        <div>
          <h1 class="text-3xl">{author.name}</h1>
          {author.bio && <p class="mt-2 text-gray-600 max-w-2xl">{author.bio}</p>}
          {author.credentials && author.credentials.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {author.credentials.map((c: string) => (
                <span class="badge">{c}</span>
              ))}
            </div>
          )}
          {author.social_links && Object.keys(author.social_links).length > 0 && (
            <div class="mt-4 flex flex-wrap gap-3 text-sm">
              {Object.entries(author.social_links).map(([platform, url]) => (
                <a 
                  class="text-primary-600 hover:text-primary-700" 
                  href={url as string} 
                  target="_blank" 
                  rel="noreferrer"
                >
                  {platform.charAt(0).toUpperCase() + platform.slice(1)}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>

      <div class="mt-10">
        <h2>Articles</h2>
        {posts.length === 0 ? (
          <div class="mt-4 text-gray-600">No posts yet.</div>
        ) : (
          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            {posts.map((p) => (
              <article class="card p-5">
                <a href={`/blog/${p.slug}`} class="block">
                  <div class="text-sm text-gray-500">Blog</div>
                  <div class="mt-1 text-lg font-semibold text-gray-900">{p.title}</div>
                  <div class="mt-2 text-sm text-gray-600">{p.meta_description || ''}</div>
                </a>
              </article>
            ))}
          </div>
        )}
      </div>
    </section>
  </main>
</Layout>
