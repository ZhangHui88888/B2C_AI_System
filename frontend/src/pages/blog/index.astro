---
import Layout from '@layouts/Layout.astro';
import BreadcrumbSchema from '@components/seo/BreadcrumbSchema.astro';
import PublishDate from '@components/geo/PublishDate.astro';
import { api } from '@lib/api';

const siteName = import.meta.env.PUBLIC_SITE_NAME || 'DTC Store';
let siteUrl = 'https://example.com';
try {
  siteUrl = new URL(Astro.request.url).origin;
} catch {}

const breadcrumbItems = [
  { name: 'Home', url: siteUrl },
  { name: 'Blog', url: new URL('/blog', siteUrl).toString() },
];

// Fetch blog posts from API
let posts: any[] = [];
let error: string | null = null;

try {
  const response = await api.getBlogPosts({ 
    status: 'published',
    limit: 50 
  });
  
  if (response.success && response.data) {
    posts = response.data.data || [];
  } else {
    error = response.error || 'Failed to load blog posts';
  }
} catch (e) {
  console.error('Error fetching blog posts:', e);
  error = 'Failed to load blog posts';
}

// Sort by published date (newest first)
posts.sort((a, b) => {
  const dateA = new Date(a.published_at || a.created_at).getTime();
  const dateB = new Date(b.published_at || b.created_at).getTime();
  return dateB - dateA;
});
---

<Layout title="Blog" description={`Buying guides and updates from ${siteName}.`}>
  <Fragment slot="head">
    <BreadcrumbSchema items={breadcrumbItems} />
  </Fragment>

  <main class="container-custom">
    <section class="section">
      <h1>Blog</h1>
      <p class="mt-3 text-gray-600 max-w-2xl">Practical guides and explanations to help you shop with confidence.</p>

      {error && (
        <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
          {error}
        </div>
      )}

      {!error && posts.length === 0 && (
        <div class="mt-10 text-center text-gray-500">
          <p>No blog posts yet. Check back soon!</p>
        </div>
      )}

      {!error && posts.length > 0 && (
        <div class="mt-10 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          {posts.map((post) => {
            const author = post.author;
            const publishedAt = post.published_at || post.created_at;
            const updatedAt = post.updated_at;
            
            return (
              <article class="card p-5">
                <a href={`/blog/${post.slug}`} class="block">
                  <h2 class="text-xl font-display font-bold text-gray-900">{post.title || 'Untitled'}</h2>
                  <p class="mt-2 text-sm text-gray-600">{post.meta_description || ''}</p>
                </a>
                <div class="mt-4 flex items-center justify-between gap-3">
                  <div class="text-sm text-gray-600">
                    {author ? (
                      <a class="hover:text-primary-600" href={`/author/${author.slug}`}>
                        {author.name}
                      </a>
                    ) : (
                      'Editorial'
                    )}
                  </div>
                  <PublishDate publishedAt={publishedAt} updatedAt={updatedAt} />
                </div>
              </article>
            );
          })}
        </div>
      )}
    </section>
  </main>
</Layout>
