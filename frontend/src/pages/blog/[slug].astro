---
export const prerender = false;

import Layout from '@layouts/Layout.astro';
import BreadcrumbSchema from '@components/seo/BreadcrumbSchema.astro';
import ArticleSchema from '@components/seo/ArticleSchema.astro';
import AuthorInfo from '@components/geo/AuthorInfo.astro';
import PublishDate from '@components/geo/PublishDate.astro';
import Summary from '@components/geo/Summary.astro';
import DefinitionParagraph from '@components/geo/DefinitionParagraph.astro';
import { api } from '@lib/api';

const siteName = import.meta.env.PUBLIC_SITE_NAME || 'DTC Store';
let siteUrl = 'https://example.com';
try {
  siteUrl = new URL(Astro.request.url).origin;
} catch {}

const { slug } = Astro.params;

// Fetch blog post from API
let post: any = null;
let error: string | null = null;

if (slug) {
  try {
    const response = await api.getBlogPostBySlug(slug);
    
    if (response.success && response.data) {
      // The API returns { data: [post] } for list endpoint
      const posts = response.data.data;
      post = Array.isArray(posts) && posts.length > 0 ? posts[0] : response.data.data;
    } else {
      error = response.error || 'Blog post not found';
    }
  } catch (e) {
    console.error('Error fetching blog post:', e);
    error = 'Failed to load blog post';
  }
}

if (!post) {
  return Astro.redirect('/blog');
}

const author = post.author;

const breadcrumbItems = [
  { name: 'Home', url: siteUrl },
  { name: 'Blog', url: new URL('/blog', siteUrl).toString() },
  { name: post.title, url: new URL(`/blog/${post.slug}`, siteUrl).toString() },
];

const url = new URL(`/blog/${post.slug}`, siteUrl).toString();
const publishedAt = post.published_at || post.created_at;
const updatedAt = post.updated_at;

function xmlEscape(s: string): string {
  return s
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&apos;');
}

function renderMarkdown(md: string): string {
  const lines = (md || '').split('\n');
  const blocks: string[] = [];
  for (const line of lines) {
    const t = line.trimEnd();
    if (!t.trim()) continue;
    if (t.startsWith('### ')) {
      blocks.push(`<h3>${xmlEscape(t.slice(4).trim())}</h3>`);
      continue;
    }
    if (t.startsWith('## ')) {
      blocks.push(`<h2>${xmlEscape(t.slice(3).trim())}</h2>`);
      continue;
    }
    if (t.startsWith('# ')) {
      blocks.push(`<h1>${xmlEscape(t.slice(2).trim())}</h1>`);
      continue;
    }
    blocks.push(`<p>${xmlEscape(t)}</p>`);
  }
  return blocks.join('\n');
}

const contentHtml = renderMarkdown(post.content || '');
const summary = post.meta_description || '';
---

<Layout title={post.title} description={summary} image={post.hero_image_url}>
  <Fragment slot="head">
    <BreadcrumbSchema items={breadcrumbItems} />
    <ArticleSchema
      headline={post.title}
      description={summary}
      url={url}
      image={post.hero_image_url}
      datePublished={publishedAt}
      dateModified={updatedAt}
      authorName={author?.name}
    />
  </Fragment>

  <main class="container-custom">
    <article class="section">
      <div class="max-w-3xl">
        <h1>{post.title}</h1>
        {summary && <p class="mt-3 text-gray-600">{summary}</p>}

        <div class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          {author && (
            <AuthorInfo 
              author={{ 
                name: author.name, 
                slug: author.slug, 
                avatar: author.avatar_url, 
                bio: author.bio 
              }} 
            />
          )}
          <PublishDate publishedAt={publishedAt} updatedAt={updatedAt} />
        </div>

        {summary && (
          <div class="mt-8">
            <Summary text={summary} />
          </div>
        )}

        <div class="mt-8">
          <DefinitionParagraph term={post.title} definition={summary || post.title} />
        </div>

        <div class="mt-10 prose prose-gray max-w-none">
          <Fragment set:html={contentHtml} />
        </div>
      </div>
    </article>
  </main>
</Layout>
